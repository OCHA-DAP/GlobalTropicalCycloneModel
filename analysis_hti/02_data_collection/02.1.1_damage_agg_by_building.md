```python
from pathlib import Path
import os

from shapely.geometry import LineString,Polygon, MultiPolygon
import geopandas as gpd
import numpy as np
import pandas as pd
import xarray as xr
import re
import matplotlib.pyplot as plt
from matplotlib.patches import Patch
from matplotlib.lines import Line2D
from scipy import stats
```


```python
input_dir = (
    Path(os.getenv("STORM_DATA_DIR"))
    / "analysis_hti/02_model_features/02_housing_damage/input/"
)
output_dir = (
    Path(os.getenv("STORM_DATA_DIR"))
    / "analysis_hti/02_model_features/02_housing_damage/output/"
)

# Load shapefile
shp = gpd.read_file(input_dir / "shapefile_hti_fixed.gpkg")
shp = shp.to_crs('EPSG:4326')

# Load grid
grid_land_overlap = gpd.read_file(output_dir / "hti_0.1_degree_grid_land_overlap.gpkg")
grid_land_overlap["id"] = grid_land_overlap["id"].astype(int)

# Load grids per Municipality
ids_mun = pd.read_csv(input_dir / "grid_municipality_info.csv")

# Load damage data
damage_data = pd.read_csv(input_dir / "impact_data_bld_hti.csv")
```

## Building locations


```python
bld_count = pd.read_csv(
    input_dir / "hti_google_bld_grid_count.csv"
)
bld_count = bld_count.rename({'count':'numbuildings'}, axis=1)

gpd_bld = gpd.GeoDataFrame(bld_count.merge(grid_land_overlap, on='id'),
                           geometry='geometry')
```

### Map of building locations


```python
# Plot builing loc over map
fig, ax = plt.subplots(1,1)

gpd_bld.plot(ax=ax, cmap='Reds', markersize=10, label='Buildings', column='numbuildings')
ax.set_xlabel('Longitude')
ax.set_ylabel('Latitude')
ax.set_title('Haiti builings by grid')

plt.show()
```



![png](02.1.1_damage_agg_by_building_files/02.1.1_damage_agg_by_building_5_0.png)



### Distribution of total houses per grid cell


```python
gpd_bld[gpd_bld['numbuildings'] !=0]
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>id</th>
      <th>numbuildings</th>
      <th>Longitude</th>
      <th>Latitude</th>
      <th>Centroid</th>
      <th>geometry</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>235</td>
      <td>255.0</td>
      <td>-74.45</td>
      <td>18.65</td>
      <td>-74.45W_18.65N</td>
      <td>POLYGON ((-74.50000 18.70000, -74.40000 18.700...</td>
    </tr>
    <tr>
      <th>1</th>
      <td>236</td>
      <td>4708.0</td>
      <td>-74.45</td>
      <td>18.55</td>
      <td>-74.45W_18.55N</td>
      <td>POLYGON ((-74.50000 18.60000, -74.40000 18.600...</td>
    </tr>
    <tr>
      <th>2</th>
      <td>237</td>
      <td>7880.0</td>
      <td>-74.45</td>
      <td>18.45</td>
      <td>-74.45W_18.45N</td>
      <td>POLYGON ((-74.50000 18.50000, -74.40000 18.500...</td>
    </tr>
    <tr>
      <th>3</th>
      <td>238</td>
      <td>1020.0</td>
      <td>-74.45</td>
      <td>18.35</td>
      <td>-74.45W_18.35N</td>
      <td>POLYGON ((-74.50000 18.40000, -74.40000 18.400...</td>
    </tr>
    <tr>
      <th>4</th>
      <td>277</td>
      <td>3597.0</td>
      <td>-74.35</td>
      <td>18.65</td>
      <td>-74.35W_18.65N</td>
      <td>POLYGON ((-74.40000 18.70000, -74.30000 18.700...</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>316</th>
      <td>1404</td>
      <td>3423.0</td>
      <td>-71.65</td>
      <td>19.35</td>
      <td>-71.65W_19.35N</td>
      <td>POLYGON ((-71.70000 19.40000, -71.60000 19.400...</td>
    </tr>
    <tr>
      <th>317</th>
      <td>1405</td>
      <td>4826.0</td>
      <td>-71.65</td>
      <td>19.25</td>
      <td>-71.65W_19.25N</td>
      <td>POLYGON ((-71.70000 19.30000, -71.60000 19.300...</td>
    </tr>
    <tr>
      <th>318</th>
      <td>1406</td>
      <td>2648.0</td>
      <td>-71.65</td>
      <td>19.15</td>
      <td>-71.65W_19.15N</td>
      <td>POLYGON ((-71.70000 19.20000, -71.60000 19.200...</td>
    </tr>
    <tr>
      <th>319</th>
      <td>1407</td>
      <td>1892.0</td>
      <td>-71.65</td>
      <td>19.05</td>
      <td>-71.65W_19.05N</td>
      <td>POLYGON ((-71.70000 19.10000, -71.60000 19.100...</td>
    </tr>
    <tr>
      <th>320</th>
      <td>1414</td>
      <td>27.0</td>
      <td>-71.65</td>
      <td>18.35</td>
      <td>-71.65W_18.35N</td>
      <td>POLYGON ((-71.70000 18.40000, -71.60000 18.400...</td>
    </tr>
  </tbody>
</table>
<p>316 rows × 6 columns</p>
</div>




```python
build_per_grid = gpd_bld['numbuildings']
#plt.hist(build_per_grid, bins=50)
hist = np.histogram(build_per_grid, bins=10 ** np.linspace(0, np.log10(10**4), len(build_per_grid)), density=True)
x = hist[1][:-1]
y = hist[0]

plt.plot(x,y, 'ro', alpha=0.4, label='Buildings')
plt.xscale('log')
plt.yscale('log')

plt.xlabel('Buildings per grid cell')
plt.ylabel('PDF')

q25 = np.quantile(build_per_grid, 0.25)
q50 = np.quantile(build_per_grid, 0.50)
mode = stats.mode(build_per_grid).mode

# Add text boxes with annotations
plt.text(0.7, 0.9, f'Quantile 25: {q25:.2f}', transform=plt.gca().transAxes)
plt.text(0.7, 0.85, f'Quantile 50: {q50:.2f}', transform=plt.gca().transAxes)
plt.text(0.7, 0.8, f'Mode: {mode:.2f}', transform=plt.gca().transAxes)

plt.show()
```



![png](02.1.1_damage_agg_by_building_files/02.1.1_damage_agg_by_building_8_0.png)



### Building damage to grid


```python
# ADM1 Regions by id
mun_dict = ids_mun[['id', 'ADM1_PCODE']].groupby(by='ADM1_PCODE').groups
muns =  mun_dict.keys()
ids = []
for m in muns:
    ids.append(ids_mun.iloc[mun_dict[m].values].id)
df_muns_adm1 = pd.DataFrame({'Region': muns, 'ids':ids})
adm1_provinces_exploded = df_muns_adm1.explode('ids').reset_index(drop=True)

# ADM2 Regions by id
region_dict = ids_mun[['id', 'ADM2_PCODE']].groupby(by='ADM2_PCODE').groups
regions = region_dict.keys()
ids = []
for r in regions:
    ids.append(ids_mun.iloc[region_dict[r].values].id)
df_muns_adm2 = pd.DataFrame({'Region': regions, 'ids':ids})
adm2_provinces_exploded = df_muns_adm2.explode('ids').reset_index(drop=True)
```


```python
# Assign adm1 municipality to bld count
bld_grid_adm1 = bld_count.merge(adm1_provinces_exploded, left_on='id', right_on='ids', how='inner')[['id', 'Region', 'numbuildings']]

# Assign adm2 municipality to bld count
bld_grid_adm2 = bld_count.merge(adm2_provinces_exploded, left_on='id', right_on='ids', how='inner')[['id', 'Region', 'numbuildings']]


bld_grid_adm1.sort_values('numbuildings', ascending=False)
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>id</th>
      <th>Region</th>
      <th>numbuildings</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>227</th>
      <td>1160</td>
      <td>HT01</td>
      <td>300289.0</td>
    </tr>
    <tr>
      <th>211</th>
      <td>1118</td>
      <td>HT01</td>
      <td>277305.0</td>
    </tr>
    <tr>
      <th>226</th>
      <td>1159</td>
      <td>HT01</td>
      <td>170524.0</td>
    </tr>
    <tr>
      <th>194</th>
      <td>1076</td>
      <td>HT01</td>
      <td>103463.0</td>
    </tr>
    <tr>
      <th>153</th>
      <td>983</td>
      <td>HT05</td>
      <td>97619.0</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>67</th>
      <td>694</td>
      <td>HT01</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>45</th>
      <td>571</td>
      <td>HT08</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>121</th>
      <td>899</td>
      <td>HT05</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>142</th>
      <td>948</td>
      <td>HT01</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>297</th>
      <td>1333</td>
      <td>HT02</td>
      <td>0.0</td>
    </tr>
  </tbody>
</table>
<p>321 rows × 3 columns</p>
</div>




```python
# Because I can: builings by Municipality

df_aux = bld_grid_adm1.groupby('Region').sum().sort_values(by='numbuildings', ascending=False)
df_aux2 = bld_grid_adm2.groupby('Region').sum().sort_values(by='numbuildings', ascending=False)

plt.figure(figsize=(12, 6))
plt.bar(df_aux.index, df_aux['numbuildings'])
plt.ylabel('Number of Buildings')
plt.title('Number of Buildings by ADM1 region')
plt.xticks(rotation=90)
plt.show()

plt.figure(figsize=(12, 6))
plt.bar(df_aux2.index, df_aux2['numbuildings'])
plt.ylabel('Number of Buildings')
plt.title('Number of Buildings by ADM2 region')
plt.xticks(rotation=90)
plt.show()
```



![png](02.1.1_damage_agg_by_building_files/02.1.1_damage_agg_by_building_12_0.png)





![png](02.1.1_damage_agg_by_building_files/02.1.1_damage_agg_by_building_12_1.png)



Since I have multiple regions affected by a single typhoon but just une quantity of damage, at the end I have damage not even at region level, but at a bigger scale (damage at a set of regions level). This is bad but is what we have, and all the calculous that we do have to take this into account.


```python
# Total number of buildings per adm1 region
total_bld_reg = bld_grid_adm1.groupby('Region').sum()['numbuildings'].reset_index(drop=False)
bld_grid_reg_adm1_merged = bld_grid_adm1.merge(total_bld_reg, on='Region', how='left')

# Total number of buildings per adm2 region
total_bld_reg = bld_grid_adm2.groupby('Region').sum()['numbuildings'].reset_index(drop=False)
bld_grid_reg_adm2_merged = bld_grid_adm2.merge(total_bld_reg, on='Region', how='left')
```


```python
import ast

bld_damage_merged_adm1 = damage_data.merge(bld_grid_reg_adm1_merged, left_on='ADM1_PCODE', right_on='Region')
bld_damage_merged_adm2 = damage_data.merge(bld_grid_reg_adm2_merged, left_on='ADM2_PCODE', right_on='Region')
```


```python
bld_damage_merged_total = pd.DataFrame()
bld_dmg_aux = bld_damage_merged_adm1.drop_duplicates(['typhoon_name', 'Year'])
for typhoon, year, level in zip(bld_dmg_aux['typhoon_name'], bld_dmg_aux['Year'], bld_dmg_aux['event_level']):
    #adm1 or adm2
    if level == 'ADM1':
        bld_damage_merged = bld_damage_merged_adm1.copy()
        ADM = 'ADM1_PCODE'
    else:
        bld_damage_merged = bld_damage_merged_adm2.copy()
        ADM = 'ADM2_PCODE'

    bld_damage_merged_set_regions = bld_damage_merged.loc[(bld_damage_merged.typhoon_name == typhoon) & (bld_damage_merged.Year == year)].copy()

    bld_aux = bld_damage_merged_set_regions[bld_damage_merged_set_regions['bld_affected']!= 0].drop_duplicates(ADM)
    bld_aux2 = bld_damage_merged_set_regions[bld_damage_merged_set_regions['bld_affected_from_phl']!= 0].drop_duplicates(ADM)
    # Total number of buildings in the set of regions
    bld_damage_merged_set_regions['numbuildings_z'] = bld_aux.numbuildings_y.unique().sum()
    bld_damage_merged_set_regions['numbuildings_z_from_phl'] = bld_aux2.numbuildings_y.unique().sum()
    # Density of buildings per cell for every typhoon
    bld_damage_merged_set_regions['frac_bld'] = bld_damage_merged_set_regions['numbuildings_x'] / bld_damage_merged_set_regions['numbuildings_z']
    bld_damage_merged_set_regions['frac_bld_from_phl'] = bld_damage_merged_set_regions['numbuildings_x'] / bld_damage_merged_set_regions['numbuildings_z_from_phl']
    # Create percentage of damage per grid cell
    bld_damage_merged_set_regions['perc_dmg_grid'] = bld_damage_merged_set_regions['frac_bld'] * bld_damage_merged_set_regions['bld_affected'] * 100 / bld_damage_merged_set_regions['numbuildings_z']
    bld_damage_merged_set_regions['perc_dmg_grid_from_phl'] = bld_damage_merged_set_regions['frac_bld_from_phl'] * bld_damage_merged_set_regions['bld_affected_from_phl'] * 100 / bld_damage_merged_set_regions['numbuildings_z_from_phl']

    bld_damage_merged_set_regions = bld_damage_merged_set_regions[[
        'typhoon_name',
        'Year',
        'event_level',
        'id',
        'bld_affected', 'bld_affected_from_phl',
        'numbuildings_x',
        'numbuildings_z',
        'frac_bld',
        'perc_dmg_grid',
        'perc_dmg_grid_from_phl'
        ]].drop_duplicates().sort_values('perc_dmg_grid')

    bld_damage_merged_total = pd.concat([bld_damage_merged_total, bld_damage_merged_set_regions])
# Fix names
bld_damage_merged_total['typhoon_name'] = bld_damage_merged_total['typhoon_name'].str.strip()
```

### Some plots


```python
fig, ax = plt.subplots(1,2)
ax[0].hist(bld_damage_merged_total.perc_dmg_grid)
ax[0].set_yscale('log')
ax[0].set_title('Dummy way of \ncomputing bld damage')

ax[1].hist(bld_damage_merged_total.perc_dmg_grid_from_phl)
ax[1].set_yscale('log')
ax[1].set_title('Bld damage \nfrom Phlippines relation')

plt.tight_layout()
plt.show()
```



![png](02.1.1_damage_agg_by_building_files/02.1.1_damage_agg_by_building_18_0.png)



### Save % of damage per grid cell


```python
bld_damage_merged_total.sort_values('bld_affected')
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>typhoon_name</th>
      <th>Year</th>
      <th>event_level</th>
      <th>id</th>
      <th>bld_affected</th>
      <th>bld_affected_from_phl</th>
      <th>numbuildings_x</th>
      <th>numbuildings_z</th>
      <th>frac_bld</th>
      <th>perc_dmg_grid</th>
      <th>perc_dmg_grid_from_phl</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>14052</th>
      <td>ISAAC</td>
      <td>2012</td>
      <td>ADM1</td>
      <td>1150</td>
      <td>0.000000</td>
      <td>400.278354</td>
      <td>7651.0</td>
      <td>2904892.0</td>
      <td>0.002634</td>
      <td>0.000000</td>
      <td>1.881721e-05</td>
    </tr>
    <tr>
      <th>74697</th>
      <td>OLGA</td>
      <td>2007</td>
      <td>ADM1</td>
      <td>1024</td>
      <td>0.000000</td>
      <td>99.057901</td>
      <td>5538.0</td>
      <td>718881.0</td>
      <td>0.007704</td>
      <td>0.000000</td>
      <td>3.370675e-06</td>
    </tr>
    <tr>
      <th>74698</th>
      <td>OLGA</td>
      <td>2007</td>
      <td>ADM1</td>
      <td>1025</td>
      <td>0.000000</td>
      <td>99.057901</td>
      <td>8447.0</td>
      <td>718881.0</td>
      <td>0.011750</td>
      <td>0.000000</td>
      <td>5.141223e-06</td>
    </tr>
    <tr>
      <th>2880</th>
      <td>OLGA</td>
      <td>2007</td>
      <td>ADM1</td>
      <td>235</td>
      <td>0.000000</td>
      <td>99.057901</td>
      <td>255.0</td>
      <td>718881.0</td>
      <td>0.000355</td>
      <td>0.000000</td>
      <td>1.552044e-07</td>
    </tr>
    <tr>
      <th>80152</th>
      <td>IRENE</td>
      <td>2011</td>
      <td>ADM1</td>
      <td>938</td>
      <td>0.000000</td>
      <td>45.329592</td>
      <td>11816.0</td>
      <td>328965.0</td>
      <td>0.035919</td>
      <td>0.000000</td>
      <td>3.290994e-06</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>100299</th>
      <td>MATTHEW</td>
      <td>2016</td>
      <td>ADM1</td>
      <td>701</td>
      <td>772005.210029</td>
      <td>91301.304088</td>
      <td>9218.0</td>
      <td>2555970.0</td>
      <td>0.003606</td>
      <td>0.108929</td>
      <td>5.171166e-03</td>
    </tr>
    <tr>
      <th>29711</th>
      <td>MATTHEW</td>
      <td>2016</td>
      <td>ADM1</td>
      <td>1078</td>
      <td>772005.210029</td>
      <td>91301.304088</td>
      <td>9072.0</td>
      <td>2555970.0</td>
      <td>0.003549</td>
      <td>0.107204</td>
      <td>5.089262e-03</td>
    </tr>
    <tr>
      <th>62228</th>
      <td>MATTHEW</td>
      <td>2016</td>
      <td>ADM1</td>
      <td>1077</td>
      <td>772005.210029</td>
      <td>91301.304088</td>
      <td>8982.0</td>
      <td>2555970.0</td>
      <td>0.003514</td>
      <td>0.106141</td>
      <td>5.038774e-03</td>
    </tr>
    <tr>
      <th>23222</th>
      <td>MATTHEW</td>
      <td>2016</td>
      <td>ADM1</td>
      <td>770</td>
      <td>772005.210029</td>
      <td>91301.304088</td>
      <td>9818.0</td>
      <td>2555970.0</td>
      <td>0.003841</td>
      <td>0.116020</td>
      <td>5.507758e-03</td>
    </tr>
    <tr>
      <th>62209</th>
      <td>MATTHEW</td>
      <td>2016</td>
      <td>ADM1</td>
      <td>907</td>
      <td>772005.210029</td>
      <td>91301.304088</td>
      <td>84.0</td>
      <td>2555970.0</td>
      <td>0.000033</td>
      <td>0.000993</td>
      <td>4.712280e-05</td>
    </tr>
  </tbody>
</table>
<p>8025 rows × 11 columns</p>
</div>




```python
bld_damage_merged_total.to_csv(output_dir / "building_damage_bygrid.csv", index=False)
```
