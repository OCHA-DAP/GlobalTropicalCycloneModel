The data is gotten from `https://sites.research.google/open-buildings/#download`


```python
import pandas as pd
import geopandas as gpd
import os
from pathlib import Path
import requests
import matplotlib.pyplot as plt
```


```python
base_dir = Path(os.getenv("STORM_DATA_DIR")) / "analysis_hti/02_model_features/"
input_dir = base_dir / "02_housing_damage/input"
google_dir = input_dir / "Google Footprint Data/"
os.makedirs(google_dir, exist_ok=True)

# Load  shp
shp = gpd.read_file(input_dir / "shapefile_hti_fixed.gpkg")
shp = shp.to_crs('EPSG:4326')

# Load grids
grid = gpd.read_file(base_dir / "02_housing_damage/output/hti_0.1_degree_grid_land_overlap.gpkg")
```


```python
google_tiles = gpd.read_file(
    google_dir / "tiles.geojson"
)
```


```python
google_tiles.plot()
plt.show()
```



![png](02.1.0_google_open_buildings_files/02.1.0_google_open_buildings_4_0.png)




```python
shp.plot()
```




    <Axes: >





![png](02.1.0_google_open_buildings_files/02.1.0_google_open_buildings_5_1.png)




```python
shp.crs == google_tiles.crs
grid.crs == google_tiles.crs
```




    True




```python
joined_df = gpd.sjoin(google_tiles, grid, how="right", op="intersects")
file_pattern = joined_df.dropna().tile_id.unique()
```

    /Users/federico/anaconda3/envs/env6/lib/python3.11/site-packages/IPython/core/interactiveshell.py:3466: FutureWarning: The `op` parameter is deprecated and will be removed in a future release. Please use the `predicate` parameter instead.
      if await self.run_code(code, result, async_=asy):



```python
polygons_url_link = "https://storage.googleapis.com/open-buildings-data/v3/polygons_s2_level_4_gzip/"
points_url_link = "https://storage.googleapis.com/open-buildings-data/v3/points_s2_level_4_gzip/"
file_list = [patt + "_buildings.csv.gz" for patt in file_pattern]
```


```python
# Downloading data. It takes a long time, be cautious.
for file in file_list:
    r = requests.get(points_url_link + file, allow_redirects=True)
    open(google_dir / file, "wb").write(r.content)
```


```python
# Merging data (also takes long)
google_df = pd.DataFrame()
for file in file_list:
    zone_file = pd.read_csv(google_dir / file, compression="gzip")
    google_df = pd.concat([google_df, zone_file])
google_df
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>latitude</th>
      <th>longitude</th>
      <th>area_in_meters</th>
      <th>confidence</th>
      <th>full_plus_code</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>18.245046</td>
      <td>-74.088409</td>
      <td>44.6381</td>
      <td>0.7889</td>
      <td>77C76WW6+2J8X</td>
    </tr>
    <tr>
      <th>1</th>
      <td>19.974077</td>
      <td>-77.485400</td>
      <td>16.1927</td>
      <td>0.8163</td>
      <td>77F4XGF7+JRQ2</td>
    </tr>
    <tr>
      <th>2</th>
      <td>20.030764</td>
      <td>-75.821215</td>
      <td>41.3491</td>
      <td>0.7723</td>
      <td>77G625JH+8G3C</td>
    </tr>
    <tr>
      <th>3</th>
      <td>17.941746</td>
      <td>-76.832489</td>
      <td>57.3881</td>
      <td>0.6720</td>
      <td>7795W5R9+M2RV</td>
    </tr>
    <tr>
      <th>4</th>
      <td>20.698896</td>
      <td>-75.671223</td>
      <td>19.2484</td>
      <td>0.6894</td>
      <td>77G6M8XH+HG2X</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>8233318</th>
      <td>18.504579</td>
      <td>-69.835469</td>
      <td>74.4113</td>
      <td>0.6928</td>
      <td>77CGG537+RRJ5</td>
    </tr>
    <tr>
      <th>8233319</th>
      <td>18.494754</td>
      <td>-69.781752</td>
      <td>123.6928</td>
      <td>0.8615</td>
      <td>77CGF6V9+W755</td>
    </tr>
    <tr>
      <th>8233320</th>
      <td>19.570838</td>
      <td>-71.674996</td>
      <td>17.0606</td>
      <td>0.7231</td>
      <td>77FCH8CG+82JC</td>
    </tr>
    <tr>
      <th>8233321</th>
      <td>18.450537</td>
      <td>-69.631492</td>
      <td>75.8762</td>
      <td>0.6619</td>
      <td>77CGF929+6C6C</td>
    </tr>
    <tr>
      <th>8233322</th>
      <td>19.647554</td>
      <td>-71.688340</td>
      <td>357.6511</td>
      <td>0.8836</td>
      <td>77FCJ8X6+2MF2</td>
    </tr>
  </tbody>
</table>
<p>12794528 rows × 5 columns</p>
</div>




```python
# Saving data (takes long)
google_df.to_csv(input_dir / "google_footprint_data.csv", index=False)
```


```python
# Load (if neccesary)
google_df = pd.read_csv(input_dir / "google_footprint_data.csv")
```


```python
# Creating geodataframe from df
ggl_gdf = gpd.GeoDataFrame(
    google_df,
    geometry=gpd.points_from_xy(google_df.longitude, google_df.latitude),
)
```


```python
ggl_gdf.set_crs(grid.crs, inplace=True)
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>latitude</th>
      <th>longitude</th>
      <th>area_in_meters</th>
      <th>confidence</th>
      <th>full_plus_code</th>
      <th>geometry</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>18.245046</td>
      <td>-74.088409</td>
      <td>44.6381</td>
      <td>0.7889</td>
      <td>77C76WW6+2J8X</td>
      <td>POINT (-74.08841 18.24505)</td>
    </tr>
    <tr>
      <th>1</th>
      <td>19.974077</td>
      <td>-77.485400</td>
      <td>16.1927</td>
      <td>0.8163</td>
      <td>77F4XGF7+JRQ2</td>
      <td>POINT (-77.48540 19.97408)</td>
    </tr>
    <tr>
      <th>2</th>
      <td>20.030764</td>
      <td>-75.821215</td>
      <td>41.3491</td>
      <td>0.7723</td>
      <td>77G625JH+8G3C</td>
      <td>POINT (-75.82122 20.03076)</td>
    </tr>
    <tr>
      <th>3</th>
      <td>17.941746</td>
      <td>-76.832489</td>
      <td>57.3881</td>
      <td>0.6720</td>
      <td>7795W5R9+M2RV</td>
      <td>POINT (-76.83249 17.94175)</td>
    </tr>
    <tr>
      <th>4</th>
      <td>20.698896</td>
      <td>-75.671223</td>
      <td>19.2484</td>
      <td>0.6894</td>
      <td>77G6M8XH+HG2X</td>
      <td>POINT (-75.67122 20.69890)</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>12794523</th>
      <td>18.504579</td>
      <td>-69.835469</td>
      <td>74.4113</td>
      <td>0.6928</td>
      <td>77CGG537+RRJ5</td>
      <td>POINT (-69.83547 18.50458)</td>
    </tr>
    <tr>
      <th>12794524</th>
      <td>18.494754</td>
      <td>-69.781752</td>
      <td>123.6928</td>
      <td>0.8615</td>
      <td>77CGF6V9+W755</td>
      <td>POINT (-69.78175 18.49475)</td>
    </tr>
    <tr>
      <th>12794525</th>
      <td>19.570838</td>
      <td>-71.674996</td>
      <td>17.0606</td>
      <td>0.7231</td>
      <td>77FCH8CG+82JC</td>
      <td>POINT (-71.67500 19.57084)</td>
    </tr>
    <tr>
      <th>12794526</th>
      <td>18.450537</td>
      <td>-69.631492</td>
      <td>75.8762</td>
      <td>0.6619</td>
      <td>77CGF929+6C6C</td>
      <td>POINT (-69.63149 18.45054)</td>
    </tr>
    <tr>
      <th>12794527</th>
      <td>19.647554</td>
      <td>-71.688340</td>
      <td>357.6511</td>
      <td>0.8836</td>
      <td>77FCJ8X6+2MF2</td>
      <td>POINT (-71.68834 19.64755)</td>
    </tr>
  </tbody>
</table>
<p>12794528 rows × 6 columns</p>
</div>




```python
del google_df
ggl_gdf_within = gpd.sjoin(ggl_gdf, grid, how="inner", predicate="within")

```


```python
ggl_gdf_within.head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>latitude</th>
      <th>longitude</th>
      <th>area_in_meters</th>
      <th>confidence</th>
      <th>full_plus_code</th>
      <th>geometry</th>
      <th>index_right</th>
      <th>id</th>
      <th>Longitude</th>
      <th>Latitude</th>
      <th>Centroid</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>18.245046</td>
      <td>-74.088409</td>
      <td>44.6381</td>
      <td>0.7889</td>
      <td>77C76WW6+2J8X</td>
      <td>POINT (-74.08841 18.24505)</td>
      <td>23</td>
      <td>407</td>
      <td>-74.05</td>
      <td>18.25</td>
      <td>-74.05W_18.25N</td>
    </tr>
    <tr>
      <th>389</th>
      <td>18.230430</td>
      <td>-74.066561</td>
      <td>80.7576</td>
      <td>0.7250</td>
      <td>77C76WJM+59G6</td>
      <td>POINT (-74.06656 18.23043)</td>
      <td>23</td>
      <td>407</td>
      <td>-74.05</td>
      <td>18.25</td>
      <td>-74.05W_18.25N</td>
    </tr>
    <tr>
      <th>2170</th>
      <td>18.241935</td>
      <td>-74.059732</td>
      <td>102.2700</td>
      <td>0.7748</td>
      <td>77C76WRR+Q4C8</td>
      <td>POINT (-74.05973 18.24193)</td>
      <td>23</td>
      <td>407</td>
      <td>-74.05</td>
      <td>18.25</td>
      <td>-74.05W_18.25N</td>
    </tr>
    <tr>
      <th>2978</th>
      <td>18.266750</td>
      <td>-74.002093</td>
      <td>31.2356</td>
      <td>0.7905</td>
      <td>77C77X8X+P532</td>
      <td>POINT (-74.00209 18.26675)</td>
      <td>23</td>
      <td>407</td>
      <td>-74.05</td>
      <td>18.25</td>
      <td>-74.05W_18.25N</td>
    </tr>
    <tr>
      <th>3136</th>
      <td>18.253966</td>
      <td>-74.071417</td>
      <td>34.5221</td>
      <td>0.7878</td>
      <td>77C77W3H+HCPP</td>
      <td>POINT (-74.07142 18.25397)</td>
      <td>23</td>
      <td>407</td>
      <td>-74.05</td>
      <td>18.25</td>
      <td>-74.05W_18.25N</td>
    </tr>
  </tbody>
</table>
</div>




```python
# The important file
ggl_gdf_within.to_csv(
    input_dir / "hti_google_bld_points.csv.gz", compression='gzip', index=False
)
```

Buildings count


```python
result = ggl_gdf_within.groupby('id').size().reset_index(name='count')
```


```python
result = result.merge(grid, how='right')[['id','count']].fillna(0)
```


```python
result.to_csv(
    input_dir / "hti_google_bld_grid_count.csv", index=False
)
```
