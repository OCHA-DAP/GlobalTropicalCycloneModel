```python
from pathlib import Path
import os
import pandas as pd
import geopandas as gpd
import numpy as np
from shapely.geometry import Point

import rasterio
from rasterio.merge import merge
from rasterstats import zonal_stats

from osgeo import gdal
import matplotlib.pyplot as plt
```

```https://dwtkns.com/srtm30m/``` to get the data (must be registered)


```python
#data_dir = '/home/fmoss/data'
data_dir = os.getenv("STORM_DATA_DIR")
base_url = Path(data_dir) / "analysis_hti/02_model_features/"
input_dir = base_url / "04_topography/input/srtm/"
os.makedirs(input_dir, exist_ok=True)
output_dir = base_url / "04_topography/output/"
os.makedirs(output_dir, exist_ok=True)
shp_output_dir = base_url / "02_housing_damage/output/"
```


```python
# Load grid
grid = gpd.read_file(base_url / "02_housing_damage/output/hti_0.1_degree_grid_land_overlap.gpkg")
# Load shp
shp = gpd.read_file(base_url / "02_housing_damage/input/shapefile_hti_fixed.gpkg")
shp = shp.to_crs('EPSG:4326')
```

## Merge all .hdg files


```python
# List all files
fileList = os.listdir(input_dir/ "dwtkns")
print(fileList)

# All .hgt together
mosaic_raster = []
for file in fileList:
    if file.endswith(".hgt.zip"):
        rast = rasterio.open(input_dir / "dwtkns" / file)
        mosaic_raster.append(rast)
merged_raster, out_raster = merge(mosaic_raster)

# Metadata of the files
out_meta = rast.meta.copy()
out_meta.update(
    {
        "driver": "GTiff",
        "height": merged_raster.shape[1],
        "width": merged_raster.shape[2],
        "transform": out_raster,
#        "crs": grid.crs,
    }
)

# Save file
with rasterio.open(input_dir / "hti_merged_srtm.tif", "w", **out_meta) as dest:
    dest.write(merged_raster)

```

    ['N19W072.SRTMGL1.hgt.zip', 'N18W072.SRTMGL1.hgt.zip', 'N18W075.SRTMGL1.hgt.zip', 'N19W075.SRTMGL1.hgt.zip', 'N18W074.SRTMGL1.hgt.zip', 'N19W074.SRTMGL1.hgt.zip', 'N19W073.SRTMGL1.hgt.zip', 'N17W072.SRTMGL1.hgt.zip', 'N18W073.SRTMGL1.hgt.zip', 'N20W073.SRTMGL1.hgt.zip', 'N20W074.SRTMGL1.hgt.zip']


## Open merged file and compute stuff


```python
# Load
merged_rast = rasterio.open(input_dir / "hti_merged_srtm.tif")
```

Information about the dataset


```python
merged_rast_path = input_dir / "hti_merged_srtm.tif"
!gdalinfo \
"{merged_rast_path}"
```

    Driver: GTiff/GeoTIFF
    Files: /Users/federico/Documents/data/analysis_hti/02_model_features/04_topography/input/srtm/hti_merged_srtm.tif
    Size is 14401, 14401
    Coordinate System is:
    GEOGCRS["WGS 84",
        DATUM["World Geodetic System 1984",
            ELLIPSOID["WGS 84",6378137,298.257223563,
                LENGTHUNIT["metre",1]]],
        PRIMEM["Greenwich",0,
            ANGLEUNIT["degree",0.0174532925199433]],
        CS[ellipsoidal,2],
            AXIS["geodetic latitude (Lat)",north,
                ORDER[1],
                ANGLEUNIT["degree",0.0174532925199433]],
            AXIS["geodetic longitude (Lon)",east,
                ORDER[2],
                ANGLEUNIT["degree",0.0174532925199433]],
        USAGE[
            SCOPE["unknown"],
            AREA["World"],
            BBOX[-90,-180,90,180]],
        ID["EPSG",4326]]
    Data axis to CRS axis mapping: 2,1
    Origin = (-75.000138888888884,21.000138888888888)
    Pixel Size = (0.000277777777778,-0.000277777777778)
    Metadata:
      AREA_OR_POINT=Area
    Image Structure Metadata:
      INTERLEAVE=BAND
    Corner Coordinates:
    Upper Left  ( -75.0001389,  21.0001389) ( 75d 0' 0.50"W, 21d 0' 0.50"N)
    Lower Left  ( -75.0001389,  16.9998611) ( 75d 0' 0.50"W, 16d59'59.50"N)
    Upper Right ( -70.9998611,  21.0001389) ( 70d59'59.50"W, 21d 0' 0.50"N)
    Lower Right ( -70.9998611,  16.9998611) ( 70d59'59.50"W, 16d59'59.50"N)
    Center      ( -73.0000000,  19.0000000) ( 73d 0' 0.00"W, 19d 0' 0.00"N)
    Band 1 Block=14401x1 Type=Int16, ColorInterp=Gray
      NoData Value=-32768



```python
## Altitude
altitude = merged_rast.read(1)
```


```python
## slope
hti_slope_gdaldem = input_dir / "hti_slope_gdaldem.tif"
!gdaldem slope -s 111120 -co COMPRESS=DEFLATE -co ZLEVEL=9 \
"{merged_rast_path}" "{hti_slope_gdaldem}" -compute_edges
```

    0...10...20...30...40...50...60...70...80...90...100 - done.



```python
slope_rast = rasterio.open(input_dir / "hti_slope_gdaldem.tif")
slope_array = slope_rast.read(1)
```


```python
## calculate  Terrain Ruggedness Index TRI
hti_tri_gdaldem = input_dir / "hti_tri_gdaldem.tif"
!gdaldem TRI -co COMPRESS=DEFLATE -co ZLEVEL=9 \
"{merged_rast_path}" "{hti_tri_gdaldem}" -compute_edges
```

    0...10...20...30...40...50...60...70...80...90...100 - done.



```python
tri_rast = rasterio.open(input_dir / "hti_tri_gdaldem.tif")
tri_array = tri_rast.read(1)
```

### Mean slope with raster


```python
summary_stats = zonal_stats(
    grid,
    slope_array,
    stats=["mean", "std"],
    nodata=-9999,
    all_touched=True,
    affine=merged_rast.transform,
)
grid_slope = pd.DataFrame(summary_stats)
grid_slope_df = pd.concat([grid, grid_slope], axis=1)
grid_slope_df
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>id</th>
      <th>Longitude</th>
      <th>Latitude</th>
      <th>Centroid</th>
      <th>geometry</th>
      <th>mean</th>
      <th>std</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>235</td>
      <td>-74.45</td>
      <td>18.65</td>
      <td>-74.45W_18.65N</td>
      <td>POLYGON ((-74.50000 18.70000, -74.40000 18.700...</td>
      <td>0.366521</td>
      <td>1.733864</td>
    </tr>
    <tr>
      <th>1</th>
      <td>236</td>
      <td>-74.45</td>
      <td>18.55</td>
      <td>-74.45W_18.55N</td>
      <td>POLYGON ((-74.50000 18.60000, -74.40000 18.600...</td>
      <td>3.642291</td>
      <td>6.735253</td>
    </tr>
    <tr>
      <th>2</th>
      <td>237</td>
      <td>-74.45</td>
      <td>18.45</td>
      <td>-74.45W_18.45N</td>
      <td>POLYGON ((-74.50000 18.50000, -74.40000 18.500...</td>
      <td>9.420513</td>
      <td>9.781895</td>
    </tr>
    <tr>
      <th>3</th>
      <td>238</td>
      <td>-74.45</td>
      <td>18.35</td>
      <td>-74.45W_18.35N</td>
      <td>POLYGON ((-74.50000 18.40000, -74.40000 18.400...</td>
      <td>6.070587</td>
      <td>10.722867</td>
    </tr>
    <tr>
      <th>4</th>
      <td>277</td>
      <td>-74.35</td>
      <td>18.65</td>
      <td>-74.35W_18.65N</td>
      <td>POLYGON ((-74.40000 18.70000, -74.30000 18.700...</td>
      <td>5.445702</td>
      <td>7.406852</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>316</th>
      <td>1404</td>
      <td>-71.65</td>
      <td>19.35</td>
      <td>-71.65W_19.35N</td>
      <td>POLYGON ((-71.70000 19.40000, -71.60000 19.400...</td>
      <td>11.052654</td>
      <td>7.522681</td>
    </tr>
    <tr>
      <th>317</th>
      <td>1405</td>
      <td>-71.65</td>
      <td>19.25</td>
      <td>-71.65W_19.25N</td>
      <td>POLYGON ((-71.70000 19.30000, -71.60000 19.300...</td>
      <td>11.990623</td>
      <td>7.046580</td>
    </tr>
    <tr>
      <th>318</th>
      <td>1406</td>
      <td>-71.65</td>
      <td>19.15</td>
      <td>-71.65W_19.15N</td>
      <td>POLYGON ((-71.70000 19.20000, -71.60000 19.200...</td>
      <td>17.760025</td>
      <td>10.794667</td>
    </tr>
    <tr>
      <th>319</th>
      <td>1407</td>
      <td>-71.65</td>
      <td>19.05</td>
      <td>-71.65W_19.05N</td>
      <td>POLYGON ((-71.70000 19.10000, -71.60000 19.100...</td>
      <td>8.505580</td>
      <td>6.437821</td>
    </tr>
    <tr>
      <th>320</th>
      <td>1414</td>
      <td>-71.65</td>
      <td>18.35</td>
      <td>-71.65W_18.35N</td>
      <td>POLYGON ((-71.70000 18.40000, -71.60000 18.400...</td>
      <td>15.723595</td>
      <td>10.298276</td>
    </tr>
  </tbody>
</table>
<p>321 rows × 7 columns</p>
</div>




```python
fig, ax = plt.subplots(1,1)
grid.plot(color='gray', alpha=0.4, ax=ax, label='No data')
gpd.GeoDataFrame(grid_slope_df.dropna(), geometry='geometry').plot(column='mean', legend=True, ax=ax)
plt.title('Slope [degree]')
plt.show()
```



![png](04.0.1_topography_variables_files/04.0.1_topography_variables_17_0.png)



### Mean altitude with raster


```python
summary_stats = zonal_stats(
    grid,
    altitude,
    stats=["mean"],
    nodata=-32768,
    all_touched=True,
    affine=merged_rast.transform,
)
grid_elev = pd.DataFrame(summary_stats)
grid_elev_df = pd.concat([grid, grid_elev], axis=1)
grid_elev_df
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>id</th>
      <th>Longitude</th>
      <th>Latitude</th>
      <th>Centroid</th>
      <th>geometry</th>
      <th>mean</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>235</td>
      <td>-74.45</td>
      <td>18.65</td>
      <td>-74.45W_18.65N</td>
      <td>POLYGON ((-74.50000 18.70000, -74.40000 18.700...</td>
      <td>2.458353</td>
    </tr>
    <tr>
      <th>1</th>
      <td>236</td>
      <td>-74.45</td>
      <td>18.55</td>
      <td>-74.45W_18.55N</td>
      <td>POLYGON ((-74.50000 18.60000, -74.40000 18.600...</td>
      <td>25.429616</td>
    </tr>
    <tr>
      <th>2</th>
      <td>237</td>
      <td>-74.45</td>
      <td>18.45</td>
      <td>-74.45W_18.45N</td>
      <td>POLYGON ((-74.50000 18.50000, -74.40000 18.500...</td>
      <td>99.760399</td>
    </tr>
    <tr>
      <th>3</th>
      <td>238</td>
      <td>-74.45</td>
      <td>18.35</td>
      <td>-74.45W_18.35N</td>
      <td>POLYGON ((-74.50000 18.40000, -74.40000 18.400...</td>
      <td>86.746204</td>
    </tr>
    <tr>
      <th>4</th>
      <td>277</td>
      <td>-74.35</td>
      <td>18.65</td>
      <td>-74.35W_18.65N</td>
      <td>POLYGON ((-74.40000 18.70000, -74.30000 18.700...</td>
      <td>43.631425</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>316</th>
      <td>1404</td>
      <td>-71.65</td>
      <td>19.35</td>
      <td>-71.65W_19.35N</td>
      <td>POLYGON ((-71.70000 19.40000, -71.60000 19.400...</td>
      <td>540.872929</td>
    </tr>
    <tr>
      <th>317</th>
      <td>1405</td>
      <td>-71.65</td>
      <td>19.25</td>
      <td>-71.65W_19.25N</td>
      <td>POLYGON ((-71.70000 19.30000, -71.60000 19.300...</td>
      <td>559.283523</td>
    </tr>
    <tr>
      <th>318</th>
      <td>1406</td>
      <td>-71.65</td>
      <td>19.15</td>
      <td>-71.65W_19.15N</td>
      <td>POLYGON ((-71.70000 19.20000, -71.60000 19.200...</td>
      <td>568.632999</td>
    </tr>
    <tr>
      <th>319</th>
      <td>1407</td>
      <td>-71.65</td>
      <td>19.05</td>
      <td>-71.65W_19.05N</td>
      <td>POLYGON ((-71.70000 19.10000, -71.60000 19.100...</td>
      <td>403.397879</td>
    </tr>
    <tr>
      <th>320</th>
      <td>1414</td>
      <td>-71.65</td>
      <td>18.35</td>
      <td>-71.65W_18.35N</td>
      <td>POLYGON ((-71.70000 18.40000, -71.60000 18.400...</td>
      <td>605.905587</td>
    </tr>
  </tbody>
</table>
<p>321 rows × 6 columns</p>
</div>




```python
fig, ax = plt.subplots(1,1)
grid.plot(color='gray', alpha=0.4, ax=ax, label='No data')
gpd.GeoDataFrame(grid_elev_df.dropna(), geometry='geometry').plot(column='mean', legend=True, ax=ax, label='Altitude')
plt.title('Altitude [m]')
plt.show()
```



![png](04.0.1_topography_variables_files/04.0.1_topography_variables_20_0.png)



Merge altitude and slope data


```python
df_slope = grid_slope_df.fillna(0).rename({'mean':'mean_slope'}, axis=1)
df_elev = grid_elev_df.fillna(0).rename({'mean':'mean_elev'}, axis=1)
df_slope_elev = df_slope.merge(df_elev, on='id')[['id', 'mean_elev', 'mean_slope']]
```

## With coast and Coast length


```python
# dissolving polygons into one land mass
dissolved_shp = shp.dissolve(by="ADM0_PCODE")

# Coastline
coastline = dissolved_shp.boundary
coastline.plot()
plt.show()
```



![png](04.0.1_topography_variables_files/04.0.1_topography_variables_24_0.png)




```python
coastline.crs = grid.crs
coastline
```




    ADM0_PCODE
    HT    MULTILINESTRING ((-73.83383 18.09714, -73.8333...
    dtype: geometry




```python
# Linestrings and MultiLinestrings
grid_line_gdf = gpd.overlay(gpd.GeoDataFrame(coastline, geometry=coastline.geometry, crs=coastline.crs)
                .reset_index(),
                grid,
                how="intersection",
                )[["id", "Centroid", "geometry"]]
# Coast line
grid_line_gdf["coast_length"] = grid_line_gdf["geometry"].to_crs(25394).length #25394 gives me length in meters.
grid_coast = grid[["id", "Centroid"]].merge(grid_line_gdf, on=["id", "Centroid"], how="left")

# With coast? Binary
grid_coast["with_coast"] = np.where(grid_coast["coast_length"] > 0, 1, 0)
grid_coast["with_coast"].value_counts()
```




    with_coast
    1    174
    0    147
    Name: count, dtype: int64




```python
fig, ax = plt.subplots(1,2, figsize=(10,6))
ax[0] = grid_coast.with_coast.hist(ax=ax[0])
ax[0].set_xticks([0.05,0.95], ['No coast', 'With coast'])
ax[0].set_ylabel('Frequency')
ax[0].set_title('Grids with coasts')
ax[0].grid('off')

ax[1] = grid_coast.coast_length.fillna(0).hist(ax=ax[1])
ax[1].set_xlabel('Coast length [m]')
ax[1].set_ylabel('Frequency')
ax[1].set_title('Coast length per grid')


plt.tight_layout()
plt.show()
```



![png](04.0.1_topography_variables_files/04.0.1_topography_variables_27_0.png)



## Save it


```python
# Merge data
merge_final = df_slope_elev.merge(grid_coast, on='id', how='left')
merge_final = merge_final[['id','with_coast','coast_length','mean_elev','mean_slope']]
merge_final = merge_final.fillna(0) # No coast length? Then is 0
```


```python
merge_final
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>id</th>
      <th>with_coast</th>
      <th>coast_length</th>
      <th>mean_elev</th>
      <th>mean_slope</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>235</td>
      <td>1</td>
      <td>6394.768385</td>
      <td>2.458353</td>
      <td>0.366521</td>
    </tr>
    <tr>
      <th>1</th>
      <td>236</td>
      <td>1</td>
      <td>15727.884373</td>
      <td>25.429616</td>
      <td>3.642291</td>
    </tr>
    <tr>
      <th>2</th>
      <td>237</td>
      <td>1</td>
      <td>19788.911470</td>
      <td>99.760399</td>
      <td>9.420513</td>
    </tr>
    <tr>
      <th>3</th>
      <td>238</td>
      <td>1</td>
      <td>13223.504976</td>
      <td>86.746204</td>
      <td>6.070587</td>
    </tr>
    <tr>
      <th>4</th>
      <td>277</td>
      <td>1</td>
      <td>18328.466435</td>
      <td>43.631425</td>
      <td>5.445702</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>316</th>
      <td>1404</td>
      <td>1</td>
      <td>5967.621022</td>
      <td>540.872929</td>
      <td>11.052654</td>
    </tr>
    <tr>
      <th>317</th>
      <td>1405</td>
      <td>1</td>
      <td>18059.469831</td>
      <td>559.283523</td>
      <td>11.990623</td>
    </tr>
    <tr>
      <th>318</th>
      <td>1406</td>
      <td>1</td>
      <td>30432.164296</td>
      <td>568.632999</td>
      <td>17.760025</td>
    </tr>
    <tr>
      <th>319</th>
      <td>1407</td>
      <td>1</td>
      <td>1418.522750</td>
      <td>403.397879</td>
      <td>8.505580</td>
    </tr>
    <tr>
      <th>320</th>
      <td>1414</td>
      <td>1</td>
      <td>1593.112998</td>
      <td>605.905587</td>
      <td>15.723595</td>
    </tr>
  </tbody>
</table>
<p>321 rows × 5 columns</p>
</div>




```python
merge_final.to_csv(output_dir / "topography_variables_bygrid.csv", index=False)
```
