# Notebook that downloads GPM rainfall data done per typhoon


```python
import getpass
import os
from pathlib import Path

import pandas as pd
import datetime as dt
from bs4 import BeautifulSoup
import requests
import time
```


```python
#data_dir = '/home/fmoss/data'
# Setting directories
input_dir = (
    Path(os.getenv("STORM_DATA_DIR"))
    #Path(data_dir)
    / "analysis_hti/02_model_features/03_rainfall/input"
)
# Setting path to save the GPM data
gpm_file_name = "gpm_data/rainfall_data/output_hhr/"
gpm_folder_path = Path(input_dir, gpm_file_name)
```


```python
# To create an account for downloading the data
# follow the instructions here: https://registration.pps.eosdis.nasa.gov/registration/
# Change the user name and provide the password in the code
# Normally, is just the passwords and the user is just the email that you registered.
USERNAME =  getpass.getpass(prompt="Username: ", stream=None)
PASSWORD = getpass.getpass(prompt="Password: ", stream=None)

# Setting the number of days prior to the landfall data for which to collect data
DAYS_TO_LANDFALL = 2
```


```python
# Load and clean the typhoon metadata
# We really only care about the landfall date
typhoon_metadata = pd.read_csv(input_dir / "metadata_typhoons.csv").set_index(
    "typhoon"
)
for colname in ["startdate", "enddate", "landfalldate"]:
    typhoon_metadata[colname] = pd.to_datetime(
        typhoon_metadata[colname], format="%Y-%m-%d"
    )
typhoon_metadata
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>startdate</th>
      <th>enddate</th>
      <th>landfalldate</th>
      <th>landfall_time</th>
      <th>affected_pop</th>
    </tr>
    <tr>
      <th>typhoon</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>LILI2002</th>
      <td>2002-09-21</td>
      <td>2002-10-04</td>
      <td>2002-09-28</td>
      <td>12:00:00</td>
      <td>True</td>
    </tr>
    <tr>
      <th>MINDY2003</th>
      <td>2003-10-10</td>
      <td>2003-10-14</td>
      <td>2003-10-11</td>
      <td>07:00:00</td>
      <td>False</td>
    </tr>
    <tr>
      <th>IVAN2004</th>
      <td>2004-09-02</td>
      <td>2004-09-24</td>
      <td>2004-09-10</td>
      <td>13:00:00</td>
      <td>True</td>
    </tr>
    <tr>
      <th>JEANNE2004</th>
      <td>2004-09-13</td>
      <td>2004-09-29</td>
      <td>2004-09-17</td>
      <td>18:00:00</td>
      <td>True</td>
    </tr>
    <tr>
      <th>ALPHA2005</th>
      <td>2005-10-22</td>
      <td>2005-10-24</td>
      <td>2005-10-23</td>
      <td>11:20:00</td>
      <td>True</td>
    </tr>
    <tr>
      <th>DENNIS2005</th>
      <td>2005-07-04</td>
      <td>2005-07-18</td>
      <td>2005-07-07</td>
      <td>12:00:00</td>
      <td>True</td>
    </tr>
    <tr>
      <th>EMILY2005</th>
      <td>2005-07-11</td>
      <td>2005-07-21</td>
      <td>2005-07-16</td>
      <td>05:00:00</td>
      <td>True</td>
    </tr>
    <tr>
      <th>FRANKLIN2005</th>
      <td>2005-07-21</td>
      <td>2005-07-31</td>
      <td>2005-07-21</td>
      <td>18:00:00</td>
      <td>False</td>
    </tr>
    <tr>
      <th>KATRINA2005</th>
      <td>2005-08-23</td>
      <td>2005-08-31</td>
      <td>2005-08-23</td>
      <td>18:00:00</td>
      <td>False</td>
    </tr>
    <tr>
      <th>RITA2005</th>
      <td>2005-09-18</td>
      <td>2005-09-26</td>
      <td>2005-09-18</td>
      <td>08:00:00</td>
      <td>False</td>
    </tr>
    <tr>
      <th>STAN2005</th>
      <td>2005-10-01</td>
      <td>2005-10-05</td>
      <td>2005-10-01</td>
      <td>12:00:00</td>
      <td>True</td>
    </tr>
    <tr>
      <th>WILMA2005</th>
      <td>2005-10-15</td>
      <td>2005-10-26</td>
      <td>2005-10-15</td>
      <td>18:00:00</td>
      <td>False</td>
    </tr>
    <tr>
      <th>ERNESTO2006</th>
      <td>2006-08-24</td>
      <td>2006-09-04</td>
      <td>2006-08-27</td>
      <td>23:00:00</td>
      <td>True</td>
    </tr>
    <tr>
      <th>DEAN2007</th>
      <td>2007-08-13</td>
      <td>2007-08-23</td>
      <td>2007-08-19</td>
      <td>12:00:00</td>
      <td>True</td>
    </tr>
    <tr>
      <th>NOEL2007</th>
      <td>2007-10-24</td>
      <td>2007-11-06</td>
      <td>2007-10-29</td>
      <td>08:20:00</td>
      <td>True</td>
    </tr>
    <tr>
      <th>OLGA2007</th>
      <td>2007-12-10</td>
      <td>2007-12-16</td>
      <td>2007-12-12</td>
      <td>06:00:00</td>
      <td>True</td>
    </tr>
    <tr>
      <th>GUSTAV2008</th>
      <td>2008-08-25</td>
      <td>2008-09-05</td>
      <td>2008-08-26</td>
      <td>19:00:00</td>
      <td>True</td>
    </tr>
    <tr>
      <th>HANNA2008</th>
      <td>2008-08-28</td>
      <td>2008-09-08</td>
      <td>2008-09-03</td>
      <td>03:00:00</td>
      <td>True</td>
    </tr>
    <tr>
      <th>IKE2008</th>
      <td>2008-09-01</td>
      <td>2008-09-15</td>
      <td>2008-09-07</td>
      <td>12:00:00</td>
      <td>True</td>
    </tr>
    <tr>
      <th>KYLE2008</th>
      <td>2008-09-25</td>
      <td>2008-09-30</td>
      <td>2008-09-25</td>
      <td>00:00:00</td>
      <td>False</td>
    </tr>
    <tr>
      <th>OMAR2008</th>
      <td>2008-10-13</td>
      <td>2008-10-21</td>
      <td>2008-10-13</td>
      <td>12:00:00</td>
      <td>False</td>
    </tr>
    <tr>
      <th>DANNY2009</th>
      <td>2009-08-26</td>
      <td>2009-08-29</td>
      <td>2009-08-26</td>
      <td>09:00:00</td>
      <td>False</td>
    </tr>
    <tr>
      <th>BONNIE2010</th>
      <td>2010-07-22</td>
      <td>2010-07-25</td>
      <td>2010-07-22</td>
      <td>06:00:00</td>
      <td>False</td>
    </tr>
    <tr>
      <th>KARL2010</th>
      <td>2010-09-13</td>
      <td>2010-09-18</td>
      <td>2010-09-13</td>
      <td>18:00:00</td>
      <td>False</td>
    </tr>
    <tr>
      <th>MATTHEW2010</th>
      <td>2010-09-23</td>
      <td>2010-09-26</td>
      <td>2010-09-23</td>
      <td>12:00:00</td>
      <td>False</td>
    </tr>
    <tr>
      <th>OTTO2010</th>
      <td>2010-10-06</td>
      <td>2010-10-17</td>
      <td>2010-10-06</td>
      <td>15:00:00</td>
      <td>False</td>
    </tr>
    <tr>
      <th>TOMAS2010</th>
      <td>2010-10-29</td>
      <td>2010-11-10</td>
      <td>2010-11-05</td>
      <td>21:00:00</td>
      <td>True</td>
    </tr>
    <tr>
      <th>IRENE2011</th>
      <td>2011-08-21</td>
      <td>2011-08-30</td>
      <td>2011-08-23</td>
      <td>19:00:00</td>
      <td>True</td>
    </tr>
    <tr>
      <th>ISAAC2012</th>
      <td>2012-08-20</td>
      <td>2012-09-01</td>
      <td>2012-08-25</td>
      <td>06:00:00</td>
      <td>True</td>
    </tr>
    <tr>
      <th>SANDY2012</th>
      <td>2012-10-21</td>
      <td>2012-10-31</td>
      <td>2012-10-25</td>
      <td>02:00:00</td>
      <td>True</td>
    </tr>
    <tr>
      <th>CRISTOBAL2014</th>
      <td>2014-08-23</td>
      <td>2014-09-02</td>
      <td>2014-08-23</td>
      <td>18:00:00</td>
      <td>False</td>
    </tr>
    <tr>
      <th>ERIKA2015</th>
      <td>2015-08-24</td>
      <td>2015-08-28</td>
      <td>2015-08-28</td>
      <td>12:00:00</td>
      <td>True</td>
    </tr>
    <tr>
      <th>KATE2015</th>
      <td>2015-11-08</td>
      <td>2015-11-13</td>
      <td>2015-11-08</td>
      <td>18:00:00</td>
      <td>False</td>
    </tr>
    <tr>
      <th>EARL2016</th>
      <td>2016-08-02</td>
      <td>2016-08-06</td>
      <td>2016-08-02</td>
      <td>06:00:00</td>
      <td>False</td>
    </tr>
    <tr>
      <th>MATTHEW2016</th>
      <td>2016-09-28</td>
      <td>2016-10-10</td>
      <td>2016-10-04</td>
      <td>11:00:00</td>
      <td>True</td>
    </tr>
    <tr>
      <th>GERT2017</th>
      <td>2017-08-12</td>
      <td>2017-08-18</td>
      <td>2017-08-12</td>
      <td>12:00:00</td>
      <td>False</td>
    </tr>
    <tr>
      <th>IRMA2017</th>
      <td>2017-08-30</td>
      <td>2017-09-13</td>
      <td>2017-09-08</td>
      <td>02:00:00</td>
      <td>True</td>
    </tr>
    <tr>
      <th>GORDON2018</th>
      <td>2018-09-02</td>
      <td>2018-09-07</td>
      <td>2018-09-02</td>
      <td>18:00:00</td>
      <td>False</td>
    </tr>
    <tr>
      <th>HUMBERTO2019</th>
      <td>2019-09-12</td>
      <td>2019-09-20</td>
      <td>2019-09-12</td>
      <td>12:00:00</td>
      <td>False</td>
    </tr>
    <tr>
      <th>DELTA2020</th>
      <td>2020-10-04</td>
      <td>2020-10-11</td>
      <td>2020-10-04</td>
      <td>18:00:00</td>
      <td>False</td>
    </tr>
    <tr>
      <th>ETA2020</th>
      <td>2020-10-31</td>
      <td>2020-11-14</td>
      <td>2020-11-01</td>
      <td>01:00:00</td>
      <td>False</td>
    </tr>
    <tr>
      <th>IOTA2020</th>
      <td>2020-11-12</td>
      <td>2020-11-18</td>
      <td>2020-11-12</td>
      <td>14:00:00</td>
      <td>False</td>
    </tr>
    <tr>
      <th>LAURA2020</th>
      <td>2020-08-20</td>
      <td>2020-08-29</td>
      <td>2020-08-23</td>
      <td>11:00:00</td>
      <td>True</td>
    </tr>
    <tr>
      <th>NANA2020</th>
      <td>2020-09-01</td>
      <td>2020-09-04</td>
      <td>2020-09-01</td>
      <td>06:00:00</td>
      <td>False</td>
    </tr>
    <tr>
      <th>ELSA2021</th>
      <td>2021-06-30</td>
      <td>2021-07-10</td>
      <td>2021-07-03</td>
      <td>23:00:00</td>
      <td>True</td>
    </tr>
    <tr>
      <th>IDA2021</th>
      <td>2021-08-26</td>
      <td>2021-09-04</td>
      <td>2021-08-26</td>
      <td>12:00:00</td>
      <td>False</td>
    </tr>
    <tr>
      <th>LISA2022</th>
      <td>2022-10-30</td>
      <td>2022-11-05</td>
      <td>2022-10-30</td>
      <td>21:00:00</td>
      <td>False</td>
    </tr>
    <tr>
      <th>NICOLE2022</th>
      <td>2022-11-06</td>
      <td>2022-11-11</td>
      <td>2022-11-06</td>
      <td>12:00:00</td>
      <td>False</td>
    </tr>
  </tbody>
</table>
</div>




```python
# Soft events
typhoon_metadata_nodmg = typhoon_metadata[typhoon_metadata.affected_pop == False]
```


```python
#%% Functions used
def list_files(url):
    page = requests.get(url, auth=(USERNAME, PASSWORD)).text
    soup = BeautifulSoup(page, "html.parser")
    return [
        url + "/" + node.get("href")
        for node in soup.find_all("a")
        if node.get("href").endswith("tif")
    ]


def download_gpm_http(start_date, end_date, download_path):
    base_url = "https://arthurhouhttps.pps.eosdis.nasa.gov/pub/gpmdata"

    date_list = pd.date_range(start_date, end_date)
    file_list = []

    for date in date_list:
        #print(f"Downloading data for date {date}")
        day_path = download_path / date.strftime("%Y%m%d")
        day_path.mkdir(parents=True, exist_ok=True)

        url = f"{base_url}/{date.strftime('%Y/%m/%d')}/gis"
        tiff_files = list_files(url=url)

        for tiff_file in tiff_files:
            file_name = tiff_file.split("/")[-1]

            file_path = day_path / file_name
            file_list.append(file_path)
            r = requests.get(tiff_file, auth=(USERNAME, USERNAME))
            time.sleep(0.2)
            open(file_path, "wb").write(r.content)

    return file_list
```


```python
len(list_files('https://arthurhouhttps.pps.eosdis.nasa.gov/pub/gpmdata/2023/01/01/gis/'))
```




    50



## Download the data

This section is for downloading the data.
It takes a long time to complete.


```python
i=2 # Sometimes if there's a problem, just identify the typhoon number and start downloading again from that.

# Download just nodmg data
for typhoon, metadata in typhoon_metadata_nodmg[i:].iterrows():
    start_date = metadata["landfalldate"] - dt.timedelta(days=DAYS_TO_LANDFALL)
    end_date = metadata["landfalldate"] + dt.timedelta(days=DAYS_TO_LANDFALL)
    print('Typhoon {}/{}'.format(i, len(typhoon_metadata_nodmg)-1));i+=1
    print(f"Downloading data for {typhoon} between {start_date} and {end_date}")
    download_gpm_http(start_date=start_date,
                    end_date=end_date,
                    download_path=gpm_folder_path / typhoon / "GPM")
```
