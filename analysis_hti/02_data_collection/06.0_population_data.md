```python
import pandas as pd
import geopandas as gpd
import numpy as np
from pathlib import Path
import os
import requests, zipfile, io
import rasterio
#import rioxarray as rxr
from shapely.geometry import Polygon
import matplotlib.pyplot as plt
from rasterstats import zonal_stats
from scipy.stats import linregress
```


```python
base_dir = Path(os.getenv("STORM_DATA_DIR")) / "analysis_hti/02_model_features/"
input_dir = base_dir / "06_settlement/input/"
os.makedirs(input_dir, exist_ok=True)
shp_input_dir = base_dir / "02_housing_damage/input/"
grid_input_dir = base_dir / "02_housing_damage/output/"
output_dir = base_dir / "06_settlement/output/"
os.makedirs(output_dir, exist_ok=True)
```


```python
# Load Shapefile
shp = gpd.read_file(
    shp_input_dir / "shapefile_hti_fixed.gpkg"
)
shp = shp.to_crs('EPSG:4326')

# Load grid
grid = gpd.read_file(grid_input_dir / "hti_0.1_degree_grid_land_overlap.gpkg")

# Load ids of municipalities
ids_mun = pd.read_csv(base_dir / "02_housing_damage/input/grid_municipality_info.csv")
ids_mun.ADM1_EN = ids_mun.ADM1_EN.str.upper()

# Load damage
df_housing = pd.read_csv(shp_input_dir / "impact_data_clean_hti.csv")
```

## Population distribution (from Meta)

### Analysis


```python
# Open folder with data
file_list = os.listdir(input_dir / "population_hti_2018-10-01")
if '.DS_Store' in file_list:
    file_list.remove('.DS_Store')
file_list
```




    ['population_hti_2018-10-01.tif', 'population_hti_2018-10-01.tif.aux.xml']




```python
pop_raster = rasterio.open(input_dir / "population_hti_2018-10-01" / file_list[0])
pop = pop_raster.read(1)
```


```python
pop_rast_path = input_dir / "population_hti_2018-10-01" / file_list[0]
!gdalinfo \
"{pop_rast_path}"
```

    Driver: GTiff/GeoTIFF
    Files: /Users/federico/Documents/data/analysis_hti/02_model_features/06_settlement/input/population_hti_2018-10-01/population_hti_2018-10-01.tif
           /Users/federico/Documents/data/analysis_hti/02_model_features/06_settlement/input/population_hti_2018-10-01/population_hti_2018-10-01.tif.aux.xml
    Size is 10240, 7488
    Coordinate System is:
    GEOGCRS["WGS 84",
        DATUM["World Geodetic System 1984",
            ELLIPSOID["WGS 84",6378137,298.257223563,
                LENGTHUNIT["metre",1]]],
        PRIMEM["Greenwich",0,
            ANGLEUNIT["degree",0.0174532925199433]],
        CS[ellipsoidal,2],
            AXIS["geodetic latitude (Lat)",north,
                ORDER[1],
                ANGLEUNIT["degree",0.0174532925199433]],
            AXIS["geodetic longitude (Lon)",east,
                ORDER[2],
                ANGLEUNIT["degree",0.0174532925199433]],
        USAGE[
            SCOPE["unknown"],
            AREA["World"],
            BBOX[-90,-180,90,180]],
        ID["EPSG",4326]]
    Data axis to CRS axis mapping: 2,1
    Origin = (-74.475694444444429,20.094027777777775)
    Pixel Size = (0.000277777777778,-0.000277777777778)
    Metadata:
      AREA_OR_POINT=Area
    Image Structure Metadata:
      COMPRESSION=DEFLATE
      INTERLEAVE=BAND
    Corner Coordinates:
    Upper Left  ( -74.4756944,  20.0940278) ( 74d28'32.50"W, 20d 5'38.50"N)
    Lower Left  ( -74.4756944,  18.0140278) ( 74d28'32.50"W, 18d 0'50.50"N)
    Upper Right ( -71.6312500,  20.0940278) ( 71d37'52.50"W, 20d 5'38.50"N)
    Lower Right ( -71.6312500,  18.0140278) ( 71d37'52.50"W, 18d 0'50.50"N)
    Center      ( -73.0534722,  19.0540278) ( 73d 3'12.50"W, 19d 3'14.50"N)
    Band 1 Block=256x256 Type=Float64, ColorInterp=Gray
      Description = Population Count
      Min=0.370 Max=582.544
      Minimum=0.370, Maximum=582.544, Mean=20.564, StdDev=23.969
      NoData Value=nan
      Overviews: 5120x3744, 2560x1872, 1280x936, 640x468, 320x234, 160x117
      Metadata:
        STATISTICS_MAXIMUM=582.54408711807
        STATISTICS_MEAN=20.564231840868
        STATISTICS_MINIMUM=0.37007187574502
        STATISTICS_STDDEV=23.969091624516



```python
summary_stats = zonal_stats(
    grid,
    pop,
    stats=["sum"],
    nodata=-9999,
    all_touched=True,
    affine=pop_raster.transform,
)
grid_pop = pd.DataFrame(summary_stats)
grid_pop_df = pd.concat([grid, grid_pop], axis=1)
grid_pop_df
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>id</th>
      <th>Longitude</th>
      <th>Latitude</th>
      <th>Centroid</th>
      <th>geometry</th>
      <th>sum</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>235</td>
      <td>-74.45</td>
      <td>18.65</td>
      <td>-74.45W_18.65N</td>
      <td>POLYGON ((-74.50000 18.70000, -74.40000 18.700...</td>
      <td>1109.201168</td>
    </tr>
    <tr>
      <th>1</th>
      <td>236</td>
      <td>-74.45</td>
      <td>18.55</td>
      <td>-74.45W_18.55N</td>
      <td>POLYGON ((-74.50000 18.60000, -74.40000 18.600...</td>
      <td>16504.608117</td>
    </tr>
    <tr>
      <th>2</th>
      <td>237</td>
      <td>-74.45</td>
      <td>18.45</td>
      <td>-74.45W_18.45N</td>
      <td>POLYGON ((-74.50000 18.50000, -74.40000 18.500...</td>
      <td>39679.440375</td>
    </tr>
    <tr>
      <th>3</th>
      <td>238</td>
      <td>-74.45</td>
      <td>18.35</td>
      <td>-74.45W_18.35N</td>
      <td>POLYGON ((-74.50000 18.40000, -74.40000 18.400...</td>
      <td>5727.293678</td>
    </tr>
    <tr>
      <th>4</th>
      <td>277</td>
      <td>-74.35</td>
      <td>18.65</td>
      <td>-74.35W_18.65N</td>
      <td>POLYGON ((-74.40000 18.70000, -74.30000 18.700...</td>
      <td>18525.900088</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>316</th>
      <td>1404</td>
      <td>-71.65</td>
      <td>19.35</td>
      <td>-71.65W_19.35N</td>
      <td>POLYGON ((-71.70000 19.40000, -71.60000 19.400...</td>
      <td>194.144117</td>
    </tr>
    <tr>
      <th>317</th>
      <td>1405</td>
      <td>-71.65</td>
      <td>19.25</td>
      <td>-71.65W_19.25N</td>
      <td>POLYGON ((-71.70000 19.30000, -71.60000 19.300...</td>
      <td>7627.784643</td>
    </tr>
    <tr>
      <th>318</th>
      <td>1406</td>
      <td>-71.65</td>
      <td>19.15</td>
      <td>-71.65W_19.15N</td>
      <td>POLYGON ((-71.70000 19.20000, -71.60000 19.200...</td>
      <td>5460.503320</td>
    </tr>
    <tr>
      <th>319</th>
      <td>1407</td>
      <td>-71.65</td>
      <td>19.05</td>
      <td>-71.65W_19.05N</td>
      <td>POLYGON ((-71.70000 19.10000, -71.60000 19.100...</td>
      <td>174.584285</td>
    </tr>
    <tr>
      <th>320</th>
      <td>1414</td>
      <td>-71.65</td>
      <td>18.35</td>
      <td>-71.65W_18.35N</td>
      <td>POLYGON ((-71.70000 18.40000, -71.60000 18.400...</td>
      <td>58.496463</td>
    </tr>
  </tbody>
</table>
<p>321 rows × 6 columns</p>
</div>



Let's check


```python
print('People: ', np.round(grid_pop_df['sum'].sum()))
```

    People:  10764094.0


Makes total sense according to google

### Some plots


```python
pop_df_fix = grid_pop_df.fillna(0)
pop_df_fix = pop_df_fix.rename({'sum':'total_pop'}, axis=1)
```


```python
# Plot per grid
# Define the bins and labels
bins = [-float('inf'), 1, 10, 100, 500, 1000, 5000, 10000, 100000, float('inf')]
labels = [0, 1, 2, 3, 4, 5, 6, 7, 8]

# Create the new column using pd.cut
pop_df_fix['num_cat'] = pd.cut(pop_df_fix['total_pop'], bins=bins, labels=labels, include_lowest=True)
gpd_pop_df = gpd.GeoDataFrame(pop_df_fix, geometry='geometry')
```


```python
# Plot the GeoDataFrame
fig, ax = plt.subplots(1,1, figsize=(8, 5))
gpd_pop_df.plot(column='num_cat', cmap='Reds', legend=True, ax=ax, legend_kwds={'title': 'Population by grid'})

# Customize the legend labels
legend_labels = {
    0: '0',
    1: '1 - 10',
    2: '10 - 100',
    3: '100 - 500',
    4: '500 - 1000',
    5: '1000 - 5000',
    6: '5000 - 10000',
    7: '10000 - 100000',
    8: '> 100000'
}

# Get the current legend
legend = ax.get_legend()

# Customize the legend labels using legend_labels dictionary
for key, label in legend_labels.items():
    legend.get_texts()[key].set_text(label)

# Display the map
plt.show()
```



![png](06.0_population_data_files/06.0_population_data_15_0.png)




```python
# Plot the GeoDataFrame
fig, ax = plt.subplots(1,1, figsize=(5, 5))
gpd_pop_df.plot(column='total_pop', cmap='Reds', legend=True, ax=ax)

ax.set_title('Population by grid')
plt.show()

```



![png](06.0_population_data_files/06.0_population_data_16_0.png)



## Google open buildings


```python
google_bld = pd.read_csv(shp_input_dir / "hti_google_bld_grid_count.csv")
```


```python
df_merge = pop_df_fix.merge(google_bld, on='id')
df_merge['people/bld'] = df_merge['total_pop'] / df_merge['count']
```


```python
df_merge.sort_values('people/bld', ascending=False)
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>id</th>
      <th>Longitude</th>
      <th>Latitude</th>
      <th>Centroid</th>
      <th>geometry</th>
      <th>total_pop</th>
      <th>count</th>
      <th>people/bld</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>110</th>
      <td>864</td>
      <td>-72.95</td>
      <td>18.75</td>
      <td>-72.95W_18.75N</td>
      <td>POLYGON ((-73.00000 18.80000, -72.90000 18.800...</td>
      <td>28626.960272</td>
      <td>3195.0</td>
      <td>8.959925</td>
    </tr>
    <tr>
      <th>123</th>
      <td>905</td>
      <td>-72.85</td>
      <td>18.85</td>
      <td>-72.85W_18.85N</td>
      <td>POLYGON ((-72.90000 18.90000, -72.80000 18.900...</td>
      <td>70895.150420</td>
      <td>8805.0</td>
      <td>8.051692</td>
    </tr>
    <tr>
      <th>8</th>
      <td>281</td>
      <td>-74.35</td>
      <td>18.25</td>
      <td>-74.35W_18.25N</td>
      <td>POLYGON ((-74.40000 18.30000, -74.30000 18.300...</td>
      <td>3000.026052</td>
      <td>389.0</td>
      <td>7.712149</td>
    </tr>
    <tr>
      <th>120</th>
      <td>898</td>
      <td>-72.85</td>
      <td>19.55</td>
      <td>-72.85W_19.55N</td>
      <td>POLYGON ((-72.90000 19.60000, -72.80000 19.600...</td>
      <td>12111.467613</td>
      <td>1772.0</td>
      <td>6.834914</td>
    </tr>
    <tr>
      <th>126</th>
      <td>909</td>
      <td>-72.85</td>
      <td>18.45</td>
      <td>-72.85W_18.45N</td>
      <td>POLYGON ((-72.90000 18.50000, -72.80000 18.500...</td>
      <td>145494.616979</td>
      <td>21489.0</td>
      <td>6.770656</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>45</th>
      <td>571</td>
      <td>-73.65</td>
      <td>18.65</td>
      <td>-73.65W_18.65N</td>
      <td>POLYGON ((-73.70000 18.70000, -73.60000 18.700...</td>
      <td>0.000000</td>
      <td>0.0</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>67</th>
      <td>694</td>
      <td>-73.35</td>
      <td>18.95</td>
      <td>-73.35W_18.95N</td>
      <td>POLYGON ((-73.40000 19.00000, -73.30000 19.000...</td>
      <td>0.000000</td>
      <td>0.0</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>121</th>
      <td>899</td>
      <td>-72.85</td>
      <td>19.45</td>
      <td>-72.85W_19.45N</td>
      <td>POLYGON ((-72.90000 19.50000, -72.80000 19.500...</td>
      <td>0.000000</td>
      <td>0.0</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>142</th>
      <td>948</td>
      <td>-72.75</td>
      <td>18.75</td>
      <td>-72.75W_18.75N</td>
      <td>POLYGON ((-72.80000 18.80000, -72.70000 18.800...</td>
      <td>0.000000</td>
      <td>0.0</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>297</th>
      <td>1333</td>
      <td>-71.85</td>
      <td>18.05</td>
      <td>-71.85W_18.05N</td>
      <td>POLYGON ((-71.90000 18.10000, -71.80000 18.100...</td>
      <td>0.000000</td>
      <td>0.0</td>
      <td>NaN</td>
    </tr>
  </tbody>
</table>
<p>321 rows × 8 columns</p>
</div>




```python
# Total bld at adm0
df_merge['count'].sum()
```




    4034248.0




```python
# Plot the GeoDataFrame
fig, ax = plt.subplots(1,1, figsize=(5, 5))
df_merge.plot(column='count', cmap='Reds', legend=True, ax=ax)

ax.set_title('Number of buildings')
plt.show()
```



![png](06.0_population_data_files/06.0_population_data_22_0.png)




```python
# Plot the GeoDataFrame
fig, ax = plt.subplots(1,1, figsize=(5, 5))
df_merge.plot(column='people/bld', cmap='Reds', legend=True, ax=ax)

ax.set_title('Population density \n[people/building]')
plt.show()
```



![png](06.0_population_data_files/06.0_population_data_23_0.png)




```python
# Plotting the data points
plt.plot(df_merge.total_pop, df_merge['count'], 'o', label='Data')

# Performing linear regression
slope, intercept, _, _, _ = linregress(df_merge.total_pop, df_merge['count'])

# Calculating the regression line
regression_line = intercept + slope * df_merge.total_pop

# Plotting the regression line
plt.plot(df_merge.total_pop, regression_line, 'r', label=f'Linear fit: y = {slope:.2f}x + {intercept:.2f}')

# Adding labels and legend
plt.xlabel('Population')
plt.ylabel('Buildings')
plt.grid()
plt.legend()
plt.title('Population and Buildings, HAITI')
plt.show()

```



![png](06.0_population_data_files/06.0_population_data_24_0.png)



The same but at adm1 and adm2 level


```python
# ADMIN1
df_merge_adm1 = df_merge.merge(ids_mun,
                               left_on='id', right_on='id')[
                                   ['count', 'total_pop', 'ADM1_PCODE']
                                   ].groupby('ADM1_PCODE').sum().reset_index(drop=False)
df_merge_adm1['people/bld'] = df_merge_adm1['total_pop'] / df_merge_adm1['count']

#ADMIN2
df_merge_adm2 = df_merge.merge(ids_mun,
                               left_on='id', right_on='id')[
                                   ['count', 'total_pop', 'ADM2_PCODE']
                                   ].groupby('ADM2_PCODE').sum().reset_index(drop=False)
df_merge_adm2['people/bld'] = df_merge_adm2['total_pop'] / df_merge_adm2['count']
```


```python
fig, ax  = plt.subplots(1,2, figsize=(10,5))
ax[0].plot(df_merge_adm1['total_pop'], df_merge_adm1['count'], 'o')

# Performing linear regression
slope, intercept, _, _, _ = linregress(df_merge_adm1.total_pop, df_merge_adm1['count'])
# Calculating the regression line
regression_line = intercept + slope * df_merge_adm1.total_pop
# Plotting the regression line
ax[0].plot(df_merge_adm1.total_pop, regression_line, 'r', label=f'Linear fit: y = {slope:.2f}x + {intercept:.2f}')

ax[0].set_xlabel('Population')
ax[0].set_ylabel('Buildings')
ax[0].set_title('ADM1 regions')
ax[0].legend()

ax[1].plot(df_merge_adm2['total_pop'], df_merge_adm2['count'], 'o')

# Performing linear regression
slope, intercept, _, _, _ = linregress(df_merge_adm2.total_pop, df_merge_adm2['count'])
# Calculating the regression line
regression_line = intercept + slope * df_merge_adm2.total_pop
# Plotting the regression line
ax[1].plot(df_merge_adm2.total_pop, regression_line, 'r', label=f'Linear fit: y = {slope:.2f}x + {intercept:.2f}')

ax[1].set_xlabel('Population')
ax[1].set_ylabel('Buildings')
ax[1].set_title('ADM2 regions')
ax[1].legend()

plt.tight_layout()
plt.show()
```



![png](06.0_population_data_files/06.0_population_data_27_0.png)



## Building damage from population

### From Philippines


```python
# Create a dictionary with the data
data = {
    'Typhoon': ['Glenda (2014)', 'Luis (2014)', 'Mario (2014)', 'Amang (2015)', 'Dodong (2015)',
                'Ineng (2015)', 'Kabayan (2015)', 'Lando (2015)', 'Nona (2015)', 'Onyok (2015)',
                'Seniang (2015)', 'Ferdie (2016)', 'Karen (2016)', 'Lawin (2016)', 'Marce (2016)',
                'Domeng (2018)', 'Ompong (2018)', 'Rosita (2018)', 'Quiel (2019)', 'Tisoy (Kammuri) (2019)',
                'Ursula (2019)', 'Ambo (2020)', 'Pepito (2020)', 'Quinta (2020)', 'Rolly (Goni) (2020)',
                'Ulysses (Vamco) (2020)'],
    'Affected_Families': [1793513, 66222, 1253412, 58063, 3352, 128355, 13393, 745753, 666794, 5422,
                          307013, 9098, 60735, 631630, 6750, 44, 1622539, 262386, 1005, 1648650, 1716007,
                          268122, 13015, 404513, 1554857, 2494380],
    'Affected_People': [7680823, 310374, 5695685, 250014, 12696, 579923, 64996, 3185523, 3021008, 23500,
                        1415729, 33036, 276044, 2816616, 34073, 186, 6680416, 1108018, 3048, 6937924, 7177618,
                        1109443, 59829, 1748362, 6441919, 10311691],
    'Totally_Damaged_Houses': [191751,  388,  10814,  672,  56,  223,  184,  20250,
                                         145088,  10,  1728,  814,  1421,  45435,  12,  12,  32742,
                                          13481,  54,  183908,  145672,  16146,  12,  26623,  141548,
                                         57292]
}

# Create a DataFrame
df_phl = pd.DataFrame(data)
n_of_people_adm0 = 115.6 * 1e6 # From Google
n_of_bld_adm0 = 33466954 # From google open bld datasets
df_phl['Affected_People'] = df_phl['Affected_People'] / n_of_people_adm0
df_phl['Totally_Damaged_Houses'] = df_phl['Totally_Damaged_Houses'] / n_of_bld_adm0
# Perform linear fitting
coefficients, cov_matrix = np.polyfit(df_phl.Affected_People, df_phl.Totally_Damaged_Houses, 1, cov=True)
poly_function = np.poly1d(coefficients)

# Extract standard deviations from the covariance matrix
errors = np.sqrt(np.diag(cov_matrix))

# Plot the data points
plt.plot(df_phl.Affected_People, df_phl.Totally_Damaged_Houses, 'o', label='Data')

# Plot the linear fit
plt.plot(df_phl.Affected_People, poly_function(df_phl.Affected_People), label=f'Fit: {coefficients[0]:.3f}x + {coefficients[1]:.4f} ± {errors[0]:.3f}x ± {errors[1]:.4f}')

# Add legend with the equation of the fit
plt.legend()
plt.xlabel('Affected people / Total population')
plt.ylabel('Destroyed bld / Total bld ')
plt.title('Philippines events, 2014-2020')
# Show the plot
plt.show()

```



![png](06.0_population_data_files/06.0_population_data_30_0.png)



### Analysis


```python
df_housing_pop = df_housing.merge(df_merge_adm1[['total_pop', 'count', 'ADM1_PCODE']],
                                  on='ADM1_PCODE', how='left').rename({
                                      'total_pop':'total_pop_adm1',
                                      'count':'total_bld_adm1'}, axis=1)
df_housing_pop = df_housing_pop.merge(df_merge_adm2[['total_pop', 'count', 'ADM2_PCODE']],
                                  on='ADM2_PCODE', how='left').rename({
                                      'total_pop':'total_pop_adm2',
                                      'count':'total_bld_adm2'}, axis=1)
df_housing_pop
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>affected_population</th>
      <th>Year</th>
      <th>sid</th>
      <th>typhoon_name</th>
      <th>affected_adm1_regions</th>
      <th>affected_adm2_regions</th>
      <th>event_level</th>
      <th>ADM1_PCODE</th>
      <th>ADM2_PCODE</th>
      <th>total_pop_adm1</th>
      <th>total_bld_adm1</th>
      <th>total_pop_adm2</th>
      <th>total_bld_adm2</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>250.0</td>
      <td>2002</td>
      <td>2002265N10315</td>
      <td>LILI</td>
      <td>ARTIBONITE</td>
      <td>ANSE ROUGE</td>
      <td>ADM1</td>
      <td>HT05</td>
      <td>HT0523</td>
      <td>1.734844e+06</td>
      <td>641966.0</td>
      <td>49979.179976</td>
      <td>16341.0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>250.0</td>
      <td>2002</td>
      <td>2002265N10315</td>
      <td>LILI</td>
      <td>ARTIBONITE</td>
      <td>DESDUNES</td>
      <td>ADM1</td>
      <td>HT05</td>
      <td>HT0544</td>
      <td>1.734844e+06</td>
      <td>641966.0</td>
      <td>64773.846914</td>
      <td>26617.0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>250.0</td>
      <td>2002</td>
      <td>2002265N10315</td>
      <td>LILI</td>
      <td>ARTIBONITE</td>
      <td>DESSALINES</td>
      <td>ADM1</td>
      <td>HT05</td>
      <td>HT0541</td>
      <td>1.734844e+06</td>
      <td>641966.0</td>
      <td>136402.078308</td>
      <td>48162.0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>250.0</td>
      <td>2002</td>
      <td>2002265N10315</td>
      <td>LILI</td>
      <td>ARTIBONITE</td>
      <td>ENNERY</td>
      <td>ADM1</td>
      <td>HT05</td>
      <td>HT0512</td>
      <td>1.734844e+06</td>
      <td>641966.0</td>
      <td>49783.259033</td>
      <td>13811.0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>250.0</td>
      <td>2002</td>
      <td>2002265N10315</td>
      <td>LILI</td>
      <td>ARTIBONITE</td>
      <td>GONAIVES</td>
      <td>ADM1</td>
      <td>HT05</td>
      <td>HT0511</td>
      <td>1.734844e+06</td>
      <td>641966.0</td>
      <td>339049.450604</td>
      <td>126471.0</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>1427</th>
      <td>3.0</td>
      <td>2021</td>
      <td>2021182N09317</td>
      <td>ELSA</td>
      <td>NIPPES</td>
      <td>MIRAGOANE</td>
      <td>ADM1</td>
      <td>HT10</td>
      <td>HT1011</td>
      <td>2.461518e+05</td>
      <td>79817.0</td>
      <td>19628.088514</td>
      <td>10263.0</td>
    </tr>
    <tr>
      <th>1428</th>
      <td>3.0</td>
      <td>2021</td>
      <td>2021182N09317</td>
      <td>ELSA</td>
      <td>NIPPES</td>
      <td>PAILLANT</td>
      <td>ADM1</td>
      <td>HT10</td>
      <td>HT1014</td>
      <td>2.461518e+05</td>
      <td>79817.0</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1429</th>
      <td>3.0</td>
      <td>2021</td>
      <td>2021182N09317</td>
      <td>ELSA</td>
      <td>NIPPES</td>
      <td>PETIT TROU DE NIPPES</td>
      <td>ADM1</td>
      <td>HT10</td>
      <td>HT1022</td>
      <td>2.461518e+05</td>
      <td>79817.0</td>
      <td>31994.702932</td>
      <td>11077.0</td>
    </tr>
    <tr>
      <th>1430</th>
      <td>3.0</td>
      <td>2021</td>
      <td>2021182N09317</td>
      <td>ELSA</td>
      <td>NIPPES</td>
      <td>PETITE RIVIERE DE NIPPES</td>
      <td>ADM1</td>
      <td>HT10</td>
      <td>HT1012</td>
      <td>2.461518e+05</td>
      <td>79817.0</td>
      <td>54061.575979</td>
      <td>25030.0</td>
    </tr>
    <tr>
      <th>1431</th>
      <td>3.0</td>
      <td>2021</td>
      <td>2021182N09317</td>
      <td>ELSA</td>
      <td>NIPPES</td>
      <td>PLAISANCE DU SUD</td>
      <td>ADM1</td>
      <td>HT10</td>
      <td>HT1025</td>
      <td>2.461518e+05</td>
      <td>79817.0</td>
      <td>28385.050441</td>
      <td>5790.0</td>
    </tr>
  </tbody>
</table>
<p>1432 rows × 13 columns</p>
</div>




```python
df_map = shp[['ADM1_PCODE', 'ADM2_PCODE']].drop_duplicates()

df_housing_new = pd.DataFrame()
event_names = df_housing_pop.typhoon_name.unique()
# For Philippines correlation approach:
alpha0 = coefficients[0] # From last section
alpha1 = coefficients[1]
alpha3 = 2.32 # From analysis_phl/01_data_exploration/00.1_damage_data_exploration.ipynb
alpha4 = 0.02
total_pop_adm0_hti = 10764094 # From pop data
total_bld_adm0_hti = 4034248 # From Google open bld data

# For every event
for event in event_names:
    dft = df_housing_pop[df_housing_pop.typhoon_name == event].copy()  # Make a copy to avoid SettingWithCopyWarning

    year = dft.Year.iloc[0]
    sid = dft.sid.iloc[0]
    level = dft.event_level.iloc[0]

    dft_aux = dft.merge(df_map, on=['ADM1_PCODE', 'ADM2_PCODE'], how='right')
    dft_aux['typhoon_name'] = event
    dft_aux['Year'] = year
    dft_aux['sid'] = sid
    dft_aux['event_level'] = level

    # Fill nans
    dft_aux['total_pop_adm1'].fillna(0, inplace=True)
    dft_aux['total_bld_adm1'].fillna(0, inplace=True)
    dft_aux['total_pop_adm2'].fillna(0, inplace=True)
    dft_aux['total_bld_adm2'].fillna(0, inplace=True)
    dft_aux['affected_population'].fillna(0, inplace=True)

    # Create empty features
    dft_aux['density'] = 0

    # ADM1 EVENTS
    if dft_aux.event_level.iloc[0] == 'ADM1':
        # Sum over all adm1 regions
        dft_aux2 = dft_aux.drop_duplicates('affected_adm1_regions').dropna()
        bld = dft_aux2['total_bld_adm1'].sum()
        pop = dft_aux2['total_pop_adm1'].sum()
        density = bld / pop

        dft_aux.loc[:, 'density'] = density  # Use .loc to assign values
        # Asuming linear correlation between bld afffected and affected population.
        dft_aux.loc[:, 'bld_affected'] = dft_aux['density'] * dft_aux['affected_population']  # Use .loc to assign values
        # Asuming same case scenario as the Philippines.
        dft_aux.loc[:, 'bld_destroyed_from_phl'] = (alpha1 + (alpha0 * dft_aux['affected_population']) / pop) * bld
        dft_aux.loc[:, 'bld_affected_from_phl'] = alpha3 * dft_aux['bld_destroyed_from_phl'] #+ alpha4 * bld

    # ADM2 EVENTS
    elif dft_aux.event_level.iloc[0] == 'ADM2':
        dft_aux2 = dft_aux.drop_duplicates('affected_adm2_regions').dropna()
        # Sum over all adm2 regions
        bld = dft_aux2['total_bld_adm2'].sum()
        pop = dft_aux2['total_pop_adm2'].sum()
        density = bld / pop
        dft_aux.loc[:, 'density'] = density  # Use .loc to assign values
        # Asuming linear correlation between bld afffected and affected population.
        dft_aux.loc[:, 'bld_affected'] = dft_aux['density'] * dft_aux['affected_population']  # Use .loc to assign values
        # Asuming same case scenario as the Philippines.
        dft_aux.loc[:, 'bld_destroyed_from_phl'] = (alpha1 + (alpha0 * dft_aux['affected_population']) / pop) * bld
        dft_aux.loc[:, 'bld_affected_from_phl'] = alpha3 * dft_aux['bld_destroyed_from_phl'] #+ alpha4 * bld

    df_housing_new = pd.concat([df_housing_new, dft_aux])

df_housing_new = df_housing_new.drop(['affected_adm1_regions', 'affected_adm2_regions', 'density'], axis=1)
```


```python
df_housing_new
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>affected_population</th>
      <th>Year</th>
      <th>sid</th>
      <th>typhoon_name</th>
      <th>event_level</th>
      <th>ADM1_PCODE</th>
      <th>ADM2_PCODE</th>
      <th>total_pop_adm1</th>
      <th>total_bld_adm1</th>
      <th>total_pop_adm2</th>
      <th>total_bld_adm2</th>
      <th>bld_affected</th>
      <th>bld_destroyed_from_phl</th>
      <th>bld_affected_from_phl</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>250.0</td>
      <td>2002</td>
      <td>2002265N10315</td>
      <td>LILI</td>
      <td>ADM1</td>
      <td>HT08</td>
      <td>HT0812</td>
      <td>456165.881894</td>
      <td>124442.0</td>
      <td>18525.900088</td>
      <td>3597.0</td>
      <td>93.696877</td>
      <td>244.368884</td>
      <td>566.935811</td>
    </tr>
    <tr>
      <th>1</th>
      <td>250.0</td>
      <td>2002</td>
      <td>2002265N10315</td>
      <td>LILI</td>
      <td>ADM1</td>
      <td>HT03</td>
      <td>HT0321</td>
      <td>968784.594226</td>
      <td>328965.0</td>
      <td>73458.860678</td>
      <td>27998.0</td>
      <td>93.696877</td>
      <td>244.368884</td>
      <td>566.935811</td>
    </tr>
    <tr>
      <th>2</th>
      <td>250.0</td>
      <td>2002</td>
      <td>2002265N10315</td>
      <td>LILI</td>
      <td>ADM1</td>
      <td>HT09</td>
      <td>HT0922</td>
      <td>735066.542597</td>
      <td>213227.0</td>
      <td>39059.743275</td>
      <td>7425.0</td>
      <td>93.696877</td>
      <td>244.368884</td>
      <td>566.935811</td>
    </tr>
    <tr>
      <th>3</th>
      <td>250.0</td>
      <td>2002</td>
      <td>2002265N10315</td>
      <td>LILI</td>
      <td>ADM1</td>
      <td>HT02</td>
      <td>HT0234</td>
      <td>535326.604314</td>
      <td>223755.0</td>
      <td>30011.225207</td>
      <td>17733.0</td>
      <td>93.696877</td>
      <td>244.368884</td>
      <td>566.935811</td>
    </tr>
    <tr>
      <th>4</th>
      <td>250.0</td>
      <td>2002</td>
      <td>2002265N10315</td>
      <td>LILI</td>
      <td>ADM1</td>
      <td>HT10</td>
      <td>HT1021</td>
      <td>246151.775086</td>
      <td>79817.0</td>
      <td>37722.898918</td>
      <td>10995.0</td>
      <td>93.696877</td>
      <td>244.368884</td>
      <td>566.935811</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>135</th>
      <td>3.0</td>
      <td>2021</td>
      <td>2021182N09317</td>
      <td>ELSA</td>
      <td>ADM1</td>
      <td>HT07</td>
      <td>HT0753</td>
      <td>767338.433528</td>
      <td>315176.0</td>
      <td>41971.857395</td>
      <td>9924.0</td>
      <td>1.130102</td>
      <td>139.202762</td>
      <td>322.950409</td>
    </tr>
    <tr>
      <th>136</th>
      <td>3.0</td>
      <td>2021</td>
      <td>2021182N09317</td>
      <td>ELSA</td>
      <td>ADM1</td>
      <td>HT07</td>
      <td>HT0712</td>
      <td>767338.433528</td>
      <td>315176.0</td>
      <td>102197.019642</td>
      <td>47598.0</td>
      <td>1.130102</td>
      <td>139.202762</td>
      <td>322.950409</td>
    </tr>
    <tr>
      <th>137</th>
      <td>0.0</td>
      <td>2021</td>
      <td>2021182N09317</td>
      <td>ELSA</td>
      <td>ADM1</td>
      <td>HT04</td>
      <td>HT0431</td>
      <td>0.000000</td>
      <td>0.0</td>
      <td>0.000000</td>
      <td>0.0</td>
      <td>0.000000</td>
      <td>139.145376</td>
      <td>322.817273</td>
    </tr>
    <tr>
      <th>138</th>
      <td>0.0</td>
      <td>2021</td>
      <td>2021182N09317</td>
      <td>ELSA</td>
      <td>ADM1</td>
      <td>HT04</td>
      <td>HT0441</td>
      <td>0.000000</td>
      <td>0.0</td>
      <td>0.000000</td>
      <td>0.0</td>
      <td>0.000000</td>
      <td>139.145376</td>
      <td>322.817273</td>
    </tr>
    <tr>
      <th>139</th>
      <td>0.0</td>
      <td>2021</td>
      <td>2021182N09317</td>
      <td>ELSA</td>
      <td>ADM1</td>
      <td>HT05</td>
      <td>HT0532</td>
      <td>0.000000</td>
      <td>0.0</td>
      <td>0.000000</td>
      <td>0.0</td>
      <td>0.000000</td>
      <td>139.145376</td>
      <td>322.817273</td>
    </tr>
  </tbody>
</table>
<p>3512 rows × 14 columns</p>
</div>




```python
fig, ax = plt.subplots(1,1)
ax.plot(df_housing_new.affected_population, df_housing_new.bld_affected_from_phl, 'o-', label='Philippines relation')
ax.plot(df_housing_new.affected_population, df_housing_new.bld_affected, 'o-', label='Dummy relation')

ax.set_xlabel('Affected population')
ax.set_ylabel('Affected buildings')

plt.legend()
plt.show()
```



![png](06.0_population_data_files/06.0_population_data_35_0.png)



## Population as impact data


```python
pop_grid = pop_df_fix.merge(ids_mun, on='id')[[
    'id',
    'total_pop',
    'ADM1_PCODE',
    'ADM2_PCODE'
]]
```


```python
pop_damage_merged_adm1 = df_housing_new.merge(pop_grid, on='ADM1_PCODE')
pop_damage_merged_adm2 = df_housing_new.merge(pop_grid, on='ADM2_PCODE')
```


```python
pop_damage_merged = pop_damage_merged_adm2.copy()
pop_damage_merged_set_regions = pop_damage_merged.loc[pop_damage_merged.typhoon_name == 'ALPHA'].copy()
TOTAL_POP = 'total_pop_adm2'
ADM = 'ADM2_PCODE'

pop_aux = pop_damage_merged_set_regions[pop_damage_merged_set_regions['affected_population']!= 0].drop_duplicates(ADM)
# Total number of people in the set of regions
pop_damage_merged_set_regions['numpeople_z'] = pop_aux[TOTAL_POP].unique().sum()
# Density of people per cell for every typhoon
pop_damage_merged_set_regions['frac_people'] = pop_damage_merged_set_regions['total_pop'] / pop_damage_merged_set_regions['numpeople_z']
# Create percentage of damage per grid cell
pop_damage_merged_set_regions['perc_aff_pop_grid'] = pop_damage_merged_set_regions['frac_people'] * pop_damage_merged_set_regions['affected_population'] * 100 / pop_damage_merged_set_regions['numpeople_z']

pop_damage_merged_set_regions = pop_damage_merged_set_regions[[
    'typhoon_name',
    'Year',
    'event_level',
    'id',
    'affected_population',
    'total_pop',
    'numpeople_z',
    'frac_people',
    'perc_aff_pop_grid'
    ]].drop_duplicates().sort_values('perc_aff_pop_grid')

pop_damage_merged_set_regions.perc_aff_pop_grid.sum()
```




    0.09511022971733123




```python
pop_damage_merged_set_regions[pop_damage_merged_set_regions['affected_population']!= 0].frac_people.sum() #checked!
```




    1.0




```python
(pop_damage_merged_set_regions.perc_aff_pop_grid * pop_damage_merged_set_regions.numpeople_z / 100).sum() #checked!
```




    2192.0




```python
pop_damage_merged_total = pd.DataFrame()
pop_dmg_aux = pop_damage_merged_adm1.drop_duplicates(['typhoon_name', 'Year'])
for typhoon, year, level in zip(pop_dmg_aux['typhoon_name'], pop_dmg_aux['Year'], pop_dmg_aux['event_level']):
    #adm1 or adm2
    if level == 'ADM1':
        pop_damage_merged = pop_damage_merged_adm1.copy()
        ADM = 'ADM1_PCODE'
        TOTAL_POP = 'total_pop_adm1'
    else:
        pop_damage_merged = pop_damage_merged_adm2.copy()
        ADM = 'ADM2_PCODE'
        TOTAL_POP = 'total_pop_adm2'

    pop_damage_merged_set_regions = pop_damage_merged.loc[(pop_damage_merged.typhoon_name == typhoon) & (pop_damage_merged.Year == year)].copy()

    pop_aux = pop_damage_merged_set_regions[pop_damage_merged_set_regions['affected_population']!= 0].drop_duplicates(ADM)
    # Total number of people in the set of regions
    pop_damage_merged_set_regions['numpeople_z'] = pop_aux[TOTAL_POP].unique().sum()
    # Density of people per cell for every typhoon
    pop_damage_merged_set_regions['frac_people'] = pop_damage_merged_set_regions['total_pop'] / pop_damage_merged_set_regions['numpeople_z']
    # Create percentage of affected population per grid cell
    pop_damage_merged_set_regions['perc_aff_pop_grid'] = pop_damage_merged_set_regions['frac_people'] * pop_damage_merged_set_regions['affected_population'] * 100 / pop_damage_merged_set_regions['numpeople_z']

    pop_damage_merged_set_regions = pop_damage_merged_set_regions[[
        'typhoon_name',
        'Year',
        'event_level',
        'id',
        'affected_population',
        'total_pop',
        'numpeople_z',
        'frac_people',
        'perc_aff_pop_grid'
        ]].drop_duplicates().sort_values('perc_aff_pop_grid')

    pop_damage_merged_total = pd.concat([pop_damage_merged_total, pop_damage_merged_set_regions])

# Fix names
pop_damage_merged_total['typhoon_name'] = pop_damage_merged_total['typhoon_name'].str.strip()
```


```python
pop_damage_merged_total
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>typhoon_name</th>
      <th>Year</th>
      <th>event_level</th>
      <th>id</th>
      <th>affected_population</th>
      <th>total_pop</th>
      <th>numpeople_z</th>
      <th>frac_people</th>
      <th>perc_aff_pop_grid</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>24471</th>
      <td>LILI</td>
      <td>2002</td>
      <td>ADM1</td>
      <td>1333</td>
      <td>250.0</td>
      <td>0.000000e+00</td>
      <td>1.076409e+07</td>
      <td>0.000000</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>16</th>
      <td>LILI</td>
      <td>2002</td>
      <td>ADM1</td>
      <td>445</td>
      <td>250.0</td>
      <td>0.000000e+00</td>
      <td>1.076409e+07</td>
      <td>0.000000</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>34294</th>
      <td>LILI</td>
      <td>2002</td>
      <td>ADM1</td>
      <td>948</td>
      <td>250.0</td>
      <td>0.000000e+00</td>
      <td>1.076409e+07</td>
      <td>0.000000</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>16700</th>
      <td>LILI</td>
      <td>2002</td>
      <td>ADM1</td>
      <td>643</td>
      <td>250.0</td>
      <td>0.000000e+00</td>
      <td>1.076409e+07</td>
      <td>0.000000</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>67478</th>
      <td>LILI</td>
      <td>2002</td>
      <td>ADM1</td>
      <td>899</td>
      <td>250.0</td>
      <td>0.000000e+00</td>
      <td>1.076409e+07</td>
      <td>0.000000</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>66196</th>
      <td>ELSA</td>
      <td>2021</td>
      <td>ADM1</td>
      <td>1159</td>
      <td>3.0</td>
      <td>1.451328e+05</td>
      <td>6.219108e+06</td>
      <td>0.023337</td>
      <td>0.000001</td>
    </tr>
    <tr>
      <th>66170</th>
      <td>ELSA</td>
      <td>2021</td>
      <td>ADM1</td>
      <td>909</td>
      <td>3.0</td>
      <td>1.454946e+05</td>
      <td>6.219108e+06</td>
      <td>0.023395</td>
      <td>0.000001</td>
    </tr>
    <tr>
      <th>66187</th>
      <td>ELSA</td>
      <td>2021</td>
      <td>ADM1</td>
      <td>1076</td>
      <td>3.0</td>
      <td>2.987461e+05</td>
      <td>6.219108e+06</td>
      <td>0.048037</td>
      <td>0.000002</td>
    </tr>
    <tr>
      <th>66197</th>
      <td>ELSA</td>
      <td>2021</td>
      <td>ADM1</td>
      <td>1160</td>
      <td>3.0</td>
      <td>7.071491e+05</td>
      <td>6.219108e+06</td>
      <td>0.113706</td>
      <td>0.000005</td>
    </tr>
    <tr>
      <th>66192</th>
      <td>ELSA</td>
      <td>2021</td>
      <td>ADM1</td>
      <td>1118</td>
      <td>3.0</td>
      <td>1.468212e+06</td>
      <td>6.219108e+06</td>
      <td>0.236081</td>
      <td>0.000011</td>
    </tr>
  </tbody>
</table>
<p>8025 rows × 9 columns</p>
</div>



## Save it


```python
# Save population data
pop_out = pop_df_fix[['id','total_pop']]
pop_out.to_csv(output_dir / 'hti_population_data.csv', index=False)
```


```python
# Save bld dmg data
df_housing_new.to_csv(shp_input_dir / 'impact_data_bld_hti.csv', index=False)
```


```python
# Save pop affected data
pop_damage_merged_total.to_csv(grid_input_dir / 'pop_affected_bygrid.csv', index=False)
```

## Examples


```python
df_housing_new_gpd = gpd.GeoDataFrame(
    df_housing_new.merge(shp, on=['ADM1_PCODE', 'ADM2_PCODE'])[df_housing_new.columns.to_list() + ['geometry']],
    geometry='geometry')
```


```python
from climada.hazard import Centroids, TCTracks, TropCyclone
from shapely.geometry import LineString
typhoons = df_housing_new_gpd.typhoon_name.unique()
df_damage = df_housing_new_gpd.copy()
fig, ax = plt.subplots(1,3, figsize=(15,5))
ax = ax.flatten()
i=0
for t in typhoons[2:5]:
    df_event = df_housing_new_gpd[df_housing_new_gpd.typhoon_name==t]
    # Track path
    id = df_event.sid.iloc[0]
    track = TCTracks.from_ibtracs_netcdf(storm_id=id)
    tc_track = track.get_track()

    points_ib = gpd.points_from_xy(tc_track.lon, tc_track.lat)
    tc_track_line_ib = LineString(points_ib)

    geometries_ib = gpd.GeoSeries([tc_track_line_ib])
    line_gdf_ib = gpd.GeoDataFrame(geometry=geometries_ib)

    df_event.plot(column='bld_affected', legend=False, ax=ax[i], cmap='Reds')
    line_gdf_ib.plot(ax=ax[i], color='k', linewidth=1, label='Typhoon track')  # Plot the LineString in black
    bld_aff = np.round(df_event.bld_affected.max())
    ax[i].set_title('{}, \n {} bld affected'.format(t.upper(), bld_aff))
    i+=1

plt.suptitle('Building Damage, HAITI', size=20)
plt.tight_layout()
plt.show()
```
