```python
import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
import geopandas as gpd
import os
from pathlib import Path
```


```python
input_dir = (
    Path(os.getenv("STORM_DATA_DIR"))
    / "analysis_phl/02_model_features/02_housing_damage/input/"
)
output_dir = (
    Path(os.getenv("STORM_DATA_DIR"))
    / "analysis_phl/02_model_features/02_housing_damage/output/"
)

# Load PHL
phl = gpd.read_file(
    input_dir / "phl_adminboundaries_candidate_adm3.zip"
)
phl = phl.to_crs('EPSG:4326')

# Load housing damage dataset 1
df_housing = pd.read_csv(input_dir / "IMpact_data_philipines_SEP_2021.csv")
```

## Inspection


```python
df_housing
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Id</th>
      <th>pcode</th>
      <th>typhoon</th>
      <th>Year</th>
      <th>Totally</th>
      <th>Partially</th>
      <th>total</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>PH041005000</td>
      <td>Durian</td>
      <td>2006</td>
      <td>84.0</td>
      <td>588.0</td>
      <td>672.0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2</td>
      <td>PH041006000</td>
      <td>Durian</td>
      <td>2006</td>
      <td>1.0</td>
      <td>7.0</td>
      <td>8.0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>3</td>
      <td>PH041010000</td>
      <td>Durian</td>
      <td>2006</td>
      <td>4.0</td>
      <td>48.0</td>
      <td>52.0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>4</td>
      <td>PH041014000</td>
      <td>Durian</td>
      <td>2006</td>
      <td>0.0</td>
      <td>78.0</td>
      <td>78.0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>5</td>
      <td>PH041020000</td>
      <td>Durian</td>
      <td>2006</td>
      <td>16.0</td>
      <td>169.0</td>
      <td>185.0</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>4984</th>
      <td>4985</td>
      <td>PH020902000</td>
      <td>MERANTI</td>
      <td>2016</td>
      <td>172.0</td>
      <td>447.0</td>
      <td>619.0</td>
    </tr>
    <tr>
      <th>4985</th>
      <td>4986</td>
      <td>PH020903000</td>
      <td>MERANTI</td>
      <td>2016</td>
      <td>10.0</td>
      <td>111.0</td>
      <td>121.0</td>
    </tr>
    <tr>
      <th>4986</th>
      <td>4987</td>
      <td>PH020904000</td>
      <td>MERANTI</td>
      <td>2016</td>
      <td>11.0</td>
      <td>177.0</td>
      <td>188.0</td>
    </tr>
    <tr>
      <th>4987</th>
      <td>4988</td>
      <td>PH020905000</td>
      <td>MERANTI</td>
      <td>2016</td>
      <td>19.0</td>
      <td>165.0</td>
      <td>184.0</td>
    </tr>
    <tr>
      <th>4988</th>
      <td>4989</td>
      <td>PH020906000</td>
      <td>MERANTI</td>
      <td>2016</td>
      <td>5.0</td>
      <td>323.0</td>
      <td>328.0</td>
    </tr>
  </tbody>
</table>
<p>4989 rows × 7 columns</p>
</div>




```python
df_housing.typhoon.unique()
```




    array(['Durian', 'Fengshen', 'ketsana', 'conson', 'Nesat', 'Bopha',
           'Trami', 'Usagi', 'Nari', 'Krosa', 'Utor', 'Lingling', 'Rammasun',
           'Kalmaegi', 'Fung-wong', 'Hagupit', 'Mekkhala', 'Goni', 'Noul',
           'Mujigae', 'Koppu', 'Melor', 'Sarika', 'Haima', 'Nock-Ten',
           'Mangkhut', 'Haiyan', 'YUTU', 'PHANFONE', 'NAKRI', 'KAMMURI',
           'VONGFONG', 'SAUDEL', 'MOLAVE', 'GONI', 'VAMCO', 'JANGMI', 'LINFA',
           'TOKAGE', 'MERANTI'], dtype=object)



## Cleaning


```python
df_housing['typhoon_name'] = df_housing['typhoon'].str.upper()
df_housing['total_bld_dmg'] = df_housing['total']
df_damage = df_housing[['typhoon_name', 'Year', 'total_bld_dmg', 'pcode']]
```


```python
df_damage
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>typhoon_name</th>
      <th>Year</th>
      <th>total_bld_dmg</th>
      <th>pcode</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>DURIAN</td>
      <td>2006</td>
      <td>672.0</td>
      <td>PH041005000</td>
    </tr>
    <tr>
      <th>1</th>
      <td>DURIAN</td>
      <td>2006</td>
      <td>8.0</td>
      <td>PH041006000</td>
    </tr>
    <tr>
      <th>2</th>
      <td>DURIAN</td>
      <td>2006</td>
      <td>52.0</td>
      <td>PH041010000</td>
    </tr>
    <tr>
      <th>3</th>
      <td>DURIAN</td>
      <td>2006</td>
      <td>78.0</td>
      <td>PH041014000</td>
    </tr>
    <tr>
      <th>4</th>
      <td>DURIAN</td>
      <td>2006</td>
      <td>185.0</td>
      <td>PH041020000</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>4984</th>
      <td>MERANTI</td>
      <td>2016</td>
      <td>619.0</td>
      <td>PH020902000</td>
    </tr>
    <tr>
      <th>4985</th>
      <td>MERANTI</td>
      <td>2016</td>
      <td>121.0</td>
      <td>PH020903000</td>
    </tr>
    <tr>
      <th>4986</th>
      <td>MERANTI</td>
      <td>2016</td>
      <td>188.0</td>
      <td>PH020904000</td>
    </tr>
    <tr>
      <th>4987</th>
      <td>MERANTI</td>
      <td>2016</td>
      <td>184.0</td>
      <td>PH020905000</td>
    </tr>
    <tr>
      <th>4988</th>
      <td>MERANTI</td>
      <td>2016</td>
      <td>328.0</td>
      <td>PH020906000</td>
    </tr>
  </tbody>
</table>
<p>4989 rows × 4 columns</p>
</div>




```python
# Its better to just use the pcode. There are some nans in the data.
df_damage.merge(phl[['ADM3_PCODE', 'ADM3_EN']], left_on='pcode', right_on='ADM3_PCODE', how='left')
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>typhoon_name</th>
      <th>Year</th>
      <th>total_bld_dmg</th>
      <th>pcode</th>
      <th>ADM3_PCODE</th>
      <th>ADM3_EN</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>DURIAN</td>
      <td>2006</td>
      <td>672.0</td>
      <td>PH041005000</td>
      <td>PH041005000</td>
      <td>Batangas City</td>
    </tr>
    <tr>
      <th>1</th>
      <td>DURIAN</td>
      <td>2006</td>
      <td>8.0</td>
      <td>PH041006000</td>
      <td>PH041006000</td>
      <td>Bauan</td>
    </tr>
    <tr>
      <th>2</th>
      <td>DURIAN</td>
      <td>2006</td>
      <td>52.0</td>
      <td>PH041010000</td>
      <td>PH041010000</td>
      <td>Ibaan</td>
    </tr>
    <tr>
      <th>3</th>
      <td>DURIAN</td>
      <td>2006</td>
      <td>78.0</td>
      <td>PH041014000</td>
      <td>PH041014000</td>
      <td>Lipa City</td>
    </tr>
    <tr>
      <th>4</th>
      <td>DURIAN</td>
      <td>2006</td>
      <td>185.0</td>
      <td>PH041020000</td>
      <td>PH041020000</td>
      <td>Padre Garcia</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>4984</th>
      <td>MERANTI</td>
      <td>2016</td>
      <td>619.0</td>
      <td>PH020902000</td>
      <td>PH020902000</td>
      <td>Itbayat</td>
    </tr>
    <tr>
      <th>4985</th>
      <td>MERANTI</td>
      <td>2016</td>
      <td>121.0</td>
      <td>PH020903000</td>
      <td>PH020903000</td>
      <td>Ivana</td>
    </tr>
    <tr>
      <th>4986</th>
      <td>MERANTI</td>
      <td>2016</td>
      <td>188.0</td>
      <td>PH020904000</td>
      <td>PH020904000</td>
      <td>Mahatao</td>
    </tr>
    <tr>
      <th>4987</th>
      <td>MERANTI</td>
      <td>2016</td>
      <td>184.0</td>
      <td>PH020905000</td>
      <td>PH020905000</td>
      <td>Sabtang</td>
    </tr>
    <tr>
      <th>4988</th>
      <td>MERANTI</td>
      <td>2016</td>
      <td>328.0</td>
      <td>PH020906000</td>
      <td>PH020906000</td>
      <td>Uyugan</td>
    </tr>
  </tbody>
</table>
<p>4989 rows × 6 columns</p>
</div>



## Some maps


```python
typhoons = df_damage.typhoon_name.unique()
fig, ax = plt.subplots(1,4, figsize=(15,6))
ax = ax.flatten()
i=0
for t in typhoons[:4]:
    df_aux = df_damage[df_damage['typhoon_name'] == t]
    regions = df_aux['pcode'].to_list()
    phl['colors'] = 'lightblue'  # Default color for all provinces
    phl.loc[phl['ADM3_PCODE'].isin(regions), 'colors'] = 'red'  # Color for the specified provinces

    # Plot Vietnam regions with the specified colors
    phl.plot(ax=ax[i], color=phl['colors'], edgecolor='0.3', linewidth=0.2, legend=True, label='Region Colors')
    ax[i].set_title(t.upper())
    i+=1

plt.tight_layout()
plt.show()
```



![png](00.1_damage_data_exploration_files/00.1_damage_data_exploration_10_0.png)



## Save it


```python
df_damage.to_csv(input_dir / "impact_data_clean_phl.csv", index=False)
```
