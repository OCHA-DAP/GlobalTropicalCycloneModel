```python
from pathlib import Path
import os
import pandas as pd
import geopandas as gpd
import numpy as np
from shapely.geometry import Point

import rasterio
from rasterio.merge import merge
from rasterstats import zonal_stats

from osgeo import gdal
import matplotlib.pyplot as plt
```

```https://dwtkns.com/srtm30m/``` to get the data (must be registered)


```python
#data_dir = '/home/fmoss/data'
data_dir = os.getenv("STORM_DATA_DIR")
base_url = Path(data_dir) / "analysis_phl/02_model_features/"
input_dir = base_url / "04_topography/input/srtm/"
output_dir = base_url / "04_topography/output/"
shp_output_dir = base_url / "02_housing_damage/output/"
```


```python
# Load grid
grid = gpd.read_file(base_url / "02_housing_damage/output/phl_0.1_degree_grid_land_overlap.gpkg")
# Load Shapefile
adm2_shp = gpd.read_file(base_url / "02_housing_damage/input/phl_adminboundaries_candidate_adm3.zip")
adm2_shp = adm2_shp.to_crs('EPSG:4326')
```

## Merge all .hdg files


```python
# List all files
fileList = os.listdir(input_dir/ "dwtkns")
print(fileList)

# All .hgt together
mosaic_raster = []
for file in fileList:
    if file.endswith(".hgt.zip"):
        rast = rasterio.open(input_dir / "dwtkns" / file)
        mosaic_raster.append(rast)
merged_raster, out_raster = merge(mosaic_raster)

# Metadata of the files
out_meta = rast.meta.copy()
out_meta.update(
    {
        "driver": "GTiff",
        "height": merged_raster.shape[1],
        "width": merged_raster.shape[2],
        "transform": out_raster,
#        "crs": grid.crs,
    }
)

# Save file
with rasterio.open(input_dir / "phl_merged_srtm.tif", "w", **out_meta) as dest:
    dest.write(merged_raster)

```

    ['N07E118.SRTMGL1.hgt.zip', 'N07E125.SRTMGL1.hgt.zip', 'N18E122.SRTMGL1.hgt.zip', 'N10E124.SRTMGL1.hgt.zip', 'N10E119.SRTMGL1.hgt.zip', 'N09E119.SRTMGL1.hgt.zip', 'N09E124.SRTMGL1.hgt.zip', 'N21E121.SRTMGL1.hgt.zip', 'N11E119.SRTMGL1.hgt.zip', 'N11E124.SRTMGL1.hgt.zip', 'N19E122.SRTMGL1.hgt.zip', 'N06E125.SRTMGL1.hgt.zip', 'N06E118.SRTMGL1.hgt.zip', 'N20E121.SRTMGL1.hgt.zip', 'N08E124.SRTMGL1.hgt.zip', 'N14E123.SRTMGL1.hgt.zip', 'N08E116.SRTMGL1.hgt.zip', 'N12E124.SRTMGL1.hgt.zip', 'N12E119.SRTMGL1.hgt.zip', 'N05E125.SRTMGL1.hgt.zip', 'N07E117.SRTMGL1.hgt.zip', 'N04E125.SRTMGL1.hgt.zip', 'N13E124.SRTMGL1.hgt.zip', 'N13E123.SRTMGL1.hgt.zip', 'N15E119.SRTMGL1.hgt.zip', 'N02E125.SRTMGL1.hgt.zip', 'N12E123.SRTMGL1.hgt.zip', 'N03E125.SRTMGL1.hgt.zip', 'N14E124.SRTMGL1.hgt.zip', 'N08E123.SRTMGL1.hgt.zip', 'N06E122.SRTMGL1.hgt.zip', 'N11E123.SRTMGL1.hgt.zip', 'N16E119.SRTMGL1.hgt.zip', 'N09E123.SRTMGL1.hgt.zip', 'N10E123.SRTMGL1.hgt.zip', 'N07E122.SRTMGL1.hgt.zip', 'N11E115.SRTMGL1.hgt (1).zip', 'N13E122.SRTMGL1.hgt.zip', 'N11E114.SRTMGL1.hgt (1).zip', 'N12E122.SRTMGL1.hgt.zip', 'N06E123.SRTMGL1.hgt.zip', 'N11E122.SRTMGL1.hgt.zip', 'N08E122.SRTMGL1.hgt.zip', 'N10E122.SRTMGL1.hgt.zip', 'N07E123.SRTMGL1.hgt.zip', 'N09E122.SRTMGL1.hgt.zip', 'N09E118.SRTMGL1.hgt.zip', 'N09E125.SRTMGL1.hgt.zip', 'N16E122.SRTMGL1.hgt.zip', 'N07E124.SRTMGL1.hgt.zip', 'N10E125.SRTMGL1.hgt.zip', 'N10E118.SRTMGL1.hgt.zip', 'N17E122.SRTMGL1.hgt.zip', 'N08E125.SRTMGL1.hgt.zip', 'N08E118.SRTMGL1.hgt.zip', 'N11E125.SRTMGL1.hgt.zip', 'N06E124.SRTMGL1.hgt.zip', 'N12E125.SRTMGL1.hgt.zip', 'N08E117.SRTMGL1.hgt.zip', 'N05E119.SRTMGL1.hgt.zip', 'N05E124.SRTMGL1.hgt.zip', 'N14E122.SRTMGL1.hgt.zip', 'N04E119.SRTMGL1.hgt.zip', 'N09E117.SRTMGL1.hgt.zip', 'N07E116.SRTMGL1.hgt.zip', 'N15E122.SRTMGL1.hgt.zip', 'N03E126.SRTMGL1.hgt.zip', 'N05E121.SRTMGL1.hgt.zip', 'N12E120.SRTMGL1.hgt.zip', 'N13E120.SRTMGL1.hgt.zip', 'N10E120.SRTMGL1.hgt.zip', 'N07E121.SRTMGL1.hgt.zip', 'N09E120.SRTMGL1.hgt.zip', 'N06E121.SRTMGL1.hgt.zip', 'N11E120.SRTMGL1.hgt.zip', 'N20E122.SRTMGL1.hgt.zip', 'N17E120.SRTMGL1.hgt.zip', 'N19E121.SRTMGL1.hgt.zip', 'N06E126.SRTMGL1.hgt.zip', 'N16E120.SRTMGL1.hgt.zip', 'N07E126.SRTMGL1.hgt.zip', 'N18E121.SRTMGL1.hgt.zip', 'N04E126.SRTMGL1.hgt.zip', 'N15E120.SRTMGL1.hgt.zip', 'N05E126.SRTMGL1.hgt.zip', 'N14E120.SRTMGL1.hgt.zip', 'N17E121.SRTMGL1.hgt.zip', 'N08E126.SRTMGL1.hgt.zip', 'N10E126.SRTMGL1.hgt.zip', 'N18E120.SRTMGL1.hgt.zip', 'N09E126.SRTMGL1.hgt.zip', 'N16E121.SRTMGL1.hgt.zip', 'N15E121.SRTMGL1.hgt.zip', 'N04E127.SRTMGL1.hgt.zip', 'N14E121.SRTMGL1.hgt.zip', 'N05E120.SRTMGL1.hgt.zip', 'N12E121.SRTMGL1.hgt.zip', 'N13E121.SRTMGL1.hgt.zip', 'N10E114.SRTMGL1.hgt (1).zip', 'N09E121.SRTMGL1.hgt.zip', 'N10E121.SRTMGL1.hgt.zip', 'N10E115.SRTMGL1.hgt (1).zip', 'N06E120.SRTMGL1.hgt.zip', 'N11E121.SRTMGL1.hgt.zip']


## Open merged file and compute stuff


```python
# Load
merged_rast = rasterio.open(input_dir / "phl_merged_srtm.tif")
altitude = merged_rast.read(1)
```

Information about the dataset


```python
merged_rast_path = input_dir / "phl_merged_srtm.tif"
!gdalinfo \
"{merged_rast_path}"
```

    Driver: GTiff/GeoTIFF
    Files: /Users/federico/Documents/data/analysis/02_new_model_input/04_topography/input/srtm/phl_merged_srtm.tif
    Size is 43201, 68401
    Coordinate System is:
    GEOGCRS["WGS 84",
        DATUM["World Geodetic System 1984",
            ELLIPSOID["WGS 84",6378137,298.257223563,
                LENGTHUNIT["metre",1]]],
        PRIMEM["Greenwich",0,
            ANGLEUNIT["degree",0.0174532925199433]],
        CS[ellipsoidal,2],
            AXIS["geodetic latitude (Lat)",north,
                ORDER[1],
                ANGLEUNIT["degree",0.0174532925199433]],
            AXIS["geodetic longitude (Lon)",east,
                ORDER[2],
                ANGLEUNIT["degree",0.0174532925199433]],
        USAGE[
            SCOPE["unknown"],
            AREA["World"],
            BBOX[-90,-180,90,180]],
        ID["EPSG",4326]]
    Data axis to CRS axis mapping: 2,1
    Origin = (115.999861111111116,21.000138888888888)
    Pixel Size = (0.000277777777778,-0.000277777777778)
    Metadata:
      AREA_OR_POINT=Area
    Image Structure Metadata:
      INTERLEAVE=BAND
    Corner Coordinates:
    Upper Left  ( 115.9998611,  21.0001389) (115d59'59.50"E, 21d 0' 0.50"N)
    Lower Left  ( 115.9998611,   1.9998611) (115d59'59.50"E,  1d59'59.50"N)
    Upper Right ( 128.0001389,  21.0001389) (128d 0' 0.50"E, 21d 0' 0.50"N)
    Lower Right ( 128.0001389,   1.9998611) (128d 0' 0.50"E,  1d59'59.50"N)
    Center      ( 122.0000000,  11.5000000) (122d 0' 0.00"E, 11d30' 0.00"N)
    Band 1 Block=43201x1 Type=Int16, ColorInterp=Gray
      NoData Value=-32768



```python
## slope
phl_slope_gdaldem = input_dir / "phl_slope_gdaldem.tif"
!gdaldem slope -s 111120 -co COMPRESS=DEFLATE -co ZLEVEL=9 \
"{merged_rast_path}" "{phl_slope_gdaldem}" -compute_edges
```

    0...10...20...30...40...50...60...70...80...90...100 - done.



```python
slope_rast = rasterio.open(input_dir / "phl_slope_gdaldem.tif")
slope_array = slope_rast.read(1)
```


```python
## calculate  Terrain Ruggedness Index TRI
phl_tri_gdaldem = input_dir / "phl_tri_gdaldem.tif"
!gdaldem TRI -co COMPRESS=DEFLATE -co ZLEVEL=9 \
"{merged_rast_path}" "{phl_tri_gdaldem}" -compute_edges
```

    0...10...20...30...40...50...60...70...80...90...100 - done.



```python
tri_rast = rasterio.open(input_dir / "phl_tri_gdaldem.tif")
tri_array = tri_rast.read(1)
```

### Mean rudgeness with raster


```python
summary_stats = zonal_stats(
    grid,
    tri_array,
    stats=["mean", "std"],
    nodata=-9999,
    all_touched=True,
    affine=merged_rast.transform,
)
grid_rudg = pd.DataFrame(summary_stats)
grid_rudg_df = pd.concat([grid, grid_rudg], axis=1)
del tri_array
grid_rudg_df
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>id</th>
      <th>Longitude</th>
      <th>Latitude</th>
      <th>Centroid</th>
      <th>geometry</th>
      <th>mean</th>
      <th>std</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>101</td>
      <td>114.3</td>
      <td>11.1</td>
      <td>114.3E_11.1N</td>
      <td>POLYGON ((114.25000 11.15000, 114.35000 11.150...</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1</th>
      <td>4475</td>
      <td>116.9</td>
      <td>7.9</td>
      <td>116.9E_7.9N</td>
      <td>POLYGON ((116.85000 7.95000, 116.95000 7.95000...</td>
      <td>0.217314</td>
      <td>1.331625</td>
    </tr>
    <tr>
      <th>2</th>
      <td>4639</td>
      <td>117.0</td>
      <td>8.2</td>
      <td>117.0E_8.2N</td>
      <td>POLYGON ((116.95000 8.25000, 117.05000 8.25000...</td>
      <td>0.053621</td>
      <td>0.782858</td>
    </tr>
    <tr>
      <th>3</th>
      <td>4640</td>
      <td>117.0</td>
      <td>8.1</td>
      <td>117.0E_8.1N</td>
      <td>POLYGON ((116.95000 8.15000, 117.05000 8.15000...</td>
      <td>2.291861</td>
      <td>4.317536</td>
    </tr>
    <tr>
      <th>4</th>
      <td>4641</td>
      <td>117.0</td>
      <td>8.0</td>
      <td>117.0E_8.0N</td>
      <td>POLYGON ((116.95000 8.05000, 117.05000 8.05000...</td>
      <td>7.283852</td>
      <td>7.011679</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>3721</th>
      <td>20677</td>
      <td>126.6</td>
      <td>7.6</td>
      <td>126.6E_7.6N</td>
      <td>POLYGON ((126.55000 7.65000, 126.65000 7.65000...</td>
      <td>1.752799</td>
      <td>5.001649</td>
    </tr>
    <tr>
      <th>3722</th>
      <td>20678</td>
      <td>126.6</td>
      <td>7.5</td>
      <td>126.6E_7.5N</td>
      <td>POLYGON ((126.55000 7.55000, 126.65000 7.55000...</td>
      <td>4.313097</td>
      <td>6.389963</td>
    </tr>
    <tr>
      <th>3723</th>
      <td>20679</td>
      <td>126.6</td>
      <td>7.4</td>
      <td>126.6E_7.4N</td>
      <td>POLYGON ((126.55000 7.45000, 126.65000 7.45000...</td>
      <td>0.988790</td>
      <td>3.628753</td>
    </tr>
    <tr>
      <th>3724</th>
      <td>20680</td>
      <td>126.6</td>
      <td>7.3</td>
      <td>126.6E_7.3N</td>
      <td>POLYGON ((126.55000 7.35000, 126.65000 7.35000...</td>
      <td>3.275555</td>
      <td>7.463004</td>
    </tr>
    <tr>
      <th>3725</th>
      <td>20681</td>
      <td>126.6</td>
      <td>7.2</td>
      <td>126.6E_7.2N</td>
      <td>POLYGON ((126.55000 7.25000, 126.65000 7.25000...</td>
      <td>1.179309</td>
      <td>4.402832</td>
    </tr>
  </tbody>
</table>
<p>3726 rows × 7 columns</p>
</div>




```python
fig, ax = plt.subplots(1,1)
grid.plot(color='gray', alpha=0.4, ax=ax, label='No data')
gpd.GeoDataFrame(grid_rudg_df.dropna(), geometry='geometry').plot(column='mean', legend=True, ax=ax)
plt.title('Ruggedness [TRI]')
plt.show()
```



![png](04.0.1_topography_variables_files/04.0.1_topography_variables_16_0.png)



### Mean slope with raster


```python
summary_stats = zonal_stats(
    grid,
    slope_array,
    stats=["mean", "std"],
    nodata=-9999,
    all_touched=True,
    affine=merged_rast.transform,
)
grid_slope = pd.DataFrame(summary_stats)
grid_slope_df = pd.concat([grid, grid_slope], axis=1)
del slope_array
grid_slope_df
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>id</th>
      <th>Longitude</th>
      <th>Latitude</th>
      <th>Centroid</th>
      <th>geometry</th>
      <th>mean</th>
      <th>std</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>101</td>
      <td>114.3</td>
      <td>11.1</td>
      <td>114.3E_11.1N</td>
      <td>POLYGON ((114.25000 11.15000, 114.35000 11.150...</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1</th>
      <td>4475</td>
      <td>116.9</td>
      <td>7.9</td>
      <td>116.9E_7.9N</td>
      <td>POLYGON ((116.85000 7.95000, 116.95000 7.95000...</td>
      <td>0.127924</td>
      <td>0.804620</td>
    </tr>
    <tr>
      <th>2</th>
      <td>4639</td>
      <td>117.0</td>
      <td>8.2</td>
      <td>117.0E_8.2N</td>
      <td>POLYGON ((116.95000 8.25000, 117.05000 8.25000...</td>
      <td>0.027975</td>
      <td>0.417205</td>
    </tr>
    <tr>
      <th>3</th>
      <td>4640</td>
      <td>117.0</td>
      <td>8.1</td>
      <td>117.0E_8.1N</td>
      <td>POLYGON ((116.95000 8.15000, 117.05000 8.15000...</td>
      <td>1.365539</td>
      <td>2.750480</td>
    </tr>
    <tr>
      <th>4</th>
      <td>4641</td>
      <td>117.0</td>
      <td>8.0</td>
      <td>117.0E_8.0N</td>
      <td>POLYGON ((116.95000 8.05000, 117.05000 8.05000...</td>
      <td>4.594237</td>
      <td>4.892300</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>3721</th>
      <td>20677</td>
      <td>126.6</td>
      <td>7.6</td>
      <td>126.6E_7.6N</td>
      <td>POLYGON ((126.55000 7.65000, 126.65000 7.65000...</td>
      <td>1.059275</td>
      <td>3.196127</td>
    </tr>
    <tr>
      <th>3722</th>
      <td>20678</td>
      <td>126.6</td>
      <td>7.5</td>
      <td>126.6E_7.5N</td>
      <td>POLYGON ((126.55000 7.55000, 126.65000 7.55000...</td>
      <td>2.649756</td>
      <td>4.184331</td>
    </tr>
    <tr>
      <th>3723</th>
      <td>20679</td>
      <td>126.6</td>
      <td>7.4</td>
      <td>126.6E_7.4N</td>
      <td>POLYGON ((126.55000 7.45000, 126.65000 7.45000...</td>
      <td>0.614328</td>
      <td>2.337994</td>
    </tr>
    <tr>
      <th>3724</th>
      <td>20680</td>
      <td>126.6</td>
      <td>7.3</td>
      <td>126.6E_7.3N</td>
      <td>POLYGON ((126.55000 7.35000, 126.65000 7.35000...</td>
      <td>2.066074</td>
      <td>4.714732</td>
    </tr>
    <tr>
      <th>3725</th>
      <td>20681</td>
      <td>126.6</td>
      <td>7.2</td>
      <td>126.6E_7.2N</td>
      <td>POLYGON ((126.55000 7.25000, 126.65000 7.25000...</td>
      <td>0.764651</td>
      <td>2.931863</td>
    </tr>
  </tbody>
</table>
<p>3726 rows × 7 columns</p>
</div>




```python
fig, ax = plt.subplots(1,1)
grid.plot(color='gray', alpha=0.4, ax=ax, label='No data')
gpd.GeoDataFrame(grid_slope_df.dropna(), geometry='geometry').plot(column='mean', legend=True, ax=ax)
plt.title('Slope [degree]')
plt.show()
```



![png](04.0.1_topography_variables_files/04.0.1_topography_variables_19_0.png)



### Mean altitude with raster


```python
summary_stats = zonal_stats(
    grid,
    altitude,
    stats=["mean"],
    nodata=-32768,
    all_touched=True,
    affine=merged_rast.transform,
)
grid_elev = pd.DataFrame(summary_stats)
grid_elev_df = pd.concat([grid, grid_elev], axis=1)
del altitude
grid_elev_df
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>id</th>
      <th>Longitude</th>
      <th>Latitude</th>
      <th>Centroid</th>
      <th>geometry</th>
      <th>mean</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>101</td>
      <td>114.3</td>
      <td>11.1</td>
      <td>114.3E_11.1N</td>
      <td>POLYGON ((114.25000 11.15000, 114.35000 11.150...</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1</th>
      <td>4475</td>
      <td>116.9</td>
      <td>7.9</td>
      <td>116.9E_7.9N</td>
      <td>POLYGON ((116.85000 7.95000, 116.95000 7.95000...</td>
      <td>0.422334</td>
    </tr>
    <tr>
      <th>2</th>
      <td>4639</td>
      <td>117.0</td>
      <td>8.2</td>
      <td>117.0E_8.2N</td>
      <td>POLYGON ((116.95000 8.25000, 117.05000 8.25000...</td>
      <td>0.050729</td>
    </tr>
    <tr>
      <th>3</th>
      <td>4640</td>
      <td>117.0</td>
      <td>8.1</td>
      <td>117.0E_8.1N</td>
      <td>POLYGON ((116.95000 8.15000, 117.05000 8.15000...</td>
      <td>5.896272</td>
    </tr>
    <tr>
      <th>4</th>
      <td>4641</td>
      <td>117.0</td>
      <td>8.0</td>
      <td>117.0E_8.0N</td>
      <td>POLYGON ((116.95000 8.05000, 117.05000 8.05000...</td>
      <td>26.036955</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>3721</th>
      <td>20677</td>
      <td>126.6</td>
      <td>7.6</td>
      <td>126.6E_7.6N</td>
      <td>POLYGON ((126.55000 7.65000, 126.65000 7.65000...</td>
      <td>5.634180</td>
    </tr>
    <tr>
      <th>3722</th>
      <td>20678</td>
      <td>126.6</td>
      <td>7.5</td>
      <td>126.6E_7.5N</td>
      <td>POLYGON ((126.55000 7.55000, 126.65000 7.55000...</td>
      <td>28.449444</td>
    </tr>
    <tr>
      <th>3723</th>
      <td>20679</td>
      <td>126.6</td>
      <td>7.4</td>
      <td>126.6E_7.4N</td>
      <td>POLYGON ((126.55000 7.45000, 126.65000 7.45000...</td>
      <td>3.123472</td>
    </tr>
    <tr>
      <th>3724</th>
      <td>20680</td>
      <td>126.6</td>
      <td>7.3</td>
      <td>126.6E_7.3N</td>
      <td>POLYGON ((126.55000 7.35000, 126.65000 7.35000...</td>
      <td>26.898075</td>
    </tr>
    <tr>
      <th>3725</th>
      <td>20681</td>
      <td>126.6</td>
      <td>7.2</td>
      <td>126.6E_7.2N</td>
      <td>POLYGON ((126.55000 7.25000, 126.65000 7.25000...</td>
      <td>8.298210</td>
    </tr>
  </tbody>
</table>
<p>3726 rows × 6 columns</p>
</div>




```python
fig, ax = plt.subplots(1,1)
grid.plot(color='gray', alpha=0.4, ax=ax, label='No data')
gpd.GeoDataFrame(grid_elev_df.dropna(), geometry='geometry').plot(column='mean', legend=True, ax=ax, label='Altitude')
plt.title('Altitude [m]')
plt.show()
```



![png](04.0.1_topography_variables_files/04.0.1_topography_variables_22_0.png)



Merge altitude and slope data


```python
df_slope = grid_slope_df.fillna(0).rename({'mean':'mean_slope'}, axis=1)
df_elev = grid_elev_df.fillna(0).rename({'mean':'mean_elev'}, axis=1)
df_rug = grid_rudg_df.fillna(0).rename({'mean':'mean_rug'}, axis=1)
df_slope_elev = df_slope.merge(df_elev, on='id')
df_terrain = df_slope_elev.merge(df_rug, on='id')[['id', 'mean_elev', 'mean_slope', 'mean_rug']]
```

## With coast and Coast length


```python
# dissolving polygons into one land mass
dissolved_shp = adm2_shp.dissolve(by="ADM0_PCODE")

# Coastline
coastline = dissolved_shp.boundary
coastline.plot()
plt.show()
```



![png](04.0.1_topography_variables_files/04.0.1_topography_variables_26_0.png)




```python
coastline.crs = grid.crs
coastline
```




    ADM0_PCODE
    PH    MULTILINESTRING ((119.20744 4.66895, 119.20740...
    dtype: geometry




```python
# Linestrings and MultiLinestrings
grid_line_gdf = gpd.overlay(gpd.GeoDataFrame(coastline, geometry=coastline.geometry, crs=coastline.crs)
                .reset_index(),
                grid,
                how="intersection",
                )[["id", "Centroid", "geometry"]]
# Coast line
grid_line_gdf["coast_length"] = grid_line_gdf["geometry"].to_crs(25394).length #25394 gives me length in meters.
grid_coast = grid[["id", "Centroid"]].merge(grid_line_gdf, on=["id", "Centroid"], how="left")

# With coast? Binary
grid_coast["with_coast"] = np.where(grid_coast["coast_length"] > 0, 1, 0)
grid_coast["with_coast"].value_counts()
```




    with_coast
    1    2114
    0    1612
    Name: count, dtype: int64




```python
fig, ax = plt.subplots(1,2, figsize=(10,6))
ax[0] = grid_coast.with_coast.hist(ax=ax[0])
ax[0].set_xticks([0.05,0.95], ['No coast', 'With coast'])
ax[0].set_ylabel('Frequency')
ax[0].set_title('Grids with coasts')
ax[0].grid('off')

ax[1] = grid_coast.coast_length.fillna(0).hist(ax=ax[1])
ax[1].set_xlabel('Coast length [m]')
ax[1].set_ylabel('Frequency')
ax[1].set_title('Coast length per grid')


plt.tight_layout()
plt.show()
```



![png](04.0.1_topography_variables_files/04.0.1_topography_variables_29_0.png)



## Save it


```python
# Merge data
merge_final = df_terrain.merge(grid_coast, on='id', how='left')
merge_final = merge_final[['id','with_coast','coast_length','mean_elev','mean_slope','mean_rug']]
merge_final = merge_final.fillna(0) # No coast length? Then is 0
```


```python
merge_final
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>id</th>
      <th>with_coast</th>
      <th>coast_length</th>
      <th>mean_elev</th>
      <th>mean_slope</th>
      <th>mean_rug</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>101</td>
      <td>1</td>
      <td>3445.709753</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>1</th>
      <td>4475</td>
      <td>1</td>
      <td>8602.645832</td>
      <td>0.422334</td>
      <td>0.127924</td>
      <td>0.217314</td>
    </tr>
    <tr>
      <th>2</th>
      <td>4639</td>
      <td>1</td>
      <td>5084.012925</td>
      <td>0.050729</td>
      <td>0.027975</td>
      <td>0.053621</td>
    </tr>
    <tr>
      <th>3</th>
      <td>4640</td>
      <td>1</td>
      <td>55607.865950</td>
      <td>5.896272</td>
      <td>1.365539</td>
      <td>2.291861</td>
    </tr>
    <tr>
      <th>4</th>
      <td>4641</td>
      <td>1</td>
      <td>35529.342507</td>
      <td>26.036955</td>
      <td>4.594237</td>
      <td>7.283852</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>3721</th>
      <td>20677</td>
      <td>1</td>
      <td>21559.003490</td>
      <td>5.634180</td>
      <td>1.059275</td>
      <td>1.752799</td>
    </tr>
    <tr>
      <th>3722</th>
      <td>20678</td>
      <td>1</td>
      <td>12591.742022</td>
      <td>28.449444</td>
      <td>2.649756</td>
      <td>4.313097</td>
    </tr>
    <tr>
      <th>3723</th>
      <td>20679</td>
      <td>1</td>
      <td>19740.596834</td>
      <td>3.123472</td>
      <td>0.614328</td>
      <td>0.988790</td>
    </tr>
    <tr>
      <th>3724</th>
      <td>20680</td>
      <td>1</td>
      <td>26363.303778</td>
      <td>26.898075</td>
      <td>2.066074</td>
      <td>3.275555</td>
    </tr>
    <tr>
      <th>3725</th>
      <td>20681</td>
      <td>1</td>
      <td>9359.492382</td>
      <td>8.298210</td>
      <td>0.764651</td>
      <td>1.179309</td>
    </tr>
  </tbody>
</table>
<p>3726 rows × 6 columns</p>
</div>




```python
merge_final.to_csv(output_dir / "topography_variables_bygrid_new.csv", index=False)
```
