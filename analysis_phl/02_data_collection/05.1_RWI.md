```python
import pandas as pd
import geopandas as gpd
from pathlib import Path
import matplotlib.pyplot as plt
import os
```


```python
base_dir = Path(os.getenv("STORM_DATA_DIR")) / "analysis_phl/02_model_features/"
input_dir = base_dir / "05_vulnerability/input/"
shp_input_dir = base_dir / "02_housing_damage/output/"
output_dir = base_dir / "05_vulnerability/output/"

# Load ids of municipalities
ids_mun = pd.read_csv(base_dir / "02_housing_damage/input/phl_grid_municipality_info.csv")

# Load grids
grid = gpd.read_file(base_dir / "02_housing_damage/output/phl_0.1_degree_grid_land_overlap.gpkg")

# Load IWI
iwi = pd.read_csv(output_dir / "phl_iwi_bygrid_new.csv")

# Load RWI
rwi = pd.read_csv(input_dir / "phl_relative_wealth_index.csv")

# Load Shapefile
phl = gpd.read_file(base_dir / "02_housing_damage/input/phl_adminboundaries_candidate_adm3.zip")
phl = phl.to_crs('EPSG:4326')
```

### RWI by grid


```python
# creating a geometry column for the point data
phl_rwi_gdf = gpd.GeoDataFrame(
    rwi, geometry=gpd.points_from_xy(rwi.longitude, rwi.latitude)
)
```


```python
phl_rwi_gdf.crs = grid.crs
grid_rwi_gdf = gpd.tools.sjoin(phl_rwi_gdf, grid, how="right")
grid_rwi_gdf.head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>index_left</th>
      <th>latitude</th>
      <th>longitude</th>
      <th>rwi</th>
      <th>error</th>
      <th>id</th>
      <th>Longitude</th>
      <th>Latitude</th>
      <th>Centroid</th>
      <th>geometry</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>101</td>
      <td>114.3</td>
      <td>11.1</td>
      <td>114.3E_11.1N</td>
      <td>POLYGON ((114.25000 11.15000, 114.35000 11.150...</td>
    </tr>
    <tr>
      <th>1</th>
      <td>5707.0</td>
      <td>7.917793</td>
      <td>116.949463</td>
      <td>-0.527</td>
      <td>0.441</td>
      <td>4475</td>
      <td>116.9</td>
      <td>7.9</td>
      <td>116.9E_7.9N</td>
      <td>POLYGON ((116.85000 7.95000, 116.95000 7.95000...</td>
    </tr>
    <tr>
      <th>2</th>
      <td>21853.0</td>
      <td>8.178868</td>
      <td>117.015381</td>
      <td>-0.283</td>
      <td>0.446</td>
      <td>4639</td>
      <td>117.0</td>
      <td>8.2</td>
      <td>117.0E_8.2N</td>
      <td>POLYGON ((116.95000 8.25000, 117.05000 8.25000...</td>
    </tr>
    <tr>
      <th>3</th>
      <td>8695.0</td>
      <td>8.070107</td>
      <td>117.037353</td>
      <td>-0.660</td>
      <td>0.443</td>
      <td>4640</td>
      <td>117.0</td>
      <td>8.1</td>
      <td>117.0E_8.1N</td>
      <td>POLYGON ((116.95000 8.15000, 117.05000 8.15000...</td>
    </tr>
    <tr>
      <th>3</th>
      <td>9980.0</td>
      <td>8.113615</td>
      <td>117.015381</td>
      <td>0.059</td>
      <td>0.441</td>
      <td>4640</td>
      <td>117.0</td>
      <td>8.1</td>
      <td>117.0E_8.1N</td>
      <td>POLYGON ((116.95000 8.15000, 117.05000 8.15000...</td>
    </tr>
  </tbody>
</table>
</div>




```python
grid_rwi = pd.DataFrame(
    grid_rwi_gdf.groupby(["id", "Centroid"])["rwi"].mean()
).reset_index()

# Fill nans with mena value for the country
mean_rwi = grid_rwi.rwi.mean()
grid_rwi = grid_rwi.fillna(mean_rwi)
```

We define the "distance to the richests". The more distance you have, the more you're apart from the richer cells.. the more poor the cell is.


```python
# RWI distance
max_rwi = grid_rwi.rwi.max()
grid_rwi['distance_rwi'] = max_rwi - grid_rwi.rwi
# RWI distance
max_rwi = grid_rwi.rwi.max()
grid_rwi['distance_rwi'] = (max_rwi - grid_rwi.rwi)
max_distance = grid_rwi['distance_rwi'].max()
grid_rwi['scaled_distance'] = grid_rwi['distance_rwi'] / max_distance
grid_rwi
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>id</th>
      <th>Centroid</th>
      <th>rwi</th>
      <th>distance_rwi</th>
      <th>scaled_distance</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>101</td>
      <td>114.3E_11.1N</td>
      <td>-0.212496</td>
      <td>1.610496</td>
      <td>0.668811</td>
    </tr>
    <tr>
      <th>1</th>
      <td>4475</td>
      <td>116.9E_7.9N</td>
      <td>-0.527000</td>
      <td>1.925000</td>
      <td>0.799419</td>
    </tr>
    <tr>
      <th>2</th>
      <td>4639</td>
      <td>117.0E_8.2N</td>
      <td>-0.283000</td>
      <td>1.681000</td>
      <td>0.698090</td>
    </tr>
    <tr>
      <th>3</th>
      <td>4640</td>
      <td>117.0E_8.1N</td>
      <td>-0.358889</td>
      <td>1.756889</td>
      <td>0.729605</td>
    </tr>
    <tr>
      <th>4</th>
      <td>4641</td>
      <td>117.0E_8.0N</td>
      <td>-0.462800</td>
      <td>1.860800</td>
      <td>0.772757</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>3721</th>
      <td>20677</td>
      <td>126.6E_7.6N</td>
      <td>0.508167</td>
      <td>0.889833</td>
      <td>0.369532</td>
    </tr>
    <tr>
      <th>3722</th>
      <td>20678</td>
      <td>126.6E_7.5N</td>
      <td>-0.174100</td>
      <td>1.572100</td>
      <td>0.652865</td>
    </tr>
    <tr>
      <th>3723</th>
      <td>20679</td>
      <td>126.6E_7.4N</td>
      <td>-0.244286</td>
      <td>1.642286</td>
      <td>0.682012</td>
    </tr>
    <tr>
      <th>3724</th>
      <td>20680</td>
      <td>126.6E_7.3N</td>
      <td>0.038000</td>
      <td>1.360000</td>
      <td>0.564784</td>
    </tr>
    <tr>
      <th>3725</th>
      <td>20681</td>
      <td>126.6E_7.2N</td>
      <td>-0.175000</td>
      <td>1.573000</td>
      <td>0.653239</td>
    </tr>
  </tbody>
</table>
<p>3726 rows Ã— 5 columns</p>
</div>



### Save it


```python
grid_rwi.to_csv(output_dir / "phl_rwi_bygrid.csv", index=False)
```

### Maps


```python
geo_rwi = gpd.GeoDataFrame(grid.merge(grid_rwi, on='id'), geometry='geometry')

fig, ax = plt.subplots(1,1)
geo_rwi.plot(column='rwi', legend=True, cmap = 'YlOrBr', ax=ax)
ax.set_title('Philippines RWI')
plt.show()
```



![png](05.1_RWI_files/05.1_RWI_11_0.png)




```python
fig, ax = plt.subplots(1,1)
geo_rwi.plot(column='scaled_distance', legend=True, cmap = 'YlOrBr', ax=ax)
ax.set_title('Philippines Scaled RWI distance')
plt.show()
```



![png](05.1_RWI_files/05.1_RWI_12_0.png)



### IWI vs RWI


```python
iwi_rwi = grid_rwi.merge(iwi, left_on='id', right_on='grid_point_id')
df_merged = ids_mun.merge(iwi_rwi, on='id')
# At adm1
df_merged_grouped = df_merged[['ADM1_PCODE', 'rwi', 'IWI']].groupby('ADM1_PCODE').mean()
```


```python
plt.plot(df_merged_grouped.IWI, df_merged_grouped.rwi, 'o')
plt.xlabel('IWI')
plt.ylabel('RWI')
plt.title('Mean RWI vs IWI at AMD1 level \nPhilippines')
plt.grid()
plt.show()
```



![png](05.1_RWI_files/05.1_RWI_15_0.png)
