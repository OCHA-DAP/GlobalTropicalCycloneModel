# Notebook that downloads GPM rainfall data done per typhoon


```python
import getpass
import os
from pathlib import Path

import pandas as pd
import datetime as dt
from bs4 import BeautifulSoup
import requests
import time
```


```python
# Setting directories
input_dir = (
    Path(os.getenv("STORM_DATA_DIR"))
    / "analysis_phl/02_model_features/03_rainfall/input"
)
# Setting path to save the GPM data
gpm_file_name = "gpm_data/rainfall_data/output_hhr/"
gpm_folder_path = Path(input_dir, gpm_file_name)
```


```python
# To create an account for downloading the data
# follow the instructions here: https://registration.pps.eosdis.nasa.gov/registration/
# Change the user name and provide the password in the code
# Normally, is just the passwords and the user is just the email that you registered.
USERNAME =  getpass.getpass(prompt="Username: ", stream=None)
PASSWORD = getpass.getpass(prompt="Password: ", stream=None)

# Setting the number of days prior to the landfall data for which to collect data
DAYS_TO_LANDFALL = 2
```


```python
# Load and clean the typhoon metadata
# We really only care about the landfall date
typhoon_metadata = pd.read_csv(input_dir / "metadata_typhoons.csv").set_index(
    "typhoon"
)
for colname in ["startdate", "enddate", "landfalldate"]:
    typhoon_metadata[colname] = pd.to_datetime(
        typhoon_metadata[colname], format="%d/%m/%Y"
    )
typhoon_metadata
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>startdate</th>
      <th>enddate</th>
      <th>landfalldate</th>
      <th>landfall_time</th>
      <th>imerg_type</th>
    </tr>
    <tr>
      <th>typhoon</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>durian2006</th>
      <td>2006-11-24</td>
      <td>2006-12-09</td>
      <td>2006-11-30</td>
      <td>06:00:00</td>
      <td>final</td>
    </tr>
    <tr>
      <th>fengshen2008</th>
      <td>2008-06-17</td>
      <td>2008-06-25</td>
      <td>2008-06-20</td>
      <td>06:00:00</td>
      <td>final</td>
    </tr>
    <tr>
      <th>aere2011</th>
      <td>2011-05-05</td>
      <td>2011-05-15</td>
      <td>2011-05-07</td>
      <td>21:00:00</td>
      <td>final</td>
    </tr>
    <tr>
      <th>atsani2020</th>
      <td>2020-10-29</td>
      <td>2020-11-07</td>
      <td>2020-11-06</td>
      <td>00:00:00</td>
      <td>final</td>
    </tr>
    <tr>
      <th>bopha2012</th>
      <td>2012-11-25</td>
      <td>2012-12-09</td>
      <td>2012-12-03</td>
      <td>21:00:00</td>
      <td>final</td>
    </tr>
    <tr>
      <th>danas2019</th>
      <td>2019-07-14</td>
      <td>2019-07-23</td>
      <td>2019-07-17</td>
      <td>00:00:00</td>
      <td>final</td>
    </tr>
    <tr>
      <th>fung-wong2014</th>
      <td>2014-09-17</td>
      <td>2014-09-25</td>
      <td>2014-09-19</td>
      <td>03:00:00</td>
      <td>final</td>
    </tr>
    <tr>
      <th>goni2015</th>
      <td>2015-08-13</td>
      <td>2015-08-30</td>
      <td>2015-08-22</td>
      <td>00:00:00</td>
      <td>final</td>
    </tr>
    <tr>
      <th>goni2020</th>
      <td>2020-10-28</td>
      <td>2020-11-06</td>
      <td>2020-10-31</td>
      <td>21:00:00</td>
      <td>final</td>
    </tr>
    <tr>
      <th>hagupit2014</th>
      <td>2014-11-30</td>
      <td>2014-12-12</td>
      <td>2014-12-06</td>
      <td>18:00:00</td>
      <td>final</td>
    </tr>
    <tr>
      <th>haikui2017</th>
      <td>2017-11-07</td>
      <td>2017-11-14</td>
      <td>2017-11-08</td>
      <td>21:00:00</td>
      <td>final</td>
    </tr>
    <tr>
      <th>haima2016</th>
      <td>2016-10-14</td>
      <td>2016-10-26</td>
      <td>2016-10-19</td>
      <td>18:00:00</td>
      <td>final</td>
    </tr>
    <tr>
      <th>haiyan2013</th>
      <td>2013-11-02</td>
      <td>2013-11-11</td>
      <td>2013-11-08</td>
      <td>00:00:00</td>
      <td>final</td>
    </tr>
    <tr>
      <th>jangmi2014</th>
      <td>2014-12-27</td>
      <td>2015-01-01</td>
      <td>2014-12-29</td>
      <td>00:00:00</td>
      <td>final</td>
    </tr>
    <tr>
      <th>kai-tak2012</th>
      <td>2012-08-11</td>
      <td>2012-08-18</td>
      <td>2012-08-15</td>
      <td>03:00:00</td>
      <td>final</td>
    </tr>
    <tr>
      <th>kai-tak2017</th>
      <td>2017-12-13</td>
      <td>2017-12-23</td>
      <td>2017-12-16</td>
      <td>12:00:00</td>
      <td>final</td>
    </tr>
    <tr>
      <th>kalmaegi2014</th>
      <td>2014-09-10</td>
      <td>2014-09-17</td>
      <td>2014-09-14</td>
      <td>12:00:00</td>
      <td>final</td>
    </tr>
    <tr>
      <th>kammuri2019</th>
      <td>2019-11-24</td>
      <td>2019-12-06</td>
      <td>2019-12-02</td>
      <td>15:00:00</td>
      <td>final</td>
    </tr>
    <tr>
      <th>ketsana2009</th>
      <td>2009-09-25</td>
      <td>2009-09-30</td>
      <td>2009-09-26</td>
      <td>06:00:00</td>
      <td>final</td>
    </tr>
    <tr>
      <th>khanun2017</th>
      <td>2017-10-11</td>
      <td>2017-10-16</td>
      <td>2017-10-12</td>
      <td>18:00:00</td>
      <td>final</td>
    </tr>
    <tr>
      <th>kompasu2010</th>
      <td>2010-08-27</td>
      <td>2010-09-06</td>
      <td>2010-09-02</td>
      <td>00:00:00</td>
      <td>final</td>
    </tr>
    <tr>
      <th>koppu2015</th>
      <td>2015-10-12</td>
      <td>2015-10-21</td>
      <td>2015-10-17</td>
      <td>18:00:00</td>
      <td>final</td>
    </tr>
    <tr>
      <th>krosa2013</th>
      <td>2013-10-27</td>
      <td>2013-11-04</td>
      <td>2013-10-31</td>
      <td>12:00:00</td>
      <td>final</td>
    </tr>
    <tr>
      <th>linfa2015</th>
      <td>2015-07-01</td>
      <td>2015-07-10</td>
      <td>2015-07-05</td>
      <td>00:00:00</td>
      <td>final</td>
    </tr>
    <tr>
      <th>lingling2014</th>
      <td>2014-01-15</td>
      <td>2014-01-20</td>
      <td>2014-01-18</td>
      <td>00:00:00</td>
      <td>final</td>
    </tr>
    <tr>
      <th>maliksi2018</th>
      <td>2018-06-03</td>
      <td>2018-06-12</td>
      <td>2018-06-08</td>
      <td>00:00:00</td>
      <td>final</td>
    </tr>
    <tr>
      <th>mangkhut2018</th>
      <td>2018-09-06</td>
      <td>2018-09-17</td>
      <td>2018-09-14</td>
      <td>21:00:00</td>
      <td>final</td>
    </tr>
    <tr>
      <th>matmo2014</th>
      <td>2014-07-16</td>
      <td>2014-07-26</td>
      <td>2014-07-22</td>
      <td>00:00:00</td>
      <td>final</td>
    </tr>
    <tr>
      <th>meari2011</th>
      <td>2011-06-20</td>
      <td>2011-06-27</td>
      <td>2011-06-24</td>
      <td>00:00:00</td>
      <td>final</td>
    </tr>
    <tr>
      <th>mekkhala2015</th>
      <td>2015-01-12</td>
      <td>2015-01-20</td>
      <td>2015-01-17</td>
      <td>09:00:00</td>
      <td>final</td>
    </tr>
    <tr>
      <th>melor2015</th>
      <td>2015-12-10</td>
      <td>2015-12-17</td>
      <td>2015-12-14</td>
      <td>09:00:00</td>
      <td>final</td>
    </tr>
    <tr>
      <th>mirinae2009</th>
      <td>2009-10-25</td>
      <td>2009-11-02</td>
      <td>2009-10-30</td>
      <td>21:00:00</td>
      <td>final</td>
    </tr>
    <tr>
      <th>molave2020</th>
      <td>2020-10-24</td>
      <td>2020-10-28</td>
      <td>2020-10-25</td>
      <td>21:00:00</td>
      <td>final</td>
    </tr>
    <tr>
      <th>mujigae2015</th>
      <td>2015-09-30</td>
      <td>2015-10-05</td>
      <td>2015-10-01</td>
      <td>18:00:00</td>
      <td>final</td>
    </tr>
    <tr>
      <th>nakri2019</th>
      <td>2019-11-04</td>
      <td>2019-11-11</td>
      <td>2019-11-08</td>
      <td>00:00:00</td>
      <td>final</td>
    </tr>
    <tr>
      <th>nalgae2011</th>
      <td>2011-09-26</td>
      <td>2011-10-05</td>
      <td>2011-10-01</td>
      <td>03:00:00</td>
      <td>final</td>
    </tr>
    <tr>
      <th>nanmadol2011</th>
      <td>2011-08-21</td>
      <td>2011-08-31</td>
      <td>2011-08-27</td>
      <td>03:00:00</td>
      <td>final</td>
    </tr>
    <tr>
      <th>nari2013</th>
      <td>2013-10-08</td>
      <td>2013-10-16</td>
      <td>2013-10-11</td>
      <td>15:00:00</td>
      <td>final</td>
    </tr>
    <tr>
      <th>nesat2011</th>
      <td>2011-09-23</td>
      <td>2011-09-30</td>
      <td>2011-09-27</td>
      <td>00:00:00</td>
      <td>final</td>
    </tr>
    <tr>
      <th>nock-ten2011</th>
      <td>2011-07-24</td>
      <td>2011-07-31</td>
      <td>2011-07-27</td>
      <td>06:00:00</td>
      <td>final</td>
    </tr>
    <tr>
      <th>nock-ten2016</th>
      <td>2016-12-20</td>
      <td>2016-12-28</td>
      <td>2016-12-25</td>
      <td>15:00:00</td>
      <td>final</td>
    </tr>
    <tr>
      <th>pakhar2017</th>
      <td>2017-08-24</td>
      <td>2017-08-28</td>
      <td>2017-08-25</td>
      <td>15:00:00</td>
      <td>final</td>
    </tr>
    <tr>
      <th>parma2009</th>
      <td>2009-09-27</td>
      <td>2009-10-14</td>
      <td>2009-10-03</td>
      <td>06:00:00</td>
      <td>final</td>
    </tr>
    <tr>
      <th>phanfone2019</th>
      <td>2019-12-19</td>
      <td>2019-12-29</td>
      <td>2019-12-24</td>
      <td>12:00:00</td>
      <td>final</td>
    </tr>
    <tr>
      <th>rammasun2014</th>
      <td>2014-07-09</td>
      <td>2014-07-20</td>
      <td>2014-07-15</td>
      <td>12:00:00</td>
      <td>final</td>
    </tr>
    <tr>
      <th>sarika2016</th>
      <td>2016-10-12</td>
      <td>2016-10-20</td>
      <td>2016-10-15</td>
      <td>21:00:00</td>
      <td>final</td>
    </tr>
    <tr>
      <th>saudel2020</th>
      <td>2020-10-19</td>
      <td>2020-10-26</td>
      <td>2020-10-20</td>
      <td>15:00:00</td>
      <td>final</td>
    </tr>
    <tr>
      <th>tembin2017</th>
      <td>2017-12-20</td>
      <td>2017-12-26</td>
      <td>2017-12-21</td>
      <td>21:00:00</td>
      <td>final</td>
    </tr>
    <tr>
      <th>tokage2016</th>
      <td>2016-11-23</td>
      <td>2016-11-28</td>
      <td>2016-11-24</td>
      <td>12:00:00</td>
      <td>final</td>
    </tr>
    <tr>
      <th>trami2013</th>
      <td>2013-08-16</td>
      <td>2013-08-24</td>
      <td>2013-08-19</td>
      <td>00:00:00</td>
      <td>final</td>
    </tr>
    <tr>
      <th>usagi2013</th>
      <td>2013-09-16</td>
      <td>2013-09-24</td>
      <td>2013-09-21</td>
      <td>00:00:00</td>
      <td>final</td>
    </tr>
    <tr>
      <th>utor2013</th>
      <td>2013-08-08</td>
      <td>2013-08-18</td>
      <td>2013-08-11</td>
      <td>21:00:00</td>
      <td>final</td>
    </tr>
    <tr>
      <th>vamco2020</th>
      <td>2020-11-09</td>
      <td>2020-11-15</td>
      <td>2020-11-11</td>
      <td>18:00:00</td>
      <td>final</td>
    </tr>
    <tr>
      <th>vongfong2020</th>
      <td>2020-05-11</td>
      <td>2020-05-16</td>
      <td>2020-05-14</td>
      <td>06:00:00</td>
      <td>final</td>
    </tr>
    <tr>
      <th>washi2011</th>
      <td>2011-12-11</td>
      <td>2011-12-19</td>
      <td>2011-12-16</td>
      <td>09:00:00</td>
      <td>final</td>
    </tr>
    <tr>
      <th>yutu2018</th>
      <td>2018-10-20</td>
      <td>2018-11-03</td>
      <td>2018-10-29</td>
      <td>21:00:00</td>
      <td>final</td>
    </tr>
    <tr>
      <th>conson2010</th>
      <td>2010-07-11</td>
      <td>2010-07-17</td>
      <td>2010-07-13</td>
      <td>00:00:00</td>
      <td>final</td>
    </tr>
    <tr>
      <th>meranti2016</th>
      <td>2016-09-11</td>
      <td>2016-09-16</td>
      <td>2016-09-13</td>
      <td>18:00:00</td>
      <td>final</td>
    </tr>
    <tr>
      <th>noul2015</th>
      <td>2015-05-08</td>
      <td>2015-05-13</td>
      <td>2015-05-10</td>
      <td>08:45:00</td>
      <td>final</td>
    </tr>
  </tbody>
</table>
</div>




```python
#%% Functions used
def list_files(url):
    page = requests.get(url, auth=(USERNAME, PASSWORD)).text
    soup = BeautifulSoup(page, "html.parser")
    return [
        url + "/" + node.get("href")
        for node in soup.find_all("a")
        if node.get("href").endswith("tif")
    ]


def download_gpm_http(start_date, end_date, download_path):
    base_url = "https://arthurhouhttps.pps.eosdis.nasa.gov/pub/gpmdata"

    date_list = pd.date_range(start_date, end_date)
    file_list = []

    for date in date_list:
        #print(f"Downloading data for date {date}")
        day_path = download_path / date.strftime("%Y%m%d")
        day_path.mkdir(parents=True, exist_ok=True)

        url = f"{base_url}/{date.strftime('%Y/%m/%d')}/gis"
        tiff_files = list_files(url=url)

        for tiff_file in tiff_files:
            file_name = tiff_file.split("/")[-1]

            file_path = day_path / file_name
            file_list.append(file_path)
            r = requests.get(tiff_file, auth=(USERNAME, USERNAME))
            time.sleep(0.2)
            open(file_path, "wb").write(r.content)

    return file_list
```

## Download the data

This section is for downloading the data.
It takes a long time to complete.


```python
i=0 # Sometimes if there's a problem, just identify the typhoon number and start downloading again from that.
for typhoon, metadata in typhoon_metadata[i:].iterrows():
    start_date = metadata["landfalldate"] - dt.timedelta(days=DAYS_TO_LANDFALL)
    end_date = metadata["landfalldate"] + dt.timedelta(days=DAYS_TO_LANDFALL)
    print('Typhoon {}/{}'.format(i, len(typhoon_metadata)-1));i+=1
    print(f"Downloading data for {typhoon} between {start_date} and {end_date}")
    download_gpm_http(start_date=start_date,
                      end_date=end_date,
                      download_path=gpm_folder_path / typhoon / "GPM")
```
