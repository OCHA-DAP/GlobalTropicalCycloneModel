```python
from pathlib import Path
import os

from shapely.geometry import LineString,Polygon, MultiPolygon
import geopandas as gpd
import numpy as np
import pandas as pd
import xarray as xr
import re
import matplotlib.pyplot as plt
from matplotlib.patches import Patch
from matplotlib.lines import Line2D
from scipy import stats

from climada.hazard import Centroids, TCTracks, TropCyclone
from shapely.geometry import LineString, Point
```


```python
input_dir = (
    Path(os.getenv("STORM_DATA_DIR"))
    / "analysis_phl/02_model_features/02_housing_damage/input/"
)
output_dir = (
    Path(os.getenv("STORM_DATA_DIR"))
    / "analysis_phl/02_model_features/02_housing_damage/output/"
)
wind_info = (
    Path(os.getenv("STORM_DATA_DIR"))
    / "analysis_phl/02_model_features/01_windfield"
)
# Load typhoon id info
typhoon_ids = pd.read_csv(wind_info/ "typhoons.csv")

# Load PHL
phl = gpd.read_file(
    input_dir / "phl_adminboundaries_candidate_adm3.zip"
)
# Load grid
grid_land_overlap = gpd.read_file(output_dir / "phl_0.1_degree_grid_land_overlap.gpkg")
grid_land_overlap["id"] = grid_land_overlap["id"].astype(int)

# Load grids per Municipality
ids_mun = pd.read_csv(input_dir / "phl_grid_municipality_info.csv")

# Load damage data
damage_data = pd.read_csv(input_dir / "impact_data_clean_phl.csv")

# Number of buildings per id
bld_count = pd.read_csv(input_dir / "Google Footprint Data/phl_google_bld_grid_count.csv")
```

## Building locations

### Map of building location


```python
bld_count_red = bld_count[['Centroid', 'numbuildings']]
# Convert strings to Point geometries
bld_count_red['Centroid'] = bld_count_red['Centroid'].apply(lambda x: Point(float(x.split('_')[0][:-1]), float(x.split('_')[1][:-1])))

# Create a GeoDataFrame with the 'Centroid' column as the geometry
bld_count_red_geo = gpd.GeoDataFrame(bld_count_red, geometry='Centroid')

# Perform the spatial join
bld_count_red_geo.crs = grid_land_overlap.crs
gpd_bld_count = gpd.sjoin(grid_land_overlap, bld_count_red_geo)[['id', 'geometry', 'numbuildings']]
gpd_bld_count
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>id</th>
      <th>geometry</th>
      <th>numbuildings</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>101</td>
      <td>POLYGON ((114.25000 11.15000, 114.35000 11.150...</td>
      <td>0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>4475</td>
      <td>POLYGON ((116.85000 7.95000, 116.95000 7.95000...</td>
      <td>3</td>
    </tr>
    <tr>
      <th>2</th>
      <td>4639</td>
      <td>POLYGON ((116.95000 8.25000, 117.05000 8.25000...</td>
      <td>11</td>
    </tr>
    <tr>
      <th>3</th>
      <td>4640</td>
      <td>POLYGON ((116.95000 8.15000, 117.05000 8.15000...</td>
      <td>587</td>
    </tr>
    <tr>
      <th>4</th>
      <td>4641</td>
      <td>POLYGON ((116.95000 8.05000, 117.05000 8.05000...</td>
      <td>974</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>3721</th>
      <td>20677</td>
      <td>POLYGON ((126.55000 7.65000, 126.65000 7.65000...</td>
      <td>7393</td>
    </tr>
    <tr>
      <th>3722</th>
      <td>20678</td>
      <td>POLYGON ((126.55000 7.55000, 126.65000 7.55000...</td>
      <td>2528</td>
    </tr>
    <tr>
      <th>3723</th>
      <td>20679</td>
      <td>POLYGON ((126.55000 7.45000, 126.65000 7.45000...</td>
      <td>1484</td>
    </tr>
    <tr>
      <th>3724</th>
      <td>20680</td>
      <td>POLYGON ((126.55000 7.35000, 126.65000 7.35000...</td>
      <td>2798</td>
    </tr>
    <tr>
      <th>3725</th>
      <td>20681</td>
      <td>POLYGON ((126.55000 7.25000, 126.65000 7.25000...</td>
      <td>468</td>
    </tr>
  </tbody>
</table>
<p>3726 rows × 3 columns</p>
</div>




```python
# Plot builing loc over map
fig, ax = plt.subplots(1,1)

phl.plot(ax=ax, color='gray', edgecolor='gray', label='Fiji', alpha=0.5)
gpd_bld_count.plot(ax=ax, column='numbuildings', legend=True, cmap='viridis')
ax.set_xlabel('Longitude')
ax.set_ylabel('Latitude')
ax.set_title('PHL builings density by grid')
plt.show()
```



![png](02.1.2_damage_agg_by_building_google_files/02.1.2_damage_agg_by_building_google_5_0.png)




```python
# Plot per grid
bld_count_complete = gpd_bld_count.copy()

# Define the bins and labels
bins = [-float('inf'), 1, 50, 100, 300, 500, 1000, 5000, 10000, 100000, float('inf')]
labels = [0, 1, 2, 3, 4, 5, 6, 7, 8, 9]

# Create the new column using pd.cut
bld_count_complete['numbuildings_cat'] = pd.cut(bld_count_complete['numbuildings'], bins=bins, labels=labels, include_lowest=True)
gpd_bld_count = gpd.GeoDataFrame(bld_count_complete, geometry='geometry')
```


```python
# Define the categories and their corresponding labels
categories = [0, 1, 2, 3, 4, 5, 6, 7, 8, 9]
category_labels = ['0', '1 - 50', '50 - 100', '100 - 300', '300 - 500', '500 - 1000', '1000 - 5000', '5000 - 10000', '10000 - 100000', '> 100000']

# Plot histogram
plt.figure(figsize=(10, 6))
plt.hist(bld_count_complete['numbuildings_cat'], bins=range(11), edgecolor='black', align='left', rwidth=0.8)

# Customize xticks
plt.xticks(categories, category_labels, rotation=45, ha='right')

# Add labels and title
plt.xlabel('Number of Buildings by Grid')
plt.ylabel('Frequency')
plt.title('Distribution of Number of Buildings Categories')

# Display the plot
plt.show()
```



![png](02.1.2_damage_agg_by_building_google_files/02.1.2_damage_agg_by_building_google_7_0.png)




```python
# Plot the GeoDataFrame
fig, ax = plt.subplots(1,1, figsize=(10, 10))
gpd_bld_count.plot(column='numbuildings_cat', cmap='viridis', legend=True, ax=ax, legend_kwds={'title': 'Buildings by grid'})

# Customize the legend labels
legend_labels = {
    0: '0',
    1: '1 - 50',
    2: '50 - 100',
    3: '100 - 300',
    4: '300 - 500',
    5: '500 - 1000',
    6: '1000 - 5000',
    7: '5000 - 10000',
    8: '10000 - 100000',
    9: '> 100000'
}

# Get the current legend
legend = ax.get_legend()

# Customize the legend labels using legend_labels dictionary
for key, label in legend_labels.items():
    legend.get_texts()[key].set_text(label)

# Display the map
plt.title('PHL bld count')
plt.show()
```



![png](02.1.2_damage_agg_by_building_google_files/02.1.2_damage_agg_by_building_google_8_0.png)



Like the paper


```python
# Define the bins and labels
bins = [-float('inf'), 300, 1200, 3000, 6000, 12000, float('inf')]
labels = [0, 1, 2, 3, 4, 5]

# Create the new column using pd.cut
bld_count_complete['numbuildings_cat'] = pd.cut(bld_count_complete['numbuildings'], bins=bins, labels=labels, include_lowest=True)
gpd_bld_count = gpd.GeoDataFrame(bld_count_complete, geometry='geometry')
```


```python
# Plot the GeoDataFrame
fig, ax = plt.subplots(1,1, figsize=(10, 10))
gpd_bld_count.plot(column='numbuildings_cat', cmap='YlOrBr', legend=True, ax=ax, legend_kwds={'title': 'Buildings by grid'})

# Customize the legend labels
legend_labels = {
    0: '<300',
    1: '300 - 1200',
    2: '1200 - 3000',
    3: '3000 - 6000',
    4: '6000 - 12000',
    5: '> 12000',
}

# Get the current legend
legend = ax.get_legend()

# Customize the legend labels using legend_labels dictionary
for key, label in legend_labels.items():
    legend.get_texts()[key].set_text(label)

# Display the map
plt.title('PHL bld count')
plt.show()
```



![png](02.1.2_damage_agg_by_building_google_files/02.1.2_damage_agg_by_building_google_11_0.png)



### Distribution of bld per grid


```python
build_per_grid = bld_count_complete.numbuildings
#plt.hist(build_per_grid, bins=50)
hist = np.histogram(build_per_grid, bins=10 ** np.linspace(0, np.log10(10**4), len(build_per_grid)), density=True)
x = hist[1][:-1]
y = hist[0]

plt.plot(x,y, 'ro', alpha=0.4, label='Buildings')
plt.xscale('log')
plt.yscale('log')

plt.xlabel('Buildings per grid cell')
plt.ylabel('PDF')

q25 = np.quantile(build_per_grid, 0.25)
q50 = np.quantile(build_per_grid, 0.50)
mode = stats.mode(build_per_grid).mode

# Add text boxes with annotations
plt.text(0.7, 0.9, f'Quantile 25: {q25:.2f}', transform=plt.gca().transAxes)
plt.text(0.7, 0.85, f'Quantile 50: {q50:.2f}', transform=plt.gca().transAxes)
plt.text(0.7, 0.8, f'Mode: {mode:.2f}', transform=plt.gca().transAxes)

plt.show()
```



![png](02.1.2_damage_agg_by_building_google_files/02.1.2_damage_agg_by_building_google_13_0.png)




```python
# Save it
bld_count_complete[['id', 'numbuildings']].to_csv(output_dir / "num_building_bygrid.csv")
```

### Building damage to grid


```python
ids_mun = ids_mun.rename({'ADM3_PCODE':'region'}, axis=1)
```


```python
# # Municipalities by id
# mun_dict = ids_mun[['id', 'ADM1_EN']].groupby(by='ADM1_EN').groups
# muns =  mun_dict.keys()
# ids = []
# for m in muns:
#     ids.append(ids_mun.iloc[mun_dict[m].values].id)
# df_muns = pd.DataFrame({'Municipality': muns, 'ids':ids})
# provinces_exploded = df_muns.explode('ids')

# ADM3 Regions by id
region_dict = ids_mun[['id', 'region']].groupby(by='region').groups
regions =  region_dict.keys()
ids = []
for r in regions:
    ids.append(ids_mun.iloc[region_dict[r].values].id)
df_regions = pd.DataFrame({'Region': regions, 'ids':ids})
regions_exploded = df_regions.explode('ids')
```


```python
# Some checks
print(len(set(ids_mun.sort_values('id').id.unique()) & set(bld_count_complete.id.unique())))
#print(len(set(provinces_exploded.sort_values('ids').ids.unique()) - set(bld_count_complete.id.unique())))
```

    3726



```python
# # Assign municipality to building count
# bld_grid_mun = bld_count_complete.merge(provinces_exploded, left_on='id', right_on='ids', how='inner')[['id', 'Municipality', 'numbuildings']]

# Assign region to building count
bld_grid_region = bld_count_complete.merge(regions_exploded, left_on='id', right_on='ids', how='inner')[['id', 'Region', 'numbuildings']]


bld_grid_region.sort_values('numbuildings', ascending=False)
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>id</th>
      <th>Region</th>
      <th>numbuildings</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>845</th>
      <td>11254</td>
      <td>PH031412000</td>
      <td>433261</td>
    </tr>
    <tr>
      <th>925</th>
      <td>11422</td>
      <td>PH137606000</td>
      <td>386116</td>
    </tr>
    <tr>
      <th>848</th>
      <td>11257</td>
      <td>PH042103000</td>
      <td>341662</td>
    </tr>
    <tr>
      <th>846</th>
      <td>11255</td>
      <td>PH133914000</td>
      <td>339220</td>
    </tr>
    <tr>
      <th>924</th>
      <td>11421</td>
      <td>PH045802000</td>
      <td>336006</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>1016</th>
      <td>11600</td>
      <td>PH175205000</td>
      <td>0</td>
    </tr>
    <tr>
      <th>1702</th>
      <td>13387</td>
      <td>PH021523000</td>
      <td>0</td>
    </tr>
    <tr>
      <th>338</th>
      <td>9775</td>
      <td>PH175307000</td>
      <td>0</td>
    </tr>
    <tr>
      <th>2203</th>
      <td>15130</td>
      <td>PH063015000</td>
      <td>0</td>
    </tr>
    <tr>
      <th>0</th>
      <td>101</td>
      <td>PH175321000</td>
      <td>0</td>
    </tr>
  </tbody>
</table>
<p>3726 rows × 3 columns</p>
</div>




```python
###OPTIONAL###

# """Assign 1 bld to all 0 buildings grids"""
# bld_grid_region['numbuildings'] = bld_grid_region['numbuildings'].replace(0, 1)
# bld_grid_region.sort_values('numbuildings', ascending=False)
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>id</th>
      <th>Region</th>
      <th>numbuildings</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>845</th>
      <td>11254</td>
      <td>PH031412000</td>
      <td>433261</td>
    </tr>
    <tr>
      <th>925</th>
      <td>11422</td>
      <td>PH137606000</td>
      <td>386116</td>
    </tr>
    <tr>
      <th>848</th>
      <td>11257</td>
      <td>PH042103000</td>
      <td>341662</td>
    </tr>
    <tr>
      <th>846</th>
      <td>11255</td>
      <td>PH133914000</td>
      <td>339220</td>
    </tr>
    <tr>
      <th>924</th>
      <td>11421</td>
      <td>PH045802000</td>
      <td>336006</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>284</th>
      <td>9511</td>
      <td>PH157009000</td>
      <td>1</td>
    </tr>
    <tr>
      <th>876</th>
      <td>11294</td>
      <td>PH175310000</td>
      <td>1</td>
    </tr>
    <tr>
      <th>254</th>
      <td>9345</td>
      <td>PH157002000</td>
      <td>1</td>
    </tr>
    <tr>
      <th>884</th>
      <td>11346</td>
      <td>PH156612000</td>
      <td>1</td>
    </tr>
    <tr>
      <th>0</th>
      <td>101</td>
      <td>PH175321000</td>
      <td>1</td>
    </tr>
  </tbody>
</table>
<p>3726 rows × 3 columns</p>
</div>




```python
# Because I can: builings by Municipality

#df_aux = bld_grid_mun.groupby('Municipality').sum().sort_values(by='numbuildings', ascending=False)
df_aux2 = bld_grid_region.groupby('Region').sum().sort_values(by='numbuildings', ascending=False)

# plt.figure(figsize=(12, 6))
# plt.bar(df_aux.index, df_aux['numbuildings'])
# plt.ylabel('Number of Buildings')
# plt.title('Number of Buildings by Province')
# plt.xticks(rotation=90)
# plt.show()

plt.figure(figsize=(12, 6))
plt.bar(df_aux2.index, df_aux2['numbuildings'])
plt.xticks([])
plt.ylabel('Number of Buildings')
plt.title('Number of Buildings by ADM3 Region')
plt.xticks(rotation=90)
plt.show()
```



![png](02.1.2_damage_agg_by_building_google_files/02.1.2_damage_agg_by_building_google_21_0.png)



-VIETNAM-Since I have multiple regions affected by a single typhoon but just une quantity of damage, at the end I have damage not even at region level, but at a bigger scale (damage at a set of regions level). This is bad but is what we have, and all the calculous that we do have to take this into account.


```python
# Total number of buildings per region
total_bld_reg = bld_grid_region.groupby('Region').sum()['numbuildings'].reset_index(drop=False)
bld_grid_reg_merged = bld_grid_region.merge(total_bld_reg, on='Region', how='left')
```


```python
bld_damage_merged = bld_grid_reg_merged.merge(damage_data, left_on='Region', right_on='pcode')
```


```python
len(damage_data.drop_duplicates(['typhoon_name', 'Year']).sort_values('typhoon_name')) #GONI 2015 and 2020
```




    40




```python
bld_damage_merged_total = pd.DataFrame()
bld_dmg_aux = bld_damage_merged.drop_duplicates(['typhoon_name', 'Year'])
for typhoon, year in zip(bld_dmg_aux['typhoon_name'], bld_dmg_aux['Year']):
    bld_damage_merged_set_regions = bld_damage_merged.loc[(bld_damage_merged.typhoon_name == typhoon) & (bld_damage_merged.Year == year)].copy()
    # Total number of buildings in the set of regions
    #bld_damage_merged_set_regions['numbuildings_z'] = bld_damage_merged_set_regions.numbuildings_y.unique().sum()
    bld_damage_merged_set_regions['numbuildings_z'] = bld_damage_merged_set_regions['numbuildings_y'] #All the regions are the same for PHL
    # Density of buildings per cell for every typhoon
    bld_damage_merged_set_regions['frac_bld'] = bld_damage_merged_set_regions['numbuildings_x'] / bld_damage_merged_set_regions['numbuildings_z']
    # Create percentage of damage per grid cell
    bld_damage_merged_set_regions['perc_dmg_grid'] = bld_damage_merged_set_regions['frac_bld'] * bld_damage_merged_set_regions['total_bld_dmg'] * 100 / bld_damage_merged_set_regions['numbuildings_z']
    # Number of buuldings damaged per grid
    bld_damage_merged_set_regions['N_dmg_grid'] = bld_damage_merged_set_regions['frac_bld'] * bld_damage_merged_set_regions['total_bld_dmg']
    # For every typhoon, put 0 damage to the grid cells not affected by the typhoon
    df_aux3 = bld_damage_merged_set_regions.merge(bld_grid_region, on='id', how='right')
    df_aux3['typhoon_name'] = df_aux3.typhoon_name.fillna(typhoon)
    df_aux3['Year'] = df_aux3.Year.fillna(year)
    df_aux3 = df_aux3.rename({'Region_y': 'Region'}, axis=1)
    bld_damage_merged_set_regions_total = df_aux3.fillna(0)
    bld_damage_merged_set_regions_total = bld_damage_merged_set_regions_total.sort_values('perc_dmg_grid', ascending=False)
    bld_damage_merged_set_regions_total = bld_damage_merged_set_regions_total.drop_duplicates('id', keep='first')
    bld_damage_merged_total = pd.concat([bld_damage_merged_total, bld_damage_merged_set_regions_total])
```


```python
bld_damage_merged_total.sort_values('perc_dmg_grid', ascending=False).head(15)
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>id</th>
      <th>Region_x</th>
      <th>numbuildings_x</th>
      <th>numbuildings_y</th>
      <th>typhoon_name</th>
      <th>Year</th>
      <th>total_bld_dmg</th>
      <th>pcode</th>
      <th>numbuildings_z</th>
      <th>frac_bld</th>
      <th>perc_dmg_grid</th>
      <th>N_dmg_grid</th>
      <th>Region</th>
      <th>numbuildings</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2727</th>
      <td>16943</td>
      <td>PH052003000</td>
      <td>10.0</td>
      <td>10.0</td>
      <td>NOCK-TEN</td>
      <td>2016.0</td>
      <td>4868.0</td>
      <td>PH052003000</td>
      <td>10.0</td>
      <td>1.000000</td>
      <td>48680.000000</td>
      <td>4868.000000</td>
      <td>PH052003000</td>
      <td>10</td>
    </tr>
    <tr>
      <th>2727</th>
      <td>16943</td>
      <td>PH052003000</td>
      <td>10.0</td>
      <td>10.0</td>
      <td>DURIAN</td>
      <td>2006.0</td>
      <td>4392.0</td>
      <td>PH052003000</td>
      <td>10.0</td>
      <td>1.000000</td>
      <td>43920.000000</td>
      <td>4392.000000</td>
      <td>PH052003000</td>
      <td>10</td>
    </tr>
    <tr>
      <th>1607</th>
      <td>13119</td>
      <td>PH060414000</td>
      <td>26.0</td>
      <td>26.0</td>
      <td>PHANFONE</td>
      <td>2019.0</td>
      <td>8783.0</td>
      <td>PH060414000</td>
      <td>26.0</td>
      <td>1.000000</td>
      <td>33780.769231</td>
      <td>8783.000000</td>
      <td>PH060414000</td>
      <td>26</td>
    </tr>
    <tr>
      <th>926</th>
      <td>11051</td>
      <td>PH012823000</td>
      <td>8.0</td>
      <td>8.0</td>
      <td>MANGKHUT</td>
      <td>2018.0</td>
      <td>1187.0</td>
      <td>PH012823000</td>
      <td>8.0</td>
      <td>1.000000</td>
      <td>14837.500000</td>
      <td>1187.000000</td>
      <td>PH012823000</td>
      <td>8</td>
    </tr>
    <tr>
      <th>1607</th>
      <td>13119</td>
      <td>PH060414000</td>
      <td>26.0</td>
      <td>26.0</td>
      <td>HAIYAN</td>
      <td>2013.0</td>
      <td>3481.0</td>
      <td>PH060414000</td>
      <td>26.0</td>
      <td>1.000000</td>
      <td>13388.461538</td>
      <td>3481.000000</td>
      <td>PH060414000</td>
      <td>26</td>
    </tr>
    <tr>
      <th>2854</th>
      <td>17304</td>
      <td>PH083736000</td>
      <td>46.0</td>
      <td>46.0</td>
      <td>HAIYAN</td>
      <td>2013.0</td>
      <td>3692.0</td>
      <td>PH083736000</td>
      <td>46.0</td>
      <td>1.000000</td>
      <td>8026.086957</td>
      <td>3692.000000</td>
      <td>PH083736000</td>
      <td>46</td>
    </tr>
    <tr>
      <th>1950</th>
      <td>14299</td>
      <td>PH063018000</td>
      <td>48.0</td>
      <td>48.0</td>
      <td>HAIYAN</td>
      <td>2013.0</td>
      <td>2651.0</td>
      <td>PH063018000</td>
      <td>48.0</td>
      <td>1.000000</td>
      <td>5522.916667</td>
      <td>2651.000000</td>
      <td>PH063018000</td>
      <td>48</td>
    </tr>
    <tr>
      <th>2856</th>
      <td>17308</td>
      <td>PH083721000</td>
      <td>102.0</td>
      <td>102.0</td>
      <td>HAIYAN</td>
      <td>2013.0</td>
      <td>4235.0</td>
      <td>PH083721000</td>
      <td>102.0</td>
      <td>1.000000</td>
      <td>4151.960784</td>
      <td>4235.000000</td>
      <td>PH083721000</td>
      <td>102</td>
    </tr>
    <tr>
      <th>712</th>
      <td>10920</td>
      <td>PH031405000</td>
      <td>7.0</td>
      <td>7.0</td>
      <td>VAMCO</td>
      <td>2020.0</td>
      <td>226.0</td>
      <td>PH031405000</td>
      <td>7.0</td>
      <td>1.000000</td>
      <td>3228.571429</td>
      <td>226.000000</td>
      <td>PH031405000</td>
      <td>7</td>
    </tr>
    <tr>
      <th>578</th>
      <td>10590</td>
      <td>PH042121000</td>
      <td>93.0</td>
      <td>93.0</td>
      <td>RAMMASUN</td>
      <td>2014.0</td>
      <td>2870.0</td>
      <td>PH042121000</td>
      <td>93.0</td>
      <td>1.000000</td>
      <td>3086.021505</td>
      <td>2870.000000</td>
      <td>PH042121000</td>
      <td>93</td>
    </tr>
    <tr>
      <th>578</th>
      <td>10590</td>
      <td>PH042121000</td>
      <td>93.0</td>
      <td>93.0</td>
      <td>CONSON</td>
      <td>2010.0</td>
      <td>2521.0</td>
      <td>PH042121000</td>
      <td>93.0</td>
      <td>1.000000</td>
      <td>2710.752688</td>
      <td>2521.000000</td>
      <td>PH042121000</td>
      <td>93</td>
    </tr>
    <tr>
      <th>699</th>
      <td>10920</td>
      <td>PH031405000</td>
      <td>7.0</td>
      <td>7.0</td>
      <td>NESAT</td>
      <td>2011.0</td>
      <td>143.0</td>
      <td>PH031405000</td>
      <td>7.0</td>
      <td>1.000000</td>
      <td>2042.857143</td>
      <td>143.000000</td>
      <td>PH031405000</td>
      <td>7</td>
    </tr>
    <tr>
      <th>1601</th>
      <td>13119</td>
      <td>PH060414000</td>
      <td>26.0</td>
      <td>26.0</td>
      <td>FENGSHEN</td>
      <td>2008.0</td>
      <td>495.0</td>
      <td>PH060414000</td>
      <td>26.0</td>
      <td>1.000000</td>
      <td>1903.846154</td>
      <td>495.000000</td>
      <td>PH060414000</td>
      <td>26</td>
    </tr>
    <tr>
      <th>779</th>
      <td>11100</td>
      <td>PH175201000</td>
      <td>242.0</td>
      <td>280.0</td>
      <td>MELOR</td>
      <td>2015.0</td>
      <td>5413.0</td>
      <td>PH175201000</td>
      <td>280.0</td>
      <td>0.864286</td>
      <td>1670.849490</td>
      <td>4678.378571</td>
      <td>PH175201000</td>
      <td>242</td>
    </tr>
    <tr>
      <th>2517</th>
      <td>16275</td>
      <td>PH052008000</td>
      <td>497.0</td>
      <td>497.0</td>
      <td>DURIAN</td>
      <td>2006.0</td>
      <td>6954.0</td>
      <td>PH052008000</td>
      <td>497.0</td>
      <td>1.000000</td>
      <td>1399.195171</td>
      <td>6954.000000</td>
      <td>PH052008000</td>
      <td>497</td>
    </tr>
  </tbody>
</table>
</div>




```python
bld_damage_merged_total.groupby('typhoon_name').count()['id']
```




    typhoon_name
    BOPHA        3726
    CONSON       3726
    DURIAN       3726
    FENGSHEN     3726
    FUNG-WONG    3726
    GONI         7452
    HAGUPIT      3726
    HAIMA        3726
    HAIYAN       3726
    JANGMI       3726
    KALMAEGI     3726
    KAMMURI      3726
    KETSANA      3726
    KOPPU        3726
    KROSA        3726
    LINFA        3726
    LINGLING     3726
    MANGKHUT     3726
    MEKKHALA     3726
    MELOR        3726
    MERANTI      3726
    MOLAVE       3726
    MUJIGAE      3726
    NAKRI        3726
    NARI         3726
    NESAT        3726
    NOCK-TEN     3726
    NOUL         3726
    PHANFONE     3726
    RAMMASUN     3726
    SARIKA       3726
    SAUDEL       3726
    TOKAGE       3726
    TRAMI        3726
    USAGI        3726
    UTOR         3726
    VAMCO        3726
    VONGFONG     3726
    YUTU         3726
    Name: id, dtype: int64



### Some examples


```python
xmin, xmax, ymin, ymax = 114.25, 126.75, 4.55, 21.15
typhoon_ids.head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>typhoon_id</th>
      <th>typhoon_name</th>
      <th>typhoon_year</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>2006329N06150</td>
      <td>DURIAN</td>
      <td>2006</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2008169N08135</td>
      <td>FENGSHEN</td>
      <td>2008</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2009268N14128</td>
      <td>KETSANA</td>
      <td>2009</td>
    </tr>
    <tr>
      <th>3</th>
      <td>2010191N12138</td>
      <td>CONSON</td>
      <td>2010</td>
    </tr>
    <tr>
      <th>4</th>
      <td>2011266N13139</td>
      <td>NESAT</td>
      <td>2011</td>
    </tr>
  </tbody>
</table>
</div>




```python
# Damage info
noul = bld_damage_merged_total[bld_damage_merged_total.typhoon_name == 'NOUL']
noul = gpd.GeoDataFrame(noul.merge(bld_count_complete[['id', 'geometry']], on='id'))

# Track path
track = TCTracks.from_ibtracs_netcdf(storm_id='2015122N07144') #Noul
tc_track = track.get_track()
points = gpd.points_from_xy(tc_track.lon, tc_track.lat)
track_points = gpd.GeoDataFrame(geometry=points)
tc_track_line = LineString(points)
track_line = gpd.GeoDataFrame(geometry=[tc_track_line])

# Plot
fig, ax = plt.subplots(1,1)
noul.plot(ax=ax, column='perc_dmg_grid', legend=True, cmap='Reds')
track_line.plot(ax=ax, color='k', linewidth=1, label='Typhoon track')

# ax.set_xlim(100, 120)
# ax.set_ylim(7, 24)
ax.axis([xmin, xmax, ymin, ymax])
ax.set_title('Noul typhoon 2015, \n% of houses affected by grid')
plt.show()
```

    2024-02-19 17:19:43,916 - climada.hazard.tc_tracks - WARNING - The cached IBTrACS data set dates from 2023-06-07 23:07:38 (older than 180 days). Very likely, a more recent version is available. Consider manually removing the file /Users/federico/climada/data/IBTrACS.ALL.v04r00.nc and re-running this function, which will download the most recent version of the IBTrACS data set from the official URL.




![png](02.1.2_damage_agg_by_building_google_files/02.1.2_damage_agg_by_building_google_31_1.png)




```python
# Damage info
meranti = bld_damage_merged_total[(bld_damage_merged_total.typhoon_name == 'MERANTI') & (bld_damage_merged_total.Year == 2016)]
meranti = gpd.GeoDataFrame(meranti.merge(bld_count_complete[['id', 'geometry']], on='id'))

# Track path
track = TCTracks.from_ibtracs_netcdf(storm_id='2016253N13144') # Damrey2017
tc_track = track.get_track()
points = gpd.points_from_xy(tc_track.lon, tc_track.lat)
track_points = gpd.GeoDataFrame(geometry=points)
tc_track_line = LineString(points)
track_line = gpd.GeoDataFrame(geometry=[tc_track_line])

# Plot
fig, ax = plt.subplots(1,1)
meranti.plot(ax=ax, column='perc_dmg_grid', legend=True, cmap='Reds')
track_line.plot(ax=ax, color='k', linewidth=1, label='Typhoon track')

# ax.set_xlim(100, 120)
# ax.set_ylim(7, 24)
ax.axis([xmin, xmax, ymin, ymax])
ax.set_title('Meranti typhoon 2016, \n% of houses affected by grid')
plt.show()
```

    2024-02-19 17:19:51,712 - climada.hazard.tc_tracks - WARNING - The cached IBTrACS data set dates from 2023-06-07 23:07:38 (older than 180 days). Very likely, a more recent version is available. Consider manually removing the file /Users/federico/climada/data/IBTrACS.ALL.v04r00.nc and re-running this function, which will download the most recent version of the IBTrACS data set from the official URL.




![png](02.1.2_damage_agg_by_building_google_files/02.1.2_damage_agg_by_building_google_32_1.png)




```python
# Damage info
durian = bld_damage_merged_total[bld_damage_merged_total.typhoon_name == 'DURIAN']
durian = gpd.GeoDataFrame(durian.merge(bld_count_complete[['id', 'geometry']], on='id'))

# Track path
track = TCTracks.from_ibtracs_netcdf(storm_id='2006329N06150') #durian
tc_track = track.get_track()
points = gpd.points_from_xy(tc_track.lon, tc_track.lat)
track_points = gpd.GeoDataFrame(geometry=points)
tc_track_line = LineString(points)
track_line = gpd.GeoDataFrame(geometry=[tc_track_line])

# Plot
fig, ax = plt.subplots(1,1)
grid_land_overlap.plot(ax=ax, color='k', alpha=0.3)
durian.plot(ax=ax, column='perc_dmg_grid', legend=True, cmap='Reds', linewidth=2)
track_line.plot(ax=ax, color='k', linewidth=1, label='Typhoon track')

# ax.set_xlim(100, 120)
# ax.set_ylim(7, 24)
ax.axis([xmin, xmax, ymin, ymax])
ax.set_title('Durian typhoon 2006, \n% of houses affected by grid')
plt.show()
```

    2024-02-19 17:19:58,360 - climada.hazard.tc_tracks - WARNING - The cached IBTrACS data set dates from 2023-06-07 23:07:38 (older than 180 days). Very likely, a more recent version is available. Consider manually removing the file /Users/federico/climada/data/IBTrACS.ALL.v04r00.nc and re-running this function, which will download the most recent version of the IBTrACS data set from the official URL.




![png](02.1.2_damage_agg_by_building_google_files/02.1.2_damage_agg_by_building_google_33_1.png)



### Distribution


```python
plt.hist(bld_damage_merged_total['perc_dmg_grid'], bins=20)
plt.yscale('log')
plt.xscale('log')
plt.xlabel('% of damage')

plt.title('Philippines % of damage by grid cell')
plt.show()
```



![png](02.1.2_damage_agg_by_building_google_files/02.1.2_damage_agg_by_building_google_35_0.png)



### Save % of damage per grid cell


```python
bld_damage_merged_total[
    ['typhoon_name',
     'Year',
     'id',
     'total_bld_dmg',
     'numbuildings',
     'Region',
     'perc_dmg_grid'
     ]].sort_values('perc_dmg_grid')
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>typhoon_name</th>
      <th>Year</th>
      <th>id</th>
      <th>total_bld_dmg</th>
      <th>numbuildings</th>
      <th>Region</th>
      <th>perc_dmg_grid</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>3725</th>
      <td>NAKRI</td>
      <td>2019.0</td>
      <td>20681</td>
      <td>0.0</td>
      <td>468</td>
      <td>PH112508000</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>723</th>
      <td>HAGUPIT</td>
      <td>2014.0</td>
      <td>11005</td>
      <td>0.0</td>
      <td>0</td>
      <td>PH156606000</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>722</th>
      <td>HAGUPIT</td>
      <td>2014.0</td>
      <td>11004</td>
      <td>0.0</td>
      <td>39</td>
      <td>PH156606000</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>721</th>
      <td>HAGUPIT</td>
      <td>2014.0</td>
      <td>10974</td>
      <td>0.0</td>
      <td>32</td>
      <td>PH175308000</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>720</th>
      <td>HAGUPIT</td>
      <td>2014.0</td>
      <td>10960</td>
      <td>0.0</td>
      <td>0</td>
      <td>PH175310000</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>1607</th>
      <td>HAIYAN</td>
      <td>2013.0</td>
      <td>13119</td>
      <td>3481.0</td>
      <td>26</td>
      <td>PH060414000</td>
      <td>13388.461538</td>
    </tr>
    <tr>
      <th>926</th>
      <td>MANGKHUT</td>
      <td>2018.0</td>
      <td>11051</td>
      <td>1187.0</td>
      <td>8</td>
      <td>PH012823000</td>
      <td>14837.500000</td>
    </tr>
    <tr>
      <th>1607</th>
      <td>PHANFONE</td>
      <td>2019.0</td>
      <td>13119</td>
      <td>8783.0</td>
      <td>26</td>
      <td>PH060414000</td>
      <td>33780.769231</td>
    </tr>
    <tr>
      <th>2727</th>
      <td>DURIAN</td>
      <td>2006.0</td>
      <td>16943</td>
      <td>4392.0</td>
      <td>10</td>
      <td>PH052003000</td>
      <td>43920.000000</td>
    </tr>
    <tr>
      <th>2727</th>
      <td>NOCK-TEN</td>
      <td>2016.0</td>
      <td>16943</td>
      <td>4868.0</td>
      <td>10</td>
      <td>PH052003000</td>
      <td>48680.000000</td>
    </tr>
  </tbody>
</table>
<p>149040 rows × 7 columns</p>
</div>




```python
bld_damage_merged_total[
    ['typhoon_name',
     'Year',
     'id',
     'total_bld_dmg',
     'numbuildings',
     'Region',
     'perc_dmg_grid'
     ]].to_csv(output_dir / "building_damage_bygrid_new.csv", index=False)
```
