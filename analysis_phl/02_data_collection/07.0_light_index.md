```python
import pandas as pd
import geopandas as gpd
from pathlib import Path
import os
import requests, zipfile, io
import rasterio
from rasterio.merge import merge
from rasterstats import zonal_stats
from osgeo import gdal
import matplotlib.pyplot as plt
import rioxarray
import xarray
from shapely.geometry import Polygon
from rasterstats import zonal_stats
```


```python
base_dir = Path(os.getenv("STORM_DATA_DIR")) / "analysis_phl/02_model_features/"
input_dir = base_dir / "05_vulnerability/input/"
bld_dir = base_dir / "02_housing_damage/output/"
output_dir = base_dir / "05_vulnerability/output/"

# Load ids of municipalities
ids_mun = pd.read_csv(base_dir / "02_housing_damage/input/phl_grid_municipality_info.csv")

# Load grids
grid = gpd.read_file(base_dir / "02_housing_damage/output/phl_0.1_degree_grid_land_overlap.gpkg")

# Load PHL
adm3_shp = gpd.read_file(base_dir / "02_housing_damage/input/phl_adminboundaries_candidate_adm3.zip")
adm3_shp = adm3_shp.to_crs('EPSG:4326')

# Pop data
pop_data = pd.read_csv(bld_dir / 'num_building_bygrid.csv')
pop_data = pop_data.rename({'N_bld':'numbuildings'}, axis=1)

```


```python
grid_transformed = grid.copy()
# Define a function to adjust the longitude of a single polygon
def adjust_longitude(polygon):
    # Extract the coordinates of the polygon
    coords = list(polygon.exterior.coords)

    # Adjust longitudes from [0, 360) to [-180, 180)
    for i in range(len(coords)):
        lon, lat = coords[i]
        if lon > 180:
            coords[i] = (lon - 360, lat)

    # Create a new Polygon with adjusted coordinates
    return Polygon(coords)

# Apply the adjust_longitude function to each geometry in the DataFrame
grid_transformed["geometry"] = grid_transformed["geometry"].apply(adjust_longitude)
grid_transformed = grid_transformed[['id', 'Latitude', 'Longitude','geometry']]
```

## .tif files

### Create merged file


```python
file_list = os.listdir(input_dir)
tif_files = []
for file in file_list:
    if file.endswith('.tif'):
        tif_files.append(file)
tif_files
```




    ['SVDNB_npp_d20240101.d.00N180W.rade9.tif',
     'SVDNB_npp_d20240101.d.75N060E.rade9.tif',
     'SVDNB_npp_d20240101.d.00N060W.rade9.tif',
     'SVDNB_npp_d20240101.d.00N060E.rade9.tif',
     'SVDNB_npp_d20240101.d.75N060W.rade9.tif']




```python
# All .tif files together
mosaic_raster = []
for file in tif_files:
    rast = rasterio.open(input_dir / file)
    mosaic_raster.append(rast)
merged_raster, out_raster = merge(mosaic_raster)
```


```python
# Metadata of the files
out_meta = rast.meta.copy()
out_meta.update(
    {
        "driver": "GTiff",
        "height": merged_raster.shape[1],
        "width": merged_raster.shape[2],
        "transform": out_raster,
#        "crs": grid.crs,
    }
)

# Save file
with rasterio.open(output_dir / "light_merged.tif", "w", **out_meta) as dest:
    dest.write(merged_raster)
```

### Open merged file


```python
ras = rasterio.open(output_dir / 'light_merged.tif')
```

Information


```python
rast_path = output_dir / 'light_merged.tif'
!gdalinfo \
"{rast_path}"
```

    Driver: GTiff/GeoTIFF
    Files: /Users/federico/Documents/data/analysis/02_new_model_input/05_vulnerability/output/light_merged.tif
    Size is 86401, 33601
    Coordinate System is:
    GEOGCRS["WGS 84",
        DATUM["World Geodetic System 1984",
            ELLIPSOID["WGS 84",6378137,298.257223563,
                LENGTHUNIT["metre",1,
                    ID["EPSG",9001]]]],
        PRIMEM["Greenwich",0,
            ANGLEUNIT["degree",0.0174532925199433,
                ID["EPSG",9122]]],
        CS[ellipsoidal,2],
            AXIS["latitude",north,
                ORDER[1],
                ANGLEUNIT["degree",0.0174532925199433,
                    ID["EPSG",9122]]],
            AXIS["longitude",east,
                ORDER[2],
                ANGLEUNIT["degree",0.0174532925199433,
                    ID["EPSG",9122]]]]
    Data axis to CRS axis mapping: 2,1
    Origin = (-180.002083333349987,75.002083333350001)
    Pixel Size = (0.004166666700000,-0.004166666700000)
    Metadata:
      AREA_OR_POINT=Area
    Image Structure Metadata:
      INTERLEAVE=BAND
    Corner Coordinates:
    Upper Left  (-180.0020833,  75.0020833) (180d 0' 7.50"W, 75d 0' 7.50"N)
    Lower Left  (-180.0020833, -65.0020845) (180d 0' 7.50"W, 65d 0' 7.50"S)
    Upper Right ( 180.0020862,  75.0020833) (180d 0' 7.51"E, 75d 0' 7.50"N)
    Lower Right ( 180.0020862, -65.0020845) (180d 0' 7.51"E, 65d 0' 7.50"S)
    Center      (   0.0000014,   4.9999994) (  0d 0' 0.01"E,  5d 0' 0.00"N)
    Band 1 Block=86401x1 Type=Float32, ColorInterp=Gray



```python
lights = ras.read(1)
```


```python
summary_stats = zonal_stats(
    grid,
    lights,
    stats=["mean", "median", "std", "sum", "count", "majority", "minority"],
    nodata=-9999,
    all_touched=True,
    affine=ras.transform,
)
grid_lights = pd.DataFrame(summary_stats)
#grid_lights_df = pd.concat([mini_grid, grid_lights], axis=1)
grid_lights_df = pd.concat([grid, grid_lights], axis=1)
grid_lights_df.sort_values('sum', ascending=False)
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>id</th>
      <th>Longitude</th>
      <th>Latitude</th>
      <th>Centroid</th>
      <th>geometry</th>
      <th>mean</th>
      <th>count</th>
      <th>sum</th>
      <th>std</th>
      <th>median</th>
      <th>majority</th>
      <th>minority</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>846</th>
      <td>11255</td>
      <td>121.0</td>
      <td>14.6</td>
      <td>121.0E_14.6N</td>
      <td>POLYGON ((120.95000 14.65000, 121.05000 14.650...</td>
      <td>39.899291</td>
      <td>625</td>
      <td>24937.056641</td>
      <td>26.182847</td>
      <td>36.293320</td>
      <td>3.221558</td>
      <td>5.645538</td>
    </tr>
    <tr>
      <th>847</th>
      <td>11256</td>
      <td>121.0</td>
      <td>14.5</td>
      <td>121.0E_14.5N</td>
      <td>POLYGON ((120.95000 14.55000, 121.05000 14.550...</td>
      <td>27.149844</td>
      <td>625</td>
      <td>16968.652344</td>
      <td>22.075643</td>
      <td>21.040466</td>
      <td>5.193841</td>
      <td>4.344131</td>
    </tr>
    <tr>
      <th>925</th>
      <td>11422</td>
      <td>121.1</td>
      <td>14.6</td>
      <td>121.1E_14.6N</td>
      <td>POLYGON ((121.05000 14.65000, 121.15000 14.650...</td>
      <td>26.705556</td>
      <td>625</td>
      <td>16690.972656</td>
      <td>17.422376</td>
      <td>22.902454</td>
      <td>3.558174</td>
      <td>2.562212</td>
    </tr>
    <tr>
      <th>2497</th>
      <td>16141</td>
      <td>123.9</td>
      <td>10.3</td>
      <td>123.9E_10.3N</td>
      <td>POLYGON ((123.85000 10.35000, 123.95000 10.350...</td>
      <td>21.195981</td>
      <td>625</td>
      <td>13247.488281</td>
      <td>22.314316</td>
      <td>16.085100</td>
      <td>1.352901</td>
      <td>1.956591</td>
    </tr>
    <tr>
      <th>845</th>
      <td>11254</td>
      <td>121.0</td>
      <td>14.7</td>
      <td>121.0E_14.7N</td>
      <td>POLYGON ((120.95000 14.75000, 121.05000 14.750...</td>
      <td>18.982266</td>
      <td>625</td>
      <td>11863.916016</td>
      <td>8.802625</td>
      <td>16.736807</td>
      <td>5.831501</td>
      <td>6.557575</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>799</th>
      <td>11173</td>
      <td>120.9</td>
      <td>6.1</td>
      <td>120.9E_6.1N</td>
      <td>POLYGON ((120.85000 6.15000, 120.95000 6.15000...</td>
      <td>0.553645</td>
      <td>625</td>
      <td>346.028107</td>
      <td>0.194217</td>
      <td>0.519503</td>
      <td>0.537138</td>
      <td>0.295161</td>
    </tr>
    <tr>
      <th>13</th>
      <td>4969</td>
      <td>117.2</td>
      <td>8.6</td>
      <td>117.2E_8.6N</td>
      <td>POLYGON ((117.15000 8.65000, 117.25000 8.65000...</td>
      <td>0.542073</td>
      <td>625</td>
      <td>338.795410</td>
      <td>0.182789</td>
      <td>0.502757</td>
      <td>0.302524</td>
      <td>0.172664</td>
    </tr>
    <tr>
      <th>656</th>
      <td>10845</td>
      <td>120.7</td>
      <td>5.5</td>
      <td>120.7E_5.5N</td>
      <td>POLYGON ((120.65000 5.55000, 120.75000 5.55000...</td>
      <td>0.537135</td>
      <td>625</td>
      <td>335.709412</td>
      <td>0.170703</td>
      <td>0.512606</td>
      <td>0.236988</td>
      <td>0.304853</td>
    </tr>
    <tr>
      <th>480</th>
      <td>10345</td>
      <td>120.4</td>
      <td>5.4</td>
      <td>120.4E_5.4N</td>
      <td>POLYGON ((120.35000 5.45000, 120.45000 5.45000...</td>
      <td>0.530954</td>
      <td>625</td>
      <td>331.846313</td>
      <td>0.154982</td>
      <td>0.514432</td>
      <td>0.142907</td>
      <td>0.184473</td>
    </tr>
    <tr>
      <th>533</th>
      <td>10513</td>
      <td>120.5</td>
      <td>5.3</td>
      <td>120.5E_5.3N</td>
      <td>POLYGON ((120.45000 5.35000, 120.55000 5.35000...</td>
      <td>0.516410</td>
      <td>625</td>
      <td>322.756348</td>
      <td>0.200455</td>
      <td>0.486302</td>
      <td>0.458320</td>
      <td>0.161531</td>
    </tr>
  </tbody>
</table>
<p>3726 rows × 12 columns</p>
</div>




```python
grid_lights_df['count'].unique() #Great.. just 625 pixels per grid.
```




    array([625])



We can base our model on the median.


```python
#grid_lights_df.fillna(0).plot(column='median', legend=True, cmap='Reds')
grid_lights_df.plot(column='sum', legend=True, cmap='YlOrBr')
plt.title('Light intensity')
plt.show()
```



![png](07.0_light_index_files/07.0_light_index_16_0.png)



Include population data


```python
df_merge = pop_data.merge(grid_lights_df[['id', 'mean', 'median', 'sum' ,'std', 'geometry']], on='id')
df_merge.sort_values('sum', ascending=False)
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Unnamed: 0</th>
      <th>id</th>
      <th>numbuildings</th>
      <th>mean</th>
      <th>median</th>
      <th>sum</th>
      <th>std</th>
      <th>geometry</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>846</th>
      <td>846</td>
      <td>11255</td>
      <td>339220</td>
      <td>39.899291</td>
      <td>36.293320</td>
      <td>24937.056641</td>
      <td>26.182847</td>
      <td>POLYGON ((120.95000 14.65000, 121.05000 14.650...</td>
    </tr>
    <tr>
      <th>847</th>
      <td>847</td>
      <td>11256</td>
      <td>257806</td>
      <td>27.149844</td>
      <td>21.040466</td>
      <td>16968.652344</td>
      <td>22.075643</td>
      <td>POLYGON ((120.95000 14.55000, 121.05000 14.550...</td>
    </tr>
    <tr>
      <th>925</th>
      <td>925</td>
      <td>11422</td>
      <td>386116</td>
      <td>26.705556</td>
      <td>22.902454</td>
      <td>16690.972656</td>
      <td>17.422376</td>
      <td>POLYGON ((121.05000 14.65000, 121.15000 14.650...</td>
    </tr>
    <tr>
      <th>2497</th>
      <td>2497</td>
      <td>16141</td>
      <td>240830</td>
      <td>21.195981</td>
      <td>16.085100</td>
      <td>13247.488281</td>
      <td>22.314316</td>
      <td>POLYGON ((123.85000 10.35000, 123.95000 10.350...</td>
    </tr>
    <tr>
      <th>845</th>
      <td>845</td>
      <td>11254</td>
      <td>433261</td>
      <td>18.982266</td>
      <td>16.736807</td>
      <td>11863.916016</td>
      <td>8.802625</td>
      <td>POLYGON ((120.95000 14.75000, 121.05000 14.750...</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>799</th>
      <td>799</td>
      <td>11173</td>
      <td>240</td>
      <td>0.553645</td>
      <td>0.519503</td>
      <td>346.028107</td>
      <td>0.194217</td>
      <td>POLYGON ((120.85000 6.15000, 120.95000 6.15000...</td>
    </tr>
    <tr>
      <th>13</th>
      <td>13</td>
      <td>4969</td>
      <td>1</td>
      <td>0.542073</td>
      <td>0.502757</td>
      <td>338.795410</td>
      <td>0.182789</td>
      <td>POLYGON ((117.15000 8.65000, 117.25000 8.65000...</td>
    </tr>
    <tr>
      <th>656</th>
      <td>656</td>
      <td>10845</td>
      <td>229</td>
      <td>0.537135</td>
      <td>0.512606</td>
      <td>335.709412</td>
      <td>0.170703</td>
      <td>POLYGON ((120.65000 5.55000, 120.75000 5.55000...</td>
    </tr>
    <tr>
      <th>480</th>
      <td>480</td>
      <td>10345</td>
      <td>200</td>
      <td>0.530954</td>
      <td>0.514432</td>
      <td>331.846313</td>
      <td>0.154982</td>
      <td>POLYGON ((120.35000 5.45000, 120.45000 5.45000...</td>
    </tr>
    <tr>
      <th>533</th>
      <td>533</td>
      <td>10513</td>
      <td>0</td>
      <td>0.516410</td>
      <td>0.486302</td>
      <td>322.756348</td>
      <td>0.200455</td>
      <td>POLYGON ((120.45000 5.35000, 120.55000 5.35000...</td>
    </tr>
  </tbody>
</table>
<p>3726 rows × 8 columns</p>
</div>




```python
plt.plot(df_merge['sum'], df_merge.numbuildings, 'o')
plt.xlabel('Light index')
plt.ylabel('Households')
plt.title('Philippines')
plt.show()
```



![png](07.0_light_index_files/07.0_light_index_19_0.png)




```python
# Define the bins and labels
bins = [-float('inf'), 100, 1000, 10000, 20000, 50000, 100000, float('inf')]
labels = [0, 1, 2, 3, 4, 5, 6]


# Create the new column using pd.cut
df_merge['num_cat_N_bld'] = pd.cut(df_merge['numbuildings'], bins=bins, labels=labels, include_lowest=True)
geo_merged = gpd.GeoDataFrame(df_merge, geometry='geometry')
#df_merge['num_cat_pop'] = pd.cut(df_merge['total_pop'], bins=bins, labels=labels, include_lowest=True)
```


```python
fig, ax  = plt.subplots(1,2, figsize=(10,6))
geo_merged.plot(column='sum', legend=True, cmap='YlOrBr', ax=ax[0])
ax[0].set_title('Light intensity')

geo_merged.plot(column='num_cat_N_bld', legend=True, cmap='YlOrBr', ax=ax[1])
ax[1].set_title('Households')

# Customize the legend labels
legend_labels = {
    0: '<100',
    1: '100 - 1000',
    2: '1000 - 10000',
    3: '10000 - 20000',
    4: '20000 - 50000',
    5: '50000 - 100000',
    6: '> 100000'
}

# Get the current legend
legend1 = ax[1].get_legend()

# Customize the legend labels using legend_labels dictionary
for key, label in legend_labels.items():
    legend1.get_texts()[key].set_text(label)

plt.tight_layout()
plt.show()
```



![png](07.0_light_index_files/07.0_light_index_21_0.png)



Povery index


```python
geo_merged['PI'] = geo_merged['numbuildings'] / geo_merged['sum']
```


```python
geo_merged.plot(column='PI', legend=True, cmap='YlOrBr')
plt.title('PI')
plt.show()
```



![png](07.0_light_index_files/07.0_light_index_24_0.png)



Comparisons between this and the IWI


```python
iwi = pd.read_csv(output_dir / 'phl_iwi_bygrid_new.csv')
```


```python
iwi_pi = geo_merged.merge(iwi, left_on='id', right_on='grid_point_id')
```


```python
iwi_vals = iwi_pi.IWI
pi_vals = iwi_pi.PI


plt.plot(iwi_vals, pi_vals, 'o', alpha=0.5)
plt.xlabel('IWI')
plt.ylabel('PI')

plt.show()
```



![png](07.0_light_index_files/07.0_light_index_28_0.png)



## Save it


```python
df_merge[['id', 'sum']].to_csv(output_dir / "light_index.csv", index=False)
```
