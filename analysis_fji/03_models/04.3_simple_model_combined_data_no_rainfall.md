---
jupyter:
  jupytext:
    text_representation:
      extension: .md
      format_name: markdown
      format_version: '1.3'
      jupytext_version: 1.15.2
  kernelspec:
    display_name: env1
    language: python
    name: python3
---

```python
import matplotlib.pyplot as plt
import numpy as np
import pandas as pd

from utils import get_combined_dataset, xgb_model_combined_data_LOOCV
```

```python
# Load dataset
df_combined = get_combined_dataset()
df_fji = df_combined[df_combined.country == 'fji']

# Typhoons
fji_typhoons = df_fji.typhoon_name.unique()

# Features
features = [
    "wind_speed",
    "track_distance",
    "total_houses",
    "rainfall_max_6h",
    "rainfall_max_24h",
    "coast_length",
    "with_coast",
    "mean_elev",
    "mean_slope",
]

# Features NO Rainfall
features_drop = [
    "wind_speed",
    "track_distance",
    "total_houses",
    #"rainfall_max_6h",
    #"rainfall_max_24h",
    "coast_length",
    "with_coast",
    "mean_elev",
    "mean_slope",
]
```

```python
# Stratification
dmg = np.array(df_fji.percent_houses_damaged.to_list())
zero_dmg = np.round((np.count_nonzero(dmg == 0) / len(dmg)) , 2 )

# Define ranges for each group
x0 = list(np.linspace(0, zero_dmg, 1))   # zero damage
x1 = list(np.linspace(zero_dmg, 0.93, 2))  # almost no damage
x2 = list(np.linspace(0.935, 1, 5))  # all the damage
x3=x0+x1+x2

bins = []
for i in x3:
    bins.append(np.quantile(dmg, i))

# Histogram after stratification
samples_per_bin_fji, bins_def_fji = np.histogram(dmg, bins=bins)

# Define number of bins
num_bins_fji = len(samples_per_bin_fji)

# For future plots
str_bin_fji = []
for i in range(len(bins_def_fji[:-1])):
    a = str(np.round(bins_def_fji[i+1],3))
    b = str(np.round(bins_def_fji[i],3))
    str_bin_fji.append('{} - {}'.format(b,a))
```

### Models including zero windspeed values

```python
# XGB model with Rainfall data
y_test_typhoon_fji, y_pred_typhoon_fji, rmse_strat_fji, avg_error_strat_fji = xgb_model_combined_data_LOOCV(
    df_combined=df_combined,
    df_fji=df_fji,
    bins=bins_def_fji,
    fji_weight=2,
    features=features
)
```

```python
# XGB model without Rainfall data
y_test_typhoon_fji_less, y_pred_typhoon_fji_less, rmse_strat_fji_less, avg_error_strat_fji_less = xgb_model_combined_data_LOOCV(
    df_combined=df_combined,
    df_fji=df_fji,
    bins=bins_def_fji,
    fji_weight=2,
    features=features_drop
)
```

### Compare results

```python
fig, ax = plt.subplots(1,2, figsize=(10,6))

ax[0].plot(range(num_bins_fji), rmse_strat_fji, 'o', label="Including Rainfall")
ax[0].plot(range(num_bins_fji), rmse_strat_fji_less, 'ro', label="Without Rainfall")
ax[0].set_xlabel('Damage [%]')
ax[0].set_ylabel('RMSE')
ax[0].set_xticks(range(num_bins_fji), str_bin_fji, rotation=45)
ax[0].grid()
ax[0].legend(loc='upper left')

ax[1].plot(range(num_bins_fji), avg_error_strat_fji, 'o', label="Including Rainfall")
ax[1].plot(range(num_bins_fji), avg_error_strat_fji_less, 'ro', label="Without Rainfall")
ax[1].set_xlabel('Damage [%]')
ax[1].set_ylabel('Avg error ')
ax[1].set_xticks(range(num_bins_fji), str_bin_fji, rotation=45)
ax[1].grid()
ax[1].legend(loc='upper left')

plt.suptitle('XGBoost Regression model trained on Philippines+Fiji \ndataset using LOOCV for Fiji typhoons')
plt.tight_layout()
plt.show()
```

We should definetly consider rainfall data in our models.
