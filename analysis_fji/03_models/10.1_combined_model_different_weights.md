```python
import matplotlib.pyplot as plt
from matplotlib.colors import Normalize
import matplotlib.patches as mpatches
import numpy as np
import os
from pathlib import Path
import pandas as pd
import geopandas as gpd
from climada.hazard import Centroids, TCTracks, TropCyclone
from shapely.geometry import LineString
from sklearn.metrics import mean_squared_error
from xgboost.sklearn import XGBRegressor
import geopandas as gpd
from climada.hazard import Centroids, TCTracks, TropCyclone
from shapely.geometry import LineString
from xgboost import plot_importance
import shap
import ast

from utils import get_combined_dataset_interpolated_with_viet_new_bld_count_using_pop, get_training_dataset_complete_interpolated_new_bld_count_using_pop , get_municipality_grids, xgb_model_combined_data_with_viet_LOOCV
```

    IProgress not found. Please update jupyter and ipywidgets. See https://ipywidgets.readthedocs.io/en/stable/user_install.html


## Loading data


```python
# For Checking (Number of buildings destroyed per mun)
input_dir = (
    Path(os.getenv("STORM_DATA_DIR"))
    / "analysis_fji/02_model_features/02_housing_damage/input/"
)
actual_mun_dmg = pd.read_csv(input_dir / "fji_building_damage_mun_complete.csv")
actual_mun_dmg['typhoon'] = actual_mun_dmg['typhoon'].str.upper()

# Load Fiji Shapefile
fiji = gpd.read_file(
    input_dir / "adm2_shp_fixed.gpkg"
)
fiji = fiji.to_crs('EPSG:4326')

# Load grid
grid_dir = (
    Path(os.getenv("STORM_DATA_DIR"))
    / "analysis_fji/02_model_features/02_housing_damage/output/"
)
grid = gpd.read_file(grid_dir / "fji_0.1_degree_grid_land_overlap_new.gpkg")


# Load typhoon track
tracks_dir = (
    Path(os.getenv("STORM_DATA_DIR"))
    / "analysis_fji/02_model_features/01_windfield"
)
typhoons_info = pd.read_csv(tracks_dir / "typhoons.csv")
typhoons_info.typhoon_name = typhoons_info.typhoon_name.str.upper()
cyclones = actual_mun_dmg['typhoon'].unique()
intersection = typhoons_info[typhoons_info['typhoon_name'].isin(cyclones)].drop_duplicates(keep='last', subset = ['typhoon_name'])

# Damage data Vietnam
input_dir_viet = (
    Path(os.getenv("STORM_DATA_DIR"))
    / "analysis_viet/02_model_features/02_housing_damage/input/"
)
damage_data_viet = pd.read_csv(input_dir_viet / 'viet_damage_adm1_level.csv')
damage_data_viet['region_affected'] = damage_data_viet['region_affected'].astype('str').apply(ast.literal_eval)
```


```python
# Features
features_old = [
    "wind_speed",
    "track_distance",
    "total_houses",
    "rainfall_max_6h",
    "rainfall_max_24h",
    "coast_length",
    "with_coast",
    "mean_elev",
    "mean_slope",
]
features_IWI = features_old + ["IWI"]
features_light = features_old + ["light_index"]
features_all = features_old + ["IWI", "light_index"]
```


```python
# Load Fiji complete interpolated new 2 (using pop data to bld count)
df_fji_complete_int = get_training_dataset_complete_interpolated_new_bld_count_using_pop()
df_fji_complete_int = df_fji_complete_int[df_fji_complete_int.typhoon_name != 'ANA'] # Drop ANA
df_fji_complete_int = df_fji_complete_int.rename({
    "mean_altitude": "mean_elev",
    "total_buildings": "total_houses",
    "perc_dmg_grid": "percent_houses_damaged"
}, axis=1)
df_fji_complete_int = df_fji_complete_int[features_all + ['typhoon_name', 'grid_point_id', 'Centroid', 'percent_houses_damaged']]

# Load combined dataset interpolated
df_combined_with_viet = get_combined_dataset_interpolated_with_viet_new_bld_count_using_pop()
df_fji_with_viet = df_combined_with_viet[df_combined_with_viet.country == 'fji']
```

## Stratification


```python
# Stratification
dmg = np.array(df_fji_with_viet.percent_houses_damaged.to_list())
zero_dmg = np.round((np.count_nonzero(dmg == 0) / len(dmg)) , 2 )

# Define ranges for each group
x0 = list(np.linspace(0, zero_dmg, 1))   # zero damage
x1 = list(np.linspace(zero_dmg, 0.9, 2))  # almost no damage
x2 = list(np.linspace(0.935, 1, 5))  # all the damage
x3=x0+x1+x2

bins = []
for i in x3:
    bins.append(np.quantile(dmg, i))

# Histogram after stratification
samples_per_bin_fji, bins_def_fji = np.histogram(dmg, bins=bins)

# Define number of bins
num_bins_fji = len(samples_per_bin_fji)

# For future plots
str_bin_fji = []
for i in range(len(bins_def_fji[:-1])):
    a = str(np.round(bins_def_fji[i+1],3))
    b = str(np.round(bins_def_fji[i],3))
    str_bin_fji.append('{} - {}'.format(b,a))
```

## The models (defferent discrete weight ratios)


```python
# Fji + Phl + Viet (with IWI)
y_test_typhoon_fji_weight, y_pred_typhoon_fji_weight, rmse_strat_fji_weight, avg_error_strat_fji_weight = xgb_model_combined_data_with_viet_LOOCV(
    df_combined=df_combined_with_viet,
    df_fji=df_fji_with_viet,
    bins=bins_def_fji,
    fji_weight=3,
    phl_weight=1,
    features=features_IWI
)

# Fji + Phl + Viet (with IWI)
y_test_typhoon_phl_weight, y_pred_typhoon_phl_weight, rmse_strat_phl_weight, avg_error_strat_phl_weight = xgb_model_combined_data_with_viet_LOOCV(
    df_combined=df_combined_with_viet,
    df_fji=df_fji_with_viet,
    bins=bins_def_fji,
    fji_weight=1,
    phl_weight=3,
    features=features_IWI
)

# Fji + Phl + Viet (with IWI)
y_test_typhoon_same_weight, y_pred_typhoon_same_weight, rmse_strat_same_weight, avg_error_strat_same_weight = xgb_model_combined_data_with_viet_LOOCV(
    df_combined=df_combined_with_viet,
    df_fji=df_fji_with_viet,
    bins=bins_def_fji,
    fji_weight=3,
    phl_weight=3,
    features=features_IWI
)
```

    Mean of empty slice
    Mean of empty slice
    Mean of empty slice
    Mean of empty slice
    Mean of empty slice
    Mean of empty slice


## Results per bin


```python
fig, ax = plt.subplots(1,1, figsize=(6,6))

ax.plot(range(num_bins_fji), rmse_strat_fji_weight, 'rs', alpha=0.5, label='FJI-PHL ratio 3:1')
ax.plot(range(num_bins_fji), rmse_strat_phl_weight, 'gs', alpha=0.5, label='FJI-PHL ratio 1:3')
ax.plot(range(num_bins_fji), rmse_strat_same_weight, 'bs', alpha=0.5, label='FJI-PHL ratio 3:3')


ax.set_xticks(range(num_bins_fji), str_bin_fji, rotation=45)
ax.set_xlabel('Damage [%]')
ax.set_ylabel('RMSE')
ax.grid()
ax.set_title('XGBoost Regression model (PHL+VIET+FJI) \n using LOOCV for Fiji typhoons \n FJI-PHL weight ratios, VIET weight=1')
ax.legend()

plt.tight_layout()
plt.show()
```



![png](10.1_combined_model_different_weights_files/10.1_combined_model_different_weights_10_0.png)



## Iterative proccess


```python
rmse_strat_df = pd.DataFrame()
for i in range(6):
    for j in range(6):
        if i>0 and j>0:
            # Fji + Phl + Viet (with IWI)
            y_test_typhoon, y_pred_typhoon, rmse_strat, avg_error_strat = xgb_model_combined_data_with_viet_LOOCV(
                df_combined=df_combined_with_viet,
                df_fji=df_fji_with_viet,
                bins=bins_def_fji,
                fji_weight=i,
                phl_weight=j,
                viet_weight=1,
                features=features_IWI
                )
            df_aux = pd.DataFrame({
                'fji_weight':i,
                'phl_weight':j,
                'rmse_strat':rmse_strat
            })
            rmse_strat_df = pd.concat([rmse_strat_df, df_aux])
```

    Mean of empty slice
    Mean of empty slice
    Mean of empty slice
    Mean of empty slice
    Mean of empty slice
    Mean of empty slice
    Mean of empty slice
    Mean of empty slice
    Mean of empty slice
    Mean of empty slice
    Mean of empty slice
    Mean of empty slice
    Mean of empty slice
    Mean of empty slice
    Mean of empty slice
    Mean of empty slice
    Mean of empty slice
    Mean of empty slice
    Mean of empty slice
    Mean of empty slice
    Mean of empty slice
    Mean of empty slice
    Mean of empty slice
    Mean of empty slice
    Mean of empty slice
    Mean of empty slice
    Mean of empty slice
    Mean of empty slice
    Mean of empty slice
    Mean of empty slice
    Mean of empty slice
    Mean of empty slice
    Mean of empty slice
    Mean of empty slice
    Mean of empty slice
    Mean of empty slice
    Mean of empty slice
    Mean of empty slice
    Mean of empty slice
    Mean of empty slice
    Mean of empty slice
    Mean of empty slice
    Mean of empty slice
    Mean of empty slice
    Mean of empty slice
    Mean of empty slice
    Mean of empty slice
    Mean of empty slice
    Mean of empty slice
    Mean of empty slice



```python
df_weights = rmse_strat_df.dropna()
df_weights_fixed = pd.DataFrame(df_weights.groupby(['fji_weight', 'phl_weight'])['rmse_strat'].apply(lambda x: x.tolist())).reset_index()

df_weights_fixed.head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>fji_weight</th>
      <th>phl_weight</th>
      <th>rmse_strat</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>1</td>
      <td>[0.5651603471336841, 1.3953495365606712, 1.509...</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1</td>
      <td>2</td>
      <td>[0.666756109984948, 1.5592648758533414, 2.2205...</td>
    </tr>
    <tr>
      <th>2</th>
      <td>1</td>
      <td>3</td>
      <td>[0.9234816200938893, 1.9090324278341828, 2.111...</td>
    </tr>
    <tr>
      <th>3</th>
      <td>1</td>
      <td>4</td>
      <td>[1.1426595590318003, 2.210907512708238, 2.3637...</td>
    </tr>
    <tr>
      <th>4</th>
      <td>1</td>
      <td>5</td>
      <td>[1.2084234518627295, 2.928941282482052, 2.4693...</td>
    </tr>
  </tbody>
</table>
</div>



Lowest rmse In the last Bin


```python
idx_min = df_weights_fixed.rmse_strat.apply(lambda x: x[-1]).idxmin()
# Find the row with the minimum RMSE in the last bin
min_rmse_row = df_weights_fixed.iloc[idx_min]

# Extract FJI and PHL weights from the row with the minimum RMSE
fji_weight_min_rmse_last_bin = min_rmse_row['fji_weight']
phl_weight_min_rmse_last_bin = min_rmse_row['phl_weight']

print("FJI weight with lowest RMSE:", fji_weight_min_rmse_last_bin)
print("PHL weight with lowest RMSE:", phl_weight_min_rmse_last_bin)
```

    FJI weight with lowest RMSE: 1
    PHL weight with lowest RMSE: 3


Lowest mean RMSE


```python
# Group the dataframe by FJI and PHL weights, then calculate the mean RMSE for each group
mean_rmse_by_weights = rmse_strat_df.groupby(['fji_weight', 'phl_weight'])['rmse_strat'].mean()

# Find the combination with the lowest overall RMSE
min_rmse_weights = mean_rmse_by_weights.idxmin()
fji_weight_min_rmse_mean = min_rmse_weights[0]
phl_weight_min_rmse_mean = min_rmse_weights[1]

print("FJI weight with lowest overall RMSE:", fji_weight_min_rmse_mean)
print("PHL weight with lowest overall RMSE:", phl_weight_min_rmse_mean)
```

    FJI weight with lowest overall RMSE: 4
    PHL weight with lowest overall RMSE: 1



```python
# Filter the dataframe to include only the rows with the minimum overall RMSE and minimum last bin RMSE
min_rmse_overall_df = df_weights_fixed[(df_weights_fixed['fji_weight'] == fji_weight_min_rmse_mean) & (df_weights_fixed['phl_weight'] == phl_weight_min_rmse_mean)]
min_rmse_last_bin_df = df_weights_fixed[(df_weights_fixed['fji_weight'] == fji_weight_min_rmse_last_bin) & (df_weights_fixed['phl_weight'] == phl_weight_min_rmse_last_bin)]


# Extract data from the current row
fig, ax = plt.subplots(1,1)
# Plot the data
ax.plot(range(num_bins_fji)[1:], min_rmse_overall_df['rmse_strat'].iloc[0], 'o', alpha=0.4, label='FJI-PHL ratio {}:{} --> Lowest total RMSE'.format(fji_weight_min_rmse_mean, phl_weight_min_rmse_mean))
ax.plot(range(num_bins_fji)[1:], min_rmse_last_bin_df['rmse_strat'].iloc[0], 'o', alpha=0.4, label='FJI-PHL ratio {}:{} --> Lowest HD RMSE'.format(fji_weight_min_rmse_last_bin, phl_weight_min_rmse_last_bin))

ax.set_xticks(range(num_bins_fji)[1:], str_bin_fji[1:], rotation=45)
ax.set_xlabel('Damage [%]')
ax.set_ylabel('RMSE')
ax.grid()
ax.set_title('XGBoost Regression model (PHL+VIET+FJI) \n using LOOCV for Fiji typhoons \n FJI-PHL weight ratios, VIET weight=1')
ax.legend()

plt.tight_layout()
plt.show()
```



![png](10.1_combined_model_different_weights_files/10.1_combined_model_different_weights_18_0.png)




```python
# Initialize the plot
fig, ax = plt.subplots()

# Iterate over each row in the dataframe
for idx, row in df_weights_fixed.iterrows():
    # Extract data from the current row
    rmse_strat_fji_weight = row['rmse_strat']

    # Plot the data
    ax.plot(range(num_bins_fji)[1:], rmse_strat_fji_weight, 'o', alpha=0.4, label=f'FJI-PHL ratio {row["fji_weight"]}:{row["phl_weight"]}')

ax.set_xticks(range(num_bins_fji)[1:], str_bin_fji[1:], rotation=45)
ax.set_xlabel('Damage [%]')
ax.set_ylabel('RMSE')
ax.grid()
ax.set_title('XGBoost Regression model (PHL+VIET+FJI) \n using LOOCV for Fiji typhoons \n FJI-PHL weight ratios, VIET weight=1')
#ax.legend()

plt.tight_layout()
plt.show()
```



![png](10.1_combined_model_different_weights_files/10.1_combined_model_different_weights_19_0.png)
