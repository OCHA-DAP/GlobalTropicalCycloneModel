```python
import matplotlib.pyplot as plt
from matplotlib.colors import Normalize
import matplotlib.patches as mpatches
import numpy as np
import os
from pathlib import Path
import pandas as pd
import geopandas as gpd
from climada.hazard import Centroids, TCTracks, TropCyclone
from shapely.geometry import LineString

from utils import get_combined_dataset_smooth, get_combined_dataset, xgb_model_combined_data_LOOCV, get_training_dataset_complete, get_municipality_grids
```


```python
# For Checking (Number of buildings destroyed per mun)
input_dir = (
    Path(os.getenv("STORM_DATA_DIR"))
    / "analysis_fji/02_model_features/02_housing_damage/input/"
)
actual_mun_dmg = pd.read_csv(input_dir / "fji_building_damage_mun_complete.csv")
actual_mun_dmg['typhoon'] = actual_mun_dmg['typhoon'].str.upper()

# Load Fiji Shapefile
fiji = gpd.read_file(
    input_dir / "adm2_shp_fixed.gpkg"
)
fiji = fiji.to_crs('EPSG:4326')

# Load grid
grid_dir = (
    Path(os.getenv("STORM_DATA_DIR"))
    / "analysis_fji/02_model_features/02_housing_damage/output/"
)
grid = gpd.read_file(grid_dir / "fji_0.1_degree_grid_land_overlap_new.gpkg")


# Load typhoon track
tracks_dir = (
    Path(os.getenv("STORM_DATA_DIR"))
    / "analysis_fji/02_model_features/01_windfield"
)
typhoons_info = pd.read_csv(tracks_dir / "typhoons.csv")
typhoons_info.typhoon_name = typhoons_info.typhoon_name.str.upper()
cyclones = actual_mun_dmg['typhoon'].unique()
intersection = typhoons_info[typhoons_info['typhoon_name'].isin(cyclones)].drop_duplicates(keep='last', subset = ['typhoon_name'])
```


```python
# Load dataset
df_combined = get_combined_dataset()
df_fji = df_combined[df_combined.country == 'fji']

# Load dataset SMOOTH windfields
df_combined_smooth = get_combined_dataset_smooth()
df_fji_smooth = df_combined_smooth[df_combined_smooth.country == 'fji']

# Typhoons
fji_typhoons = df_fji.typhoon_name.unique()

# Features
features = [
    "wind_speed",
    "track_distance",
    "total_houses",
    "rainfall_max_6h",
    "rainfall_max_24h",
    "coast_length",
    "with_coast",
    "mean_elev",
    "mean_slope",
]
```


```python
# Add smooth windfields here for Philippines

df_phl = df_combined_smooth[df_combined_smooth.country == 'phl']


# Drop GONI (its duplicated and confussing). Should work with it later.
df_phl_filt = df_phl[df_phl.typhoon_name != 'GONI']

# Load smoothed winfields
input_dir_phl = (
    Path(os.getenv("STORM_DATA_DIR"))
    / "analysis/02_model_features/01_windfield/"
)
wind_smooth_phl = pd.read_csv(input_dir_phl / "windfield_data_phl_smoothed.csv")

wind_smooth_phl.merge(df_phl, on=['typhoon_name', 'track_distance']).typhoon_name.unique()
```




    array(['CONSON', 'HAIYAN', 'USAGI', 'UTOR', 'RAMMASUN', 'LINGLING',
           'NOUL', 'GONI', 'TOKAGE', 'MERANTI', 'NOCK-TEN', 'SARIKA',
           'KAMMURI', 'PHANFONE', 'SAUDEL', 'VONGFONG', 'MOLAVE'],
          dtype=object)




```python
# Stratification
dmg = np.array(df_fji.percent_houses_damaged.to_list())
zero_dmg = np.round((np.count_nonzero(dmg == 0) / len(dmg)) , 2 )

# Define ranges for each group
x0 = list(np.linspace(0, zero_dmg, 1))   # zero damage
x1 = list(np.linspace(zero_dmg, 0.93, 2))  # almost no damage
x2 = list(np.linspace(0.935, 1, 5))  # all the damage
x3=x0+x1+x2

bins = []
for i in x3:
    bins.append(np.quantile(dmg, i))

# Histogram after stratification
samples_per_bin_fji, bins_def_fji = np.histogram(dmg, bins=bins)

# Define number of bins
num_bins_fji = len(samples_per_bin_fji)

# For future plots
str_bin_fji = []
for i in range(len(bins_def_fji[:-1])):
    a = str(np.round(bins_def_fji[i+1],3))
    b = str(np.round(bins_def_fji[i],3))
    str_bin_fji.append('{} - {}'.format(b,a))
```


```python
# Drop ANA typhoon
df_combined_noana = df_combined[df_combined.typhoon_name != 'ANA']
df_fji_noana= df_fji[df_fji.typhoon_name != 'ANA']
fji_typhoons = df_fji_noana.typhoon_name.unique()

# Drop ANA typhoon on Smooth datasets
df_combined_noana_smooth = df_combined_smooth[df_combined_smooth.typhoon_name != 'ANA']
df_fji_noana_smooth = df_fji_smooth[df_fji_smooth.typhoon_name != 'ANA']
```


```python
# Run XGB

# WITH smoothing
y_test_typhoon_smooth, y_pred_typhoon_smooth, rmse_strat_smooth, avg_error_strat_smooth = xgb_model_combined_data_LOOCV(
    df_combined=df_combined_noana_smooth,
    df_fji=df_fji_noana_smooth,
    bins=bins_def_fji,
    fji_weight=6,
    features=features
)

# WITHOUT smoothing
y_test_typhoon_classic, y_pred_typhoon_classic, rmse_strat_classic, avg_error_strat_classic = xgb_model_combined_data_LOOCV(
    df_combined=df_combined_noana,
    df_fji=df_fji_noana,
    bins=bins_def_fji,
    fji_weight=6,
    features=features
)
```


```python
fig, ax = plt.subplots(1,1, figsize=(6,6))

ax.plot(range(num_bins_fji), rmse_strat_smooth, 'bs', label='With smooth windfield')
ax.plot(range(num_bins_fji), rmse_strat_classic, 'gs', label='No windspeed smoothing')

ax.set_xticks(range(num_bins_fji), str_bin_fji, rotation=45)
ax.set_xlabel('Damage [%]')
ax.set_ylabel('RMSE')
ax.grid()
ax.set_title('XGBoost Regression model trained on Philippines+Fiji \ndataset using LOOCV for Fiji typhoons')
ax.legend()

plt.tight_layout()
plt.show()
```



![png](05.5_combined_model_smooth_files/05.5_combined_model_smooth_7_0.png)



## Results at municipality level


```python
# Fiji typhoons
fji_typhoons = df_fji_noana.typhoon_name.unique()

# Calculate buildings destroyed by municipality and % of buildings destroyed by mun
mun_id = get_municipality_grids()[['id','NAME_2']]

def num_bld_destroyed_mun(mun, typhoon, y_pred_typhoon, df_fji, real=False):
    k = fji_typhoons.tolist().index(typhoon)
    df_typhoon = df_fji[df_fji.typhoon_name==typhoon]
    # Add feature "predictive_damage"
    df_typhoon['predicted_damage'] = y_pred_typhoon[k]

    mun_ids = mun_id[mun_id.NAME_2 == mun].id.to_list()
    cells_in_mun = df_typhoon[df_typhoon.typhoon_name == typhoon].set_index('grid_point_id').loc[mun_ids]

    if real:
        damage_grid = np.array(cells_in_mun.percent_houses_damaged.to_list()) # Real dmg
    else:
        damage_grid = np.array(cells_in_mun.predicted_damage.to_list()) # Dmg predicted by cell

    # Number of buildings
    N_bld_grid = np.array(cells_in_mun.total_houses.to_list()) # Bld by cell
    N_bld_mun = np.sum(N_bld_grid) # Total bld in mun

    # Calculate % of buildings (and N of bld) destroyed by mun
    N_bld_dest_pred_mun = np.sum(damage_grid) * (N_bld_mun / 100)
    perc_destroyed_mun = np.sum(damage_grid)

    return N_bld_dest_pred_mun, perc_destroyed_mun

def calculate_actual_perc_dmg(x, i, y_pred_typhoon, df_fji, typhoon):
    try:
        return num_bld_destroyed_mun(mun=x['NAME_2'], typhoon=typhoon, y_pred_typhoon=y_pred_typhoon, df_fji=df_fji, real=True)[i]
    except:
        return 0
def calculate_pred_perc_dmg(x, i, y_pred_typhoon, df_fji, typhoon):
    try:
        return num_bld_destroyed_mun(mun=x['NAME_2'], typhoon=typhoon, y_pred_typhoon=y_pred_typhoon, df_fji=df_fji, real=False)[i]
    except:
        return 0
```
