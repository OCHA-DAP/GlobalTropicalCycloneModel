```python
import matplotlib.pyplot as plt
from matplotlib.colors import Normalize
import matplotlib.patches as mpatches
import numpy as np
import os
from pathlib import Path
import pandas as pd
# import shap
from sklearn.metrics import mean_squared_error
from xgboost.sklearn import XGBRegressor
import geopandas as gpd
from climada.hazard import Centroids, TCTracks, TropCyclone
from shapely.geometry import LineString
from xgboost import plot_importance
import shap

from utils import get_combined_dataset, xgb_model_combined_data_LOOCV, get_training_dataset_complete, get_municipality_grids
```

    IProgress not found. Please update jupyter and ipywidgets. See https://ipywidgets.readthedocs.io/en/stable/user_install.html



```python
# Load dataset
df_combined = get_combined_dataset()
df_fji = df_combined[df_combined.country == 'fji']

# Drop ANA
df_combined_noana = df_combined[df_combined.typhoon_name != 'ANA']

# Features
features = [
    "wind_speed",
    "track_distance",
    "total_houses",
    "rainfall_max_6h",
    "rainfall_max_24h",
    "coast_length",
    "with_coast",
    "mean_elev",
    "mean_slope",
]
```


```python
input_dir = (
    Path(os.getenv("STORM_DATA_DIR"))
    / "analysis_fji/02_model_features/02_housing_damage/input/"
)
# Actual damage
actual_mun_dmg = pd.read_csv(input_dir / "fji_building_damage_mun_complete.csv")
actual_mun_dmg['typhoon'] = actual_mun_dmg['typhoon'].str.upper()

# Load Fiji Shapefile
fiji = gpd.read_file(
    input_dir / "adm2_shp_fixed.gpkg"
)
fiji = fiji.to_crs('EPSG:4326')

# Load grid
grid_dir = (
    Path(os.getenv("STORM_DATA_DIR"))
    / "analysis_fji/02_model_features/02_housing_damage/output/"
)
grid = gpd.read_file(grid_dir / "fji_0.1_degree_grid_land_overlap_new.gpkg")


# Load typhoon track
tracks_dir = (
    Path(os.getenv("STORM_DATA_DIR"))
    / "analysis_fji/02_model_features/01_windfield"
)
typhoons_info = pd.read_csv(tracks_dir / "typhoons.csv")
typhoons_info.typhoon_name = typhoons_info.typhoon_name.str.upper()
cyclones = actual_mun_dmg['typhoon'].unique()
intersection = typhoons_info[typhoons_info['typhoon_name'].isin(cyclones)].drop_duplicates(keep='last', subset = ['typhoon_name'])
```


```python
# Load Fiji complete
df_fji_complete = get_training_dataset_complete()
df_fji_complete = df_fji_complete[df_fji_complete.typhoon_name != 'ANA'] # Drop ANA
df_fji_complete = df_fji_complete.rename({
    "mean_altitude": "mean_elev",
    "total_buildings": "total_houses",
    "perc_dmg_grid": "percent_houses_damaged"
}, axis=1)
df_fji_complete = df_fji_complete[features + ['typhoon_name', 'grid_point_id', 'Centroid', 'percent_houses_damaged']]
```

## Windspeed and Track Distance


```python
fig, ax = plt.subplots(1,2, figsize=(10,6))
df_fji_complete.plot(kind='scatter', x='track_distance', y='wind_speed', c='percent_houses_damaged',
                alpha=0.7, cmap='Reds',ax=ax[0])
ax[0].set_xlabel('Track Distance [Km]')
ax[0].set_ylabel('Windspeed [m/s]')
ax[0].set_title('Fiji typhoons')

df_combined.plot(kind='scatter', x='track_distance', y='wind_speed', c='percent_houses_damaged',
                alpha=0.7, cmap='Reds',ax=ax[1])
ax[1].set_xlabel('Track Distance [Km]')
ax[1].set_ylabel('Windspeed [m/s]')
ax[1].set_title('All typhoons')

plt.show()
```



![png](05.4_combined_model_define_thres_windspeed_files/05.4_combined_model_define_thres_windspeed_5_0.png)



## Modify value of windspeed based on surrounding values of windspeed


```python
yasa_gpd = gpd.GeoDataFrame(df_fji_complete[df_fji_complete.typhoon_name=='YASA'].merge(
    grid,
    left_on='grid_point_id',
    right_on='id'))

winston_gpd = gpd.GeoDataFrame(df_fji_complete[df_fji_complete.typhoon_name=='WINSTON'].merge(
    grid,
    left_on='grid_point_id',
    right_on='id'))

# Load track for Yasa
id = intersection[intersection['typhoon_name'] == 'YASA'].typhoon_id.to_list()
track = TCTracks.from_ibtracs_netcdf(storm_id=id)
tc_track = track.get_track()
points_ib = gpd.points_from_xy(tc_track.lon, tc_track.lat)
tc_track_line_ib = LineString(points_ib)
geometries_ib = gpd.GeoSeries([tc_track_line_ib])

line_gdf_ib_yasa = gpd.GeoDataFrame(geometry=geometries_ib)

# Load track for Winston
id = intersection[intersection['typhoon_name'] == 'WINSTON'].typhoon_id.to_list()
track = TCTracks.from_ibtracs_netcdf(storm_id=id)
tc_track = track.get_track()
points_ib = gpd.points_from_xy(tc_track.lon, tc_track.lat)
tc_track_line_ib = LineString(points_ib)
geometries_ib = gpd.GeoSeries([tc_track_line_ib])

line_gdf_ib_winston = gpd.GeoDataFrame(geometry=geometries_ib)

fig, ax = plt.subplots(1,2, figsize=(10,5))
cmap = 'Reds'

yasa_gpd.plot(column='wind_speed', cmap=cmap, linewidth=0.2, ax=ax[0], edgecolor='0.3', legend=True)
line_gdf_ib_yasa.plot(ax=ax[0], color='k', linewidth=1, label='Typhoon track')

winston_gpd.plot(column='wind_speed', cmap=cmap, linewidth=0.2, ax=ax[1], edgecolor='0.3', legend=True)
line_gdf_ib_winston.plot(ax=ax[1], color='k', linewidth=1, label='Typhoon track')

ax[0].axis('off')
ax[1].axis('off')

ax[0].set_xlim(176, 182)
ax[0].set_ylim(-20, -12)
ax[1].set_xlim(176, 182)
ax[1].set_ylim(-20, -12)

ax[0].set_title('Windspeed [m/s], YASA', size=10)
ax[1].set_title('Windspeed [m/s], WINSTON', size=10)

plt.tight_layout()
plt.show()
```

    2023-12-07 17:02:20,936 - climada.hazard.tc_tracks - WARNING - The cached IBTrACS data set dates from 2023-06-07 23:07:38 (older than 180 days). Very likely, a more recent version is available. Consider manually removing the file /Users/federico/climada/data/IBTrACS.ALL.v04r00.nc and re-running this function, which will download the most recent version of the IBTrACS data set from the official URL.
    2023-12-07 17:02:25,678 - climada.hazard.tc_tracks - WARNING - The cached IBTrACS data set dates from 2023-06-07 23:07:38 (older than 180 days). Very likely, a more recent version is available. Consider manually removing the file /Users/federico/climada/data/IBTrACS.ALL.v04r00.nc and re-running this function, which will download the most recent version of the IBTrACS data set from the official URL.




![png](05.4_combined_model_define_thres_windspeed_files/05.4_combined_model_define_thres_windspeed_7_1.png)




```python
# Define a function to calculate mean values for neighboring cells
def calculate_mean_for_neighbors(idx, gdf, buffer_size):
    row = gdf.iloc[idx]
    if row['wind_speed'] == 0:  # Check if wind_speed is 0
        buffered = row['geometry'].buffer(buffer_size)  # Adjust buffer size as needed

        # Find neighboring geometries that intersect with the buffer, excluding the current geometry
        neighbors = gdf[~gdf.geometry.equals(row['geometry']) & gdf.geometry.intersects(buffered)]

        if not neighbors.empty:
            mean_val = neighbors['wind_speed'].mean()
            return mean_val
    return row['wind_speed']  # Return the original value if no neighbors or wind_speed != 0

# Apply the function row-wise to calculate mean values for wind_speed == 0
buffer = 0.3
yasa_mod_gpd = yasa_gpd.copy() # Create a copy
yasa_mod_gpd['wind_speed'] = yasa_mod_gpd.apply(lambda row: calculate_mean_for_neighbors(row.name, yasa_mod_gpd, buffer_size=buffer), axis=1)

winston_mod_gpd = winston_gpd.copy() # Create a copy
winston_mod_gpd['wind_speed'] = winston_mod_gpd.apply(lambda row: calculate_mean_for_neighbors(row.name, winston_mod_gpd, buffer_size=buffer), axis=1)

```


```python
fig, ax = plt.subplots(2,2, figsize=(10,10))
ax = ax.flatten()
cmap = 'Reds'

yasa_gpd.plot(column='wind_speed', cmap=cmap, linewidth=0.2, ax=ax[0], edgecolor='0.3', legend=True)
line_gdf_ib_yasa.plot(ax=ax[0], color='k', linewidth=1, label='Typhoon track')

yasa_mod_gpd.plot(column='wind_speed', cmap=cmap, linewidth=0.2, ax=ax[1], edgecolor='0.3', legend=True)
line_gdf_ib_yasa.plot(ax=ax[1], color='k', linewidth=1, label='Typhoon track')

winston_gpd.plot(column='wind_speed', cmap=cmap, linewidth=0.2, ax=ax[2], edgecolor='0.3', legend=True)
line_gdf_ib_winston.plot(ax=ax[2], color='k', linewidth=1, label='Typhoon track')

winston_mod_gpd.plot(column='wind_speed', cmap=cmap, linewidth=0.2, ax=ax[3], edgecolor='0.3', legend=True)
line_gdf_ib_winston.plot(ax=ax[3], color='k', linewidth=1, label='Typhoon track')

ax[0].axis('off')
ax[1].axis('off')
ax[2].axis('off')
ax[3].axis('off')

ax[0].set_xlim(176, 182)
ax[0].set_ylim(-20, -12)
ax[1].set_xlim(176, 182)
ax[1].set_ylim(-20, -12)
ax[2].set_xlim(176, 182)
ax[2].set_ylim(-20, -12)
ax[3].set_xlim(176, 182)
ax[3].set_ylim(-20, -12)

ax[0].set_title('Windspeed [m/s], YASA', size=10)
ax[1].set_title('Windspeed [m/s], YASA modified \nBuffer size={} degrees'.format(buffer), size=10)
ax[2].set_title('Windspeed [m/s], WINSTON', size=10)
ax[3].set_title('Windspeed [m/s], WINSTON modified \nBuffer size={} degrees'.format(buffer), size=10)

plt.tight_layout()
plt.show()
```



![png](05.4_combined_model_define_thres_windspeed_files/05.4_combined_model_define_thres_windspeed_9_0.png)




```python
# Apply this for all Fiji typhoons
fji_typhoons = df_fji_complete.typhoon_name.unique()

buffer = 0.3
df_fji_mod = pd.DataFrame()
for typh in fji_typhoons:
    df_aux = gpd.GeoDataFrame(df_fji_complete[df_fji_complete.typhoon_name==typh].merge(
        grid,
        left_on='grid_point_id',
        right_on='id'))

    df_aux['wind_speed'] = df_aux.apply(lambda row: calculate_mean_for_neighbors(row.name, df_aux, buffer_size=buffer), axis=1)
    df_fji_mod = pd.concat([df_fji_mod, df_aux])

df_fji_mod = pd.DataFrame(df_fji_mod.reset_index(drop=True).sort_values('wind_speed'))
```


```python
# Now modify the df_combined dataset with this new data
df_fji_mod['country'] = 'fji'
cols = df_combined_noana.columns
df_combined_mod = df_combined_noana[df_combined_noana.country != 'fji']
df_combined_mod = pd.concat([df_combined_mod.sort_values('typhoon_name'), df_fji_mod]).reset_index(drop=True)[cols]
```


```python
fig, ax = plt.subplots(1,1, figsize=(5,5))
df_fji_mod.plot(kind='scatter', x='track_distance', y='wind_speed', c='percent_houses_damaged',
                alpha=0.7, cmap='Reds',ax=ax)
ax.set_xlabel('Track Distance [Km]')
ax.set_ylabel('Windspeed [m/s]')
ax.set_title('Fiji typhoons')

plt.show()
```



![png](05.4_combined_model_define_thres_windspeed_files/05.4_combined_model_define_thres_windspeed_12_0.png)



## The model


```python
# Stratification
dmg = np.array(df_fji.percent_houses_damaged.to_list())
zero_dmg = np.round((np.count_nonzero(dmg == 0) / len(dmg)) , 2 )

# Define ranges for each group
x0 = list(np.linspace(0, zero_dmg, 1))   # zero damage
x1 = list(np.linspace(zero_dmg, 0.93, 2))  # almost no damage
x2 = list(np.linspace(0.935, 1, 5))  # all the damage
x3=x0+x1+x2

bins = []
for i in x3:
    bins.append(np.quantile(dmg, i))

# Histogram after stratification
samples_per_bin_fji, bins_def_fji = np.histogram(dmg, bins=bins)

# Define number of bins
num_bins_fji = len(samples_per_bin_fji)

# For future plots
str_bin_fji = []
for i in range(len(bins_def_fji[:-1])):
    a = str(np.round(bins_def_fji[i+1],3))
    b = str(np.round(bins_def_fji[i],3))
    str_bin_fji.append('{} - {}'.format(b,a))
```


```python
# Drop ANA typhoon
df_combined_noana = df_combined[df_combined.typhoon_name != 'ANA']
df_fji_noana= df_fji_complete[df_fji_complete.typhoon_name != 'ANA']

# Drop 0 windspeed data when track_distance < 300 Km
df_combined_thres = df_combined_noana[~(df_combined_noana['wind_speed'] == 0) &
                  (df_combined_noana['track_distance'] < 300)]

df_fji_thres = df_fji_noana[~(df_fji_noana['wind_speed'] == 0) &
                  (df_fji_noana['track_distance'] < 300)]

# Model with mean windspeed on 0 windspeed values
y_test_typhoon_mean, y_pred_typhoon_mean, rmse_strat_mean, avg_error_strat_mean = xgb_model_combined_data_LOOCV(
    df_combined=df_combined_mod,
    df_fji=df_fji_mod,
    bins=bins_def_fji,
    fji_weight=6,
    features=features
)

# Model with threshold (dropping 0 windspeed values)
y_test_typhoon_drop, y_pred_typhoon_drop, rmse_strat_drop, avg_error_strat_drop = xgb_model_combined_data_LOOCV(
    df_combined=df_combined_thres,
    df_fji=df_fji_thres,
    bins=bins_def_fji,
    fji_weight=6,
    features=features
)

# Model without threshold
y_test_typhoon_old, y_pred_typhoon_old, rmse_strat_old, avg_error_strat_old = xgb_model_combined_data_LOOCV(
    df_combined=df_combined_noana,
    df_fji=df_fji_noana,
    bins=bins_def_fji,
    fji_weight=6,
    features=features
)
```


```python
fig, ax = plt.subplots(1,1, figsize=(6,6))

ax.plot(range(num_bins_fji), rmse_strat_old, 'bs', label='No threshold')
ax.plot(range(num_bins_fji), rmse_strat_drop, 'gs', label='Drop windspeed = 0 \nwhen track_distance < 300 Km')
ax.plot(range(num_bins_fji), rmse_strat_mean, 'rs', label='Replace 0 windspeed values with \nmean values of windspeed \nin the surrouding areas')

ax.set_xticks(range(num_bins_fji), str_bin_fji, rotation=45)
ax.set_xlabel('Damage [%]')
ax.set_ylabel('RMSE')
ax.grid()
ax.set_title('XGBoost Regression model trained on Philippines+Fiji \ndataset using LOOCV for Fiji typhoons')
ax.legend()

plt.tight_layout()
plt.show()
```



![png](05.4_combined_model_define_thres_windspeed_files/05.4_combined_model_define_thres_windspeed_16_0.png)



## Results at municipality level


```python
# Fiji typhoons
fji_typhoons = df_fji_noana.typhoon_name.unique()

# Calculate buildings destroyed by municipality and % of buildings destroyed by mun
mun_id = get_municipality_grids()[['id','NAME_2']]

def num_bld_destroyed_mun(mun, typhoon, y_pred_typhoon, df_fji, real=False):
    k = fji_typhoons.tolist().index(typhoon)
    df_typhoon = df_fji[df_fji.typhoon_name==typhoon]
    # Add feature "predictive_damage"
    df_typhoon['predicted_damage'] = y_pred_typhoon[k]

    mun_ids = mun_id[mun_id.NAME_2 == mun].id.to_list()
    cells_in_mun = df_typhoon[df_typhoon.typhoon_name == typhoon].set_index('grid_point_id').loc[mun_ids]

    if real:
        damage_grid = np.array(cells_in_mun.percent_houses_damaged.to_list()) # Real dmg
    else:
        damage_grid = np.array(cells_in_mun.predicted_damage.to_list()) # Dmg predicted by cell

    # Number of buildings
    N_bld_grid = np.array(cells_in_mun.total_houses.to_list()) # Bld by cell
    N_bld_mun = np.sum(N_bld_grid) # Total bld in mun

    # Calculate % of buildings (and N of bld) destroyed by mun
    N_bld_dest_pred_mun = np.sum(damage_grid) * (N_bld_mun / 100)
    perc_destroyed_mun = np.sum(damage_grid)

    return N_bld_dest_pred_mun, perc_destroyed_mun

def calculate_actual_perc_dmg(x, i, y_pred_typhoon, df_fji, typhoon):
    try:
        return num_bld_destroyed_mun(mun=x['NAME_2'], typhoon=typhoon, y_pred_typhoon=y_pred_typhoon, df_fji=df_fji, real=True)[i]
    except:
        return 0
def calculate_pred_perc_dmg(x, i, y_pred_typhoon, df_fji, typhoon):
    try:
        return num_bld_destroyed_mun(mun=x['NAME_2'], typhoon=typhoon, y_pred_typhoon=y_pred_typhoon, df_fji=df_fji, real=False)[i]
    except:
        return 0
```

### For YASA


```python
typhoon='YASA'

# Classic approach
fiji_old = fiji.copy()
fiji_old['actual_perc_dmg'] = fiji_old.apply(calculate_actual_perc_dmg, df_fji=df_fji_complete,
                                             y_pred_typhoon=y_pred_typhoon_old, i=1, typhoon=typhoon, axis=1)
fiji_old['pred_perc_dmg'] = fiji_old.apply(calculate_pred_perc_dmg, df_fji=df_fji_complete,
                                           y_pred_typhoon=y_pred_typhoon_old, i=1, typhoon=typhoon, axis=1)
fiji_old['prediction_error'] = fiji_old['actual_perc_dmg'] - fiji_old['pred_perc_dmg'] # in percentual points

# Drop cells approach
fiji_drop = fiji.copy()
fiji_drop['actual_perc_dmg'] = fiji_drop.apply(calculate_actual_perc_dmg, df_fji=df_fji_thres,
                                             y_pred_typhoon=y_pred_typhoon_drop, i=1, typhoon=typhoon, axis=1)
fiji_drop['pred_perc_dmg'] = fiji_drop.apply(calculate_pred_perc_dmg, df_fji=df_fji_thres,
                                           y_pred_typhoon=y_pred_typhoon_drop, i=1, typhoon=typhoon, axis=1)
fiji_drop['prediction_error'] = fiji_drop['actual_perc_dmg'] - fiji_drop['pred_perc_dmg'] # in percentual points

# Mean values of neighboars cells approach
fiji_mean = fiji.copy()
fiji_mean['actual_perc_dmg'] = fiji_mean.apply(calculate_actual_perc_dmg, df_fji=df_fji_mod,
                                             y_pred_typhoon=y_pred_typhoon_mean, i=1, typhoon=typhoon, axis=1)
fiji_mean['pred_perc_dmg'] = fiji_mean.apply(calculate_pred_perc_dmg, df_fji=df_fji_mod,
                                           y_pred_typhoon=y_pred_typhoon_mean, i=1, typhoon=typhoon, axis=1)
fiji_mean['prediction_error'] = fiji_mean['actual_perc_dmg'] - fiji_mean['pred_perc_dmg'] # in percentual points
```


```python
# Load track
id = intersection[intersection['typhoon_name'] == typhoon].typhoon_id.to_list()
track = TCTracks.from_ibtracs_netcdf(storm_id=id)
tc_track = track.get_track()

points_ib = gpd.points_from_xy(tc_track.lon, tc_track.lat)
tc_track_line_ib = LineString(points_ib)

geometries_ib = gpd.GeoSeries([tc_track_line_ib])
line_gdf_ib = gpd.GeoDataFrame(geometry=geometries_ib)

# Plots
cmap='Reds'
cmap_blue = 'Blues'
cmap_red = 'Reds_r'
```

    2023-12-07 17:14:10,538 - climada.hazard.tc_tracks - WARNING - The cached IBTrACS data set dates from 2023-06-07 23:07:38 (older than 180 days). Very likely, a more recent version is available. Consider manually removing the file /Users/federico/climada/data/IBTrACS.ALL.v04r00.nc and re-running this function, which will download the most recent version of the IBTrACS data set from the official URL.



```python
fig, ax = plt.subplots(1, 3, figsize=(15, 5))

# Check prediction_error column for values > 0 and < 0
positive_error = fiji_old[fiji_old['prediction_error'] > 0]
negative_error = fiji_old[fiji_old['prediction_error'] < 0]

# Plotting the maps
fiji_plot_1 = fiji_old.plot(column='actual_perc_dmg', cmap=cmap, linewidth=0.2, ax=ax[0], edgecolor='0.3', legend=True)
fiji_plot_2 = fiji_old.plot(column='pred_perc_dmg', cmap=cmap, linewidth=0.2, ax=ax[1], edgecolor='0.3', legend=True)
fiji_plot_3_blue = positive_error.plot(column='prediction_error', cmap=cmap_blue, linewidth=0.2, ax=ax[2], edgecolor='0.3', vmin=0, legend=True)
fiji_plot_3_red = negative_error.plot(column='prediction_error', cmap=cmap_red, linewidth=0.2, ax=ax[2], edgecolor='0.3', vmax=0, legend=True)


line_gdf_ib.plot(ax=ax[0], color='k', linewidth=1, label='Typhoon track')  # Plot the LineString in black
line_gdf_ib.plot(ax=ax[1], color='k', linewidth=1, label='Typhoon track')  # Plot the LineString in black
line_gdf_ib.plot(ax=ax[2], color='k', linewidth=1, label='Typhoon track')  # Plot the LineString in black

# Create custom legends
blue_patch = mpatches.Patch(color='#6495ED', label='Underestimated damage')
red_patch = mpatches.Patch(color='#800000', label='Overestimated damage')
ax[2].legend(handles=[blue_patch, red_patch], loc='lower left', bbox_to_anchor=(-0.05, -0.2))

ax[0].set_title('Actual Damage by municipality')
ax[1].set_title('Predicted Damage by municipality')
ax[2].set_title('Prediction Error \n $actual_{dmg} - predicted_{dmg}$ \n(in percentage points)')
ax[0].axis('off')
ax[1].axis('off')
ax[2].axis('off')

# All Fiji map
ax[0].set_xlim(176, 182)
ax[0].set_ylim(-20, -12)
ax[1].set_xlim(176, 182)
ax[1].set_ylim(-20, -12)
ax[2].set_xlim(176, 182)
ax[2].set_ylim(-20, -12)

plt.suptitle('Typhoon {} (without modification)'.format(typhoon), y=1.1)
plt.tight_layout()
plt.show()
```



![png](05.4_combined_model_define_thres_windspeed_files/05.4_combined_model_define_thres_windspeed_22_0.png)




```python
fig, ax = plt.subplots(1, 3, figsize=(15, 5))

# Check prediction_error column for values > 0 and < 0
positive_error = fiji_mean[fiji_mean['prediction_error'] > 0]
negative_error = fiji_mean[fiji_mean['prediction_error'] < 0]

# Plotting the maps
fiji_plot_1 = fiji_mean.plot(column='actual_perc_dmg', cmap=cmap, linewidth=0.2, ax=ax[0], edgecolor='0.3', legend=True)
fiji_plot_2 = fiji_mean.plot(column='pred_perc_dmg', cmap=cmap, linewidth=0.2, ax=ax[1], edgecolor='0.3', legend=True)
fiji_plot_3_blue = positive_error.plot(column='prediction_error', cmap=cmap_blue, linewidth=0.2, ax=ax[2], edgecolor='0.3', vmin=0, legend=True)
fiji_plot_3_red = negative_error.plot(column='prediction_error', cmap=cmap_red, linewidth=0.2, ax=ax[2], edgecolor='0.3', vmax=0, legend=True)


line_gdf_ib.plot(ax=ax[0], color='k', linewidth=1, label='Typhoon track')  # Plot the LineString in black
line_gdf_ib.plot(ax=ax[1], color='k', linewidth=1, label='Typhoon track')  # Plot the LineString in black
line_gdf_ib.plot(ax=ax[2], color='k', linewidth=1, label='Typhoon track')  # Plot the LineString in black

# Create custom legends
blue_patch = mpatches.Patch(color='#6495ED', label='Underestimated damage')
red_patch = mpatches.Patch(color='#800000', label='Overestimated damage')
ax[2].legend(handles=[blue_patch, red_patch], loc='lower left', bbox_to_anchor=(-0.05, -0.2))

ax[0].set_title('Actual Damage by municipality')
ax[1].set_title('Predicted Damage by municipality')
ax[2].set_title('Prediction Error \n $actual_{dmg} - predicted_{dmg}$ \n(in percentage points)')
ax[0].axis('off')
ax[1].axis('off')
ax[2].axis('off')

# All Fiji map
ax[0].set_xlim(176, 182)
ax[0].set_ylim(-20, -12)
ax[1].set_xlim(176, 182)
ax[1].set_ylim(-20, -12)
ax[2].set_xlim(176, 182)
ax[2].set_ylim(-20, -12)

plt.suptitle('Typhoon {} (Mean values -based on surrounding area- of windspeed wheen values = 0) \nBuffer Size = {}'.format(typhoon, buffer), y=1.1)
plt.tight_layout()
plt.show()
```



![png](05.4_combined_model_define_thres_windspeed_files/05.4_combined_model_define_thres_windspeed_23_0.png)



### For WINSTON


```python
typhoon = 'WINSTON'

# Classic approach
fiji_old = fiji.copy()
fiji_old['actual_perc_dmg'] = fiji_old.apply(calculate_actual_perc_dmg, df_fji=df_fji_complete,
                                             y_pred_typhoon=y_pred_typhoon_old, i=1, typhoon=typhoon, axis=1)
fiji_old['pred_perc_dmg'] = fiji_old.apply(calculate_pred_perc_dmg, df_fji=df_fji_complete,
                                           y_pred_typhoon=y_pred_typhoon_old, i=1, typhoon=typhoon, axis=1)
fiji_old['prediction_error'] = fiji_old['actual_perc_dmg'] - fiji_old['pred_perc_dmg'] # in percentual points

# Mean values of neighboars cells approach
df_winston = df_combined[df_combined.typhoon_name == 'WINSTON']
fiji_mean = fiji.copy()
fiji_mean['actual_perc_dmg'] = fiji_mean.apply(calculate_actual_perc_dmg, df_fji=df_fji_mod,
                                             y_pred_typhoon=y_pred_typhoon_mean, i=1, typhoon=typhoon, axis=1)
fiji_mean['pred_perc_dmg'] = fiji_mean.apply(calculate_pred_perc_dmg, df_fji=df_fji_mod,
                                           y_pred_typhoon=y_pred_typhoon_mean, i=1, typhoon=typhoon, axis=1)
fiji_mean['prediction_error'] = fiji_mean['actual_perc_dmg'] - fiji_mean['pred_perc_dmg'] # in percentual points

# Load track
id = intersection[intersection['typhoon_name'] == typhoon].typhoon_id.to_list()
track = TCTracks.from_ibtracs_netcdf(storm_id=id)
tc_track = track.get_track()

points_ib = gpd.points_from_xy(tc_track.lon, tc_track.lat)
tc_track_line_ib = LineString(points_ib)

geometries_ib = gpd.GeoSeries([tc_track_line_ib])
line_gdf_ib = gpd.GeoDataFrame(geometry=geometries_ib)

# Plots
cmap='Reds'
cmap_blue = 'Blues'
cmap_red = 'Reds_r'
```

    2023-12-07 17:13:17,198 - climada.hazard.tc_tracks - WARNING - The cached IBTrACS data set dates from 2023-06-07 23:07:38 (older than 180 days). Very likely, a more recent version is available. Consider manually removing the file /Users/federico/climada/data/IBTrACS.ALL.v04r00.nc and re-running this function, which will download the most recent version of the IBTrACS data set from the official URL.



```python
fig, ax = plt.subplots(1, 3, figsize=(15, 5))

# Check prediction_error column for values > 0 and < 0
positive_error = fiji_old[fiji_old['prediction_error'] > 0]
negative_error = fiji_old[fiji_old['prediction_error'] < 0]

# Plotting the maps
fiji_plot_1 = fiji_old.plot(column='actual_perc_dmg', cmap=cmap, linewidth=0.2, ax=ax[0], edgecolor='0.3', legend=True)
fiji_plot_2 = fiji_old.plot(column='pred_perc_dmg', cmap=cmap, linewidth=0.2, ax=ax[1], edgecolor='0.3', legend=True)
fiji_plot_3_blue = positive_error.plot(column='prediction_error', cmap=cmap_blue, linewidth=0.2, ax=ax[2], edgecolor='0.3', vmin=0, legend=True)
fiji_plot_3_red = negative_error.plot(column='prediction_error', cmap=cmap_red, linewidth=0.2, ax=ax[2], edgecolor='0.3', vmax=0, legend=True)


line_gdf_ib.plot(ax=ax[0], color='k', linewidth=1, label='Typhoon track')  # Plot the LineString in black
line_gdf_ib.plot(ax=ax[1], color='k', linewidth=1, label='Typhoon track')  # Plot the LineString in black
line_gdf_ib.plot(ax=ax[2], color='k', linewidth=1, label='Typhoon track')  # Plot the LineString in black

# Create custom legends
blue_patch = mpatches.Patch(color='#6495ED', label='Underestimated damage')
red_patch = mpatches.Patch(color='#800000', label='Overestimated damage')
ax[2].legend(handles=[blue_patch, red_patch], loc='lower left', bbox_to_anchor=(-0.05, -0.2))

ax[0].set_title('Actual Damage by municipality')
ax[1].set_title('Predicted Damage by municipality')
ax[2].set_title('Prediction Error \n $actual_{dmg} - predicted_{dmg}$ \n(in percentage points)')
ax[0].axis('off')
ax[1].axis('off')
ax[2].axis('off')

# All Fiji map
ax[0].set_xlim(176, 182)
ax[0].set_ylim(-20, -12)
ax[1].set_xlim(176, 182)
ax[1].set_ylim(-20, -12)
ax[2].set_xlim(176, 182)
ax[2].set_ylim(-20, -12)

plt.suptitle('Typhoon {} (without modification)'.format(typhoon), y=1.1)
plt.tight_layout()
plt.show()
```



![png](05.4_combined_model_define_thres_windspeed_files/05.4_combined_model_define_thres_windspeed_26_0.png)




```python
fig, ax = plt.subplots(1, 3, figsize=(15, 5))

# Check prediction_error column for values > 0 and < 0
positive_error = fiji_mean[fiji_mean['prediction_error'] > 0]
negative_error = fiji_mean[fiji_mean['prediction_error'] < 0]

# Plotting the maps
fiji_plot_1 = fiji_mean.plot(column='actual_perc_dmg', cmap=cmap, linewidth=0.2, ax=ax[0], edgecolor='0.3', legend=True)
fiji_plot_2 = fiji_mean.plot(column='pred_perc_dmg', cmap=cmap, linewidth=0.2, ax=ax[1], edgecolor='0.3', legend=True)
fiji_plot_3_blue = positive_error.plot(column='prediction_error', cmap=cmap_blue, linewidth=0.2, ax=ax[2], edgecolor='0.3', vmin=0, legend=True)
fiji_plot_3_red = negative_error.plot(column='prediction_error', cmap=cmap_red, linewidth=0.2, ax=ax[2], edgecolor='0.3', vmax=0, legend=True)


line_gdf_ib.plot(ax=ax[0], color='k', linewidth=1, label='Typhoon track')  # Plot the LineString in black
line_gdf_ib.plot(ax=ax[1], color='k', linewidth=1, label='Typhoon track')  # Plot the LineString in black
line_gdf_ib.plot(ax=ax[2], color='k', linewidth=1, label='Typhoon track')  # Plot the LineString in black

# Create custom legends
blue_patch = mpatches.Patch(color='#6495ED', label='Underestimated damage')
red_patch = mpatches.Patch(color='#800000', label='Overestimated damage')
ax[2].legend(handles=[blue_patch, red_patch], loc='lower left', bbox_to_anchor=(-0.05, -0.2))

ax[0].set_title('Actual Damage by municipality')
ax[1].set_title('Predicted Damage by municipality')
ax[2].set_title('Prediction Error \n $actual_{dmg} - predicted_{dmg}$ \n(in percentage points)')
ax[0].axis('off')
ax[1].axis('off')
ax[2].axis('off')

# All Fiji map
ax[0].set_xlim(176, 182)
ax[0].set_ylim(-20, -12)
ax[1].set_xlim(176, 182)
ax[1].set_ylim(-20, -12)
ax[2].set_xlim(176, 182)
ax[2].set_ylim(-20, -12)

plt.suptitle('Typhoon {} (Mean values -based on surrounding area- of windspeed wheen values = 0) \nBuffer Size = {}'.format(typhoon, buffer), y=1.1)
plt.tight_layout()
plt.show()
```



![png](05.4_combined_model_define_thres_windspeed_files/05.4_combined_model_define_thres_windspeed_27_0.png)



### For OTHER TYPHOONs


```python
typhoon = 'EVAN'

# Classic approach
fiji_old = fiji.copy()
fiji_old['actual_perc_dmg'] = fiji_old.apply(calculate_actual_perc_dmg, df_fji=df_fji_complete,
                                             y_pred_typhoon=y_pred_typhoon_old, i=1, axis=1)
fiji_old['pred_perc_dmg'] = fiji_old.apply(calculate_pred_perc_dmg, df_fji=df_fji_complete,
                                           y_pred_typhoon=y_pred_typhoon_old, i=1, axis=1)
fiji_old['prediction_error'] = fiji_old['actual_perc_dmg'] - fiji_old['pred_perc_dmg'] # in percentual points

# Mean values of neighboars cells approach
fiji_mean = fiji.copy()
fiji_mean['actual_perc_dmg'] = fiji_mean.apply(calculate_actual_perc_dmg, df_fji=df_fji_mod,
                                             y_pred_typhoon=y_pred_typhoon_mean, i=1, axis=1)
fiji_mean['pred_perc_dmg'] = fiji_mean.apply(calculate_pred_perc_dmg, df_fji=df_fji_mod,
                                           y_pred_typhoon=y_pred_typhoon_mean, i=1, axis=1)
fiji_mean['prediction_error'] = fiji_mean['actual_perc_dmg'] - fiji_mean['pred_perc_dmg'] # in percentual points

# Load track
id = intersection[intersection['typhoon_name'] == typhoon].typhoon_id.to_list()
track = TCTracks.from_ibtracs_netcdf(storm_id=id)
tc_track = track.get_track()

points_ib = gpd.points_from_xy(tc_track.lon, tc_track.lat)
tc_track_line_ib = LineString(points_ib)

geometries_ib = gpd.GeoSeries([tc_track_line_ib])
line_gdf_ib = gpd.GeoDataFrame(geometry=geometries_ib)

# Plots
cmap='Reds'
cmap_blue = 'Blues'
cmap_red = 'Reds_r'
```

    2023-12-07 12:12:01,397 - climada.hazard.tc_tracks - WARNING - The cached IBTrACS data set dates from 2023-06-07 23:07:38 (older than 180 days). Very likely, a more recent version is available. Consider manually removing the file /Users/federico/climada/data/IBTrACS.ALL.v04r00.nc and re-running this function, which will download the most recent version of the IBTrACS data set from the official URL.



```python
fig, ax = plt.subplots(1, 3, figsize=(15, 5))

# Check prediction_error column for values > 0 and < 0
positive_error = fiji_mean[fiji_mean['prediction_error'] > 0]
negative_error = fiji_mean[fiji_mean['prediction_error'] < 0]

# Plotting the maps
fiji_plot_1 = fiji_mean.plot(column='actual_perc_dmg', cmap=cmap, linewidth=0.2, ax=ax[0], edgecolor='0.3', legend=True)
fiji_plot_2 = fiji_mean.plot(column='pred_perc_dmg', cmap=cmap, linewidth=0.2, ax=ax[1], edgecolor='0.3', legend=True)
fiji_plot_3_blue = positive_error.plot(column='prediction_error', cmap=cmap_blue, linewidth=0.2, ax=ax[2], edgecolor='0.3', vmin=0, legend=True)
fiji_plot_3_red = negative_error.plot(column='prediction_error', cmap=cmap_red, linewidth=0.2, ax=ax[2], edgecolor='0.3', vmax=0, legend=True)


line_gdf_ib.plot(ax=ax[0], color='k', linewidth=1, label='Typhoon track')  # Plot the LineString in black
line_gdf_ib.plot(ax=ax[1], color='k', linewidth=1, label='Typhoon track')  # Plot the LineString in black
line_gdf_ib.plot(ax=ax[2], color='k', linewidth=1, label='Typhoon track')  # Plot the LineString in black

# Create custom legends
blue_patch = mpatches.Patch(color='#6495ED', label='Underestimated damage')
red_patch = mpatches.Patch(color='#800000', label='Overestimated damage')
ax[2].legend(handles=[blue_patch, red_patch], loc='lower left', bbox_to_anchor=(-0.05, -0.2))

ax[0].set_title('Actual Damage by municipality')
ax[1].set_title('Predicted Damage by municipality')
ax[2].set_title('Prediction Error \n $actual_{dmg} - predicted_{dmg}$ \n(in percentage points)')
ax[0].axis('off')
ax[1].axis('off')
ax[2].axis('off')

# All Fiji map
# ax[0].set_xlim(176, 182)
# ax[0].set_ylim(-20, -12)
# ax[1].set_xlim(176, 182)
# ax[1].set_ylim(-20, -12)
# ax[2].set_xlim(176, 182)
# ax[2].set_ylim(-20, -12)

# GITA
ax[0].set_xlim(176, 182)
ax[0].set_ylim(-22, -15)
ax[1].set_xlim(176, 182)
ax[1].set_ylim(-22, -15)
ax[2].set_xlim(176, 182)
ax[2].set_ylim(-22, -15)

plt.suptitle('Typhoon {} (Mean values -based on surrounding area- of windspeed wheen values = 0) \nBuffer Size = {}'.format(typhoon, buffer), y=1.1)
plt.tight_layout()
plt.show()
```



![png](05.4_combined_model_define_thres_windspeed_files/05.4_combined_model_define_thres_windspeed_30_0.png)
