```python
import matplotlib.pyplot as plt
from matplotlib.colors import Normalize
import matplotlib.patches as mpatches
import numpy as np
import os
from pathlib import Path
import pandas as pd
import geopandas as gpd
from climada.hazard import Centroids, TCTracks, TropCyclone
from shapely.geometry import LineString

from utils import get_combined_dataset_interpolated, get_combined_dataset_interpolated_with_viet, get_combined_dataset_interpolated_with_viet_new_bld_count, get_training_dataset_complete_interpolated, get_training_dataset_complete_interpolated_new_bld_count, get_municipality_grids, xgb_model_combined_data_LOOCV, xgb_model_combined_data_with_viet_LOOCV
```

## Loading data


```python
# For Checking (Number of buildings destroyed per mun)
input_dir = (
    Path(os.getenv("STORM_DATA_DIR"))
    / "analysis_fji/02_model_features/02_housing_damage/input/"
)
actual_mun_dmg = pd.read_csv(input_dir / "fji_building_damage_mun_complete.csv")
actual_mun_dmg['typhoon'] = actual_mun_dmg['typhoon'].str.upper()

# Load Fiji Shapefile
fiji = gpd.read_file(
    input_dir / "adm2_shp_fixed.gpkg"
)
fiji = fiji.to_crs('EPSG:4326')

# Load grid
grid_dir = (
    Path(os.getenv("STORM_DATA_DIR"))
    / "analysis_fji/02_model_features/02_housing_damage/output/"
)
grid = gpd.read_file(grid_dir / "fji_0.1_degree_grid_land_overlap_new.gpkg")


# Load typhoon track
tracks_dir = (
    Path(os.getenv("STORM_DATA_DIR"))
    / "analysis_fji/02_model_features/01_windfield"
)
typhoons_info = pd.read_csv(tracks_dir / "typhoons.csv")
typhoons_info.typhoon_name = typhoons_info.typhoon_name.str.upper()
cyclones = actual_mun_dmg['typhoon'].unique()
intersection = typhoons_info[typhoons_info['typhoon_name'].isin(cyclones)].drop_duplicates(keep='last', subset = ['typhoon_name'])
```


```python
# Features
features = [
    "wind_speed",
    "track_distance",
    "total_houses",
    "rainfall_max_6h",
    "rainfall_max_24h",
    "coast_length",
    "with_coast",
    "mean_elev",
    "mean_slope",
]
```


```python
# Load Fiji complete interpolated
df_fji_complete_int = get_training_dataset_complete_interpolated()
df_fji_complete_int = df_fji_complete_int[df_fji_complete_int.typhoon_name != 'ANA'] # Drop ANA
df_fji_complete_int = df_fji_complete_int.rename({
    "mean_altitude": "mean_elev",
    "total_buildings": "total_houses",
    "perc_dmg_grid": "percent_houses_damaged"
}, axis=1)
df_fji_complete_int = df_fji_complete_int[features + ['typhoon_name', 'grid_point_id', 'Centroid', 'percent_houses_damaged']]

# Load Fiji complete interpolated
df_fji_complete_int_new = get_training_dataset_complete_interpolated_new_bld_count()
df_fji_complete_int_new = df_fji_complete_int_new[df_fji_complete_int_new.typhoon_name != 'ANA'] # Drop ANA
df_fji_complete_int_new = df_fji_complete_int_new.rename({
    "mean_altitude": "mean_elev",
    "total_buildings": "total_houses",
    "perc_dmg_grid": "percent_houses_damaged"
}, axis=1)
df_fji_complete_int_new = df_fji_complete_int_new[features + ['typhoon_name', 'grid_point_id', 'Centroid', 'percent_houses_damaged']]

# Load combined dataset interpolated
df_combined_with_viet = get_combined_dataset_interpolated_with_viet()
df_fji_with_viet = df_combined_with_viet[df_combined_with_viet.country == 'fji']

df_combined_with_viet_new = get_combined_dataset_interpolated_with_viet_new_bld_count()
df_fji_with_viet_new = df_combined_with_viet_new[df_combined_with_viet_new.country == 'fji']
```


```python
# Stratification
dmg = np.array(df_fji_with_viet.percent_houses_damaged.to_list())
zero_dmg = np.round((np.count_nonzero(dmg == 0) / len(dmg)) , 2 )

# Define ranges for each group
x0 = list(np.linspace(0, zero_dmg, 1))   # zero damage
x1 = list(np.linspace(zero_dmg, 0.93, 2))  # almost no damage
x2 = list(np.linspace(0.935, 1, 5))  # all the damage
x3=x0+x1+x2

bins = []
for i in x3:
    bins.append(np.quantile(dmg, i))

# Histogram after stratification
samples_per_bin_fji, bins_def_fji = np.histogram(dmg, bins=bins)

# Define number of bins
num_bins_fji = len(samples_per_bin_fji)

# For future plots
str_bin_fji = []
for i in range(len(bins_def_fji[:-1])):
    a = str(np.round(bins_def_fji[i+1],3))
    b = str(np.round(bins_def_fji[i],3))
    str_bin_fji.append('{} - {}'.format(b,a))
```

## The models


```python
# Fji + Phl + Viet
y_test_typhoon_with_viet, y_pred_typhoon_with_viet, rmse_strat_with_viet, avg_error_strat_with_viet = xgb_model_combined_data_with_viet_LOOCV(
    df_combined=df_combined_with_viet,
    df_fji=df_fji_with_viet,
    bins=bins_def_fji,
    fji_weight=3,
    features=features
)
```


```python
# Fji + Phl + Viet NEW BLD COUNT
y_test_typhoon_with_viet_new, y_pred_typhoon_with_viet_new, rmse_strat_with_viet_new, avg_error_strat_with_viet_new = xgb_model_combined_data_with_viet_LOOCV(
    df_combined=df_combined_with_viet_new,
    df_fji=df_fji_with_viet_new,
    bins=bins_def_fji,
    fji_weight=3,
    features=features
)
```

    /Users/federico/Library/CloudStorage/OneDrive-Personal/Documentos/ISI_Project/FIJI clean/analysis_fji/03_models/utils.py:515: RuntimeWarning: Mean of empty slice
      test_rmse_bin = np.nanmean(np.array(rmse_bin_fji)[:,i])
    /Users/federico/Library/CloudStorage/OneDrive-Personal/Documentos/ISI_Project/FIJI clean/analysis_fji/03_models/utils.py:518: RuntimeWarning: Mean of empty slice
      test_avg_bin = np.nanmean(np.array(avg_error_bin_fji)[:,i])


## Results at municipality level


```python
# Fiji typhoons
fji_typhoons = df_fji_with_viet.typhoon_name.unique()

# Calculate buildings destroyed by municipality and % of buildings destroyed by mun
mun_id = get_municipality_grids()[['id','NAME_2']]

def num_bld_destroyed_mun(mun, typhoon, y_pred_typhoon, df_fji, real=False):
    k = fji_typhoons.tolist().index(typhoon)
    df_typhoon = df_fji[df_fji.typhoon_name==typhoon]
    # Add feature "predictive_damage"
    df_typhoon['predicted_damage'] = y_pred_typhoon[k]

    mun_ids = mun_id[mun_id.NAME_2 == mun].id.to_list()
    cells_in_mun = df_typhoon[df_typhoon.typhoon_name == typhoon].set_index('grid_point_id').loc[mun_ids]

    if real:
        damage_grid = np.array(cells_in_mun.percent_houses_damaged.to_list()) # Real dmg
    else:
        damage_grid = np.array(cells_in_mun.predicted_damage.to_list()) # Dmg predicted by cell

    # Number of buildings
    N_bld_grid = np.array(cells_in_mun.total_houses.to_list()) # Bld by cell
    N_bld_mun = np.sum(N_bld_grid) # Total bld in mun

    # Calculate % of buildings (and N of bld) destroyed by mun
    N_bld_dest_pred_mun = np.sum(damage_grid) * (N_bld_mun / 100)
    perc_destroyed_mun = np.sum(damage_grid)

    return N_bld_dest_pred_mun, perc_destroyed_mun

def calculate_actual_perc_dmg(x, i, y_pred_typhoon, df_fji, typhoon):
    try:
        return num_bld_destroyed_mun(mun=x['NAME_2'], typhoon=typhoon, y_pred_typhoon=y_pred_typhoon, df_fji=df_fji, real=True)[i]
    except:
        return 0
def calculate_pred_perc_dmg(x, i, y_pred_typhoon, df_fji, typhoon):
    try:
        return num_bld_destroyed_mun(mun=x['NAME_2'], typhoon=typhoon, y_pred_typhoon=y_pred_typhoon, df_fji=df_fji, real=False)[i]
    except:
        return 0
```


```python
typhoon='YASA'

# Classic approach PHL+FJI+VIET
fiji_old = fiji.copy()
fiji_old['actual_perc_dmg'] = fiji_old.apply(calculate_actual_perc_dmg, df_fji=df_fji_complete_int,
                                             y_pred_typhoon=y_pred_typhoon_with_viet, i=1, typhoon=typhoon, axis=1)
fiji_old['pred_perc_dmg'] = fiji_old.apply(calculate_pred_perc_dmg, df_fji=df_fji_complete_int,
                                           y_pred_typhoon=y_pred_typhoon_with_viet, i=1, typhoon=typhoon, axis=1)

# Modify values
fiji_old['actual_perc_dmg'] = fiji_old['actual_perc_dmg'].apply(lambda x: 0 if x < 0 else (100 if x > 100 else x))
fiji_old['pred_perc_dmg'] = fiji_old['pred_perc_dmg'].apply(lambda x: 0 if x < 0 else (100 if x > 100 else x))
# Now calculate prediciton error
fiji_old['prediction_error'] = fiji_old['actual_perc_dmg'] - fiji_old['pred_perc_dmg'] # in percentual points


# New approach PHL+FJI+VIET new bld count
fiji_new = fiji.copy()
fiji_new['actual_perc_dmg'] = fiji_new.apply(calculate_actual_perc_dmg, df_fji=df_fji_complete_int_new,
                                             y_pred_typhoon=y_pred_typhoon_with_viet_new, i=1, typhoon=typhoon, axis=1)
fiji_new['pred_perc_dmg'] = fiji_new.apply(calculate_pred_perc_dmg, df_fji=df_fji_complete_int_new,
                                           y_pred_typhoon=y_pred_typhoon_with_viet_new, i=1, typhoon=typhoon, axis=1)
# Modify values
fiji_new['actual_perc_dmg'] = fiji_new['actual_perc_dmg'].apply(lambda x: 0 if x < 0 else (100 if x > 100 else x))
fiji_new['pred_perc_dmg'] = fiji_new['pred_perc_dmg'].apply(lambda x: 0 if x < 0 else (100 if x > 100 else x))
fiji_new['prediction_error'] = fiji_new['actual_perc_dmg'] - fiji_new['pred_perc_dmg'] # in percentual points
```


```python
# Load track
id = intersection[intersection['typhoon_name'] == typhoon].typhoon_id.to_list()
track = TCTracks.from_ibtracs_netcdf(storm_id=id)
tc_track = track.get_track()

points_ib = gpd.points_from_xy(tc_track.lon, tc_track.lat)
tc_track_line_ib = LineString(points_ib)

geometries_ib = gpd.GeoSeries([tc_track_line_ib])
line_gdf_ib = gpd.GeoDataFrame(geometry=geometries_ib)

# Plots
cmap='Reds'
cmap_blue = 'Blues'
cmap_red = 'Reds_r'
```

    2024-02-06 17:25:32,408 - climada.hazard.tc_tracks - WARNING - The cached IBTrACS data set dates from 2023-06-07 23:07:38 (older than 180 days). Very likely, a more recent version is available. Consider manually removing the file /Users/federico/climada/data/IBTrACS.ALL.v04r00.nc and re-running this function, which will download the most recent version of the IBTrACS data set from the official URL.



```python
fig, ax = plt.subplots(2, 3, figsize=(15, 10))
ax = ax.flatten()
# Check prediction_error column for values > 0 and < 0
positive_error = fiji_old[fiji_old['prediction_error'] > 0]
negative_error = fiji_old[fiji_old['prediction_error'] < 0]
positive_error_int = fiji_new[fiji_new['prediction_error'] > 0]
negative_error_int = fiji_new[fiji_new['prediction_error'] < 0]

# Plotting the maps
fiji_plot_1 = fiji_old.plot(column='actual_perc_dmg', cmap=cmap, linewidth=0.2, ax=ax[0], edgecolor='0.3', legend=True)
fiji_plot_2 = fiji_old.plot(column='pred_perc_dmg', cmap=cmap, linewidth=0.2, ax=ax[1], edgecolor='0.3', legend=True)
fiji_plot_3_blue = positive_error.plot(column='prediction_error', cmap=cmap_blue, linewidth=0.2, ax=ax[2], edgecolor='0.3', vmin=0, legend=True)
fiji_plot_3_red = negative_error.plot(column='prediction_error', cmap=cmap_red, linewidth=0.2, ax=ax[2], edgecolor='0.3', vmax=0, legend=True)
fiji_plot_1_int = fiji_new.plot(column='actual_perc_dmg', cmap=cmap, linewidth=0.2, ax=ax[3], edgecolor='0.3', legend=True)
fiji_plot_2_int = fiji_new.plot(column='pred_perc_dmg', cmap=cmap, linewidth=0.2, ax=ax[4], edgecolor='0.3', legend=True)
#fiji_plot_3_blue_int = positive_error_int.plot(column='prediction_error', cmap=cmap_blue, linewidth=0.2, ax=ax[5], edgecolor='0.3', vmin=0, legend=True)
fiji_plot_3_red_int = negative_error_int.plot(column='prediction_error', cmap=cmap_red, linewidth=0.2, ax=ax[5], edgecolor='0.3', vmax=0, legend=True)


line_gdf_ib.plot(ax=ax[0], color='k', linewidth=1, label='Typhoon track')  # Plot the LineString in black
line_gdf_ib.plot(ax=ax[1], color='k', linewidth=1, label='Typhoon track')  # Plot the LineString in black
line_gdf_ib.plot(ax=ax[2], color='k', linewidth=1, label='Typhoon track')  # Plot the LineString in black
line_gdf_ib.plot(ax=ax[3], color='k', linewidth=1, label='Typhoon track')  # Plot the LineString in black
line_gdf_ib.plot(ax=ax[4], color='k', linewidth=1, label='Typhoon track')  # Plot the LineString in black
line_gdf_ib.plot(ax=ax[5], color='k', linewidth=1, label='Typhoon track')  # Plot the LineString in black

# Create custom legends
blue_patch = mpatches.Patch(color='#6495ED', label='Underestimated damage')
red_patch = mpatches.Patch(color='#800000', label='Overestimated damage')
ax[2].legend(handles=[blue_patch, red_patch], loc='lower left', bbox_to_anchor=(-0.05, -0.2))
#ax[5].legend(handles=[blue_patch, red_patch], loc='lower left', bbox_to_anchor=(-0.05, -0.2))

ax[0].set_title('Actual Damage by municipality')
ax[1].set_title('Typhoon {} (PHL+FJI+VIET model) \n \nPredicted Damage by municipality'.format(typhoon))
ax[2].set_title('Prediction Error \n $actual_{dmg} - predicted_{dmg}$ \n(in percentage points)', y=0.95)
ax[4].set_title('Typhoon {} (PHL+FJI+VIET model NEW BLD COUNT)'.format(typhoon))
ax[0].axis('off')
ax[1].axis('off')
ax[2].axis('off')
ax[3].axis('off')
ax[4].axis('off')
ax[5].axis('off')

# All Fiji map
ax[0].set_xlim(176, 182)
ax[0].set_ylim(-20, -12)
ax[1].set_xlim(176, 182)
ax[1].set_ylim(-20, -12)
ax[2].set_xlim(176, 182)
ax[2].set_ylim(-20, -12)
ax[3].set_xlim(176, 182)
ax[3].set_ylim(-20, -12)
ax[4].set_xlim(176, 182)
ax[4].set_ylim(-20, -12)
ax[5].set_xlim(176, 182)
ax[5].set_ylim(-20, -12)

plt.tight_layout()
plt.show()
```



![png](08.0_combined_model_with_viet_new_bld_count_files/08.0_combined_model_with_viet_new_bld_count_13_0.png)



Another approach for this plots


```python
from sklearn.metrics import mean_squared_error

typhoons = df_fji_with_viet.typhoon_name.unique()
rmse_viet_tot = []
rmse_viet_new_tot = []
for typhoon in typhoons:

    # Classic approach PHL+FJI+VIET
    fiji_old = fiji.copy()
    fiji_old['actual_perc_dmg'] = fiji_old.apply(calculate_actual_perc_dmg, df_fji=df_fji_complete_int,
                                                y_pred_typhoon=y_pred_typhoon_with_viet, i=1, typhoon=typhoon, axis=1)
    fiji_old['pred_perc_dmg'] = fiji_old.apply(calculate_pred_perc_dmg, df_fji=df_fji_complete_int,
                                            y_pred_typhoon=y_pred_typhoon_with_viet, i=1, typhoon=typhoon, axis=1)

    # Modify values
    fiji_old['actual_perc_dmg'] = fiji_old['actual_perc_dmg'].apply(lambda x: 0 if x < 0 else (100 if x > 100 else x))
    fiji_old['pred_perc_dmg'] = fiji_old['pred_perc_dmg'].apply(lambda x: 0 if x < 0 else (100 if x > 100 else x))
    # Now calculate prediciton error
    fiji_old['prediction_error'] = fiji_old['actual_perc_dmg'] - fiji_old['pred_perc_dmg'] # in percentual points


    # New approach PHL+FJI+VIET new bld count
    fiji_new = fiji.copy()
    fiji_new['actual_perc_dmg'] = fiji_new.apply(calculate_actual_perc_dmg, df_fji=df_fji_complete_int_new,
                                                y_pred_typhoon=y_pred_typhoon_with_viet_new, i=1, typhoon=typhoon, axis=1)
    fiji_new['pred_perc_dmg'] = fiji_new.apply(calculate_pred_perc_dmg, df_fji=df_fji_complete_int_new,
                                            y_pred_typhoon=y_pred_typhoon_with_viet_new, i=1, typhoon=typhoon, axis=1)
    # Modify values
    fiji_new['actual_perc_dmg'] = fiji_new['actual_perc_dmg'].apply(lambda x: 0 if x < 0 else (100 if x > 100 else x))
    fiji_new['pred_perc_dmg'] = fiji_new['pred_perc_dmg'].apply(lambda x: 0 if x < 0 else (100 if x > 100 else x))
    fiji_new['prediction_error'] = fiji_new['actual_perc_dmg'] - fiji_new['pred_perc_dmg'] # in percentual points

    actual_dmg_old = fiji_old['actual_perc_dmg']
    actual_dmg_new = fiji_new['actual_perc_dmg']
    pred_dmg_viet = fiji_old['pred_perc_dmg']
    pred_dmg_viet_new = fiji_new['pred_perc_dmg']
    muns = fiji_old['NAME_2']

    rmse_viet = []
    rmse_viet_new = []
    for i in range(len(muns)):
        rmse_viet.append(np.sqrt(mean_squared_error([actual_dmg_old[i]], [pred_dmg_viet[i]])))
        rmse_viet_new.append(np.sqrt(mean_squared_error([actual_dmg_new[i]], [pred_dmg_viet_new[i]])))

    rmse_viet_tot.append(rmse_viet)
    rmse_viet_new_tot.append(rmse_viet_new)
```


```python
# RMSE per mun
rmse_mun_fji_viet = []
rmse_mun_fji_viet_new = []
for i in range(len(muns)):
    #RMSE no VIET
    test_rmse_mun = np.nanmean(np.array(rmse_viet_tot)[:,i])
    rmse_mun_fji_viet.append(test_rmse_mun)

    #RMSE with VIET
    test_rmse_mun_viet = np.nanmean(np.array(rmse_viet_new_tot)[:,i])
    rmse_mun_fji_viet_new.append(test_rmse_mun_viet)

```


```python
plt.plot(rmse_mun_fji_viet, 'o-', label='PHL+FJI+VIET model', alpha=0.8)
plt.plot(rmse_mun_fji_viet_new, 'o-', label='PHL+FJI+VIET model NEW bld count', alpha=0.8)

plt.xticks(range(len(muns)), muns, rotation='vertical')  # Set x-axis ticks and labels
plt.tight_layout()  # Adjust layout to prevent overlapping
plt.title('Tropical Cyclones in Fiji')
plt.ylabel('RMSE')

plt.legend()
plt.show()
```



![png](08.0_combined_model_with_viet_new_bld_count_files/08.0_combined_model_with_viet_new_bld_count_17_0.png)



Just to check


```python
typhoons
```




    array(['TOMAS', 'EVAN', 'WINSTON', 'GITA', 'SARAI', 'TINO', 'HAROLD',
           'YASA', 'ANA'], dtype=object)




```python
typhoon='GITA'

# Classic approach PHL+FJI+VIET
fiji_old = fiji.copy()
fiji_old['actual_perc_dmg'] = fiji_old.apply(calculate_actual_perc_dmg, df_fji=df_fji_complete_int,
                                             y_pred_typhoon=y_pred_typhoon_with_viet, i=1, typhoon=typhoon, axis=1)
fiji_old['pred_perc_dmg'] = fiji_old.apply(calculate_pred_perc_dmg, df_fji=df_fji_complete_int,
                                           y_pred_typhoon=y_pred_typhoon_with_viet, i=1, typhoon=typhoon, axis=1)

# Modify values
fiji_old['actual_perc_dmg'] = fiji_old['actual_perc_dmg'].apply(lambda x: 0 if x < 0 else (100 if x > 100 else x))
fiji_old['pred_perc_dmg'] = fiji_old['pred_perc_dmg'].apply(lambda x: 0 if x < 0 else (100 if x > 100 else x))
# Now calculate prediciton error
fiji_old['prediction_error'] = fiji_old['actual_perc_dmg'] - fiji_old['pred_perc_dmg'] # in percentual points


# New approach PHL+FJI+VIET new bld count
fiji_new = fiji.copy()
fiji_new['actual_perc_dmg'] = fiji_new.apply(calculate_actual_perc_dmg, df_fji=df_fji_complete_int_new,
                                             y_pred_typhoon=y_pred_typhoon_with_viet_new, i=1, typhoon=typhoon, axis=1)
fiji_new['pred_perc_dmg'] = fiji_new.apply(calculate_pred_perc_dmg, df_fji=df_fji_complete_int_new,
                                           y_pred_typhoon=y_pred_typhoon_with_viet_new, i=1, typhoon=typhoon, axis=1)
# Modify values
fiji_new['actual_perc_dmg'] = fiji_new['actual_perc_dmg'].apply(lambda x: 0 if x < 0 else (100 if x > 100 else x))
fiji_new['pred_perc_dmg'] = fiji_new['pred_perc_dmg'].apply(lambda x: 0 if x < 0 else (100 if x > 100 else x))
fiji_new['prediction_error'] = fiji_new['actual_perc_dmg'] - fiji_new['pred_perc_dmg'] # in percentual points

actual_dmg = fiji_old['actual_perc_dmg']
pred_dmg_viet = fiji_old['pred_perc_dmg']
pred_dmg_viet_new = fiji_new['pred_perc_dmg']
error_baseline = fiji_old['actual_perc_dmg'] - fiji_old['actual_perc_dmg'] #basically 0
error_old = fiji_old['prediction_error']
error_new = fiji_new['prediction_error']
muns = fiji_old['NAME_2']
```


```python
plt.plot(error_baseline, 'o-',label='Baseline', alpha=1)
plt.plot(error_old, 'o-', label='PHL+FJI+VIET model', alpha=0.4)
plt.plot(error_new, 'o-', label='PHL+FJI+VIET model, \nnew bld count', alpha=0.4)

plt.xticks(range(len(muns)), muns, rotation='vertical')  # Set x-axis ticks and labels
plt.tight_layout()  # Adjust layout to prevent overlapping
plt.title('Tropical Cyclone: {}'.format(typhoon))
plt.ylabel('% Points of damage')

plt.grid()
plt.legend(loc='upper left')
plt.show()
```



![png](08.0_combined_model_with_viet_new_bld_count_files/08.0_combined_model_with_viet_new_bld_count_21_0.png)
