```python
import matplotlib.pyplot as plt
from matplotlib.colors import Normalize
import matplotlib.patches as mpatches
import numpy as np
import os
from pathlib import Path
import pandas as pd
import geopandas as gpd
from climada.hazard import Centroids, TCTracks, TropCyclone
from shapely.geometry import LineString
from sklearn.metrics import mean_squared_error
from xgboost.sklearn import XGBRegressor
import geopandas as gpd
from climada.hazard import Centroids, TCTracks, TropCyclone
from shapely.geometry import LineString
from xgboost import plot_importance
import shap
import ast

from utils import get_combined_dataset_interpolated_with_viet_new_bld_count_using_pop, get_training_dataset_complete_interpolated_new_bld_count_using_pop , get_municipality_grids, xgb_model_combined_data_with_viet_LOOCV
```

## Loading data


```python
# For Checking (Number of buildings destroyed per mun)
input_dir = (
    Path(os.getenv("STORM_DATA_DIR"))
    / "analysis_fji/02_model_features/02_housing_damage/input/"
)
actual_mun_dmg = pd.read_csv(input_dir / "fji_building_damage_mun_complete.csv")
actual_mun_dmg['typhoon'] = actual_mun_dmg['typhoon'].str.upper()

# Load Fiji Shapefile
fiji = gpd.read_file(
    input_dir / "adm2_shp_fixed.gpkg"
)
fiji = fiji.to_crs('EPSG:4326')

# Load grid
grid_dir = (
    Path(os.getenv("STORM_DATA_DIR"))
    / "analysis_fji/02_model_features/02_housing_damage/output/"
)
grid = gpd.read_file(grid_dir / "fji_0.1_degree_grid_land_overlap_new.gpkg")


# Load typhoon track
tracks_dir = (
    Path(os.getenv("STORM_DATA_DIR"))
    / "analysis_fji/02_model_features/01_windfield"
)
typhoons_info = pd.read_csv(tracks_dir / "typhoons.csv")
typhoons_info.typhoon_name = typhoons_info.typhoon_name.str.upper()
cyclones = actual_mun_dmg['typhoon'].unique()
intersection = typhoons_info[typhoons_info['typhoon_name'].isin(cyclones)].drop_duplicates(keep='last', subset = ['typhoon_name'])

# Damage data Vietnam
input_dir_viet = (
    Path(os.getenv("STORM_DATA_DIR"))
    / "analysis_viet/02_model_features/02_housing_damage/input/"
)
damage_data_viet = pd.read_csv(input_dir_viet / 'viet_damage_adm1_level.csv')
damage_data_viet['region_affected'] = damage_data_viet['region_affected'].astype('str').apply(ast.literal_eval)
```


```python
# Features
features_old = [
    "wind_speed",
    "track_distance",
    "total_houses",
    "rainfall_max_6h",
    "rainfall_max_24h",
    "coast_length",
    "with_coast",
    "mean_elev",
    "mean_slope",
]
features_IWI = features_old + ["IWI"]
features_light = features_old + ["light_index"]
features_all = features_old + ["IWI", "light_index"]
```


```python
# Load Fiji complete interpolated new 2 (using pop data to bld count)
df_fji_complete_int = get_training_dataset_complete_interpolated_new_bld_count_using_pop()
df_fji_complete_int = df_fji_complete_int[df_fji_complete_int.typhoon_name != 'ANA'] # Drop ANA
df_fji_complete_int = df_fji_complete_int.rename({
    "mean_altitude": "mean_elev",
    "total_buildings": "total_houses",
    "perc_dmg_grid": "percent_houses_damaged"
}, axis=1)
df_fji_complete_int = df_fji_complete_int[features_all + ['typhoon_name', 'grid_point_id', 'Centroid', 'percent_houses_damaged']]

# Load combined dataset interpolated
df_combined_with_viet = get_combined_dataset_interpolated_with_viet_new_bld_count_using_pop()
df_fji_with_viet = df_combined_with_viet[df_combined_with_viet.country == 'fji']
```

## Selecting geolocalized typhoons


```python
# Selecting typhoons
# Fiji: EVAN, SARAI, TINO, TOMAS are ADM1
# Vietnam:
adm1_viet = damage_data_viet[damage_data_viet.region_affected.apply(lambda x: len(x) < 2)]
adm1_viet_typhoons = adm1_viet.typhoon_name.str.upper().to_list()
adm1_viet
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>typhoon_name</th>
      <th>Year</th>
      <th>total_bld_dmg</th>
      <th>region_affected</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Linda</td>
      <td>1997</td>
      <td>216054.0</td>
      <td>[MD]</td>
    </tr>
    <tr>
      <th>11</th>
      <td>KaiTak</td>
      <td>2012</td>
      <td>1297.0</td>
      <td>[NE]</td>
    </tr>
    <tr>
      <th>16</th>
      <td>Vicente</td>
      <td>2012</td>
      <td>496.0</td>
      <td>[NE]</td>
    </tr>
    <tr>
      <th>21</th>
      <td>Nari</td>
      <td>2013</td>
      <td>42586.0</td>
      <td>[NC]</td>
    </tr>
    <tr>
      <th>22</th>
      <td>Wutip</td>
      <td>2013</td>
      <td>201869.0</td>
      <td>[NC]</td>
    </tr>
    <tr>
      <th>29</th>
      <td>Mirinae</td>
      <td>2016</td>
      <td>13612.0</td>
      <td>[RRD]</td>
    </tr>
    <tr>
      <th>31</th>
      <td>Sonca</td>
      <td>2017</td>
      <td>187.0</td>
      <td>[NC]</td>
    </tr>
    <tr>
      <th>34</th>
      <td>Talas</td>
      <td>2017</td>
      <td>10878.0</td>
      <td>[NC]</td>
    </tr>
    <tr>
      <th>38</th>
      <td>Sinlaku</td>
      <td>2020</td>
      <td>3321.0</td>
      <td>[SC,C]</td>
    </tr>
  </tbody>
</table>
</div>




```python
df_viet = df_combined_with_viet[(df_combined_with_viet.typhoon_name.isin(adm1_viet_typhoons)) & (df_combined_with_viet.country=='viet')]
df_noviet = df_combined_with_viet[df_combined_with_viet.country != 'viet']
df_combined_localized = pd.concat([df_viet, df_noviet])
df_fji_localized = df_combined_localized[df_combined_localized.country == 'fji']
```

## Stratification


```python
# Stratification
dmg = np.array(df_fji_with_viet.percent_houses_damaged.to_list())
zero_dmg = np.round((np.count_nonzero(dmg == 0) / len(dmg)) , 2 )

# Define ranges for each group
x0 = list(np.linspace(0, zero_dmg, 1))   # zero damage
x1 = list(np.linspace(zero_dmg, 0.9, 2))  # almost no damage
x2 = list(np.linspace(0.935, 1, 5))  # all the damage
x3=x0+x1+x2

bins = []
for i in x3:
    bins.append(np.quantile(dmg, i))

# Histogram after stratification
samples_per_bin_fji, bins_def_fji = np.histogram(dmg, bins=bins)

# Define number of bins
num_bins_fji = len(samples_per_bin_fji)

# For future plots
str_bin_fji = []
for i in range(len(bins_def_fji[:-1])):
    a = str(np.round(bins_def_fji[i+1],3))
    b = str(np.round(bins_def_fji[i],3))
    str_bin_fji.append('{} - {}'.format(b,a))
```

## The models


```python
# Fji + Phl + Viet (with IWI) -LOCALIZED-
y_test_typhoon, y_pred_typhoon, rmse_strat, avg_error_strat = xgb_model_combined_data_with_viet_LOOCV(
    df_combined=df_combined_localized,
    df_fji=df_fji_localized,
    bins=bins_def_fji,
    fji_weight=3,
    phl_weight=1,
    features=features_IWI
)
```

    Mean of empty slice
    Mean of empty slice



```python
# Fji + Phl + Viet (with IWI) -ALL TYPHOONS-
y_test_typhoon_all, y_pred_typhoon_all, rmse_strat_all, avg_error_strat_all = xgb_model_combined_data_with_viet_LOOCV(
    df_combined=df_combined_with_viet,
    df_fji=df_fji_with_viet,
    bins=bins_def_fji,
    fji_weight=3,
    phl_weight=1,
    features=features_IWI
)
```

    Mean of empty slice
    Mean of empty slice


## Results per bin


```python
fig, ax = plt.subplots(1,1, figsize=(6,6))

ax.plot(range(num_bins_fji), rmse_strat_all, 'rs', alpha=0.5, label='All typhoons')
ax.plot(range(num_bins_fji), rmse_strat, 'gs', alpha=0.5, label='Just ADM1 Viet typhoons')


ax.set_xticks(range(num_bins_fji), str_bin_fji, rotation=45)
ax.set_xlabel('Damage [%]')
ax.set_ylabel('RMSE')
ax.grid()
ax.set_title('XGBoost Regression model (PHL+VIET+FJI) \n using LOOCV for Fiji typhoons')
ax.legend()

plt.tight_layout()
plt.show()
```



![png](10.0_combined_model_localized_typhoons_files/10.0_combined_model_localized_typhoons_14_0.png)
