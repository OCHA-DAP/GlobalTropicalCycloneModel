---
jupyter:
  jupytext:
    text_representation:
      extension: .md
      format_name: markdown
      format_version: '1.3'
      jupytext_version: 1.15.2
  kernelspec:
    display_name: Python 3 (ipykernel)
    language: python
    name: python3
---

```python
import pandas as pd
import os
from pathlib import Path
```

```python
pd.set_option("display.float_format", lambda x: "%.5f" % x)
input_dir = (
    Path(os.getenv("STORM_DATA_DIR"))
    / "analysis_fji/02_new_model_input/02_housing_damage/input/"
)
baseline_input_dir = (
    Path(os.getenv("STORM_DATA_DIR")) / "analysis_fji/01_baseline_model/input/"
)
output_dir = (
    Path(os.getenv("STORM_DATA_DIR"))
    / "analysis_fji/02_new_model_input/02_housing_damage/output/"
)
```

### Load data

```python
# Load housing damage
df_housing = pd.read_csv(input_dir / "fji_impact_data/processed_house_impact_new.csv")

# Define total damage
df_housing['total'] = df_housing['Destroyed'] + df_housing['Major Damage']
df_housing['total'] = df_housing['total'].astype(int)
df_housing['Year'] = df_housing['Year'].astype('Int64')

# Be concise
build_dmg_data = df_housing[['ADM1_NAME', 'ADM2_NAME', 'Cyclone Name', 'Year', 'Destroyed', 'Major Damage', 'total']].rename({'Cyclone Name':'typhoon', 'Destroyed':'Totally', 'Major Damage':'Partially' }, axis=1)

```

```python
build_dmg_data.isna().sum()
```

```python
build_dmg_data
```

### Fix it

```python
# Lets asign the year to evan, gina and tomas.
build_dmg_data.loc[build_dmg_data['typhoon'] == 'Evan', 'Year'] = build_dmg_data.loc[build_dmg_data['typhoon'] == 'Evan', 'Year'].fillna(2012)
build_dmg_data.loc[build_dmg_data['typhoon'] == 'Gita', 'Year'] = build_dmg_data.loc[build_dmg_data['typhoon'] == 'Gita', 'Year'].fillna(2018)
build_dmg_data.loc[build_dmg_data['typhoon'] == 'Tomas', 'Year'] = build_dmg_data.loc[build_dmg_data['typhoon'] == 'Tomas', 'Year'].fillna(2010)

```

Lets split the total damage values across all provinces in each division for the typhoons with no admin2 data

```python
# Define Municipalities in Provinces
east = ['Kadavu', 'Lau', 'Lomaiviti', 'Rotuma']
north =  ['Macuata', 'Cakaudrove', 'Bua']
west =  ['Ba', 'Nadroga_Navosa', 'Ra']
central = ['Naitasiri', 'Namosi', 'Rewa', 'Serua', 'Tailevu']

subset_damage = build_dmg_data[build_dmg_data.ADM2_NAME.isna()]

# Define the division-to-province mapping
division_to_province = {
    'Northern Division': north,
    'Western Division': west,
    'Central Division': central,
    'Eastern Division': east
}

# Create an empty DataFrame to store the expanded data
expanded_data = pd.DataFrame()

# Iterate through rows and expand divisions into multiple rows
for _, row in subset_damage.iterrows():
    division = row['ADM1_NAME']
    provinces = division_to_province.get(division, [])
    num_provinces = len(provinces)

    if num_provinces > 0:
        total_per_province = row['total'] / num_provinces
        for province in provinces:
            new_row = row.copy()
            new_row['ADM2_NAME'] = province
            new_row['total'] = total_per_province
            expanded_data = pd.concat([expanded_data, new_row.to_frame().T])

build_dmg_data = pd.concat([build_dmg_data.dropna(subset=['ADM2_NAME']), expanded_data]).copy()
```

```python
# Stadardize Municipality names
build_dmg_data = build_dmg_data.replace('Nadroga_Navosa','Nadroga/Navosa')
```

### Save it

```python
build_dmg_data
```

```python
build_dmg_data.to_csv(input_dir / "fji_building_damage_mun_complete.csv")
```
