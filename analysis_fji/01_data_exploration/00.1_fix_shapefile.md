---
jupyter:
  jupytext:
    text_representation:
      extension: .md
      format_name: markdown
      format_version: '1.3'
      jupytext_version: 1.15.2
  kernelspec:
    display_name: env1
    language: python
    name: env1
---

<!-- #region -->
Load shapefile and fix the coordinates. Since the 180 degree meridian falls into Fiji, it's a little bit tricky to work with the data because all the buildings on the east side have anti-intuitive coordinates (what is suppose to be 182 degrees is -178 degrees, and so on).


Where does the shapefile comes from? GADM: https://gadm.org/download_country.html
<!-- #endregion -->

```python
import os
from pathlib import Path
import geopandas as gpd
import numpy as np
import matplotlib.pyplot as plt
import pandas as pd
import re
from shapely.geometry import Polygon, MultiPolygon
```

```python
input_dir = (
    Path(os.getenv("STORM_DATA_DIR"))
    / "analysis_fji/02_new_model_input/02_housing_damage/input/"
)
output_dir = (
    Path(os.getenv("STORM_DATA_DIR"))
    / "analysis_fji/02_new_model_input/02_housing_damage/output/"
)
```

```python
adm2_shp = gpd.read_file(input_dir / "gadm41_FJI_shp/gadm41_FJI_2.shp" )
adm2_shp.head()
```

## Fix it


I couldn't find a suitable CRS and I cannot defined a custom CRS to transform this data. So let's fix it manually by treating the geometry as a string.

```python
# Fix coordinates
modified_geom = adm2_shp.copy()
modified_geom['str_geom'] = modified_geom.geometry.astype(str)

# Define a function to adjust geometries with negative longitudes
def adjust_geometry(geometry):
    adjusted_geometries = []

    pattern = r'\(\(([^)]*)\)\)|\(([^)]*)\)'
    matches = re.findall(pattern, geometry)

    for match in matches:
        coordinates = match[0] if match[0] else match[1]
        coordinates = re.findall(r'(-?\d+\.\d+ -?\d+\.\d+)', coordinates)
        polygon_coords = []

        for coord in coordinates:
            lon, lat = map(float, coord.split(' '))
            if lon < 0:
                lon += 360
            polygon_coords.append((lon, lat))  # Reversed the order of lon and lat

        if len(polygon_coords) > 2:
            # Create a Polygon if there are more than 2 coordinates
            adjusted_geometries.append(Polygon(polygon_coords))
        else:
            # Create a MultiPolygon if there are multiple polygons
            adjusted_geometries.append(MultiPolygon([Polygon(coords) for coords in polygon_coords]))

    if len(adjusted_geometries) == 1:
        return adjusted_geometries[0]
    else:
        return MultiPolygon(adjusted_geometries)

# Apply the function to each geometry
modified_geom['geometry'] = modified_geom['str_geom'].apply(adjust_geometry)
```

```python
fiji = modified_geom.copy()
fiji.loc[:, "geometry"].plot()
plt.xlim(176,182)
plt.ylim(-20,-15)
plt.grid()
plt.show()
```

## Save it

```python
modified_geom.to_file(input_dir / "adm2_shp_fixed.gpkg", driver="GPKG")
```
