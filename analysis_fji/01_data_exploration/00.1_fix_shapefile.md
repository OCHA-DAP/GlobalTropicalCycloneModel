Load shapefile and fix the coordinates. Since the 180 degree meridian falls into Fiji, it's a little bit tricky to work with the data because all the buildings on the east side have anti-intuitive coordinates (what is suppose to be 182 degrees is -178 degrees, and so on).


Where does the shapefile comes from? GADM: https://gadm.org/download_country.html


```python
import os
from pathlib import Path
import geopandas as gpd
import numpy as np
import matplotlib.pyplot as plt
import pandas as pd
import re
from shapely.geometry import Polygon, MultiPolygon
```


```python
input_dir = (
    Path(os.getenv("STORM_DATA_DIR"))
    / "analysis_fji/02_new_model_input/02_housing_damage/input/"
)
output_dir = (
    Path(os.getenv("STORM_DATA_DIR"))
    / "analysis_fji/02_new_model_input/02_housing_damage/output/"
)
```


```python
adm2_shp = gpd.read_file(input_dir / "gadm41_FJI_shp/gadm41_FJI_2.shp" )
adm2_shp.head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>GID_2</th>
      <th>GID_0</th>
      <th>COUNTRY</th>
      <th>GID_1</th>
      <th>NAME_1</th>
      <th>NL_NAME_1</th>
      <th>NAME_2</th>
      <th>VARNAME_2</th>
      <th>NL_NAME_2</th>
      <th>TYPE_2</th>
      <th>ENGTYPE_2</th>
      <th>CC_2</th>
      <th>HASC_2</th>
      <th>geometry</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>FJI.1.1_1</td>
      <td>FJI</td>
      <td>Fiji</td>
      <td>FJI.1_1</td>
      <td>Central</td>
      <td>NA</td>
      <td>Naitasiri</td>
      <td>NA</td>
      <td>NA</td>
      <td>Province</td>
      <td>Province</td>
      <td>NA</td>
      <td>FJ.CENT</td>
      <td>POLYGON ((178.02792 -17.57986, 178.02873 -17.5...</td>
    </tr>
    <tr>
      <th>1</th>
      <td>FJI.1.2_1</td>
      <td>FJI</td>
      <td>Fiji</td>
      <td>FJI.1_1</td>
      <td>Central</td>
      <td>NA</td>
      <td>Namosi</td>
      <td>NA</td>
      <td>NA</td>
      <td>Province</td>
      <td>Province</td>
      <td>NA</td>
      <td>FJ.CE.NM</td>
      <td>MULTIPOLYGON (((178.27052 -18.17324, 178.27080...</td>
    </tr>
    <tr>
      <th>2</th>
      <td>FJI.1.3_1</td>
      <td>FJI</td>
      <td>Fiji</td>
      <td>FJI.1_1</td>
      <td>Central</td>
      <td>NA</td>
      <td>Rewa</td>
      <td>NA</td>
      <td>NA</td>
      <td>Province</td>
      <td>Province</td>
      <td>NA</td>
      <td>FJ.CE.RW</td>
      <td>MULTIPOLYGON (((178.15167 -18.41028, 178.15111...</td>
    </tr>
    <tr>
      <th>3</th>
      <td>FJI.1.4_1</td>
      <td>FJI</td>
      <td>Fiji</td>
      <td>FJI.1_1</td>
      <td>Central</td>
      <td>NA</td>
      <td>Serua</td>
      <td>NA</td>
      <td>NA</td>
      <td>Province</td>
      <td>Province</td>
      <td>NA</td>
      <td>FJ.CE.SR</td>
      <td>MULTIPOLYGON (((178.07361 -18.43389, 178.07333...</td>
    </tr>
    <tr>
      <th>4</th>
      <td>FJI.1.5_1</td>
      <td>FJI</td>
      <td>Fiji</td>
      <td>FJI.1_1</td>
      <td>Central</td>
      <td>NA</td>
      <td>Tailevu</td>
      <td>NA</td>
      <td>NA</td>
      <td>Province</td>
      <td>Province</td>
      <td>NA</td>
      <td>FJ.CE.TL</td>
      <td>MULTIPOLYGON (((178.61694 -17.97167, 178.61722...</td>
    </tr>
  </tbody>
</table>
</div>



## Fix it

I couldn't find a suitable CRS and I cannot defined a custom CRS to transform this data. So let's fix it manually by treating the geometry as a string.


```python
# Fix coordinates
modified_geom = adm2_shp.copy()
modified_geom['str_geom'] = modified_geom.geometry.astype(str)

# Define a function to adjust geometries with negative longitudes
def adjust_geometry(geometry):
    adjusted_geometries = []

    pattern = r'\(\(([^)]*)\)\)|\(([^)]*)\)'
    matches = re.findall(pattern, geometry)

    for match in matches:
        coordinates = match[0] if match[0] else match[1]
        coordinates = re.findall(r'(-?\d+\.\d+ -?\d+\.\d+)', coordinates)
        polygon_coords = []

        for coord in coordinates:
            lon, lat = map(float, coord.split(' '))
            if lon < 0:
                lon += 360
            polygon_coords.append((lon, lat))  # Reversed the order of lon and lat

        if len(polygon_coords) > 2:
            # Create a Polygon if there are more than 2 coordinates
            adjusted_geometries.append(Polygon(polygon_coords))
        else:
            # Create a MultiPolygon if there are multiple polygons
            adjusted_geometries.append(MultiPolygon([Polygon(coords) for coords in polygon_coords]))

    if len(adjusted_geometries) == 1:
        return adjusted_geometries[0]
    else:
        return MultiPolygon(adjusted_geometries)

# Apply the function to each geometry
modified_geom['geometry'] = modified_geom['str_geom'].apply(adjust_geometry)
```


```python
fiji = modified_geom.copy()
fiji.loc[:, "geometry"].plot()
plt.xlim(176,182)
plt.ylim(-20,-15)
plt.grid()
plt.show()
```



![png](00.1_fix_shapefile_files/00.1_fix_shapefile_7_0.png)



## Save it


```python
modified_geom.to_file(input_dir / "adm2_shp_fixed.gpkg", driver="GPKG")
```

```python

```
