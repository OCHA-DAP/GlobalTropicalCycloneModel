```python
from pathlib import Path
import os
import pandas as pd
import geopandas as gpd
import numpy as np
from shapely.geometry import Point

import rasterio
from rasterio.merge import merge
from rasterstats import zonal_stats

from osgeo import gdal
import matplotlib.pyplot as plt
```

```python
# https://dwtkns.com/srtm30m/ to get the data (must be registered)

base_url = Path(os.getenv("STORM_DATA_DIR")) / "analysis_fji/02_new_model_input/"
input_dir = base_url / "04_topography/input/srtm/"
output_dir = base_url / "04_topography/output/"
shp_output_dir = base_url / "02_housing_damage/output/"
```

```python
# Load grid
grid = gpd.read_file(base_url / "02_housing_damage/output/fji_0.1_degree_grid_land_overlap_new.gpkg")
# Load Fiji
adm2_shp = gpd.read_file(base_url / "02_housing_damage/input/adm2_shp_fixed.gpkg")
adm2_shp = adm2_shp.to_crs('EPSG:4326')
```

## Merge all .hdg files


```python
# List all files
fileList = os.listdir(input_dir/ "dwtkms")
print(fileList)

# All .hgt together
mosaic_raster = []
for file in fileList:
    if file.endswith(".hgt"):
        rast = rasterio.open(input_dir / "dwtkms" / file)
        mosaic_raster.append(rast)
merged_raster, out_raster = merge(mosaic_raster)

# Metadata of the files
out_meta = rast.meta.copy()
out_meta.update(
    {
        "driver": "GTiff",
        "height": merged_raster.shape[1],
        "width": merged_raster.shape[2],
        "transform": out_raster,
#        "crs": grid.crs,
    }
)

# Save file
with rasterio.open(input_dir / "fji_merged_srtm.tif", "w", **out_meta) as dest:
    dest.write(merged_raster)

```

```python
merged_raster.max()
```

```python
merged_raster.min()
```

```python
merged_raster
```

```python
out_meta
```

```python
# Create a GDAL memory dataset
driver = gdal.GetDriverByName(out_meta['driver'])
dataset = driver.Create('', out_meta['width'], out_meta['height'], out_meta['count'], gdal.GDT_Int16)

# Set geotransform
dataset.SetGeoTransform(out_meta['transform'])

# Set projection
srs = osr.SpatialReference()
srs.SetFromUserInput(out_meta['crs'])
dataset.SetProjection(srs.ExportToWkt())

# Write data to the dataset
band = dataset.GetRasterBand(1)
band.WriteArray(merged_raster)
```

## Open merged file and locate in the FIJI region


```python
# Open new .tif
merged_rast = gdal.Open(str(input_dir / "fji_merged_srtm.tif"))

# Read band 1 (height)
band = merged_rast.GetRasterBand(1)
altitude = band.ReadAsArray()
```

Restrict to the fiji Region.

For that, let's use `geotransform`.

This gives a list `(a,b,c,d,e,f)`


    -b and f are the pixel width and height, respectively.
    -a and d are the longitude and latitude of the upper-left corner of the pixel (the origin).
    -d and e are rotation coefficients, which are usually 0 in most cases.


```python
# Get the geotransform information to calculate coordinates
geotransform = merged_rast.GetGeoTransform()
print(geotransform)

# Define the minimum and maximum latitude and longitude coordinates for the region of interest (ROI) - Fiji
min_longitude = 176.5
max_longitude = 182
min_latitude = -19.5
max_latitude = -16

# Since the 180 meridian goes through Fiji, we must treat 2 regions separately.

# PART 1
# Calculate the corresponding row and column indices for the ROI -Fiji
min_col = int((min_longitude - geotransform[0]) / geotransform[1])
max_col = int((max_longitude - geotransform[0]) / geotransform[1])
min_row = int((max_latitude - geotransform[3]) / geotransform[5])
max_row = int((min_latitude - geotransform[3]) / geotransform[5])

# Extract the ROI from the original arrays
reduced_altitude = altitude[min_row:max_row, min_col:max_col]

# Calculate the reduced slope based on the reduced altitude
x, y = np.gradient(reduced_altitude)
reduced_slope = np.arctan(np.sqrt(x ** 2 + y ** 2)) * (180 / np.pi)

# PART 2
min_longitude2 = -180
max_longitude2 = (max_longitude - 360)

min_col = int((min_longitude2 - geotransform[0]) / geotransform[1])
max_col = int((max_longitude2 - geotransform[0]) / geotransform[1])
min_row = int((max_latitude - geotransform[3]) / geotransform[5])
max_row = int((min_latitude - geotransform[3]) / geotransform[5])

# Extract the ROI from the original altitude array
reduced_altitude2 = altitude[min_row:max_row, min_col:max_col]

# Calculate the reduced slope based on the reduced altitude
x, y = np.gradient(reduced_altitude2)
reduced_slope2 = np.arctan(np.sqrt(x ** 2 + y ** 2)) * (180 / np.pi)

reduced_altitude_final = np.concatenate((reduced_altitude, reduced_altitude2), axis=1)
reduced_slope_final = np.concatenate((reduced_slope, reduced_slope2), axis=1)
```

    (-180.0001388888889, 0.0002777777777777778, 0.0, -14.99986111111111, 0.0, -0.0002777777777777778)



```python
np.shape(reduced_altitude_final)
```




    (12600, 19801)



Sometimes we dont have altitude data in some parts of the ocean and by default the number -32768 is set. As a ploting technique, let's replace this number with something more managable



```python
# Replace -32768 with -100
reduced_altitude_final_fix = reduced_altitude_final.copy()
reduced_altitude_final_fix[reduced_altitude_final_fix == -32768] = -100

# Plot the altitude data
plt.figure(figsize=(8, 8))
plt.imshow(reduced_altitude_final_fix, cmap='terrain',
           extent=[min_longitude, max_longitude, min_latitude, max_latitude],
           vmin=-100, vmax=np.max(reduced_altitude_final_fix)) # Custom colorbar just to visualize better
plt.colorbar(label='Altitude [m]')
plt.title('Altitude Map')
plt.show()

# Plot the slope data
plt.figure(figsize=(8, 8))
plt.imshow(reduced_slope_final, cmap='viridis', extent=[min_longitude, max_longitude, min_latitude, max_latitude])
plt.colorbar(label='Slope [degree]')
plt.title('Slope Map')
plt.show()
```



![png](04.0_topography_variables_files/04.0_topography_variables_12_0.png)





![png](04.0_topography_variables_files/04.0_topography_variables_12_1.png)



## To grid

### Save and load just in case


```python
np.save(output_dir/'altitude_fiji.npy', reduced_altitude_final)
np.save(output_dir/'slope_fiji.npy', reduced_slope_final)
np.save(output_dir/'geotransform.npy', np.array(geotransform))
```


```python
reduced_altitude_final = np.load(output_dir/'altitude_fiji.npy')
reduced_slope_final = np.load(output_dir/'slope_fiji.npy')
geotransform = np.load(output_dir/'geotransform.npy')
data = np.load('data_for_df.npy')
min_longitude = 176.5
max_longitude = 182
min_latitude = -19.5
max_latitude = -16
```

## Plot data+grids


```python
fig, ax = plt.subplots(1, 2, figsize=(12,8))

# Intersection of grid and shapefile
adm2_grid_intersection = gpd.overlay(adm2_shp, grid, how="identity")
adm2_grid_intersection.loc[:, "geometry"].plot(ax=ax[0])
ax[0].axis([min_longitude, max_longitude, min_latitude, max_latitude])
adm2_grid_intersection.loc[:, "geometry"].plot(ax=ax[1])
ax[1].axis([min_longitude, max_longitude, min_latitude, max_latitude])

# Plot the slope data
img = ax[0].imshow(reduced_slope_final, cmap='viridis', extent=[min_longitude, max_longitude, min_latitude, max_latitude])
plt.colorbar(img, ax=ax[0], label='Slope [degree]')
ax[0].set_title('Slope Map + grids')

# Plot the altitude data
img = ax[1].imshow(reduced_altitude_final, cmap='terrain', extent=[min_longitude, max_longitude, min_latitude, max_latitude])
plt.colorbar(img, ax=ax[1], label='Altitude [m]')
ax[1].set_title('Altitude Map + grids')

plt.tight_layout()
plt.show()
```



![png](04.0_topography_variables_files/04.0_topography_variables_18_0.png)



Good to know: we don't have altitude information for some small islands on the east side.

### To grid and consider less datapoints


```python
"""RUN WITH CAUTION"""

step = 5 # I dont need THAT MUCH resolution in my database (each datapoint is 30m appart from the next datapoint)

def pixel_to_lat_lon(x, y, min_lat, min_lon):
    increment = geotransform[1]
    lat = min_lat + y * increment
    lon = min_lon + x * increment
    return lat, lon

min_row, min_col = 0, 0
max_row, max_col = np.shape(reduced_altitude_final)

data = []
for row in range(0, max_row-1, step):
    for col in range(0, max_col-1, step):
        lat, lon = pixel_to_lat_lon(col, row, min_lat=min_latitude, min_lon=min_longitude)
        data.append((reduced_altitude_final[row, col], reduced_slope_final[row, col], lat, lon))


df = pd.DataFrame(data, columns=['altitude', 'slope', 'latitude', 'longitude'])
```


```python
# Save
df.to_csv(output_dir / "topology_data_raw.csv")
```


```python
# Load
df = pd.read_csv(output_dir / "topology_data_raw.csv")
```


```python
# Remove oceans (i.e altitude <0) Obs: nodata = -32768 m typically
df_no_oceans = df[df['altitude'] >= 0]
df_no_oceans = df_no_oceans.reset_index(drop=True)
df_no_oceans
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Unnamed: 0</th>
      <th>altitude</th>
      <th>slope</th>
      <th>latitude</th>
      <th>longitude</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>180</td>
      <td>0.0</td>
      <td>89.996503</td>
      <td>-19.500000</td>
      <td>177.000000</td>
    </tr>
    <tr>
      <th>1</th>
      <td>181</td>
      <td>0.0</td>
      <td>0.000000</td>
      <td>-19.500000</td>
      <td>177.002778</td>
    </tr>
    <tr>
      <th>2</th>
      <td>182</td>
      <td>0.0</td>
      <td>0.000000</td>
      <td>-19.500000</td>
      <td>177.005556</td>
    </tr>
    <tr>
      <th>3</th>
      <td>183</td>
      <td>0.0</td>
      <td>0.000000</td>
      <td>-19.500000</td>
      <td>177.008333</td>
    </tr>
    <tr>
      <th>4</th>
      <td>184</td>
      <td>0.0</td>
      <td>0.000000</td>
      <td>-19.500000</td>
      <td>177.011111</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>1880227</th>
      <td>2494436</td>
      <td>0.0</td>
      <td>0.000000</td>
      <td>-16.002778</td>
      <td>180.988889</td>
    </tr>
    <tr>
      <th>1880228</th>
      <td>2494437</td>
      <td>0.0</td>
      <td>0.000000</td>
      <td>-16.002778</td>
      <td>180.991667</td>
    </tr>
    <tr>
      <th>1880229</th>
      <td>2494438</td>
      <td>0.0</td>
      <td>0.000000</td>
      <td>-16.002778</td>
      <td>180.994444</td>
    </tr>
    <tr>
      <th>1880230</th>
      <td>2494439</td>
      <td>0.0</td>
      <td>0.000000</td>
      <td>-16.002778</td>
      <td>180.997222</td>
    </tr>
    <tr>
      <th>1880231</th>
      <td>2494440</td>
      <td>0.0</td>
      <td>0.000000</td>
      <td>-16.002778</td>
      <td>181.000000</td>
    </tr>
  </tbody>
</table>
<p>1880232 rows × 5 columns</p>
</div>



### Mean altitude and Mean slope


```python
# Create a GeoDataFrame from the DataFrame 'df' with a specified CRS
gdf = gpd.GeoDataFrame(df_no_oceans, geometry=[Point(x, y) for x, y in zip(df_no_oceans.longitude, df_no_oceans.latitude)])
gdf.crs = grid.crs  # Set the CRS to WGS 84

# Calculate mean altitude and mean slope for each polygon
merged = gpd.sjoin(grid, gdf)
mean_data = merged.groupby('id').agg(mean_altitude=('altitude', 'mean'), mean_slope=('slope', 'mean')).reset_index()
merged_grid = pd.merge(grid, mean_data, on='id', how='left')
```


```python
# How many datapoints per grid?
merged.groupby('id').count().rename({'Longitude': 'Data points'},axis=1)['Data points'].hist()
plt.xlabel('Altitude Datapoints')
plt.ylabel('Number of grid cells')
plt.show()
```



![png](04.0_topography_variables_files/04.0_topography_variables_27_0.png)



In the majority of cases, we have around 1200 datapoints per grid. In some cases (likely small islands) we have around 36 data points.


```python
# There's also no altitude information for some grid cells
nans_altitude = merged_grid[merged_grid.isna().any(axis=1)]
nans_altitude
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>id</th>
      <th>Longitude</th>
      <th>Latitude</th>
      <th>Centroid</th>
      <th>geometry</th>
      <th>mean_altitude</th>
      <th>mean_slope</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>355</td>
      <td>176.85</td>
      <td>-17.15</td>
      <td>176.85E_-17.15N</td>
      <td>POLYGON ((176.80000 -17.10000, 176.90000 -17.1...</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1</th>
      <td>409</td>
      <td>176.95</td>
      <td>-12.45</td>
      <td>176.95E_-12.45N</td>
      <td>POLYGON ((176.90000 -12.40000, 177.00000 -12.4...</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2</th>
      <td>456</td>
      <td>176.95</td>
      <td>-17.15</td>
      <td>176.95E_-17.15N</td>
      <td>POLYGON ((176.90000 -17.10000, 177.00000 -17.1...</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>3</th>
      <td>510</td>
      <td>177.05</td>
      <td>-12.45</td>
      <td>177.05E_-12.45N</td>
      <td>POLYGON ((177.00000 -12.40000, 177.10000 -12.4...</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>4</th>
      <td>511</td>
      <td>177.05</td>
      <td>-12.55</td>
      <td>177.05E_-12.55N</td>
      <td>POLYGON ((177.00000 -12.50000, 177.10000 -12.5...</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>9</th>
      <td>611</td>
      <td>177.15</td>
      <td>-12.45</td>
      <td>177.15E_-12.45N</td>
      <td>POLYGON ((177.10000 -12.40000, 177.20000 -12.4...</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>10</th>
      <td>612</td>
      <td>177.15</td>
      <td>-12.55</td>
      <td>177.15E_-12.55N</td>
      <td>POLYGON ((177.10000 -12.50000, 177.20000 -12.5...</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>325</th>
      <td>3573</td>
      <td>180.05</td>
      <td>-15.75</td>
      <td>180.05E_-15.75N</td>
      <td>POLYGON ((180.00000 -15.70000, 180.10000 -15.7...</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>334</th>
      <td>3674</td>
      <td>180.15</td>
      <td>-15.75</td>
      <td>180.15E_-15.75N</td>
      <td>POLYGON ((180.10000 -15.70000, 180.20000 -15.7...</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>352</th>
      <td>4080</td>
      <td>180.55</td>
      <td>-15.95</td>
      <td>180.55E_-15.95N</td>
      <td>POLYGON ((180.50000 -15.90000, 180.60000 -15.9...</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>382</th>
      <td>4698</td>
      <td>181.15</td>
      <td>-17.15</td>
      <td>181.15E_-17.15N</td>
      <td>POLYGON ((181.10000 -17.10000, 181.20000 -17.1...</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>383</th>
      <td>4700</td>
      <td>181.15</td>
      <td>-17.35</td>
      <td>181.15E_-17.35N</td>
      <td>POLYGON ((181.10000 -17.30000, 181.20000 -17.3...</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>384</th>
      <td>4703</td>
      <td>181.15</td>
      <td>-17.65</td>
      <td>181.15E_-17.65N</td>
      <td>POLYGON ((181.10000 -17.60000, 181.20000 -17.6...</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>385</th>
      <td>4704</td>
      <td>181.15</td>
      <td>-17.75</td>
      <td>181.15E_-17.75N</td>
      <td>POLYGON ((181.10000 -17.70000, 181.20000 -17.7...</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>386</th>
      <td>4708</td>
      <td>181.15</td>
      <td>-18.15</td>
      <td>181.15E_-18.15N</td>
      <td>POLYGON ((181.10000 -18.10000, 181.20000 -18.1...</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>387</th>
      <td>4709</td>
      <td>181.15</td>
      <td>-18.25</td>
      <td>181.15E_-18.25N</td>
      <td>POLYGON ((181.10000 -18.20000, 181.20000 -18.2...</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>388</th>
      <td>4715</td>
      <td>181.15</td>
      <td>-18.85</td>
      <td>181.15E_-18.85N</td>
      <td>POLYGON ((181.10000 -18.80000, 181.20000 -18.8...</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>389</th>
      <td>4716</td>
      <td>181.15</td>
      <td>-18.95</td>
      <td>181.15E_-18.95N</td>
      <td>POLYGON ((181.10000 -18.90000, 181.20000 -18.9...</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>390</th>
      <td>4737</td>
      <td>181.15</td>
      <td>-21.05</td>
      <td>181.15E_-21.05N</td>
      <td>POLYGON ((181.10000 -21.00000, 181.20000 -21.0...</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>391</th>
      <td>4800</td>
      <td>181.25</td>
      <td>-17.25</td>
      <td>181.25E_-17.25N</td>
      <td>POLYGON ((181.20000 -17.20000, 181.30000 -17.2...</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>392</th>
      <td>4803</td>
      <td>181.25</td>
      <td>-17.55</td>
      <td>181.25E_-17.55N</td>
      <td>POLYGON ((181.20000 -17.50000, 181.30000 -17.5...</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>393</th>
      <td>4804</td>
      <td>181.25</td>
      <td>-17.65</td>
      <td>181.25E_-17.65N</td>
      <td>POLYGON ((181.20000 -17.60000, 181.30000 -17.6...</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>394</th>
      <td>4809</td>
      <td>181.25</td>
      <td>-18.15</td>
      <td>181.25E_-18.15N</td>
      <td>POLYGON ((181.20000 -18.10000, 181.30000 -18.1...</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>395</th>
      <td>4810</td>
      <td>181.25</td>
      <td>-18.25</td>
      <td>181.25E_-18.25N</td>
      <td>POLYGON ((181.20000 -18.20000, 181.30000 -18.2...</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>396</th>
      <td>4811</td>
      <td>181.25</td>
      <td>-18.35</td>
      <td>181.25E_-18.35N</td>
      <td>POLYGON ((181.20000 -18.30000, 181.30000 -18.3...</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>397</th>
      <td>4814</td>
      <td>181.25</td>
      <td>-18.65</td>
      <td>181.25E_-18.65N</td>
      <td>POLYGON ((181.20000 -18.60000, 181.30000 -18.6...</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>398</th>
      <td>4834</td>
      <td>181.25</td>
      <td>-20.65</td>
      <td>181.25E_-20.65N</td>
      <td>POLYGON ((181.20000 -20.60000, 181.30000 -20.6...</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>399</th>
      <td>4838</td>
      <td>181.25</td>
      <td>-21.05</td>
      <td>181.25E_-21.05N</td>
      <td>POLYGON ((181.20000 -21.00000, 181.30000 -21.0...</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>400</th>
      <td>4906</td>
      <td>181.35</td>
      <td>-17.75</td>
      <td>181.35E_-17.75N</td>
      <td>POLYGON ((181.30000 -17.70000, 181.40000 -17.7...</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>401</th>
      <td>4912</td>
      <td>181.35</td>
      <td>-18.35</td>
      <td>181.35E_-18.35N</td>
      <td>POLYGON ((181.30000 -18.30000, 181.40000 -18.3...</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>402</th>
      <td>4915</td>
      <td>181.35</td>
      <td>-18.65</td>
      <td>181.35E_-18.65N</td>
      <td>POLYGON ((181.30000 -18.60000, 181.40000 -18.6...</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>403</th>
      <td>4917</td>
      <td>181.35</td>
      <td>-18.85</td>
      <td>181.35E_-18.85N</td>
      <td>POLYGON ((181.30000 -18.80000, 181.40000 -18.8...</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>404</th>
      <td>4920</td>
      <td>181.35</td>
      <td>-19.15</td>
      <td>181.35E_-19.15N</td>
      <td>POLYGON ((181.30000 -19.10000, 181.40000 -19.1...</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>405</th>
      <td>4935</td>
      <td>181.35</td>
      <td>-20.65</td>
      <td>181.35E_-20.65N</td>
      <td>POLYGON ((181.30000 -20.60000, 181.40000 -20.6...</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>406</th>
      <td>5016</td>
      <td>181.45</td>
      <td>-18.65</td>
      <td>181.45E_-18.65N</td>
      <td>POLYGON ((181.40000 -18.60000, 181.50000 -18.6...</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>407</th>
      <td>5018</td>
      <td>181.45</td>
      <td>-18.85</td>
      <td>181.45E_-18.85N</td>
      <td>POLYGON ((181.40000 -18.80000, 181.50000 -18.8...</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>408</th>
      <td>5019</td>
      <td>181.45</td>
      <td>-18.95</td>
      <td>181.45E_-18.95N</td>
      <td>POLYGON ((181.40000 -18.90000, 181.50000 -18.9...</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>409</th>
      <td>5020</td>
      <td>181.45</td>
      <td>-19.05</td>
      <td>181.45E_-19.05N</td>
      <td>POLYGON ((181.40000 -19.00000, 181.50000 -19.0...</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>410</th>
      <td>5021</td>
      <td>181.45</td>
      <td>-19.15</td>
      <td>181.45E_-19.15N</td>
      <td>POLYGON ((181.40000 -19.10000, 181.50000 -19.1...</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>411</th>
      <td>5111</td>
      <td>181.55</td>
      <td>-18.05</td>
      <td>181.55E_-18.05N</td>
      <td>POLYGON ((181.50000 -18.00000, 181.60000 -18.0...</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>412</th>
      <td>5115</td>
      <td>181.55</td>
      <td>-18.45</td>
      <td>181.55E_-18.45N</td>
      <td>POLYGON ((181.50000 -18.40000, 181.60000 -18.4...</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>413</th>
      <td>5117</td>
      <td>181.55</td>
      <td>-18.65</td>
      <td>181.55E_-18.65N</td>
      <td>POLYGON ((181.50000 -18.60000, 181.60000 -18.6...</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>414</th>
      <td>5118</td>
      <td>181.55</td>
      <td>-18.75</td>
      <td>181.55E_-18.75N</td>
      <td>POLYGON ((181.50000 -18.70000, 181.60000 -18.7...</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>415</th>
      <td>5120</td>
      <td>181.55</td>
      <td>-18.95</td>
      <td>181.55E_-18.95N</td>
      <td>POLYGON ((181.50000 -18.90000, 181.60000 -18.9...</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>416</th>
      <td>5122</td>
      <td>181.55</td>
      <td>-19.15</td>
      <td>181.55E_-19.15N</td>
      <td>POLYGON ((181.50000 -19.10000, 181.60000 -19.1...</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>417</th>
      <td>5123</td>
      <td>181.55</td>
      <td>-19.25</td>
      <td>181.55E_-19.25N</td>
      <td>POLYGON ((181.50000 -19.20000, 181.60000 -19.2...</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>418</th>
      <td>5221</td>
      <td>181.65</td>
      <td>-18.95</td>
      <td>181.65E_-18.95N</td>
      <td>POLYGON ((181.60000 -18.90000, 181.70000 -18.9...</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>419</th>
      <td>5223</td>
      <td>181.65</td>
      <td>-19.15</td>
      <td>181.65E_-19.15N</td>
      <td>POLYGON ((181.60000 -19.10000, 181.70000 -19.1...</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>420</th>
      <td>5331</td>
      <td>181.75</td>
      <td>-19.85</td>
      <td>181.75E_-19.85N</td>
      <td>POLYGON ((181.70000 -19.80000, 181.80000 -19.8...</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
  </tbody>
</table>
</div>




```python
# Lets locate these points
fig, ax = plt.subplots(1,1, figsize=(10,6))
nans_altitude.plot(ax=ax, color='red', label='No altitude data')
adm2_shp.plot(ax=ax, label='Fiji')

ax.set_xlabel('Longitude')
ax.set_ylabel('Latitude')

# Create proxy artists for the legend
red_patch = plt.Line2D([0], [0], marker='s', color='w', label='No altitude data', markersize=10, markerfacecolor='red')
blue_patch = plt.Line2D([0], [0], marker='.', color='w', label='Fiji', markersize=10, markerfacecolor='blue')

# Add the legend using the proxy artists
ax.legend(handles=[red_patch, blue_patch])
plt.show()
```



![png](04.0_topography_variables_files/04.0_topography_variables_30_0.png)



My hypothesis: the altitude dataset must consider those datapoints as ocean and, since we're droping <0 data, we are loosing those points. I propose to replace those values with 0s in altitude.


```python
# Replace nans with 0
merged_grid = merged_grid.fillna(0)
```


```python
fig, ax = plt.subplots(1,2, figsize=(10,6))
merged_grid.mean_altitude.hist(ax=ax[0], bins=50)
ax[0].set_xlabel('Mean altitude [m]')
ax[0].set_ylabel('Frequency')
ax[0].set_title('Mean altitude in grids')

merged_grid.mean_slope.hist(ax=ax[1], bins=50)
ax[1].set_xlabel('Mean slope [degree]')
ax[1].set_ylabel('Frequency')
ax[1].set_title('Mean slope in grids')

plt.tight_layout()
plt.show()
```



![png](04.0_topography_variables_files/04.0_topography_variables_33_0.png)



### With coast and Coast length


```python
# dissolving polygons into one land mass
dissolved_shp = adm2_shp.dissolve(by="GID_0")

# Coastline
coastline = dissolved_shp.boundary
coastline.plot()
plt.show()
```



![png](04.0_topography_variables_files/04.0_topography_variables_35_0.png)




```python
coastline.crs = grid.crs
coastline
```




    GID_0
    FJI    MULTILINESTRING ((177.32417 -18.11583, 177.323...
    dtype: geometry




```python
# Linestrings and MultiLinestrings
grid_line_gdf = gpd.overlay(gpd.GeoDataFrame(coastline, geometry=coastline.geometry, crs=coastline.crs)
                .reset_index(),
                grid,
                how="intersection",
                )[["id", "Centroid", "geometry"]]
# Coast line
grid_line_gdf["coast_length"] = grid_line_gdf["geometry"].to_crs(25394).length #25394 gives me length in meters.
grid_coast = grid[["id", "Centroid"]].merge(grid_line_gdf, on=["id", "Centroid"], how="left")

# With coast? Binary
grid_coast["with_coast"] = np.where(grid_coast["coast_length"] > 0, 1, 0)
grid_coast["with_coast"].value_counts()
```




    with_coast
    1    338
    0     83
    Name: count, dtype: int64




```python
fig, ax = plt.subplots(1,2, figsize=(10,6))
ax[0] = grid_coast.with_coast.hist(ax=ax[0])
ax[0].set_xticks([0.05,0.95], ['No coast', 'With coast'])
ax[0].set_ylabel('Frequency')
ax[0].set_title('Grids with coasts')
ax[0].grid('off')

ax[1] = grid_coast.coast_length.fillna(0).hist(ax=ax[1])
ax[1].set_xlabel('Coast length [m]')
ax[1].set_ylabel('Frequency')
ax[1].set_title('Coast length per grid')


plt.tight_layout()
plt.show()
```



![png](04.0_topography_variables_files/04.0_topography_variables_38_0.png)



## Save it


```python
# Merge data
merge_final = merged_grid.merge(grid_coast, on='id', how='left')
merge_final = merge_final[['id','with_coast','coast_length','mean_altitude','mean_slope']]
merge_final = merge_final.fillna(0) # No coast length? Then is 0
```


```python
merge_final
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>id</th>
      <th>with_coast</th>
      <th>coast_length</th>
      <th>mean_altitude</th>
      <th>mean_slope</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>355</td>
      <td>1</td>
      <td>224.976542</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>409</td>
      <td>1</td>
      <td>9835.966285</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>456</td>
      <td>1</td>
      <td>30905.368530</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>510</td>
      <td>1</td>
      <td>19870.176731</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>511</td>
      <td>1</td>
      <td>32765.248313</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>416</th>
      <td>5122</td>
      <td>1</td>
      <td>49388.931854</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>417</th>
      <td>5123</td>
      <td>1</td>
      <td>10886.461556</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>418</th>
      <td>5221</td>
      <td>1</td>
      <td>1516.399318</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>419</th>
      <td>5223</td>
      <td>1</td>
      <td>10173.166160</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>420</th>
      <td>5331</td>
      <td>1</td>
      <td>17774.293574</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
  </tbody>
</table>
<p>421 rows × 5 columns</p>
</div>




```python
merge_final.to_csv(output_dir / "topography_variables_bygrid_new.csv", index=False)
```
