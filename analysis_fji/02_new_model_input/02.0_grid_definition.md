```python
import os
from pathlib import Path
import geopandas as gpd
from shapely.geometry import Polygon
import numpy as np
import matplotlib.pyplot as plt
import pandas as pd

pd.set_option("display.float_format", lambda x: "%.5f" % x)
```


```python
input_dir = (
    Path(os.getenv("STORM_DATA_DIR"))
    / "analysis_fji/02_new_model_input/02_housing_damage/input/"
)
output_dir = (
    Path(os.getenv("STORM_DATA_DIR"))
    / "analysis_fji/02_new_model_input/02_housing_damage/output/"
)

# Load Fiji
adm2_shp = gpd.read_file(
    input_dir / "adm2_shp_fixed.gpkg"
)
adm2_shp = adm2_shp.to_crs('EPSG:4326')
```

## Creation of grid


```python
# grid creation
xmin, xmax, ymin, ymax = 176.5, 182, -22, -12 # Fiji extremes coordintates

cell_size = 0.1

cols = list(np.arange(xmin, xmax + cell_size, cell_size))
rows = list(np.arange(ymin, ymax + cell_size, cell_size))
rows.reverse()

polygons = [
    Polygon(
        [
            (x, y),
            (x + cell_size, y),
            (x + cell_size, y - cell_size),
            (x, y - cell_size),
        ]
    )
    for x in cols
    for y in rows
]
grid = gpd.GeoDataFrame({"geometry": polygons}, crs=adm2_shp.crs)
grid["id"] = grid.index + 1
grid.head()
```
```python
grid.loc[:, "geometry"].plot()
plt.show()
```
```python
# write as geopackage
grid.to_file(output_dir / "fji_0.1_degree_grid_new.gpkg", driver="GPKG")
```

## Creation of centroids


```python
# Extract lat and lon from the centerpoint
grid["Longitude"] = grid["geometry"].centroid.map(lambda p: p.x)
grid["Latitude"] = grid["geometry"].centroid.map(lambda p: p.y)
grid["Centroid"] = (
    round(grid["Longitude"], 2).astype(str)
    + "E"
    + "_"
    + round(grid["Latitude"], 2).astype(str)
    + "N"
)
grid.head(5)
```

```python
# Centroids
grid_centroids = grid.copy()
grid_centroids["geometry"] = grid_centroids["geometry"].centroid
grid_centroids.loc[:, "geometry"].plot()
plt.show()
```

```python
# write as geopackage
grid_centroids.to_file(
    output_dir / "fji_0.1_degree_grid_centroids_new.gpkg", driver="GPKG"
)
```

## Intersection of grid and admin shapefile


```python
# intersection of grid and shapefile
adm2_grid_intersection = gpd.overlay(adm2_shp, grid, how="identity")
adm2_grid_intersection.loc[:, "geometry"].plot()
plt.axis([xmin, xmax, ymin, ymax])

plt.show()
```
```python
adm2_grid_intersection = adm2_grid_intersection.dropna(subset=["id"])
```


```python
adm2_grid_intersection.to_file(
    input_dir / "fji_adm2_grid_intersection_new.gpkg", driver="GPKG"
)
```

### Grid-land overlap


```python
grid_land_overlap = grid.loc[grid["id"].isin(adm2_grid_intersection["id"])]
```


```python
grid_land_overlap
```
```python
grid_land_overlap.to_file(
    output_dir / "fji_0.1_degree_grid_land_overlap_new.gpkg", driver="GPKG"
)
```


```python
grid_land_overlap_centroids = grid_centroids.loc[
    grid["id"].isin(adm2_grid_intersection["id"])
]
```


```python
grid_land_overlap_centroids.to_file(
    output_dir / "fji_0.1_degree_grid_centroids_land_overlap_new.gpkg",
    driver="GPKG",
)
```

### Grids per municipality


```python
grid_muni = gpd.sjoin(adm2_shp, grid_land_overlap, how='inner')
grid_muni = grid_muni.drop_duplicates(subset=['id'])

admin2_grid_muni = grid_muni[['id', 'NAME_2']].groupby(by='NAME_2').count().rename({'id':'grid_cells'}, axis=1).sort_values('grid_cells', ascending=False)
admin1_grid_muni = grid_muni[['id', 'NAME_1']].groupby(by='NAME_1').count().rename({'id':'grid_cells'}, axis=1).sort_values('grid_cells', ascending=False)

```


```python
fig, ax = plt.subplots(1,2, figsize=(12,6), gridspec_kw={'width_ratios': [2, 3]})
admin1_grid_muni.plot.bar(rot=45, legend=False, ax=ax[0])
ax[0].set_xlabel('')
ax[0].set_ylabel('Grid cells')
ax[0].set_title('Admin 1 (divisions)')

admin2_grid_muni.plot.bar(rot=90, legend=False, ax=ax[1])
ax[1].set_xlabel('')
ax[1].set_ylabel('Grid cells')
ax[1].set_title('Admin 2 (provinces)')

plt.tight_layout()
plt.show()
```
```python
grid_muni.to_csv(
    input_dir / "grid_municipality_info.csv",
)
```

```python

```
