```python
from pathlib import Path
import os

from shapely.geometry import LineString,Polygon, MultiPolygon
import geopandas as gpd
import numpy as np
import pandas as pd
import xarray as xr
import re
import matplotlib.pyplot as plt
from matplotlib.patches import Patch
from matplotlib.lines import Line2D
from scipy import stats
```


```python
input_dir = (
    Path(os.getenv("STORM_DATA_DIR"))
    / "analysis_fji/02_new_model_input/02_housing_damage/input/"
)
output_dir = (
    Path(os.getenv("STORM_DATA_DIR"))
    / "analysis_fji/02_new_model_input/02_housing_damage/output/"
)

# Load Fiji
fiji = gpd.read_file(input_dir / "adm2_shp_fixed.gpkg")
fiji = fiji.to_crs('EPSG:4326')

# Load grid
grid_land_overlap = gpd.read_file(output_dir / "fji_0.01_degree_grid_land_overlap.gpkg")
grid_land_overlap["id"] = grid_land_overlap["id"].astype(int)

# Load grids per Municipality
#ids_mun = pd.read_csv(input_dir / "grid_0.01_municipality_info.csv")

# Load damage data
#damage_data = pd.read_csv(input_dir / "fji_building_damage_mun_complete.csv")

```

## Building locations


```python
gpd_bld_east = gpd.read_file(
    input_dir / "hotosm_fji_east_buildings_polygons_shp.zip"
)
gpd_bld_west = gpd.read_file(
    input_dir / "hotosm_fji_west_buildings_polygons_shp.zip"
)
```

I would like to go from 0 to 360 in the longitude axis. Cannot find a useful crs that satisfy what I want. So let's define one.


```python
# Change crs
custom_crs = "+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs +lon_wrap=360"
east = gpd_bld_east.copy()
east = east.to_crs(custom_crs)

# Define crs for west side
west = gpd_bld_west.copy()
west = west.to_crs('EPSG:4326')
```

I would really want to work with one concatenated dataset but since the CRS of the east and the west are different, we have to work separately.

### Types of buildings


```python
# Type of buildings

bld = pd.concat([east.building, west.building])
fig, ax = plt.subplots(1,1)
ax.hist(bld, bins=50)
ax.set_xticklabels(ax.get_xticklabels(), rotation=90, size=8)

plt.show()
```

    /var/folders/dy/vms3cfrn4q9952h8s6l586dr0000gp/T/ipykernel_10610/311903155.py:6: UserWarning: set_ticklabels() should only be used with a fixed number of ticks, i.e. after set_ticks() or using a FixedLocator.
      ax.set_xticklabels(ax.get_xticklabels(), rotation=90, size=8)




![png](01.1_bld_to_grid_files/01.1_bld_to_grid_8_1.png)



We just have information about if there are buildings in a location and in some cases, if that builing is a house

### Map of building location


```python
# Plot builing loc over map
fig, ax = plt.subplots(1,1)

fiji.plot(ax=ax, color='gray', edgecolor='gray', label='Fiji')
east.plot(ax=ax, color='red', markersize=10, label='Buildings')
west.plot(ax=ax, color='red', markersize=10, label='Buildings')
ax.set_xlim(175.5, 182.5)
ax.set_ylim(-22,-12)
ax.set_xlabel('Longitude')
ax.set_ylabel('Latitude')
ax.set_title('Fiji builings locations')
# Manually create the legend
legend_elements = [
    Line2D([0], [0], marker='o', color='w', markerfacecolor='red', markersize=10, label='Buildings'),
    Patch(color='gray', label='Fiji')
]

ax.legend(handles=legend_elements, loc='upper left')

plt.savefig('building_location')
plt.show()
```



![png](01.1_bld_to_grid_files/01.1_bld_to_grid_11_0.png)



### Buildings to grid cells


```python
# Centroids
east_centroids = east.copy()
east_centroids["geometry"] = east_centroids["geometry"].centroid

west_centroids = west.copy()
west_centroids["geometry"] = west_centroids["geometry"].centroid
```

    /var/folders/dy/vms3cfrn4q9952h8s6l586dr0000gp/T/ipykernel_10610/1674229990.py:3: UserWarning: Geometry is in a geographic CRS. Results from 'centroid' are likely incorrect. Use 'GeoSeries.to_crs()' to re-project geometries to a projected CRS before this operation.

      east_centroids["geometry"] = east_centroids["geometry"].centroid
    /var/folders/dy/vms3cfrn4q9952h8s6l586dr0000gp/T/ipykernel_10610/1674229990.py:6: UserWarning: Geometry is in a geographic CRS. Results from 'centroid' are likely incorrect. Use 'GeoSeries.to_crs()' to re-project geometries to a projected CRS before this operation.

      west_centroids["geometry"] = west_centroids["geometry"].centroid



```python
# East and West buildings count per grid
east_bld_centroid_grid_count = grid_land_overlap.merge(
    grid_land_overlap.sjoin(east_centroids, how="left")
    .groupby("id")
    .count()
    .building.rename("numbuildings")
    .reset_index()
)

west_bld_centroid_grid_count = grid_land_overlap.merge(
    grid_land_overlap.sjoin(west_centroids, how="left")
    .groupby("id")
    .count()
    .building.rename("numbuildings")
    .reset_index()
)

```

    /Users/federico/anaconda3/envs/env6/lib/python3.11/site-packages/geopandas/geodataframe.py:2189: UserWarning: CRS mismatch between the CRS of left geometries and the CRS of right geometries.
    Use `to_crs()` to reproject one of the input geometries to match the CRS of the other.

    Left CRS: EPSG:4326
    Right CRS: +proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs + ...

      return geopandas.sjoin(left_df=self, right_df=df, *args, **kwargs)  # noqa: B026



```python
# Combine the two DataFrames
combined_df = pd.concat([east_bld_centroid_grid_count, west_bld_centroid_grid_count], ignore_index=True)

# Keep the maximum value of numbuildings
fji_bld_centroid_grid_count = combined_df.groupby(['id', 'Longitude', 'Latitude', 'Centroid', 'geometry'], as_index=False)['numbuildings'].max()
fji_bld_centroid_grid_count
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>id</th>
      <th>Longitude</th>
      <th>Latitude</th>
      <th>Centroid</th>
      <th>geometry</th>
      <th>numbuildings</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>39554</td>
      <td>176.895</td>
      <td>-17.145</td>
      <td>176.89E_-17.14N</td>
      <td>POLYGON ((176.89000 -17.14000, 176.90000 -17.1...</td>
      <td>0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>40555</td>
      <td>176.905</td>
      <td>-17.145</td>
      <td>176.9E_-17.14N</td>
      <td>POLYGON ((176.90000 -17.14000, 176.91000 -17.1...</td>
      <td>0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>40556</td>
      <td>176.905</td>
      <td>-17.155</td>
      <td>176.9E_-17.15N</td>
      <td>POLYGON ((176.90000 -17.15000, 176.91000 -17.1...</td>
      <td>0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>41556</td>
      <td>176.915</td>
      <td>-17.145</td>
      <td>176.91E_-17.14N</td>
      <td>POLYGON ((176.91000 -17.14000, 176.92000 -17.1...</td>
      <td>129</td>
    </tr>
    <tr>
      <th>4</th>
      <td>41557</td>
      <td>176.915</td>
      <td>-17.155</td>
      <td>176.91E_-17.15N</td>
      <td>POLYGON ((176.91000 -17.15000, 176.92000 -17.1...</td>
      <td>9</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>18642</th>
      <td>527307</td>
      <td>181.765</td>
      <td>-19.805</td>
      <td>181.76E_-19.8N</td>
      <td>POLYGON ((181.76000 -19.80000, 181.77000 -19.8...</td>
      <td>0</td>
    </tr>
    <tr>
      <th>18643</th>
      <td>527308</td>
      <td>181.765</td>
      <td>-19.815</td>
      <td>181.76E_-19.81N</td>
      <td>POLYGON ((181.76000 -19.81000, 181.77000 -19.8...</td>
      <td>0</td>
    </tr>
    <tr>
      <th>18644</th>
      <td>527309</td>
      <td>181.765</td>
      <td>-19.825</td>
      <td>181.76E_-19.82N</td>
      <td>POLYGON ((181.76000 -19.82000, 181.77000 -19.8...</td>
      <td>0</td>
    </tr>
    <tr>
      <th>18645</th>
      <td>528308</td>
      <td>181.775</td>
      <td>-19.805</td>
      <td>181.77E_-19.8N</td>
      <td>POLYGON ((181.77000 -19.80000, 181.78000 -19.8...</td>
      <td>0</td>
    </tr>
    <tr>
      <th>18646</th>
      <td>528309</td>
      <td>181.775</td>
      <td>-19.815</td>
      <td>181.77E_-19.81N</td>
      <td>POLYGON ((181.77000 -19.81000, 181.78000 -19.8...</td>
      <td>0</td>
    </tr>
  </tbody>
</table>
<p>18647 rows Ã— 6 columns</p>
</div>



Add information about the previous definition of grid cell


```python
# Load previous grid
grid_old = gpd.read_file(output_dir / "fji_0.1_degree_grid_land_overlap_new.gpkg")
grid_old["grid_point_id"] = grid_old["id"].astype(int)
grid_old = grid_old[['grid_point_id', 'geometry']]
grid_old = gpd.GeoDataFrame(grid_old, geometry='geometry')

# Convert current grid to geopandas
grid_new = gpd.GeoDataFrame(fji_bld_centroid_grid_count, geometry='geometry')

# All together
total_grid = gpd.sjoin(grid_new, grid_old).drop('index_right', axis=1)
```


```python
total_grid.to_csv(output_dir / 'numbuildings_per_grid_0.01.csv', index=False)
```
