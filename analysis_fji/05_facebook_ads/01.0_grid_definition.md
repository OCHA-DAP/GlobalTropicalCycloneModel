```python
import os
from pathlib import Path
import geopandas as gpd
from shapely.geometry import Polygon
import numpy as np
import matplotlib.pyplot as plt
import pandas as pd

pd.set_option("display.float_format", lambda x: "%.5f" % x)
```


```python
input_dir = (
    Path(os.getenv("STORM_DATA_DIR"))
    / "analysis_fji/02_new_model_input/02_housing_damage/input/"
)
output_dir = (
    Path(os.getenv("STORM_DATA_DIR"))
    / "analysis_fji/02_new_model_input/02_housing_damage/output/"
)

# Load Fiji
adm2_shp = gpd.read_file(
    input_dir / "adm2_shp_fixed.gpkg"
)
adm2_shp = adm2_shp.to_crs('EPSG:4326')
```

## Creation of grid


```python
# grid creation
xmin, xmax, ymin, ymax = 176.5, 182, -22, -12 # Fiji extremes coordintates

cell_size = 0.01

cols = list(np.arange(xmin, xmax + cell_size, cell_size))
rows = list(np.arange(ymin, ymax + cell_size, cell_size))
rows.reverse()

polygons = [
    Polygon(
        [
            (x, y),
            (x + cell_size, y),
            (x + cell_size, y - cell_size),
            (x, y - cell_size),
        ]
    )
    for x in cols
    for y in rows
]
grid = gpd.GeoDataFrame({"geometry": polygons}, crs=adm2_shp.crs)
grid["id"] = grid.index + 1
grid.head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>geometry</th>
      <th>id</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>POLYGON ((176.50000 -12.00000, 176.51000 -12.0...</td>
      <td>1</td>
    </tr>
    <tr>
      <th>1</th>
      <td>POLYGON ((176.50000 -12.01000, 176.51000 -12.0...</td>
      <td>2</td>
    </tr>
    <tr>
      <th>2</th>
      <td>POLYGON ((176.50000 -12.02000, 176.51000 -12.0...</td>
      <td>3</td>
    </tr>
    <tr>
      <th>3</th>
      <td>POLYGON ((176.50000 -12.03000, 176.51000 -12.0...</td>
      <td>4</td>
    </tr>
    <tr>
      <th>4</th>
      <td>POLYGON ((176.50000 -12.04000, 176.51000 -12.0...</td>
      <td>5</td>
    </tr>
  </tbody>
</table>
</div>




```python
grid.loc[:, "geometry"].plot()
plt.show()
```



![png](01.0_grid_definition_files/01.0_grid_definition_4_0.png)




```python
# write as geopackage
#grid.to_file(output_dir / "fji_0.1_degree_grid_new.gpkg", driver="GPKG")
```

## Creation of centroids


```python
# Extract lat and lon from the centerpoint
grid["Longitude"] = grid["geometry"].centroid.map(lambda p: p.x)
grid["Latitude"] = grid["geometry"].centroid.map(lambda p: p.y)
grid["Centroid"] = (
    round(grid["Longitude"], 2).astype(str)
    + "E"
    + "_"
    + +round(grid["Latitude"], 2).astype(str)
    + "N"
)
grid.head(5)
```

    /var/folders/dy/vms3cfrn4q9952h8s6l586dr0000gp/T/ipykernel_10537/3930163373.py:2: UserWarning: Geometry is in a geographic CRS. Results from 'centroid' are likely incorrect. Use 'GeoSeries.to_crs()' to re-project geometries to a projected CRS before this operation.

      grid["Longitude"] = grid["geometry"].centroid.map(lambda p: p.x)
    /var/folders/dy/vms3cfrn4q9952h8s6l586dr0000gp/T/ipykernel_10537/3930163373.py:3: UserWarning: Geometry is in a geographic CRS. Results from 'centroid' are likely incorrect. Use 'GeoSeries.to_crs()' to re-project geometries to a projected CRS before this operation.

      grid["Latitude"] = grid["geometry"].centroid.map(lambda p: p.y)





<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>geometry</th>
      <th>id</th>
      <th>Longitude</th>
      <th>Latitude</th>
      <th>Centroid</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>POLYGON ((176.50000 -12.00000, 176.51000 -12.0...</td>
      <td>1</td>
      <td>176.50500</td>
      <td>-12.00500</td>
      <td>176.5E_-12.0N</td>
    </tr>
    <tr>
      <th>1</th>
      <td>POLYGON ((176.50000 -12.01000, 176.51000 -12.0...</td>
      <td>2</td>
      <td>176.50500</td>
      <td>-12.01500</td>
      <td>176.5E_-12.01N</td>
    </tr>
    <tr>
      <th>2</th>
      <td>POLYGON ((176.50000 -12.02000, 176.51000 -12.0...</td>
      <td>3</td>
      <td>176.50500</td>
      <td>-12.02500</td>
      <td>176.5E_-12.02N</td>
    </tr>
    <tr>
      <th>3</th>
      <td>POLYGON ((176.50000 -12.03000, 176.51000 -12.0...</td>
      <td>4</td>
      <td>176.50500</td>
      <td>-12.03500</td>
      <td>176.5E_-12.03N</td>
    </tr>
    <tr>
      <th>4</th>
      <td>POLYGON ((176.50000 -12.04000, 176.51000 -12.0...</td>
      <td>5</td>
      <td>176.50500</td>
      <td>-12.04500</td>
      <td>176.5E_-12.04N</td>
    </tr>
  </tbody>
</table>
</div>




```python
# Centroids
grid_centroids = grid.copy()
grid_centroids["geometry"] = grid_centroids["geometry"].centroid
grid_centroids.loc[:, "geometry"].plot()
plt.show()
```

    /var/folders/dy/vms3cfrn4q9952h8s6l586dr0000gp/T/ipykernel_10537/3027722353.py:3: UserWarning: Geometry is in a geographic CRS. Results from 'centroid' are likely incorrect. Use 'GeoSeries.to_crs()' to re-project geometries to a projected CRS before this operation.

      grid_centroids["geometry"] = grid_centroids["geometry"].centroid




![png](01.0_grid_definition_files/01.0_grid_definition_8_1.png)




```python
# write as geopackage
# grid_centroids.to_file(
#     output_dir / "fji_0.1_degree_grid_centroids_new.gpkg", driver="GPKG"
# )
```

## Intersection of grid and admin shapefile


```python
# intersection of grid and shapefile
adm2_grid_intersection = gpd.overlay(adm2_shp, grid, how="identity")
adm2_grid_intersection.loc[:, "geometry"].plot()
plt.axis([xmin, xmax, ymin, ymax])

plt.show()
```



![png](01.0_grid_definition_files/01.0_grid_definition_11_0.png)




```python
adm2_grid_intersection = adm2_grid_intersection.dropna(subset=["id"])
```


```python
# adm2_grid_intersection.to_file(
#     input_dir / "fji_adm2_grid_intersection_new.gpkg", driver="GPKG"
# )
```

### Grid-land overlap


```python
grid_land_overlap = grid.loc[grid["id"].isin(adm2_grid_intersection["id"])]
```


```python
grid_land_overlap
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>geometry</th>
      <th>id</th>
      <th>Longitude</th>
      <th>Latitude</th>
      <th>Centroid</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>39553</th>
      <td>POLYGON ((176.89000 -17.14000, 176.90000 -17.1...</td>
      <td>39554</td>
      <td>176.89500</td>
      <td>-17.14500</td>
      <td>176.89E_-17.14N</td>
    </tr>
    <tr>
      <th>40554</th>
      <td>POLYGON ((176.90000 -17.14000, 176.91000 -17.1...</td>
      <td>40555</td>
      <td>176.90500</td>
      <td>-17.14500</td>
      <td>176.9E_-17.14N</td>
    </tr>
    <tr>
      <th>40555</th>
      <td>POLYGON ((176.90000 -17.15000, 176.91000 -17.1...</td>
      <td>40556</td>
      <td>176.90500</td>
      <td>-17.15500</td>
      <td>176.9E_-17.15N</td>
    </tr>
    <tr>
      <th>41555</th>
      <td>POLYGON ((176.91000 -17.14000, 176.92000 -17.1...</td>
      <td>41556</td>
      <td>176.91500</td>
      <td>-17.14500</td>
      <td>176.91E_-17.14N</td>
    </tr>
    <tr>
      <th>41556</th>
      <td>POLYGON ((176.91000 -17.15000, 176.92000 -17.1...</td>
      <td>41557</td>
      <td>176.91500</td>
      <td>-17.15500</td>
      <td>176.91E_-17.15N</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>527306</th>
      <td>POLYGON ((181.76000 -19.80000, 181.77000 -19.8...</td>
      <td>527307</td>
      <td>181.76500</td>
      <td>-19.80500</td>
      <td>181.76E_-19.8N</td>
    </tr>
    <tr>
      <th>527307</th>
      <td>POLYGON ((181.76000 -19.81000, 181.77000 -19.8...</td>
      <td>527308</td>
      <td>181.76500</td>
      <td>-19.81500</td>
      <td>181.76E_-19.81N</td>
    </tr>
    <tr>
      <th>527308</th>
      <td>POLYGON ((181.76000 -19.82000, 181.77000 -19.8...</td>
      <td>527309</td>
      <td>181.76500</td>
      <td>-19.82500</td>
      <td>181.76E_-19.82N</td>
    </tr>
    <tr>
      <th>528307</th>
      <td>POLYGON ((181.77000 -19.80000, 181.78000 -19.8...</td>
      <td>528308</td>
      <td>181.77500</td>
      <td>-19.80500</td>
      <td>181.77E_-19.8N</td>
    </tr>
    <tr>
      <th>528308</th>
      <td>POLYGON ((181.77000 -19.81000, 181.78000 -19.8...</td>
      <td>528309</td>
      <td>181.77500</td>
      <td>-19.81500</td>
      <td>181.77E_-19.81N</td>
    </tr>
  </tbody>
</table>
<p>18647 rows Ã— 5 columns</p>
</div>




```python
grid_land_overlap.to_file(
    output_dir / "fji_0.01_degree_grid_land_overlap.gpkg", driver="GPKG"
)
```


```python
grid_land_overlap_centroids = grid_centroids.loc[
    grid["id"].isin(adm2_grid_intersection["id"])
]
```


```python
grid_land_overlap_centroids.to_file(
    output_dir / "fji_0.01_degree_grid_centroids_land_overlap.gpkg",
    driver="GPKG",
)
```

### Grids per municipality


```python
grid_muni = gpd.sjoin(adm2_shp, grid_land_overlap, how='inner')
grid_muni = grid_muni.drop_duplicates(subset=['id'])

admin2_grid_muni = grid_muni[['id', 'NAME_2']].groupby(by='NAME_2').count().rename({'id':'grid_cells'}, axis=1).sort_values('grid_cells', ascending=False)
admin1_grid_muni = grid_muni[['id', 'NAME_1']].groupby(by='NAME_1').count().rename({'id':'grid_cells'}, axis=1).sort_values('grid_cells', ascending=False)

```


```python
fig, ax = plt.subplots(1,2, figsize=(12,6), gridspec_kw={'width_ratios': [2, 3]})
admin1_grid_muni.plot.bar(rot=45, legend=False, ax=ax[0])
ax[0].set_xlabel('')
ax[0].set_ylabel('Grid cells')
ax[0].set_title('Admin 1 (divisions)')

admin2_grid_muni.plot.bar(rot=90, legend=False, ax=ax[1])
ax[1].set_xlabel('')
ax[1].set_ylabel('Grid cells')
ax[1].set_title('Admin 2 (provinces)')

plt.tight_layout()
plt.show()
```



![png](01.0_grid_definition_files/01.0_grid_definition_22_0.png)




```python
grid_muni.to_csv(
    input_dir / "grid_0.01_municipality_info.csv",
)
```
