```python
from pathlib import Path
import os

from climada.hazard import Centroids, TCTracks, TropCyclone
from shapely.geometry import LineString, Polygon
import geopandas as gpd
import numpy as np
import pandas as pd
import xarray as xr
import matplotlib.pyplot as plt
from matplotlib.patches import Patch
import warnings
```


```python
input_dir = Path(os.getenv("STORM_DATA_DIR")) / "analysis_fji/02_new_model_input"
output_dir = (
    Path(os.getenv("STORM_DATA_DIR"))
    / "analysis_fji/02_new_model_input/02_model_features/output/"
    )
fiji_dir = (
    Path(os.getenv("STORM_DATA_DIR"))
    / "analysis_fji/02_new_model_input/02_model_features/input/"
    )

# Load Fiji
fiji = gpd.read_file(fiji_dir / "adm2_shp_fixed.gpkg")
fiji = fiji.to_crs('EPSG:4326')

# Load grid
grid = gpd.read_file(input_dir / "02_housing_damage/output/fji_0.1_degree_grid_land_overlap_new.gpkg")

# Load damage
dmg = pd.read_csv(output_dir / "building_damage_bygrid_new_rural_urban_bld_using_pop.csv")

# Mun damage
damage_data = pd.read_csv(fiji_dir / "fji_building_damage_mun_complete_fix.csv")
```


```python
# Load YASA (Fiji historical typhoon)
yasa_id = '2020346S13168'
# Load Track from IbTracks
yasa_track = TCTracks.from_ibtracs_netcdf(storm_id=yasa_id)
tc_track = yasa_track.get_track()

points = gpd.points_from_xy(tc_track.lon, tc_track.lat)
track_points = gpd.GeoDataFrame(geometry=points)
tc_track_line = LineString(points)
track_line = gpd.GeoDataFrame(geometry=[tc_track_line])
```

    2024-02-26 12:16:37,190 - climada.hazard.tc_tracks - WARNING - The cached IBTrACS data set dates from 2023-06-07 23:07:38 (older than 180 days). Very likely, a more recent version is available. Consider manually removing the file /Users/federico/climada/data/IBTrACS.ALL.v04r00.nc and re-running this function, which will download the most recent version of the IBTrACS data set from the official URL.



```python
# Grid damage
yasa_dmg_grid = gpd.GeoDataFrame(dmg[dmg.typhoon_name=='Yasa'].merge(grid, on='id'),
                                 geometry='geometry')
yasa_dmg_grid['N_dmg'] = yasa_dmg_grid['perc_dmg_grid'] * yasa_dmg_grid['numbuildings_z'] / 100
# Mun damage
yasa_dmg_mun = gpd.GeoDataFrame(damage_data[damage_data.typhoon=='Yasa'].merge(
                    fiji,
                    left_on='ADM2_NAME', right_on='NAME_2',
                    how='right')[
                        ['total', 'NAME_2', 'geometry']
                        ].fillna(0), geometry='geometry')
```


```python
# Plot per grid
# Define the bins and labels
bins = [-float('inf'), 10, 50, 100, 500, 1000, float('inf')]
labels = [0, 1, 2, 3, 4, 5]

# Create the new column using pd.cut
yasa_dmg_grid['num_cat'] = pd.cut(yasa_dmg_grid['N_dmg'], bins=bins, labels=labels, include_lowest=True)
#gpd_pop_df = gpd.GeoDataFrame(yasa_dmg_grid, geometry='geometry')

# Plot the GeoDataFrame
fig, ax = plt.subplots(1,1, figsize=(6, 6))
yasa_dmg_grid.plot(column='num_cat', cmap='viridis', legend=True, ax=ax)
track_line.plot(ax=ax, color='k')
# Customize the legend labels
legend_labels = {
    0: '0 - 10',
    1: '10 - 50',
    2: '50 - 100',
    3: '100 - 500',
    4: '500 - 1000',
    5: '> 1000'
}

# Get the current legend
legend = ax.get_legend()

# Customize the legend labels using legend_labels dictionary
for key, label in legend_labels.items():
    legend.get_texts()[key].set_text(label)

ax.set_xlim(176, 182)
ax.set_ylim(-22, -12)
ax.set_title('Yasa grid-level damage \n(houses affected)')
plt.show()
```



![png](02.2_damage_figures_files/02.2_damage_figures_4_0.png)




```python
fig, ax = plt.subplots(1,1, figsize=(6,6))
yasa_dmg_mun.plot(column='total', legend=True, cmap='viridis', ax=ax)
track_line.plot(ax=ax, color='k')
ax.set_xlim(176, 182)
ax.set_ylim(-22, -12)
ax.set_title('Yasa Municipality damage \n(houses affected)')
plt.show()
```



![png](02.2_damage_figures_files/02.2_damage_figures_5_0.png)




```python
fig, ax = plt.subplots(1,1, figsize=(6,6))
yasa_dmg_grid.plot(column='N_dmg', legend=True, cmap='viridis', ax=ax)
track_line.plot(ax=ax, color='k')
ax.set_xlim(176, 182)
ax.set_ylim(-22, -12)
ax.set_title('Yasa grid-level damage \n(houses affected)')
plt.show()
```



![png](02.2_damage_figures_files/02.2_damage_figures_6_0.png)
