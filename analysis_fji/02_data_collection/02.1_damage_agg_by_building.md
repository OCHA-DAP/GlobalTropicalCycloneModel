```python
from pathlib import Path
import os

from shapely.geometry import LineString,Polygon, MultiPolygon
import geopandas as gpd
import numpy as np
import pandas as pd
import xarray as xr
import re
import matplotlib.pyplot as plt
from matplotlib.patches import Patch
from matplotlib.lines import Line2D
from scipy import stats
```


```python
input_dir = (
    Path(os.getenv("STORM_DATA_DIR"))
    / "analysis_fji/02_new_model_input/02_model_features/input/"
)
output_dir = (
    Path(os.getenv("STORM_DATA_DIR"))
    / "analysis_fji/02_new_model_input/02_model_features/output/"
)

# Load Fiji
fiji = gpd.read_file(input_dir / "adm2_shp_fixed.gpkg")
fiji = fiji.to_crs('EPSG:4326')

# Load grid
grid_land_overlap = gpd.read_file(output_dir / "fji_0.1_degree_grid_land_overlap_new.gpkg")
grid_land_overlap["id"] = grid_land_overlap["id"].astype(int)

# Load grids per Municipality
ids_mun = pd.read_csv(input_dir / "grid_municipality_info.csv")

# Load damage data
damage_data = pd.read_csv(input_dir / "fji_building_damage_mun_complete.csv")

```

## Building locations


```python
gpd_bld_east = gpd.read_file(
    input_dir / "hotosm_fji_east_buildings_polygons_shp.zip"
)
gpd_bld_west = gpd.read_file(
    input_dir / "hotosm_fji_west_buildings_polygons_shp.zip"
)
```

I would like to go from 0 to 360 in the longitude axis. Cannot find a useful crs that satisfy what I want. So let's define one.


```python
# Change crs
custom_crs = "+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs +lon_wrap=360"
east = gpd_bld_east.copy()
east = east.to_crs(custom_crs)

# Define crs for west side
west = gpd_bld_west.copy()
west = west.to_crs('EPSG:4326')
```

I would really want to work with one concatenated dataset but since the CRS of the east and the west are different, we have to work separately.

## Types of buildings


```python
# Type of buildings

bld = pd.concat([east.building, west.building])
fig, ax = plt.subplots(1,1)
ax.hist(bld, bins=50)
ax.set_xticklabels(ax.get_xticklabels(), rotation=90, size=8)

plt.show()
```

    /var/folders/dy/vms3cfrn4q9952h8s6l586dr0000gp/T/ipykernel_43718/311903155.py:6: UserWarning: set_ticklabels() should only be used with a fixed number of ticks, i.e. after set_ticks() or using a FixedLocator.
      ax.set_xticklabels(ax.get_xticklabels(), rotation=90, size=8)




![png](02.1_damage_agg_by_building_files/02.1_damage_agg_by_building_8_1.png)



We just have information about if there are buildings in a location and in some cases, if that builing is a house

### Map of building location


```python
# Plot builing loc over map
fig, ax = plt.subplots(1,1)

fiji.plot(ax=ax, color='gray', edgecolor='gray', label='Fiji')
east.plot(ax=ax, color='red', markersize=10, label='Buildings')
west.plot(ax=ax, color='red', markersize=10, label='Buildings')
ax.set_xlim(175.5, 182.5)
ax.set_ylim(-22,-12)
ax.set_xlabel('Longitude')
ax.set_ylabel('Latitude')
ax.set_title('Fiji builings locations')
# Manually create the legend
legend_elements = [
    Line2D([0], [0], marker='o', color='w', markerfacecolor='red', markersize=10, label='Buildings'),
    Patch(color='gray', label='Fiji')
]

ax.legend(handles=legend_elements, loc='upper left')

plt.savefig('building_location')
plt.show()
```



![png](02.1_damage_agg_by_building_files/02.1_damage_agg_by_building_11_0.png)



### Buildings to grid cells


```python
# Centroids
east_centroids = east.copy()
east_centroids["geometry"] = east_centroids["geometry"].centroid

west_centroids = west.copy()
west_centroids["geometry"] = west_centroids["geometry"].centroid
```

    /var/folders/dy/vms3cfrn4q9952h8s6l586dr0000gp/T/ipykernel_43718/1674229990.py:3: UserWarning: Geometry is in a geographic CRS. Results from 'centroid' are likely incorrect. Use 'GeoSeries.to_crs()' to re-project geometries to a projected CRS before this operation.

      east_centroids["geometry"] = east_centroids["geometry"].centroid
    /var/folders/dy/vms3cfrn4q9952h8s6l586dr0000gp/T/ipykernel_43718/1674229990.py:6: UserWarning: Geometry is in a geographic CRS. Results from 'centroid' are likely incorrect. Use 'GeoSeries.to_crs()' to re-project geometries to a projected CRS before this operation.

      west_centroids["geometry"] = west_centroids["geometry"].centroid



```python
# East and West buildings count per grid
east_bld_centroid_grid_count = grid_land_overlap.merge(
    grid_land_overlap.sjoin(east_centroids, how="left")
    .groupby("id")
    .count()
    .building.rename("numbuildings")
    .reset_index()
)

west_bld_centroid_grid_count = grid_land_overlap.merge(
    grid_land_overlap.sjoin(west_centroids, how="left")
    .groupby("id")
    .count()
    .building.rename("numbuildings")
    .reset_index()
)

```

    /Users/federico/anaconda3/envs/env6/lib/python3.11/site-packages/geopandas/geodataframe.py:2189: UserWarning: CRS mismatch between the CRS of left geometries and the CRS of right geometries.
    Use `to_crs()` to reproject one of the input geometries to match the CRS of the other.

    Left CRS: EPSG:4326
    Right CRS: +proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs + ...

      return geopandas.sjoin(left_df=self, right_df=df, *args, **kwargs)  # noqa: B026



```python
# Combine the two DataFrames
combined_df = pd.concat([east_bld_centroid_grid_count, west_bld_centroid_grid_count], ignore_index=True)

# Keep the maximum value of numbuildings
fji_bld_centroid_grid_count = combined_df.groupby(['id', 'Longitude', 'Latitude', 'Centroid', 'geometry'], as_index=False)['numbuildings'].max()
fji_bld_centroid_grid_count
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>id</th>
      <th>Longitude</th>
      <th>Latitude</th>
      <th>Centroid</th>
      <th>geometry</th>
      <th>numbuildings</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>355</td>
      <td>176.85</td>
      <td>-17.15</td>
      <td>176.85E_-17.15N</td>
      <td>POLYGON ((176.80000 -17.10000, 176.90000 -17.1...</td>
      <td>0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>409</td>
      <td>176.95</td>
      <td>-12.45</td>
      <td>176.95E_-12.45N</td>
      <td>POLYGON ((176.90000 -12.40000, 177.00000 -12.4...</td>
      <td>0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>456</td>
      <td>176.95</td>
      <td>-17.15</td>
      <td>176.95E_-17.15N</td>
      <td>POLYGON ((176.90000 -17.10000, 177.00000 -17.1...</td>
      <td>213</td>
    </tr>
    <tr>
      <th>3</th>
      <td>510</td>
      <td>177.05</td>
      <td>-12.45</td>
      <td>177.05E_-12.45N</td>
      <td>POLYGON ((177.00000 -12.40000, 177.10000 -12.4...</td>
      <td>0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>511</td>
      <td>177.05</td>
      <td>-12.55</td>
      <td>177.05E_-12.55N</td>
      <td>POLYGON ((177.00000 -12.50000, 177.10000 -12.5...</td>
      <td>0</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>416</th>
      <td>5122</td>
      <td>181.55</td>
      <td>-19.15</td>
      <td>181.55E_-19.15N</td>
      <td>POLYGON ((181.50000 -19.10000, 181.60000 -19.1...</td>
      <td>76</td>
    </tr>
    <tr>
      <th>417</th>
      <td>5123</td>
      <td>181.55</td>
      <td>-19.25</td>
      <td>181.55E_-19.25N</td>
      <td>POLYGON ((181.50000 -19.20000, 181.60000 -19.2...</td>
      <td>0</td>
    </tr>
    <tr>
      <th>418</th>
      <td>5221</td>
      <td>181.65</td>
      <td>-18.95</td>
      <td>181.65E_-18.95N</td>
      <td>POLYGON ((181.60000 -18.90000, 181.70000 -18.9...</td>
      <td>0</td>
    </tr>
    <tr>
      <th>419</th>
      <td>5223</td>
      <td>181.65</td>
      <td>-19.15</td>
      <td>181.65E_-19.15N</td>
      <td>POLYGON ((181.60000 -19.10000, 181.70000 -19.1...</td>
      <td>0</td>
    </tr>
    <tr>
      <th>420</th>
      <td>5331</td>
      <td>181.75</td>
      <td>-19.85</td>
      <td>181.75E_-19.85N</td>
      <td>POLYGON ((181.70000 -19.80000, 181.80000 -19.8...</td>
      <td>0</td>
    </tr>
  </tbody>
</table>
<p>421 rows × 6 columns</p>
</div>




```python
fji_bld_centroid_grid_count.to_csv('numbuildings_per_grid.csv')
```

### Distribution of total houses per grid cell


```python
build_per_grid = fji_bld_centroid_grid_count.numbuildings
plt.hist(build_per_grid, bins=50)
plt.xlabel('Buildings per grid cell')
plt.ylabel('Frequency')


q25 = np.quantile(build_per_grid, 0.25)
q50 = np.quantile(build_per_grid, 0.50)
mode = stats.mode(build_per_grid).mode

# Add text boxes with annotations
plt.text(0.7, 0.9, f'Quantile 25: {q25:.2f}', transform=plt.gca().transAxes)
plt.text(0.7, 0.85, f'Quantile 50: {q50:.2f}', transform=plt.gca().transAxes)
plt.text(0.7, 0.8, f'Mode: {mode:.2f}', transform=plt.gca().transAxes)

plt.show()
```



![png](02.1_damage_agg_by_building_files/02.1_damage_agg_by_building_18_0.png)




```python
# Save it
buildings_by_grid = fji_bld_centroid_grid_count[['id','numbuildings']]
buildings_by_grid.to_csv(output_dir / "num_building_bygrid.csv")
```

### Building damage to grid


```python
# Municipalities by id
mun_dict = ids_mun[['id', 'NAME_2']].groupby(by='NAME_2').groups
muns =  mun_dict.keys()
ids = []
for m in muns:
    ids.append(ids_mun.iloc[mun_dict[m].values].id)
df_muns = pd.DataFrame({'Municipality': muns, 'ids':ids})
provinces_exploded = df_muns.explode('ids')
```


```python
# Some checks
print(len(set(ids_mun.sort_values('id').id.unique()) & set(fji_bld_centroid_grid_count.id.unique())))
print(len(set(provinces_exploded.sort_values('ids').ids.unique()) & set(fji_bld_centroid_grid_count.id.unique())))
```

    421
    421



```python
# Assign municipality to fji_bld_centroid_grid_count
bld_grid_mun = fji_bld_centroid_grid_count.merge(provinces_exploded, left_on='id', right_on='ids', how='inner')[['id', 'Municipality', 'numbuildings']]

bld_grid_mun.sort_values('numbuildings', ascending=False)
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>id</th>
      <th>Municipality</th>
      <th>numbuildings</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>166</th>
      <td>1981</td>
      <td>Rewa</td>
      <td>21908</td>
    </tr>
    <tr>
      <th>179</th>
      <td>2081</td>
      <td>Naitasiri</td>
      <td>21025</td>
    </tr>
    <tr>
      <th>39</th>
      <td>966</td>
      <td>Ba</td>
      <td>15721</td>
    </tr>
    <tr>
      <th>257</th>
      <td>2873</td>
      <td>Macuata</td>
      <td>9963</td>
    </tr>
    <tr>
      <th>165</th>
      <td>1980</td>
      <td>Naitasiri</td>
      <td>9246</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>235</th>
      <td>2581</td>
      <td>Lomaiviti</td>
      <td>0</td>
    </tr>
    <tr>
      <th>234</th>
      <td>2577</td>
      <td>Bua</td>
      <td>0</td>
    </tr>
    <tr>
      <th>227</th>
      <td>2569</td>
      <td>Macuata</td>
      <td>0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>409</td>
      <td>Rotuma</td>
      <td>0</td>
    </tr>
    <tr>
      <th>420</th>
      <td>5331</td>
      <td>Lau</td>
      <td>0</td>
    </tr>
  </tbody>
</table>
<p>421 rows × 3 columns</p>
</div>




```python
# Because I can: builings by Municipality

df_aux = bld_grid_mun.groupby('Municipality').sum().sort_values(by='numbuildings', ascending=False)

plt.figure(figsize=(12, 6))
plt.bar(df_aux.index, df_aux['numbuildings'])
plt.xlabel('Municipality')
plt.ylabel('Number of Buildings')
plt.title('Number of Buildings by Municipality')
plt.xticks(rotation=45)

plt.show()
```



![png](02.1_damage_agg_by_building_files/02.1_damage_agg_by_building_24_0.png)




```python
# Create density of buildings per cell
total_bld_mun = bld_grid_mun.groupby('Municipality').sum()['numbuildings'].reset_index(drop=False)
bld_grid_mun_merged = bld_grid_mun.merge(total_bld_mun, on='Municipality', how='left')
bld_grid_mun_merged['frac_bld'] = bld_grid_mun_merged['numbuildings_x'] / bld_grid_mun_merged['numbuildings_y']
```


```python
# Create percentage of damage per grid cell
bld_damage_merged = damage_data.merge(bld_grid_mun_merged, left_on='ADM2_NAME', right_on = 'Municipality')
bld_damage_merged['perc_dmg_grid'] = bld_damage_merged['frac_bld'] * bld_damage_merged['total'] * 100 / bld_damage_merged['numbuildings_y']

```

### Save % of damage per grid cell


```python
bld_damage_merged
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Unnamed: 0</th>
      <th>ADM1_NAME</th>
      <th>ADM2_NAME</th>
      <th>typhoon</th>
      <th>Year</th>
      <th>Totally</th>
      <th>Partially</th>
      <th>total</th>
      <th>id</th>
      <th>Municipality</th>
      <th>numbuildings_x</th>
      <th>numbuildings_y</th>
      <th>frac_bld</th>
      <th>perc_dmg_grid</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0</td>
      <td>Central Division</td>
      <td>Naitasiri</td>
      <td>Winston</td>
      <td>2016</td>
      <td>542.0</td>
      <td>365.0</td>
      <td>907.00</td>
      <td>1473</td>
      <td>Naitasiri</td>
      <td>119</td>
      <td>47778</td>
      <td>0.002491</td>
      <td>0.004728</td>
    </tr>
    <tr>
      <th>1</th>
      <td>0</td>
      <td>Central Division</td>
      <td>Naitasiri</td>
      <td>Winston</td>
      <td>2016</td>
      <td>542.0</td>
      <td>365.0</td>
      <td>907.00</td>
      <td>1571</td>
      <td>Naitasiri</td>
      <td>259</td>
      <td>47778</td>
      <td>0.005421</td>
      <td>0.010291</td>
    </tr>
    <tr>
      <th>2</th>
      <td>0</td>
      <td>Central Division</td>
      <td>Naitasiri</td>
      <td>Winston</td>
      <td>2016</td>
      <td>542.0</td>
      <td>365.0</td>
      <td>907.00</td>
      <td>1572</td>
      <td>Naitasiri</td>
      <td>146</td>
      <td>47778</td>
      <td>0.003056</td>
      <td>0.005801</td>
    </tr>
    <tr>
      <th>3</th>
      <td>0</td>
      <td>Central Division</td>
      <td>Naitasiri</td>
      <td>Winston</td>
      <td>2016</td>
      <td>542.0</td>
      <td>365.0</td>
      <td>907.00</td>
      <td>1573</td>
      <td>Naitasiri</td>
      <td>409</td>
      <td>47778</td>
      <td>0.008560</td>
      <td>0.016251</td>
    </tr>
    <tr>
      <th>4</th>
      <td>0</td>
      <td>Central Division</td>
      <td>Naitasiri</td>
      <td>Winston</td>
      <td>2016</td>
      <td>542.0</td>
      <td>365.0</td>
      <td>907.00</td>
      <td>1574</td>
      <td>Naitasiri</td>
      <td>288</td>
      <td>47778</td>
      <td>0.006028</td>
      <td>0.011443</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>2814</th>
      <td>58</td>
      <td>Eastern Division</td>
      <td>Rotuma</td>
      <td>Tomas</td>
      <td>2010</td>
      <td>47.0</td>
      <td>174.0</td>
      <td>55.25</td>
      <td>409</td>
      <td>Rotuma</td>
      <td>0</td>
      <td>0</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2815</th>
      <td>58</td>
      <td>Eastern Division</td>
      <td>Rotuma</td>
      <td>Tomas</td>
      <td>2010</td>
      <td>47.0</td>
      <td>174.0</td>
      <td>55.25</td>
      <td>510</td>
      <td>Rotuma</td>
      <td>0</td>
      <td>0</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2816</th>
      <td>58</td>
      <td>Eastern Division</td>
      <td>Rotuma</td>
      <td>Tomas</td>
      <td>2010</td>
      <td>47.0</td>
      <td>174.0</td>
      <td>55.25</td>
      <td>511</td>
      <td>Rotuma</td>
      <td>0</td>
      <td>0</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2817</th>
      <td>58</td>
      <td>Eastern Division</td>
      <td>Rotuma</td>
      <td>Tomas</td>
      <td>2010</td>
      <td>47.0</td>
      <td>174.0</td>
      <td>55.25</td>
      <td>611</td>
      <td>Rotuma</td>
      <td>0</td>
      <td>0</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2818</th>
      <td>58</td>
      <td>Eastern Division</td>
      <td>Rotuma</td>
      <td>Tomas</td>
      <td>2010</td>
      <td>47.0</td>
      <td>174.0</td>
      <td>55.25</td>
      <td>612</td>
      <td>Rotuma</td>
      <td>0</td>
      <td>0</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
  </tbody>
</table>
<p>2819 rows × 14 columns</p>
</div>




```python
bld_damage_merged.to_csv(output_dir / "building_damage_bygrid_new.csv")
```
