```python
import pandas as pd
import geopandas as gpd
from pathlib import Path
import os
import requests, zipfile, io
import rasterio
from rasterio.merge import merge
from rasterstats import zonal_stats
from osgeo import gdal
import matplotlib.pyplot as plt
import rioxarray
import xarray
from shapely.geometry import Polygon
from rasterstats import zonal_stats
```


```python
base_dir = Path(os.getenv("STORM_DATA_DIR")) / "analysis_fji/02_model_features/"
input_dir = base_dir / "05_vulnerablility/input/"
shp_input_dir = base_dir / "02_housing_damage/output/"
output_dir = base_dir / "05_vulnerablility/output/"

# Load ids of municipalities
ids_mun = pd.read_csv(base_dir / "02_housing_damage/input/grid_municipality_info.csv")

# Load grids
grid = gpd.read_file(base_dir / "02_housing_damage/output/fji_0.1_degree_grid_land_overlap_new.gpkg")

# Load RWI
fji_rwi = pd.read_csv(input_dir / "GDL-Mean-International-Wealth-Index-(IWI)-score-of-region-data.csv")

# Load Fiji
adm2_shp = gpd.read_file(base_dir / "02_housing_damage/input/adm2_shp_fixed.gpkg")
adm2_shp = adm2_shp.to_crs('EPSG:4326')

# Mini grids
minigrids_dir = (
    Path(os.getenv("STORM_DATA_DIR"))
    / "analysis_fji/02_model_features/02_housing_damage/output/"
)
mini_grid = gpd.read_file(minigrids_dir / "fji_0.01_degree_grid_land_overlap.gpkg")

bld_dir = (
    Path(os.getenv("STORM_DATA_DIR"))
    / "analysis_fji/02_model_features/06_settlement/output/"
)
# Pop data
pop_data = pd.read_csv(bld_dir / 'fji_population_data.csv')
pop_data = pop_data.rename({'N_bld':'numbuildings'}, axis=1)

# Pop data 2
pop_data2 = pd.read_csv(bld_dir / 'fji_population_data_new_approach.csv')
pop_data2 = pop_data2.rename({'N_bld':'numbuildings'}, axis=1)
```


```python
grid_transformed = grid.copy()
minigrid_transformed = mini_grid.copy()
# Define a function to adjust the longitude of a single polygon
def adjust_longitude(polygon):
    # Extract the coordinates of the polygon
    coords = list(polygon.exterior.coords)

    # Adjust longitudes from [0, 360) to [-180, 180)
    for i in range(len(coords)):
        lon, lat = coords[i]
        if lon > 180:
            coords[i] = (lon - 360, lat)

    # Create a new Polygon with adjusted coordinates
    return Polygon(coords)

# Apply the adjust_longitude function to each geometry in the DataFrame
grid_transformed["geometry"] = grid_transformed["geometry"].apply(adjust_longitude)
grid_transformed = grid_transformed[['id', 'Latitude', 'Longitude','geometry']]

# Mini grids transformed
minigrid_transformed["geometry"] = minigrid_transformed["geometry"].apply(adjust_longitude)
minigrid_transformed = minigrid_transformed[['id', 'Latitude', 'Longitude','geometry']]
minigrid_transformed
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>id</th>
      <th>Latitude</th>
      <th>Longitude</th>
      <th>geometry</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>39554</td>
      <td>-17.145</td>
      <td>176.895</td>
      <td>POLYGON ((176.89000 -17.14000, 176.90000 -17.1...</td>
    </tr>
    <tr>
      <th>1</th>
      <td>40555</td>
      <td>-17.145</td>
      <td>176.905</td>
      <td>POLYGON ((176.90000 -17.14000, 176.91000 -17.1...</td>
    </tr>
    <tr>
      <th>2</th>
      <td>40556</td>
      <td>-17.155</td>
      <td>176.905</td>
      <td>POLYGON ((176.90000 -17.15000, 176.91000 -17.1...</td>
    </tr>
    <tr>
      <th>3</th>
      <td>41556</td>
      <td>-17.145</td>
      <td>176.915</td>
      <td>POLYGON ((176.91000 -17.14000, 176.92000 -17.1...</td>
    </tr>
    <tr>
      <th>4</th>
      <td>41557</td>
      <td>-17.155</td>
      <td>176.915</td>
      <td>POLYGON ((176.91000 -17.15000, 176.92000 -17.1...</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>18642</th>
      <td>527307</td>
      <td>-19.805</td>
      <td>181.765</td>
      <td>POLYGON ((-178.24000 -19.80000, -178.23000 -19...</td>
    </tr>
    <tr>
      <th>18643</th>
      <td>527308</td>
      <td>-19.815</td>
      <td>181.765</td>
      <td>POLYGON ((-178.24000 -19.81000, -178.23000 -19...</td>
    </tr>
    <tr>
      <th>18644</th>
      <td>527309</td>
      <td>-19.825</td>
      <td>181.765</td>
      <td>POLYGON ((-178.24000 -19.82000, -178.23000 -19...</td>
    </tr>
    <tr>
      <th>18645</th>
      <td>528308</td>
      <td>-19.805</td>
      <td>181.775</td>
      <td>POLYGON ((-178.23000 -19.80000, -178.22000 -19...</td>
    </tr>
    <tr>
      <th>18646</th>
      <td>528309</td>
      <td>-19.815</td>
      <td>181.775</td>
      <td>POLYGON ((-178.23000 -19.81000, -178.22000 -19...</td>
    </tr>
  </tbody>
</table>
<p>18647 rows × 4 columns</p>
</div>



## .tif files

from https://www.ngdc.noaa.gov/eog/viirs/download_ut_mos.html

### Create merged file


```python
file_list = os.listdir(input_dir)
tif_files = []
for file in file_list:
    if file.endswith('.tif'):
        tif_files.append(file)
tif_files
```




    ['SVDNB_npp_d20240101.d.00N180W.rade9.tif',
     'SVDNB_npp_d20240101.d.00N060E.rade9.tif']




```python
# All .tif files together
mosaic_raster = []
for file in tif_files:
    rast = rasterio.open(input_dir / file)
    mosaic_raster.append(rast)
merged_raster, out_raster = merge(mosaic_raster)
```


```python
# Metadata of the files
out_meta = rast.meta.copy()
out_meta.update(
    {
        "driver": "GTiff",
        "height": merged_raster.shape[1],
        "width": merged_raster.shape[2],
        "transform": out_raster,
#        "crs": grid.crs,
    }
)

# Save file
with rasterio.open(input_dir / "light_merged.tif", "w", **out_meta) as dest:
    dest.write(merged_raster)
```

### Open merged file


```python
ras = rasterio.open(output_dir / 'light_merged.tif')
#ras = xarray.open_dataset(input_dir / tif_files[0])
```

Information


```python
rast_path = output_dir / 'light_merged.tif'
!gdalinfo \
"{rast_path}"
```

    Driver: GTiff/GeoTIFF
    Files: /Users/federico/Documents/data/analysis_fji/02_new_model_input/05_vulnerablility/output/light_merged.tif
    Size is 86401, 15601
    Coordinate System is:
    GEOGCRS["WGS 84",
        DATUM["World Geodetic System 1984",
            ELLIPSOID["WGS 84",6378137,298.257223563,
                LENGTHUNIT["metre",1,
                    ID["EPSG",9001]]]],
        PRIMEM["Greenwich",0,
            ANGLEUNIT["degree",0.0174532925199433,
                ID["EPSG",9122]]],
        CS[ellipsoidal,2],
            AXIS["latitude",north,
                ORDER[1],
                ANGLEUNIT["degree",0.0174532925199433,
                    ID["EPSG",9122]]],
            AXIS["longitude",east,
                ORDER[2],
                ANGLEUNIT["degree",0.0174532925199433,
                    ID["EPSG",9122]]]]
    Data axis to CRS axis mapping: 2,1
    Origin = (-180.002083333349987,0.002083333350000)
    Pixel Size = (0.004166666700000,-0.004166666700000)
    Metadata:
      AREA_OR_POINT=Area
    Image Structure Metadata:
      INTERLEAVE=BAND
    Corner Coordinates:
    Upper Left  (-180.0020833,   0.0020833) (180d 0' 7.50"W,  0d 0' 7.50"N)
    Lower Left  (-180.0020833, -65.0020839) (180d 0' 7.50"W, 65d 0' 7.50"S)
    Upper Right ( 180.0020862,   0.0020833) (180d 0' 7.51"E,  0d 0' 7.50"N)
    Lower Right ( 180.0020862, -65.0020839) (180d 0' 7.51"E, 65d 0' 7.50"S)
    Center      (   0.0000014, -32.5000003) (  0d 0' 0.01"E, 32d30' 0.00"S)
    Band 1 Block=86401x1 Type=Float32, ColorInterp=Gray



```python
lights = ras.read(1)
```


```python
summary_stats = zonal_stats(
    #minigrid_transformed,
    grid_transformed,
    lights,
    stats=["mean", "median", "std", "sum", "count", "majority", "minority"],
    nodata=-9999,
    all_touched=True,
    affine=ras.transform,
)
grid_lights = pd.DataFrame(summary_stats)
#grid_lights_df = pd.concat([mini_grid, grid_lights], axis=1)
grid_lights_df = pd.concat([grid, grid_lights], axis=1)
grid_lights_df.sort_values('sum', ascending=False)
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>id</th>
      <th>Longitude</th>
      <th>Latitude</th>
      <th>Centroid</th>
      <th>geometry</th>
      <th>mean</th>
      <th>count</th>
      <th>sum</th>
      <th>std</th>
      <th>median</th>
      <th>majority</th>
      <th>minority</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>325</th>
      <td>3573</td>
      <td>180.05</td>
      <td>-15.75</td>
      <td>180.05E_-15.75N</td>
      <td>POLYGON ((180.00000 -15.70000, 180.10000 -15.7...</td>
      <td>1.196144</td>
      <td>2159425</td>
      <td>2.582983e+06</td>
      <td>9.408232</td>
      <td>0.669754</td>
      <td>0.000000</td>
      <td>-0.272499</td>
    </tr>
    <tr>
      <th>333</th>
      <td>3606</td>
      <td>180.05</td>
      <td>-19.05</td>
      <td>180.05E_-19.05N</td>
      <td>POLYGON ((180.00000 -19.00000, 180.10000 -19.0...</td>
      <td>1.179368</td>
      <td>2159425</td>
      <td>2.546756e+06</td>
      <td>37.918418</td>
      <td>0.672866</td>
      <td>0.000000</td>
      <td>-0.081523</td>
    </tr>
    <tr>
      <th>327</th>
      <td>3580</td>
      <td>180.05</td>
      <td>-16.45</td>
      <td>180.05E_-16.45N</td>
      <td>POLYGON ((180.00000 -16.40000, 180.10000 -16.4...</td>
      <td>1.170776</td>
      <td>2159425</td>
      <td>2.528202e+06</td>
      <td>36.777571</td>
      <td>0.617564</td>
      <td>0.000000</td>
      <td>-0.590043</td>
    </tr>
    <tr>
      <th>326</th>
      <td>3577</td>
      <td>180.05</td>
      <td>-16.15</td>
      <td>180.05E_-16.15N</td>
      <td>POLYGON ((180.00000 -16.10000, 180.10000 -16.1...</td>
      <td>1.152411</td>
      <td>2159425</td>
      <td>2.488545e+06</td>
      <td>9.086687</td>
      <td>0.625992</td>
      <td>0.000000</td>
      <td>-0.262251</td>
    </tr>
    <tr>
      <th>332</th>
      <td>3585</td>
      <td>180.05</td>
      <td>-16.95</td>
      <td>180.05E_-16.95N</td>
      <td>POLYGON ((180.00000 -16.90000, 180.10000 -16.9...</td>
      <td>1.108815</td>
      <td>2159425</td>
      <td>2.394404e+06</td>
      <td>48.600869</td>
      <td>0.598512</td>
      <td>0.000000</td>
      <td>-0.291163</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>354</th>
      <td>4088</td>
      <td>180.55</td>
      <td>-16.75</td>
      <td>180.55E_-16.75N</td>
      <td>POLYGON ((180.50000 -16.70000, 180.60000 -16.7...</td>
      <td>0.373295</td>
      <td>625</td>
      <td>2.333092e+02</td>
      <td>0.093503</td>
      <td>0.371634</td>
      <td>0.186086</td>
      <td>0.184895</td>
    </tr>
    <tr>
      <th>359</th>
      <td>4292</td>
      <td>180.75</td>
      <td>-16.95</td>
      <td>180.75E_-16.95N</td>
      <td>POLYGON ((180.70000 -16.90000, 180.80000 -16.9...</td>
      <td>0.368497</td>
      <td>625</td>
      <td>2.303108e+02</td>
      <td>0.084707</td>
      <td>0.367366</td>
      <td>0.242876</td>
      <td>0.222599</td>
    </tr>
    <tr>
      <th>370</th>
      <td>4495</td>
      <td>180.95</td>
      <td>-17.05</td>
      <td>180.95E_-17.05N</td>
      <td>POLYGON ((180.90000 -17.00000, 181.00000 -17.0...</td>
      <td>0.365052</td>
      <td>625</td>
      <td>2.281577e+02</td>
      <td>0.078574</td>
      <td>0.368908</td>
      <td>0.237091</td>
      <td>0.169815</td>
    </tr>
    <tr>
      <th>390</th>
      <td>4737</td>
      <td>181.15</td>
      <td>-21.05</td>
      <td>181.15E_-21.05N</td>
      <td>POLYGON ((181.10000 -21.00000, 181.20000 -21.0...</td>
      <td>0.359946</td>
      <td>625</td>
      <td>2.249666e+02</td>
      <td>0.093806</td>
      <td>0.351309</td>
      <td>0.193091</td>
      <td>0.177057</td>
    </tr>
    <tr>
      <th>399</th>
      <td>4838</td>
      <td>181.25</td>
      <td>-21.05</td>
      <td>181.25E_-21.05N</td>
      <td>POLYGON ((181.20000 -21.00000, 181.30000 -21.0...</td>
      <td>0.357736</td>
      <td>625</td>
      <td>2.235849e+02</td>
      <td>0.093846</td>
      <td>0.345420</td>
      <td>0.235547</td>
      <td>0.137160</td>
    </tr>
  </tbody>
</table>
<p>421 rows × 12 columns</p>
</div>



There's a weird effect going on in the 180 meridian: too much count


Some ref:

-  there are 625 pixeles per grid.
-  In the 180 meridian there are a lot of pixeles (superposed I guess)
-  The distributions of bright per grid is highly skewed (too much 0 brightness/band data)
-  The sum seems to be the best stat to compute (if the number of pixels is constant)
-  The number of pixels is not constant.



```python
weird_ones = grid_lights_df[grid_lights_df['sum'] >= 1e04] # TOO BIG
real_ones = grid_lights_df[grid_lights_df['sum'] < 1e04] # OK

fig, ax  = plt.subplots(1,3)
ax[0].plot(grid_lights_df['mean'], grid_lights_df['sum'], 'o')
ax[0].set_xlabel('mean')
ax[0].set_ylabel('sum')
ax[0].set_title('With artifact')

ax[1].plot(real_ones['mean'], real_ones['sum'], 'o')
ax[1].set_xlabel('mean')
ax[1].set_ylabel('sum')
ax[1].set_title('Without artefact')

ax[2].plot(real_ones['median'], real_ones['sum'], 'o')
ax[2].set_xlabel('median')
ax[2].set_ylabel('sum')
ax[2].set_title('Without artefact')

plt.tight_layout()
plt.show()
```



![png](07.0_light_index_files/07.0_light_index_15_0.png)



We can find the coefficient of the sum and the mean and use the "fixed sum"


```python
import numpy as np
x = real_ones['mean']
y = real_ones['sum']
a,b = np.polyfit(x,y, deg=1)
print(a,b) #b is negligible

# Replace it
weird_ones_fixed = weird_ones.copy()
weird_ones_fixed['sum'] = weird_ones_fixed['mean'] * a + b
```

    624.9999999999999 -1.681476694600172e-13



```python
grid_lights_df_fixed = pd.concat([real_ones, weird_ones_fixed])
```

We can base our model on the sum.


```python
grid_lights_df_fixed.plot(column='sum', legend=True, cmap='YlOrBr')
plt.title('Light intensity')
plt.show()
```



![png](07.0_light_index_files/07.0_light_index_20_0.png)



Include population data


```python
df_merge = pop_data2.merge(grid_lights_df_fixed[['id', 'mean', 'median', 'sum' ,'std', 'geometry']], on='id')
df_merge.sort_values('mean', ascending=False)
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>id</th>
      <th>Centroid</th>
      <th>geometry_x</th>
      <th>total_pop</th>
      <th>numbuildings</th>
      <th>mean</th>
      <th>median</th>
      <th>sum</th>
      <th>std</th>
      <th>geometry_y</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1981</td>
      <td>178.45E_-18.15N</td>
      <td>POLYGON ((178.3999999999999 -18.09999999999994...</td>
      <td>107468.0</td>
      <td>17899.0</td>
      <td>5.078188</td>
      <td>1.927919</td>
      <td>3173.867676</td>
      <td>5.856600</td>
      <td>POLYGON ((178.40000 -18.10000, 178.50000 -18.1...</td>
    </tr>
    <tr>
      <th>213</th>
      <td>510</td>
      <td>177.05E_-12.45N</td>
      <td>POLYGON ((176.99999999999997 -12.3999999999998...</td>
      <td>357.0</td>
      <td>73.0</td>
      <td>3.307821</td>
      <td>3.208075</td>
      <td>2067.388184</td>
      <td>0.912573</td>
      <td>POLYGON ((177.00000 -12.40000, 177.10000 -12.4...</td>
    </tr>
    <tr>
      <th>163</th>
      <td>763</td>
      <td>177.25E_-17.55N</td>
      <td>POLYGON ((177.19999999999996 -17.4999999999999...</td>
      <td>608.0</td>
      <td>75.0</td>
      <td>3.079601</td>
      <td>3.049799</td>
      <td>1924.750732</td>
      <td>0.423021</td>
      <td>POLYGON ((177.20000 -17.50000, 177.30000 -17.5...</td>
    </tr>
    <tr>
      <th>315</th>
      <td>762</td>
      <td>177.25E_-17.45N</td>
      <td>POLYGON ((177.19999999999996 -17.3999999999999...</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>3.076538</td>
      <td>3.129141</td>
      <td>1922.836426</td>
      <td>0.547503</td>
      <td>POLYGON ((177.20000 -17.40000, 177.30000 -17.4...</td>
    </tr>
    <tr>
      <th>4</th>
      <td>967</td>
      <td>177.45E_-17.75N</td>
      <td>POLYGON ((177.39999999999995 -17.6999999999999...</td>
      <td>39947.0</td>
      <td>7823.0</td>
      <td>3.018845</td>
      <td>1.766788</td>
      <td>1886.777832</td>
      <td>3.814638</td>
      <td>POLYGON ((177.40000 -17.70000, 177.50000 -17.7...</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>266</th>
      <td>4088</td>
      <td>180.55E_-16.75N</td>
      <td>POLYGON ((180.49999999999977 -16.6999999999999...</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.373295</td>
      <td>0.371634</td>
      <td>233.309219</td>
      <td>0.093503</td>
      <td>POLYGON ((180.50000 -16.70000, 180.60000 -16.7...</td>
    </tr>
    <tr>
      <th>251</th>
      <td>4292</td>
      <td>180.75E_-16.95N</td>
      <td>POLYGON ((180.69999999999976 -16.8999999999999...</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.368497</td>
      <td>0.367366</td>
      <td>230.310791</td>
      <td>0.084707</td>
      <td>POLYGON ((180.70000 -16.90000, 180.80000 -16.9...</td>
    </tr>
    <tr>
      <th>261</th>
      <td>4495</td>
      <td>180.95E_-17.05N</td>
      <td>POLYGON ((180.89999999999975 -16.9999999999999...</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.365052</td>
      <td>0.368908</td>
      <td>228.157654</td>
      <td>0.078574</td>
      <td>POLYGON ((180.90000 -17.00000, 181.00000 -17.0...</td>
    </tr>
    <tr>
      <th>325</th>
      <td>4737</td>
      <td>181.15E_-21.05N</td>
      <td>POLYGON ((181.09999999999974 -20.9999999999999...</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.359946</td>
      <td>0.351309</td>
      <td>224.966553</td>
      <td>0.093806</td>
      <td>POLYGON ((181.10000 -21.00000, 181.20000 -21.0...</td>
    </tr>
    <tr>
      <th>308</th>
      <td>4838</td>
      <td>181.25E_-21.05N</td>
      <td>POLYGON ((181.19999999999973 -20.9999999999999...</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.357736</td>
      <td>0.345420</td>
      <td>223.584885</td>
      <td>0.093846</td>
      <td>POLYGON ((181.20000 -21.00000, 181.30000 -21.0...</td>
    </tr>
  </tbody>
</table>
<p>421 rows × 10 columns</p>
</div>




```python
plt.plot(df_merge['sum'], df_merge.numbuildings, 'o')
plt.xlabel('Light index')
plt.ylabel('Households')
plt.title('Fiji')
plt.show()
```



![png](07.0_light_index_files/07.0_light_index_23_0.png)




```python
# Define the bins and labels
bins = [-float('inf'), 100, 500, 1000, 5000, 10000, 20000, float('inf')]
labels = [0, 1, 2, 3, 4, 5, 6]


# Create the new column using pd.cut
df_merge['num_cat_N_bld'] = pd.cut(df_merge['numbuildings'], bins=bins, labels=labels, include_lowest=True)
geo_merged = gpd.GeoDataFrame(df_merge, geometry='geometry_y')
#df_merge['num_cat_pop'] = pd.cut(df_merge['total_pop'], bins=bins, labels=labels, include_lowest=True)
```


```python
fig, ax  = plt.subplots(1,2, figsize=(10,6))
geo_merged.plot(column='sum', legend=True, cmap='YlOrBr', ax=ax[0])
ax[0].set_title('Light intensity')

geo_merged.plot(column='num_cat_N_bld', legend=True, cmap='YlOrBr', ax=ax[1])
ax[1].set_title('Households')

# Customize the legend labels
legend_labels = {
    0: '<100',
    1: '100 - 500',
    2: '500 - 1000',
    3: '1000 - 5000',
    4: '5000 - 10000',
    5: '10000 - 20000',
    6: '> 20000'
}

# Get the current legend
legend1 = ax[1].get_legend()

# Customize the legend labels using legend_labels dictionary
for key, label in legend_labels.items():
    legend1.get_texts()[key].set_text(label)

plt.tight_layout()
plt.show()
```



![png](07.0_light_index_files/07.0_light_index_25_0.png)



Povery index


```python
geo_merged['PI'] = geo_merged['numbuildings'] / geo_merged['sum']
```


```python
geo_merged.plot(column='PI', legend=True, cmap='YlOrBr')
plt.title('PI')
plt.show()
```



![png](07.0_light_index_files/07.0_light_index_28_0.png)



## Save it


```python
df_merge[['id', 'sum']].to_csv(output_dir / "light_index.csv", index=False)
```
