```python
from pathlib import Path
import os

from shapely.geometry import LineString,Polygon, MultiPolygon
import geopandas as gpd
import numpy as np
import pandas as pd
import xarray as xr
import re
import matplotlib.pyplot as plt
from matplotlib.patches import Patch
from matplotlib.lines import Line2D
from scipy import stats
```


```python
bld_dir = (
    Path(os.getenv("STORM_DATA_DIR"))
    / "analysis_fji/02_model_features/06_settlement/output/"
)
# Pop data
pop_data = pd.read_csv(bld_dir / 'fji_population_data.csv')
pop_data = pop_data.rename({'N_bld':'numbuildings'}, axis=1)

# Pop data 2
pop_data2 = pd.read_csv(bld_dir / 'fji_population_data_new_approach.csv')
pop_data2 = pop_data2.rename({'N_bld':'numbuildings'}, axis=1)

input_dir = (
    Path(os.getenv("STORM_DATA_DIR"))
    / "analysis_fji/02_model_features/02_housing_damage/input/"
)

output_dir = (
    Path(os.getenv("STORM_DATA_DIR"))
    / "analysis_fji/02_model_features/02_housing_damage/output/"
)

# Load Fiji
fiji = gpd.read_file(input_dir / "adm2_shp_fixed.gpkg")
fiji = fiji.to_crs('EPSG:4326')

# Load grid
grid_land_overlap = gpd.read_file(output_dir / "fji_0.1_degree_grid_land_overlap_new.gpkg")
grid_land_overlap["id"] = grid_land_overlap["id"].astype(int)

# Load grids per Municipality
ids_mun = pd.read_csv(input_dir / "grid_municipality_info.csv")

```

## First approach


```python
pop_by_grid = pop_data.sort_values('total_pop', ascending=False).total_pop
bld_by_grid = pop_data.sort_values('total_pop', ascending=False).numbuildings

plt.plot(pop_by_grid, bld_by_grid, 'o', alpha=0.7)
plt.xlabel('Population by grid')
plt.ylabel('Buildings by grid')
plt.xscale('log')
plt.yscale('log')
plt.grid()
plt.show()
```



![png](06.1_population_analysis_files/06.1_population_analysis_3_0.png)



What's that line??


```python
plt.hist(bld_by_grid, bins = 100)
plt.xscale('log')
plt.xlabel('Buildings')
plt.ylabel('Grid Cells')
plt.show()
```



![png](06.1_population_analysis_files/06.1_population_analysis_5_0.png)



Seems that there are a bunch of cells (100) with a lot of buildings (~10^3 bld)


```python
reduced_pop_dataset = pop_data[(pop_data.numbuildings > 10**2.7) & (pop_data.numbuildings < 10**2.8)]
reduced_pop_dataset
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>id</th>
      <th>Centroid</th>
      <th>geometry</th>
      <th>urban</th>
      <th>rural</th>
      <th>water</th>
      <th>total_pop</th>
      <th>numbuildings</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>32</th>
      <td>868</td>
      <td>177.35E_-17.95N</td>
      <td>POLYGON ((177.29999999999995 -17.8999999999999...</td>
      <td>0.00</td>
      <td>1.00</td>
      <td>0.00</td>
      <td>0.000000</td>
      <td>542.321224</td>
    </tr>
    <tr>
      <th>33</th>
      <td>869</td>
      <td>177.35E_-18.05N</td>
      <td>POLYGON ((177.29999999999995 -17.9999999999999...</td>
      <td>0.00</td>
      <td>0.98</td>
      <td>0.02</td>
      <td>4201.541504</td>
      <td>531.474799</td>
    </tr>
    <tr>
      <th>42</th>
      <td>969</td>
      <td>177.45E_-17.95N</td>
      <td>POLYGON ((177.39999999999995 -17.8999999999999...</td>
      <td>0.00</td>
      <td>1.00</td>
      <td>0.00</td>
      <td>1049.379395</td>
      <td>542.321224</td>
    </tr>
    <tr>
      <th>43</th>
      <td>970</td>
      <td>177.45E_-18.05N</td>
      <td>POLYGON ((177.39999999999995 -17.9999999999999...</td>
      <td>0.00</td>
      <td>1.00</td>
      <td>0.00</td>
      <td>0.000000</td>
      <td>542.321224</td>
    </tr>
    <tr>
      <th>44</th>
      <td>971</td>
      <td>177.45E_-18.15N</td>
      <td>POLYGON ((177.39999999999995 -18.0999999999999...</td>
      <td>0.01</td>
      <td>0.63</td>
      <td>0.36</td>
      <td>6939.420898</td>
      <td>580.354311</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>259</th>
      <td>2875</td>
      <td>179.35E_-16.65N</td>
      <td>POLYGON ((179.29999999999984 -16.5999999999999...</td>
      <td>0.00</td>
      <td>1.00</td>
      <td>0.00</td>
      <td>0.000000</td>
      <td>542.321224</td>
    </tr>
    <tr>
      <th>273</th>
      <td>2975</td>
      <td>179.45E_-16.55N</td>
      <td>POLYGON ((179.39999999999984 -16.4999999999999...</td>
      <td>0.00</td>
      <td>1.00</td>
      <td>0.00</td>
      <td>0.000000</td>
      <td>542.321224</td>
    </tr>
    <tr>
      <th>274</th>
      <td>2976</td>
      <td>179.45E_-16.65N</td>
      <td>POLYGON ((179.39999999999984 -16.5999999999999...</td>
      <td>0.00</td>
      <td>0.97</td>
      <td>0.03</td>
      <td>0.000000</td>
      <td>526.051587</td>
    </tr>
    <tr>
      <th>283</th>
      <td>3074</td>
      <td>179.55E_-16.35N</td>
      <td>POLYGON ((179.49999999999983 -16.2999999999999...</td>
      <td>0.00</td>
      <td>1.00</td>
      <td>0.00</td>
      <td>954.410278</td>
      <td>542.321224</td>
    </tr>
    <tr>
      <th>284</th>
      <td>3075</td>
      <td>179.55E_-16.45N</td>
      <td>POLYGON ((179.49999999999983 -16.3999999999999...</td>
      <td>0.00</td>
      <td>1.00</td>
      <td>0.00</td>
      <td>0.000000</td>
      <td>542.321224</td>
    </tr>
  </tbody>
</table>
<p>92 rows Ã— 8 columns</p>
</div>




```python
geo_reduced_pop_dataset = gpd.GeoDataFrame(reduced_pop_dataset.drop(['geometry', 'Centroid'], axis=1).merge(grid_land_overlap, on='id'), geometry = 'geometry')
fig, ax = plt.subplots(1,2)

grid_land_overlap.plot(color='gray', ax=ax[0])
geo_reduced_pop_dataset.plot(column='numbuildings', legend=True, ax=ax[0])
ax[0].set_title('Number of buildings')

grid_land_overlap.plot(color='gray', ax=ax[1])
geo_reduced_pop_dataset.plot(column='total_pop', legend=True, ax=ax[1])
ax[1].set_title('Population')

plt.tight_layout()
plt.show()
```



![png](06.1_population_analysis_files/06.1_population_analysis_8_0.png)




```python
plt.plot(reduced_pop_dataset.total_pop, reduced_pop_dataset.numbuildings, 'o')
plt.xlabel('Population')
plt.ylabel('Buildings')

plt.show()
```



![png](06.1_population_analysis_files/06.1_population_analysis_9_0.png)



HIP: In the map, those regions dont have water so it's just land. Also, It's mainly rural areas. So, the distribution of buildings is homogeneous across that subset. Seems that there are little towns, with more people living in that we're loosing just because we are not contemplating a model that includes population data to N of building prediciton.

## Second approach


```python
pop_by_grid2 = pop_data2.sort_values('total_pop', ascending=False).total_pop
bld_by_grid2 = pop_data2.sort_values('total_pop', ascending=False).numbuildings

plt.plot(pop_by_grid2, bld_by_grid2, 'o', alpha=0.7)
plt.xlabel('Population by grid')
plt.ylabel('Buildings by grid')
plt.xscale('log')
plt.yscale('log')
plt.grid()
plt.show()
```



![png](06.1_population_analysis_files/06.1_population_analysis_12_0.png)
