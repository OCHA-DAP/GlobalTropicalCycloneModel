```python
import pandas as pd
import geopandas as gpd
from pathlib import Path
import os
import requests, zipfile, io
import rasterio
from rasterio.merge import merge
from rasterstats import zonal_stats
from osgeo import gdal
import matplotlib.pyplot as plt
import rioxarray
import xarray
from shapely.geometry import Polygon
from rasterstats import zonal_stats
```


```python
base_dir = Path(os.getenv("STORM_DATA_DIR")) / "analysis_vnm/02_model_features/"
input_dir = base_dir / "05_vulnerability/input/"
bld_dir = base_dir / "02_housing_damage/output/"
output_dir = base_dir / "05_vulnerability/output/"

# Load ids of municipalities
ids_mun = pd.read_csv(base_dir / "02_housing_damage/input/grid_municipality_info.csv")

# Load grids
grid = gpd.read_file(base_dir / "02_housing_damage/output/viet_0.1_degree_grid_land_overlap_new.gpkg")

# Load viet
viet = gpd.read_file(base_dir / "02_housing_damage/input/adm2_shp_fixed.gpkg")
viet = viet.to_crs('EPSG:4326')

# Pop data
pop_data = pd.read_csv(bld_dir / 'num_building_bygrid.csv')
pop_data = pop_data.rename({'N_bld':'numbuildings'}, axis=1)
```


```python
grid_transformed = grid.copy()
# Define a function to adjust the longitude of a single polygon
def adjust_longitude(polygon):
    # Extract the coordinates of the polygon
    coords = list(polygon.exterior.coords)

    # Adjust longitudes from [0, 360) to [-180, 180)
    for i in range(len(coords)):
        lon, lat = coords[i]
        if lon > 180:
            coords[i] = (lon - 360, lat)

    # Create a new Polygon with adjusted coordinates
    return Polygon(coords)

# Apply the adjust_longitude function to each geometry in the DataFrame
grid_transformed["geometry"] = grid_transformed["geometry"].apply(adjust_longitude)
grid_transformed = grid_transformed[['id', 'Latitude', 'Longitude','geometry']]
```

## .tif files

### Create merged file


```python
file_list = os.listdir(input_dir)
tif_files = []
for file in file_list:
    if file.endswith('.tif'):
        tif_files.append(file)
tif_files
```




    ['SVDNB_npp_d20240101.d.00N180W.rade9.tif',
     'SVDNB_npp_d20240101.d.75N060E.rade9.tif',
     'SVDNB_npp_d20240101.d.00N060W.rade9.tif',
     'SVDNB_npp_d20240101.d.00N060E.rade9.tif',
     'SVDNB_npp_d20240101.d.75N060W.rade9.tif']




```python
# All .tif files together
mosaic_raster = []
for file in tif_files:
    rast = rasterio.open(input_dir / file)
    mosaic_raster.append(rast)
merged_raster, out_raster = merge(mosaic_raster)
```


```python
# Metadata of the files
out_meta = rast.meta.copy()
out_meta.update(
    {
        "driver": "GTiff",
        "height": merged_raster.shape[1],
        "width": merged_raster.shape[2],
        "transform": out_raster,
#        "crs": grid.crs,
    }
)

# Save file
with rasterio.open(output_dir / "light_merged.tif", "w", **out_meta) as dest:
    dest.write(merged_raster)
```

### Open merged file


```python
ras = rasterio.open(output_dir / 'light_merged.tif')
```

Information


```python
rast_path = output_dir / 'light_merged.tif'
!gdalinfo \
"{rast_path}"
```

    Driver: GTiff/GeoTIFF
    Files: /Users/federico/Documents/data/analysis_viet/02_new_model_input/05_vulnerability/output/light_merged.tif
    Size is 86401, 33601
    Coordinate System is:
    GEOGCRS["WGS 84",
        DATUM["World Geodetic System 1984",
            ELLIPSOID["WGS 84",6378137,298.257223563,
                LENGTHUNIT["metre",1,
                    ID["EPSG",9001]]]],
        PRIMEM["Greenwich",0,
            ANGLEUNIT["degree",0.0174532925199433,
                ID["EPSG",9122]]],
        CS[ellipsoidal,2],
            AXIS["latitude",north,
                ORDER[1],
                ANGLEUNIT["degree",0.0174532925199433,
                    ID["EPSG",9122]]],
            AXIS["longitude",east,
                ORDER[2],
                ANGLEUNIT["degree",0.0174532925199433,
                    ID["EPSG",9122]]]]
    Data axis to CRS axis mapping: 2,1
    Origin = (-180.002083333349987,75.002083333350001)
    Pixel Size = (0.004166666700000,-0.004166666700000)
    Metadata:
      AREA_OR_POINT=Area
    Image Structure Metadata:
      INTERLEAVE=BAND
    Corner Coordinates:
    Upper Left  (-180.0020833,  75.0020833) (180d 0' 7.50"W, 75d 0' 7.50"N)
    Lower Left  (-180.0020833, -65.0020845) (180d 0' 7.50"W, 65d 0' 7.50"S)
    Upper Right ( 180.0020862,  75.0020833) (180d 0' 7.51"E, 75d 0' 7.50"N)
    Lower Right ( 180.0020862, -65.0020845) (180d 0' 7.51"E, 65d 0' 7.50"S)
    Center      (   0.0000014,   4.9999994) (  0d 0' 0.01"E,  5d 0' 0.00"N)
    Band 1 Block=86401x1 Type=Float32, ColorInterp=Gray



```python
lights = ras.read(1)
```


```python
summary_stats = zonal_stats(
    grid,
    lights,
    stats=["mean", "median", "std", "sum", "count", "majority", "minority"],
    nodata=-9999,
    all_touched=True,
    affine=ras.transform,
)
grid_lights = pd.DataFrame(summary_stats)
#grid_lights_df = pd.concat([mini_grid, grid_lights], axis=1)
grid_lights_df = pd.concat([grid, grid_lights], axis=1)
grid_lights_df.sort_values('sum', ascending=False)
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>id</th>
      <th>Longitude</th>
      <th>Latitude</th>
      <th>Centroid</th>
      <th>geometry</th>
      <th>mean</th>
      <th>count</th>
      <th>sum</th>
      <th>std</th>
      <th>median</th>
      <th>majority</th>
      <th>minority</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2638</th>
      <td>12621</td>
      <td>107.95</td>
      <td>10.85</td>
      <td>107.95E_10.85N</td>
      <td>POLYGON ((107.90000 10.90000, 108.00000 10.900...</td>
      <td>214.133600</td>
      <td>625</td>
      <td>133833.500000</td>
      <td>171.378922</td>
      <td>197.714493</td>
      <td>24.134926</td>
      <td>24.753538</td>
    </tr>
    <tr>
      <th>2637</th>
      <td>12620</td>
      <td>107.95</td>
      <td>10.95</td>
      <td>107.95E_10.95N</td>
      <td>POLYGON ((107.90000 11.00000, 108.00000 11.000...</td>
      <td>209.747800</td>
      <td>625</td>
      <td>131092.375000</td>
      <td>109.232204</td>
      <td>208.094864</td>
      <td>33.887131</td>
      <td>36.076218</td>
    </tr>
    <tr>
      <th>2700</th>
      <td>12801</td>
      <td>108.05</td>
      <td>10.95</td>
      <td>108.05E_10.95N</td>
      <td>POLYGON ((108.00000 11.00000, 108.10000 11.000...</td>
      <td>159.607650</td>
      <td>625</td>
      <td>99754.781250</td>
      <td>104.273246</td>
      <td>153.892014</td>
      <td>32.382317</td>
      <td>17.811554</td>
    </tr>
    <tr>
      <th>2576</th>
      <td>12440</td>
      <td>107.85</td>
      <td>10.85</td>
      <td>107.85E_10.85N</td>
      <td>POLYGON ((107.80000 10.90000, 107.90000 10.900...</td>
      <td>128.071250</td>
      <td>625</td>
      <td>80044.531250</td>
      <td>94.546917</td>
      <td>113.006149</td>
      <td>42.975349</td>
      <td>15.432546</td>
    </tr>
    <tr>
      <th>2577</th>
      <td>12441</td>
      <td>107.85</td>
      <td>10.75</td>
      <td>107.85E_10.75N</td>
      <td>POLYGON ((107.80000 10.80000, 107.90000 10.800...</td>
      <td>114.211187</td>
      <td>625</td>
      <td>71381.992188</td>
      <td>92.536698</td>
      <td>95.083115</td>
      <td>18.098829</td>
      <td>16.244354</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>3470</th>
      <td>24775</td>
      <td>114.65</td>
      <td>8.15</td>
      <td>114.65E_8.15N</td>
      <td>POLYGON ((114.60000 8.20000, 114.70000 8.20000...</td>
      <td>0.469920</td>
      <td>625</td>
      <td>293.700165</td>
      <td>0.211331</td>
      <td>0.429896</td>
      <td>0.242699</td>
      <td>0.292477</td>
    </tr>
    <tr>
      <th>3396</th>
      <td>23334</td>
      <td>113.85</td>
      <td>7.45</td>
      <td>113.85E_7.45N</td>
      <td>POLYGON ((113.80000 7.50000, 113.90000 7.50000...</td>
      <td>0.466248</td>
      <td>625</td>
      <td>291.405151</td>
      <td>0.123944</td>
      <td>0.445839</td>
      <td>0.236770</td>
      <td>0.283580</td>
    </tr>
    <tr>
      <th>3489</th>
      <td>25146</td>
      <td>114.85</td>
      <td>7.25</td>
      <td>114.85E_7.25N</td>
      <td>POLYGON ((114.80000 7.30000, 114.90000 7.30000...</td>
      <td>0.450028</td>
      <td>625</td>
      <td>281.267731</td>
      <td>0.072791</td>
      <td>0.445656</td>
      <td>0.284776</td>
      <td>0.231646</td>
    </tr>
    <tr>
      <th>3496</th>
      <td>25325</td>
      <td>114.95</td>
      <td>7.45</td>
      <td>114.95E_7.45N</td>
      <td>POLYGON ((114.90000 7.50000, 115.00000 7.50000...</td>
      <td>0.446096</td>
      <td>625</td>
      <td>278.809753</td>
      <td>0.082997</td>
      <td>0.434556</td>
      <td>0.282371</td>
      <td>0.283222</td>
    </tr>
    <tr>
      <th>3387</th>
      <td>23153</td>
      <td>113.75</td>
      <td>7.45</td>
      <td>113.75E_7.45N</td>
      <td>POLYGON ((113.70000 7.50000, 113.80000 7.50000...</td>
      <td>0.395759</td>
      <td>625</td>
      <td>247.349457</td>
      <td>0.079160</td>
      <td>0.391785</td>
      <td>0.173416</td>
      <td>0.222491</td>
    </tr>
  </tbody>
</table>
<p>3579 rows × 12 columns</p>
</div>




```python
grid_lights_df['count'].unique() #Great.. just 625 pixels per grid.
```




    array([625])



We can base our model on the median.


```python
#grid_lights_df.fillna(0).plot(column='median', legend=True, cmap='Reds')
grid_lights_df.plot(column='sum', legend=True, cmap='YlOrBr')
plt.title('Light intensity')
plt.show()
```



![png](07.0_light_index_files/07.0_light_index_16_0.png)



Include population data


```python
df_merge = pop_data.merge(grid_lights_df[['id', 'mean', 'median', 'sum' ,'std', 'geometry']], on='id')
df_merge.sort_values('sum', ascending=False)
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Unnamed: 0</th>
      <th>id</th>
      <th>numbuildings</th>
      <th>mean</th>
      <th>median</th>
      <th>sum</th>
      <th>std</th>
      <th>geometry</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2638</th>
      <td>2638</td>
      <td>12621</td>
      <td>14680.0</td>
      <td>214.133600</td>
      <td>197.714493</td>
      <td>133833.500000</td>
      <td>171.378922</td>
      <td>POLYGON ((107.90000 10.90000, 108.00000 10.900...</td>
    </tr>
    <tr>
      <th>2637</th>
      <td>2637</td>
      <td>12620</td>
      <td>22434.0</td>
      <td>209.747800</td>
      <td>208.094864</td>
      <td>131092.375000</td>
      <td>109.232204</td>
      <td>POLYGON ((107.90000 11.00000, 108.00000 11.000...</td>
    </tr>
    <tr>
      <th>2700</th>
      <td>2700</td>
      <td>12801</td>
      <td>104795.0</td>
      <td>159.607650</td>
      <td>153.892014</td>
      <td>99754.781250</td>
      <td>104.273246</td>
      <td>POLYGON ((108.00000 11.00000, 108.10000 11.000...</td>
    </tr>
    <tr>
      <th>2576</th>
      <td>2576</td>
      <td>12440</td>
      <td>20274.0</td>
      <td>128.071250</td>
      <td>113.006149</td>
      <td>80044.531250</td>
      <td>94.546917</td>
      <td>POLYGON ((107.80000 10.90000, 107.90000 10.900...</td>
    </tr>
    <tr>
      <th>2577</th>
      <td>2577</td>
      <td>12441</td>
      <td>20476.0</td>
      <td>114.211187</td>
      <td>95.083115</td>
      <td>71381.992188</td>
      <td>92.536698</td>
      <td>POLYGON ((107.80000 10.80000, 107.90000 10.800...</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>3470</th>
      <td>3470</td>
      <td>24775</td>
      <td>0.0</td>
      <td>0.469920</td>
      <td>0.429896</td>
      <td>293.700165</td>
      <td>0.211331</td>
      <td>POLYGON ((114.60000 8.20000, 114.70000 8.20000...</td>
    </tr>
    <tr>
      <th>3396</th>
      <td>3396</td>
      <td>23334</td>
      <td>0.0</td>
      <td>0.466248</td>
      <td>0.445839</td>
      <td>291.405151</td>
      <td>0.123944</td>
      <td>POLYGON ((113.80000 7.50000, 113.90000 7.50000...</td>
    </tr>
    <tr>
      <th>3489</th>
      <td>3489</td>
      <td>25146</td>
      <td>0.0</td>
      <td>0.450028</td>
      <td>0.445656</td>
      <td>281.267731</td>
      <td>0.072791</td>
      <td>POLYGON ((114.80000 7.30000, 114.90000 7.30000...</td>
    </tr>
    <tr>
      <th>3496</th>
      <td>3496</td>
      <td>25325</td>
      <td>0.0</td>
      <td>0.446096</td>
      <td>0.434556</td>
      <td>278.809753</td>
      <td>0.082997</td>
      <td>POLYGON ((114.90000 7.50000, 115.00000 7.50000...</td>
    </tr>
    <tr>
      <th>3387</th>
      <td>3387</td>
      <td>23153</td>
      <td>0.0</td>
      <td>0.395759</td>
      <td>0.391785</td>
      <td>247.349457</td>
      <td>0.079160</td>
      <td>POLYGON ((113.70000 7.50000, 113.80000 7.50000...</td>
    </tr>
  </tbody>
</table>
<p>3579 rows × 8 columns</p>
</div>




```python
plt.plot(df_merge['sum'], df_merge.numbuildings, 'o')
plt.xlabel('Light index')
plt.ylabel('Households')
plt.title('Vietnam')
plt.show()
```



![png](07.0_light_index_files/07.0_light_index_19_0.png)




```python
# Define the bins and labels
bins = [-float('inf'), 100, 1000, 10000, 20000, 50000, 100000, float('inf')]
labels = [0, 1, 2, 3, 4, 5, 6]

# Create the new column using pd.cut
df_merge['num_cat_N_bld'] = pd.cut(df_merge['numbuildings'], bins=bins, labels=labels, include_lowest=True)
geo_merged = gpd.GeoDataFrame(df_merge, geometry='geometry')
#df_merge['num_cat_pop'] = pd.cut(df_merge['total_pop'], bins=bins, labels=labels, include_lowest=True)
```


```python
fig, ax  = plt.subplots(1,2, figsize=(10,6))
geo_merged.plot(column='sum', legend=True, cmap='YlOrBr', ax=ax[0])
ax[0].set_title('Light intensity')

geo_merged.plot(column='num_cat_N_bld', legend=True, cmap='YlOrBr', ax=ax[1])
ax[1].set_title('Population')

# Customize the legend labels
legend_labels = {
    0: '<100',
    1: '100 - 1000',
    2: '1000 - 10000',
    3: '10000 - 20000',
    4: '20000 - 50000',
    5: '50000 - 100000',
    6: '> 100000'
}

# Get the current legend
legend1 = ax[1].get_legend()

# Customize the legend labels using legend_labels dictionary
for key, label in legend_labels.items():
    legend1.get_texts()[key].set_text(label)

plt.tight_layout()
plt.show()
```



![png](07.0_light_index_files/07.0_light_index_21_0.png)



Povery index


```python
geo_merged['PI'] = geo_merged['numbuildings'] / geo_merged['sum']
```


```python
geo_merged.plot(column='PI', legend=True, cmap='YlOrBr')
plt.title('PI')
plt.show()
```



![png](07.0_light_index_files/07.0_light_index_24_0.png)



## Save it


```python
df_merge[['id', 'sum']].to_csv(output_dir / "light_index.csv", index=False)
```
