```python
from pathlib import Path
import os
import pandas as pd
import geopandas as gpd
import numpy as np
from shapely.geometry import Point

import rasterio
from rasterio.merge import merge
from rasterstats import zonal_stats

from osgeo import gdal
import matplotlib.pyplot as plt
```

```https://dwtkns.com/srtm30m/``` to get the data (must be registered)


```python
#data_dir = '/home/fmoss/data'
data_dir = os.getenv("STORM_DATA_DIR")
base_url = Path(data_dir) / "analysis_vnm/02_model_features/"
input_dir = base_url / "04_topography/input/srtm/"
output_dir = base_url / "04_topography/output/"
shp_output_dir = base_url / "02_housing_damage/output/"
```


```python
# Load grid
grid = gpd.read_file(base_url / "02_housing_damage/output/viet_0.1_degree_grid_land_overlap_new.gpkg")
# Load Vietnam
adm2_shp = gpd.read_file(base_url / "02_housing_damage/input/adm2_shp_fixed.gpkg")
adm2_shp = adm2_shp.to_crs('EPSG:4326')
```

## Merge all .hdg files


```python
# List all files
fileList = os.listdir(input_dir/ "dwtkns")
print(fileList)

# All .hgt together
mosaic_raster = []
for file in fileList:
    if file.endswith(".hgt.zip"):
        rast = rasterio.open(input_dir / "dwtkns" / file)
        mosaic_raster.append(rast)
merged_raster, out_raster = merge(mosaic_raster)

# Metadata of the files
out_meta = rast.meta.copy()
out_meta.update(
    {
        "driver": "GTiff",
        "height": merged_raster.shape[1],
        "width": merged_raster.shape[2],
        "transform": out_raster,
#        "crs": grid.crs,
    }
)

# Save file
with rasterio.open(input_dir / "viet_merged_srtm.tif", "w", **out_meta) as dest:
    dest.write(merged_raster)

```

    ['N15E111.SRTMGL1.hgt.zip', 'N17E107.SRTMGL1.hgt.zip', 'N20E105.SRTMGL1.hgt.zip', 'N14E108.SRTMGL1.hgt.zip', 'N19E106.SRTMGL1.hgt.zip', 'N21E105.SRTMGL1.hgt.zip', 'N16E107.SRTMGL1.hgt.zip', 'N18E106.SRTMGL1.hgt.zip', 'N15E108.SRTMGL1.hgt.zip', 'N16E108.SRTMGL1.hgt.zip', 'N19E110.SRTMGL1.hgt.zip', 'N22E105.SRTMGL1.hgt.zip', 'N15E107.SRTMGL1.hgt.zip', 'N18E109.SRTMGL1.hgt.zip', 'N18E110.SRTMGL1.hgt.zip', 'N16E111.SRTMGL1.hgt.zip', 'N19E109.SRTMGL1.hgt.zip', 'N14E107.SRTMGL1.hgt.zip', 'N23E105.SRTMGL1.hgt.zip', 'N11E108.SRTMGL1.hgt.zip', 'N12E107.SRTMGL1.hgt.zip', '.DS_Store', 'N10E108.SRTMGL1.hgt.zip', 'N22E102.SRTMGL1.hgt.zip', 'N08E111.SRTMGL1.hgt.zip', 'N13E107.SRTMGL1.hgt.zip', 'N10E107.SRTMGL1.hgt.zip', 'N13E108.SRTMGL1.hgt.zip', 'N21E102.SRTMGL1.hgt.zip', 'N11E107.SRTMGL1.hgt.zip', 'N12E108.SRTMGL1.hgt.zip', 'N12E106.SRTMGL1.hgt.zip', 'N11E109.SRTMGL1.hgt.zip', 'N09E109.SRTMGL1.hgt.zip', 'N13E106.SRTMGL1.hgt.zip', 'N22E103.SRTMGL1.hgt.zip', 'N13E109.SRTMGL1.hgt.zip', 'N09E106.SRTMGL1.hgt.zip', 'N21E103.SRTMGL1.hgt.zip', 'N10E106.SRTMGL1.hgt.zip', 'N20E103.SRTMGL1.hgt.zip', 'N08E106.SRTMGL1.hgt.zip', 'N12E109.SRTMGL1.hgt.zip', 'N11E106.SRTMGL1.hgt.zip', 'N14E109.SRTMGL1.hgt.zip', 'N17E106.SRTMGL1.hgt.zip', 'N20E104.SRTMGL1.hgt.zip', 'N15E109.SRTMGL1.hgt.zip', 'N21E104.SRTMGL1.hgt.zip', 'N16E106.SRTMGL1.hgt.zip', 'N22E104.SRTMGL1.hgt.zip', 'N15E106.SRTMGL1.hgt.zip', 'N18E108.SRTMGL1.hgt.zip', 'N19E108.SRTMGL1.hgt.zip', 'N14E106.SRTMGL1.hgt.zip', 'N23E104.SRTMGL1.hgt.zip', 'N07E113.SRTMGL1.hgt.zip', 'N08E104.SRTMGL1.hgt.zip', 'N11E104.SRTMGL1.hgt.zip', 'N09E104.SRTMGL1.hgt.zip', 'N10E104.SRTMGL1.hgt.zip', 'N10E103.SRTMGL1.hgt.zip', 'N18E105.SRTMGL1.hgt.zip', 'N21E106.SRTMGL1.hgt.zip', 'N19E105.SRTMGL1.hgt.zip', 'N11E103.SRTMGL1.hgt.zip', 'N20E106.SRTMGL1.hgt.zip', 'N16E112.SRTMGL1.hgt.zip', 'N10E115.SRTMGL1.hgt.zip', 'N22E106.SRTMGL1.hgt.zip', 'N11E115.SRTMGL1.hgt.zip', 'N21E107.SRTMGL1.hgt.zip', 'N18E104.SRTMGL1.hgt.zip', 'N17E105.SRTMGL1.hgt.zip', 'N20E107.SRTMGL1.hgt.zip', 'N19E104.SRTMGL1.hgt.zip', 'N10E114.SRTMGL1.hgt.zip', 'N14E105.SRTMGL1.hgt.zip', 'N11E114.SRTMGL1.hgt.zip', 'N21E108.SRTMGL1.hgt.zip', 'N15E105.SRTMGL1.hgt.zip', 'N13E105.SRTMGL1.hgt.zip', 'N12E105.SRTMGL1.hgt.zip', 'N11E105.SRTMGL1.hgt.zip', 'N19E103.SRTMGL1.hgt.zip', 'N08E105.SRTMGL1.hgt.zip', 'N10E105.SRTMGL1.hgt.zip', 'N09E105.SRTMGL1.hgt.zip']


## Open merged file and compute stuff


```python
# Load
merged_rast = rasterio.open(input_dir / "viet_merged_srtm.tif")
altitude = merged_rast.read(1)
```

Information about the dataset


```python
merged_rast_path = input_dir / "viet_merged_srtm.tif"
!gdalinfo \
"{merged_rast_path}"
```

    Driver: GTiff/GeoTIFF
    Files: /Users/federico/Documents/data/analysis_viet/02_new_model_input/04_topography/input/srtm/viet_merged_srtm.tif
    Size is 50401, 61201
    Coordinate System is:
    GEOGCRS["WGS 84",
        DATUM["World Geodetic System 1984",
            ELLIPSOID["WGS 84",6378137,298.257223563,
                LENGTHUNIT["metre",1]]],
        PRIMEM["Greenwich",0,
            ANGLEUNIT["degree",0.0174532925199433]],
        CS[ellipsoidal,2],
            AXIS["geodetic latitude (Lat)",north,
                ORDER[1],
                ANGLEUNIT["degree",0.0174532925199433]],
            AXIS["geodetic longitude (Lon)",east,
                ORDER[2],
                ANGLEUNIT["degree",0.0174532925199433]],
        USAGE[
            SCOPE["unknown"],
            AREA["World"],
            BBOX[-90,-180,90,180]],
        ID["EPSG",4326]]
    Data axis to CRS axis mapping: 2,1
    Origin = (101.999861111111116,24.000138888888888)
    Pixel Size = (0.000277777777778,-0.000277777777778)
    Metadata:
      AREA_OR_POINT=Area
    Image Structure Metadata:
      INTERLEAVE=BAND
    Corner Coordinates:
    Upper Left  ( 101.9998611,  24.0001389) (101d59'59.50"E, 24d 0' 0.50"N)
    Lower Left  ( 101.9998611,   6.9998611) (101d59'59.50"E,  6d59'59.50"N)
    Upper Right ( 116.0001389,  24.0001389) (116d 0' 0.50"E, 24d 0' 0.50"N)
    Lower Right ( 116.0001389,   6.9998611) (116d 0' 0.50"E,  6d59'59.50"N)
    Center      ( 109.0000000,  15.5000000) (109d 0' 0.00"E, 15d30' 0.00"N)
    Band 1 Block=50401x1 Type=Int16, ColorInterp=Gray
      NoData Value=-32768



```python
## slope
viet_slope_gdaldem = input_dir / "viet_slope_gdaldem.tif"
!gdaldem slope -s 111120 -co COMPRESS=DEFLATE -co ZLEVEL=9 \
"{merged_rast_path}" "{viet_slope_gdaldem}" -compute_edges
```

    0...10...20...30...40...50...60...70...80...90...100 - done.



```python
slope_rast = rasterio.open(input_dir / "viet_slope_gdaldem.tif")
slope_array = slope_rast.read(1)
```


```python
## calculate  Terrain Ruggedness Index TRI
viet_tri_gdaldem = input_dir / "viet_tri_gdaldem.tif"
!gdaldem TRI -co COMPRESS=DEFLATE -co ZLEVEL=9 \
"{merged_rast_path}" "{viet_tri_gdaldem}" -compute_edges
```

    0...10...20...30...40...50...60...70...80...90...100 - done.



```python
tri_rast = rasterio.open(input_dir / "viet_tri_gdaldem.tif")
tri_array = tri_rast.read(1)
```

### Mean slope with raster


```python
summary_stats = zonal_stats(
    grid,
    slope_array,
    stats=["mean", "std"],
    nodata=-9999,
    all_touched=True,
    affine=merged_rast.transform,
)
grid_slope = pd.DataFrame(summary_stats)
grid_slope_df = pd.concat([grid, grid_slope], axis=1)
grid_slope_df
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>id</th>
      <th>Longitude</th>
      <th>Latitude</th>
      <th>Centroid</th>
      <th>geometry</th>
      <th>mean</th>
      <th>std</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>2007</td>
      <td>102.15</td>
      <td>22.45</td>
      <td>102.15E_22.45N</td>
      <td>POLYGON ((102.10000 22.50000, 102.20000 22.500...</td>
      <td>20.474829</td>
      <td>8.297796</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2008</td>
      <td>102.15</td>
      <td>22.35</td>
      <td>102.15E_22.35N</td>
      <td>POLYGON ((102.10000 22.40000, 102.20000 22.400...</td>
      <td>21.390162</td>
      <td>8.315401</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2009</td>
      <td>102.15</td>
      <td>22.25</td>
      <td>102.15E_22.25N</td>
      <td>POLYGON ((102.10000 22.30000, 102.20000 22.300...</td>
      <td>21.541014</td>
      <td>8.333649</td>
    </tr>
    <tr>
      <th>3</th>
      <td>2187</td>
      <td>102.25</td>
      <td>22.55</td>
      <td>102.25E_22.55N</td>
      <td>POLYGON ((102.20000 22.60000, 102.30000 22.600...</td>
      <td>23.054955</td>
      <td>8.178382</td>
    </tr>
    <tr>
      <th>4</th>
      <td>2188</td>
      <td>102.25</td>
      <td>22.45</td>
      <td>102.25E_22.45N</td>
      <td>POLYGON ((102.20000 22.50000, 102.30000 22.500...</td>
      <td>21.058342</td>
      <td>8.370987</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>3574</th>
      <td>30180</td>
      <td>117.65</td>
      <td>10.65</td>
      <td>117.65E_10.65N</td>
      <td>POLYGON ((117.60000 10.70000, 117.70000 10.700...</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>3575</th>
      <td>30359</td>
      <td>117.75</td>
      <td>10.85</td>
      <td>117.75E_10.85N</td>
      <td>POLYGON ((117.70000 10.90000, 117.80000 10.900...</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>3576</th>
      <td>30360</td>
      <td>117.75</td>
      <td>10.75</td>
      <td>117.75E_10.75N</td>
      <td>POLYGON ((117.70000 10.80000, 117.80000 10.800...</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>3577</th>
      <td>30540</td>
      <td>117.85</td>
      <td>10.85</td>
      <td>117.85E_10.85N</td>
      <td>POLYGON ((117.80000 10.90000, 117.90000 10.900...</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>3578</th>
      <td>30541</td>
      <td>117.85</td>
      <td>10.75</td>
      <td>117.85E_10.75N</td>
      <td>POLYGON ((117.80000 10.80000, 117.90000 10.800...</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
  </tbody>
</table>
<p>3579 rows × 7 columns</p>
</div>




```python
fig, ax = plt.subplots(1,1)
grid.plot(color='gray', alpha=0.4, ax=ax, label='No data')
gpd.GeoDataFrame(grid_slope_df.dropna(), geometry='geometry').plot(column='mean', legend=True, ax=ax)
plt.title('Slope [degree]')
plt.show()
```



![png](04.0.1_topography_variables_files/04.0.1_topography_variables_16_0.png)



### Mean altitude with raster


```python
summary_stats = zonal_stats(
    grid,
    altitude,
    stats=["mean"],
    nodata=-32768,
    all_touched=True,
    affine=merged_rast.transform,
)
grid_elev = pd.DataFrame(summary_stats)
grid_elev_df = pd.concat([grid, grid_elev], axis=1)
grid_elev_df
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>id</th>
      <th>Longitude</th>
      <th>Latitude</th>
      <th>Centroid</th>
      <th>geometry</th>
      <th>mean</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>2007</td>
      <td>102.15</td>
      <td>22.45</td>
      <td>102.15E_22.45N</td>
      <td>POLYGON ((102.10000 22.50000, 102.20000 22.500...</td>
      <td>985.104826</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2008</td>
      <td>102.15</td>
      <td>22.35</td>
      <td>102.15E_22.35N</td>
      <td>POLYGON ((102.10000 22.40000, 102.20000 22.400...</td>
      <td>1276.734225</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2009</td>
      <td>102.15</td>
      <td>22.25</td>
      <td>102.15E_22.25N</td>
      <td>POLYGON ((102.10000 22.30000, 102.20000 22.300...</td>
      <td>1162.446697</td>
    </tr>
    <tr>
      <th>3</th>
      <td>2187</td>
      <td>102.25</td>
      <td>22.55</td>
      <td>102.25E_22.55N</td>
      <td>POLYGON ((102.20000 22.60000, 102.30000 22.600...</td>
      <td>801.625901</td>
    </tr>
    <tr>
      <th>4</th>
      <td>2188</td>
      <td>102.25</td>
      <td>22.45</td>
      <td>102.25E_22.45N</td>
      <td>POLYGON ((102.20000 22.50000, 102.30000 22.500...</td>
      <td>1047.179465</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>3574</th>
      <td>30180</td>
      <td>117.65</td>
      <td>10.65</td>
      <td>117.65E_10.65N</td>
      <td>POLYGON ((117.60000 10.70000, 117.70000 10.700...</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>3575</th>
      <td>30359</td>
      <td>117.75</td>
      <td>10.85</td>
      <td>117.75E_10.85N</td>
      <td>POLYGON ((117.70000 10.90000, 117.80000 10.900...</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>3576</th>
      <td>30360</td>
      <td>117.75</td>
      <td>10.75</td>
      <td>117.75E_10.75N</td>
      <td>POLYGON ((117.70000 10.80000, 117.80000 10.800...</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>3577</th>
      <td>30540</td>
      <td>117.85</td>
      <td>10.85</td>
      <td>117.85E_10.85N</td>
      <td>POLYGON ((117.80000 10.90000, 117.90000 10.900...</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>3578</th>
      <td>30541</td>
      <td>117.85</td>
      <td>10.75</td>
      <td>117.85E_10.75N</td>
      <td>POLYGON ((117.80000 10.80000, 117.90000 10.800...</td>
      <td>NaN</td>
    </tr>
  </tbody>
</table>
<p>3579 rows × 6 columns</p>
</div>




```python
fig, ax = plt.subplots(1,1)
grid.plot(color='gray', alpha=0.4, ax=ax, label='No data')
gpd.GeoDataFrame(grid_elev_df.dropna(), geometry='geometry').plot(column='mean', legend=True, ax=ax, label='Altitude')
plt.title('Altitude [m]')
plt.show()
```



![png](04.0.1_topography_variables_files/04.0.1_topography_variables_19_0.png)



Merge altitude and slope data


```python
df_slope = grid_slope_df.fillna(0).rename({'mean':'mean_slope'}, axis=1)
df_elev = grid_elev_df.fillna(0).rename({'mean':'mean_elev'}, axis=1)
df_slope_elev = df_slope.merge(df_elev, on='id')[['id', 'mean_elev', 'mean_slope']]
```

## (old approach) To grid and consider less datapoints --panda's approach


```python
"""RUN WITH CAUTION"""

step = 5 # I dont need THAT MUCH resolution in my database (each datapoint is 30m appart from the next datapoint)
min_longitude = 102
max_longitude = 118
min_latitude = 7
max_latitude = 23

def pixel_to_lat_lon(x, y, min_lat, min_lon):
    increment = geotransform[0]
    lat = min_lat + y * increment
    lon = min_lon + x * increment
    return lat, lon

min_row, min_col = 0, 0
max_row, max_col = np.shape(altitude)

data = []
for row in range(0, max_row-1, step):
    for col in range(0, max_col-1, step):
        lat, lon = pixel_to_lat_lon(col, row, min_lat=min_latitude, min_lon=min_longitude)
        data.append((altitude[row, col], slope_array[row, col], lat, lon))


df = pd.DataFrame(data, columns=['altitude', 'slope', 'latitude', 'longitude'])
```


```python
# Save
df.to_csv(output_dir / "topology_data_raw.csv.gz", compression='gzip')
```


```python
# Load
df = pd.read_csv(output_dir / "topology_data_raw.csv")
```


```python
# Remove oceans (i.e altitude <0) Obs: nodata = -32768 m typically
df_no_oceans = df[df['altitude'] >= 0]
df_no_oceans = df_no_oceans.reset_index(drop=True)
df_no_oceans
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>altitude</th>
      <th>slope</th>
      <th>latitude</th>
      <th>longitude</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1968</td>
      <td>15.396382</td>
      <td>7.000000</td>
      <td>104.000000</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1950</td>
      <td>17.702055</td>
      <td>7.000000</td>
      <td>104.001389</td>
    </tr>
    <tr>
      <th>2</th>
      <td>1973</td>
      <td>4.985445</td>
      <td>7.000000</td>
      <td>104.002778</td>
    </tr>
    <tr>
      <th>3</th>
      <td>1952</td>
      <td>4.833416</td>
      <td>7.000000</td>
      <td>104.004167</td>
    </tr>
    <tr>
      <th>4</th>
      <td>1928</td>
      <td>18.205908</td>
      <td>7.000000</td>
      <td>104.005556</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>42290776</th>
      <td>0</td>
      <td>0.000000</td>
      <td>23.998611</td>
      <td>113.994444</td>
    </tr>
    <tr>
      <th>42290777</th>
      <td>0</td>
      <td>0.000000</td>
      <td>23.998611</td>
      <td>113.995833</td>
    </tr>
    <tr>
      <th>42290778</th>
      <td>0</td>
      <td>0.000000</td>
      <td>23.998611</td>
      <td>113.997222</td>
    </tr>
    <tr>
      <th>42290779</th>
      <td>0</td>
      <td>0.000000</td>
      <td>23.998611</td>
      <td>113.998611</td>
    </tr>
    <tr>
      <th>42290780</th>
      <td>0</td>
      <td>0.000000</td>
      <td>23.998611</td>
      <td>114.000000</td>
    </tr>
  </tbody>
</table>
<p>42290781 rows × 4 columns</p>
</div>



### Mean altitude and Mean slope


```python
# Create a GeoDataFrame from the DataFrame 'df' with a specified CRS
gdf = gpd.GeoDataFrame(df_no_oceans, geometry=[Point(x, y) for x, y in zip(df_no_oceans.longitude, df_no_oceans.latitude)])
gdf.crs = grid.crs  # Set the CRS to WGS 84

# Calculate mean altitude and mean slope for each polygon
merged = gpd.sjoin(grid, gdf)
mean_data = merged.groupby('id').agg(mean_altitude=('altitude', 'mean'), mean_slope=('slope', 'mean')).reset_index()
merged_grid = pd.merge(grid, mean_data, on='id', how='left')
```


```python
# Save it
merged_grid.to_csv(output_dir / "mean_data_altitude_slope.csv", index=False)
```


```python
# How many datapoints per grid?
merged.groupby('id').count().rename({'Longitude': 'Data points'},axis=1)['Data points'].hist()
plt.xlabel('Altitude Datapoints')
plt.ylabel('Number of grid cells')
plt.show()
```



![png](04.0.1_topography_variables_files/04.0.1_topography_variables_30_0.png)



In the majority of cases, we have around 2200 datapoints per grid. In some cases (likely small islands) we have around 100 data points.


```python
# There's also no altitude information for some grid cells
nans_altitude = merged_grid[merged_grid.isna().any(axis=1)]
nans_altitude
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>id</th>
      <th>Longitude</th>
      <th>Latitude</th>
      <th>Centroid</th>
      <th>geometry</th>
      <th>mean_altitude</th>
      <th>mean_slope</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>2007</td>
      <td>102.15</td>
      <td>22.45</td>
      <td>102.15E_22.45N</td>
      <td>POLYGON ((102.10000 22.50000, 102.20000 22.500...</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2008</td>
      <td>102.15</td>
      <td>22.35</td>
      <td>102.15E_22.35N</td>
      <td>POLYGON ((102.10000 22.40000, 102.20000 22.400...</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2009</td>
      <td>102.15</td>
      <td>22.25</td>
      <td>102.15E_22.25N</td>
      <td>POLYGON ((102.10000 22.30000, 102.20000 22.300...</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>3</th>
      <td>2187</td>
      <td>102.25</td>
      <td>22.55</td>
      <td>102.25E_22.55N</td>
      <td>POLYGON ((102.20000 22.60000, 102.30000 22.600...</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>4</th>
      <td>2188</td>
      <td>102.25</td>
      <td>22.45</td>
      <td>102.25E_22.45N</td>
      <td>POLYGON ((102.20000 22.50000, 102.30000 22.500...</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>3574</th>
      <td>30180</td>
      <td>117.65</td>
      <td>10.65</td>
      <td>117.65E_10.65N</td>
      <td>POLYGON ((117.60000 10.70000, 117.70000 10.700...</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>3575</th>
      <td>30359</td>
      <td>117.75</td>
      <td>10.85</td>
      <td>117.75E_10.85N</td>
      <td>POLYGON ((117.70000 10.90000, 117.80000 10.900...</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>3576</th>
      <td>30360</td>
      <td>117.75</td>
      <td>10.75</td>
      <td>117.75E_10.75N</td>
      <td>POLYGON ((117.70000 10.80000, 117.80000 10.800...</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>3577</th>
      <td>30540</td>
      <td>117.85</td>
      <td>10.85</td>
      <td>117.85E_10.85N</td>
      <td>POLYGON ((117.80000 10.90000, 117.90000 10.900...</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>3578</th>
      <td>30541</td>
      <td>117.85</td>
      <td>10.75</td>
      <td>117.85E_10.75N</td>
      <td>POLYGON ((117.80000 10.80000, 117.90000 10.800...</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
  </tbody>
</table>
<p>956 rows × 7 columns</p>
</div>




```python
# Lets locate these points
fig, ax = plt.subplots(1,1, figsize=(10,6))
adm2_shp.plot(ax=ax, label='Vietnam')
nans_altitude.plot(ax=ax, color='red', label='No altitude data')

ax.set_xlabel('Longitude')
ax.set_ylabel('Latitude')

# Create proxy artists for the legend
blue_patch = plt.Line2D([0], [0], marker='.', color='w', label='Fiji', markersize=10, markerfacecolor='blue')
red_patch = plt.Line2D([0], [0], marker='s', color='w', label='No altitude data', markersize=10, markerfacecolor='red')

# Add the legend using the proxy artists
ax.legend(handles=[red_patch, blue_patch])
plt.show()
```



![png](04.0.1_topography_variables_files/04.0.1_topography_variables_33_0.png)



My hypothesis: the altitude dataset must consider those datapoints as ocean and, since we're droping <0 data, we are loosing those points. I propose to replace those values with 0s in altitude.

Some plots


```python
fig, ax = plt.subplots(1,2,figsize=(10,6))
adm2_shp.plot(ax=ax[0], color='red', alpha=0.5)
adm2_shp.plot(ax=ax[1], color='red', alpha=0.5)
gpd.GeoDataFrame(merged_grid.dropna(subset='mean_altitude')).plot(column='mean_altitude', legend=True, ax=ax[0])
gpd.GeoDataFrame(merged_grid.dropna(subset='mean_slope')).plot(column='mean_slope', legend=True, ax=ax[1])
ax[0].set_title('Mean altitude [m]')
ax[1].set_title('Mean slope [degree]')

plt.tight_layout()
plt.show()
```



![png](04.0.1_topography_variables_files/04.0.1_topography_variables_36_0.png)




```python
# Replace nans with 0
merged_grid_fix = merged_grid.fillna(0)
```


```python
fig, ax = plt.subplots(1,2, figsize=(10,6))
merged_grid_fix.mean_altitude.hist(ax=ax[0], bins=50)
ax[0].set_xlabel('Mean altitude [m]')
ax[0].set_ylabel('Frequency')
ax[0].set_title('Mean altitude in grids')

merged_grid_fix.mean_slope.hist(ax=ax[1], bins=50)
ax[1].set_xlabel('Mean slope [degree]')
ax[1].set_ylabel('Frequency')
ax[1].set_title('Mean slope in grids')

plt.tight_layout()
plt.show()
```



![png](04.0.1_topography_variables_files/04.0.1_topography_variables_38_0.png)



## With coast and Coast length


```python
# dissolving polygons into one land mass
dissolved_shp = adm2_shp.dissolve(by="ADM0_PCODE")

# Coastline
coastline = dissolved_shp.boundary
coastline.plot()
plt.show()
```



![png](04.0.1_topography_variables_files/04.0.1_topography_variables_40_0.png)




```python
coastline.crs = grid.crs
coastline
```




    ADM0_PCODE
    VN    MULTILINESTRING ((104.86295 8.41427, 104.86258...
    dtype: geometry




```python
# Linestrings and MultiLinestrings
grid_line_gdf = gpd.overlay(gpd.GeoDataFrame(coastline, geometry=coastline.geometry, crs=coastline.crs)
                .reset_index(),
                grid,
                how="intersection",
                )[["id", "Centroid", "geometry"]]
# Coast line
grid_line_gdf["coast_length"] = grid_line_gdf["geometry"].to_crs(25394).length #25394 gives me length in meters.
grid_coast = grid[["id", "Centroid"]].merge(grid_line_gdf, on=["id", "Centroid"], how="left")

# With coast? Binary
grid_coast["with_coast"] = np.where(grid_coast["coast_length"] > 0, 1, 0)
grid_coast["with_coast"].value_counts()
```




    with_coast
    0    2422
    1    1157
    Name: count, dtype: int64




```python
fig, ax = plt.subplots(1,2, figsize=(10,6))
ax[0] = grid_coast.with_coast.hist(ax=ax[0])
ax[0].set_xticks([0.05,0.95], ['No coast', 'With coast'])
ax[0].set_ylabel('Frequency')
ax[0].set_title('Grids with coasts')
ax[0].grid('off')

ax[1] = grid_coast.coast_length.fillna(0).hist(ax=ax[1])
ax[1].set_xlabel('Coast length [m]')
ax[1].set_ylabel('Frequency')
ax[1].set_title('Coast length per grid')


plt.tight_layout()
plt.show()
```



![png](04.0.1_topography_variables_files/04.0.1_topography_variables_43_0.png)



## Save it


```python
# Merge data
merge_final = df_slope_elev.merge(grid_coast, on='id', how='left')
merge_final = merge_final[['id','with_coast','coast_length','mean_elev','mean_slope']]
merge_final = merge_final.fillna(0) # No coast length? Then is 0
```


```python
merge_final
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>id</th>
      <th>with_coast</th>
      <th>coast_length</th>
      <th>mean_elev</th>
      <th>mean_slope</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>2007</td>
      <td>1</td>
      <td>9240.659348</td>
      <td>985.104826</td>
      <td>20.474829</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2008</td>
      <td>1</td>
      <td>18120.985665</td>
      <td>1276.734225</td>
      <td>21.390162</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2009</td>
      <td>1</td>
      <td>965.114251</td>
      <td>1162.446697</td>
      <td>21.541014</td>
    </tr>
    <tr>
      <th>3</th>
      <td>2187</td>
      <td>1</td>
      <td>5424.446827</td>
      <td>801.625901</td>
      <td>23.054955</td>
    </tr>
    <tr>
      <th>4</th>
      <td>2188</td>
      <td>1</td>
      <td>21703.068644</td>
      <td>1047.179465</td>
      <td>21.058342</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>3574</th>
      <td>30180</td>
      <td>1</td>
      <td>13130.384968</td>
      <td>0.000000</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>3575</th>
      <td>30359</td>
      <td>1</td>
      <td>5616.457618</td>
      <td>0.000000</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>3576</th>
      <td>30360</td>
      <td>1</td>
      <td>8188.877461</td>
      <td>0.000000</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>3577</th>
      <td>30540</td>
      <td>1</td>
      <td>8813.010041</td>
      <td>0.000000</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>3578</th>
      <td>30541</td>
      <td>1</td>
      <td>6328.547070</td>
      <td>0.000000</td>
      <td>0.000000</td>
    </tr>
  </tbody>
</table>
<p>3579 rows × 5 columns</p>
</div>




```python
merge_final.to_csv(output_dir / "topography_variables_bygrid_new.csv", index=False)
```


    The Kernel crashed while executing code in the the current cell or a previous cell. Please review the code in the cell(s) to identify a possible cause of the failure. Click <a href='https://aka.ms/vscodeJupyterKernelCrash'>here</a> for more info. View Jupyter <a href='command:jupyter.viewOutput'>log</a> for further details.
