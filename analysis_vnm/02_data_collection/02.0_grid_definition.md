```python
import os
from pathlib import Path
import geopandas as gpd
from shapely.geometry import Polygon
import numpy as np
import matplotlib.pyplot as plt
import pandas as pd
```


```python
input_dir = (
    Path(os.getenv("STORM_DATA_DIR"))
    / "analysis_vnm/02_model_features/02_housing_damage/input/"
)
output_dir = (
    Path(os.getenv("STORM_DATA_DIR"))
    / "analysis_vnm/02_model_features/02_housing_damage/output/"
)

# Load Vietnam
adm2_shp = gpd.read_file(
    input_dir / "adm2_shp_fixed.gpkg"
)
adm2_shp = adm2_shp.to_crs('EPSG:4326')
```

## Creation of grid


```python
# grid creation
xmin, xmax, ymin, ymax = 101, 118, 6, 24 # Vietnam extremes coordintates

cell_size = 0.1

cols = list(np.arange(xmin, xmax + cell_size, cell_size))
rows = list(np.arange(ymin, ymax + cell_size, cell_size))
rows.reverse()

polygons = [
    Polygon(
        [
            (x, y),
            (x + cell_size, y),
            (x + cell_size, y - cell_size),
            (x, y - cell_size),
        ]
    )
    for x in cols
    for y in rows
]
grid = gpd.GeoDataFrame({"geometry": polygons}, crs=adm2_shp.crs)
grid["id"] = grid.index + 1
grid.head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>geometry</th>
      <th>id</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>POLYGON ((101.00000 24.00000, 101.10000 24.000...</td>
      <td>1</td>
    </tr>
    <tr>
      <th>1</th>
      <td>POLYGON ((101.00000 23.90000, 101.10000 23.900...</td>
      <td>2</td>
    </tr>
    <tr>
      <th>2</th>
      <td>POLYGON ((101.00000 23.80000, 101.10000 23.800...</td>
      <td>3</td>
    </tr>
    <tr>
      <th>3</th>
      <td>POLYGON ((101.00000 23.70000, 101.10000 23.700...</td>
      <td>4</td>
    </tr>
    <tr>
      <th>4</th>
      <td>POLYGON ((101.00000 23.60000, 101.10000 23.600...</td>
      <td>5</td>
    </tr>
  </tbody>
</table>
</div>




```python
grid.loc[:, "geometry"].plot()
plt.show()
```



![png](02.0_grid_definition_files/02.0_grid_definition_4_0.png)




```python
# write as geopackage
grid.to_file(output_dir / "viet_0.1_degree_grid_new.gpkg", driver="GPKG")
```

## Creation of centroids


```python
# Extract lat and lon from the centerpoint
grid["Longitude"] = grid["geometry"].centroid.map(lambda p: p.x)
grid["Latitude"] = grid["geometry"].centroid.map(lambda p: p.y)
grid["Centroid"] = (
    round(grid["Longitude"], 2).astype(str)
    + "E"
    + "_"
    + +round(grid["Latitude"], 2).astype(str)
    + "N"
)
grid.head(5)
```

    /var/folders/dy/vms3cfrn4q9952h8s6l586dr0000gp/T/ipykernel_60663/3930163373.py:2: UserWarning: Geometry is in a geographic CRS. Results from 'centroid' are likely incorrect. Use 'GeoSeries.to_crs()' to re-project geometries to a projected CRS before this operation.

      grid["Longitude"] = grid["geometry"].centroid.map(lambda p: p.x)
    /var/folders/dy/vms3cfrn4q9952h8s6l586dr0000gp/T/ipykernel_60663/3930163373.py:3: UserWarning: Geometry is in a geographic CRS. Results from 'centroid' are likely incorrect. Use 'GeoSeries.to_crs()' to re-project geometries to a projected CRS before this operation.

      grid["Latitude"] = grid["geometry"].centroid.map(lambda p: p.y)





<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>geometry</th>
      <th>id</th>
      <th>Longitude</th>
      <th>Latitude</th>
      <th>Centroid</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>POLYGON ((101.00000 24.00000, 101.10000 24.000...</td>
      <td>1</td>
      <td>101.05</td>
      <td>23.95</td>
      <td>101.05E_23.95N</td>
    </tr>
    <tr>
      <th>1</th>
      <td>POLYGON ((101.00000 23.90000, 101.10000 23.900...</td>
      <td>2</td>
      <td>101.05</td>
      <td>23.85</td>
      <td>101.05E_23.85N</td>
    </tr>
    <tr>
      <th>2</th>
      <td>POLYGON ((101.00000 23.80000, 101.10000 23.800...</td>
      <td>3</td>
      <td>101.05</td>
      <td>23.75</td>
      <td>101.05E_23.75N</td>
    </tr>
    <tr>
      <th>3</th>
      <td>POLYGON ((101.00000 23.70000, 101.10000 23.700...</td>
      <td>4</td>
      <td>101.05</td>
      <td>23.65</td>
      <td>101.05E_23.65N</td>
    </tr>
    <tr>
      <th>4</th>
      <td>POLYGON ((101.00000 23.60000, 101.10000 23.600...</td>
      <td>5</td>
      <td>101.05</td>
      <td>23.55</td>
      <td>101.05E_23.55N</td>
    </tr>
  </tbody>
</table>
</div>




```python
# Centroids
grid_centroids = grid.copy()
grid_centroids["geometry"] = grid_centroids["geometry"].centroid
grid_centroids.loc[:, "geometry"].plot()
plt.show()
```

    /var/folders/dy/vms3cfrn4q9952h8s6l586dr0000gp/T/ipykernel_60663/3027722353.py:3: UserWarning: Geometry is in a geographic CRS. Results from 'centroid' are likely incorrect. Use 'GeoSeries.to_crs()' to re-project geometries to a projected CRS before this operation.

      grid_centroids["geometry"] = grid_centroids["geometry"].centroid




![png](02.0_grid_definition_files/02.0_grid_definition_8_1.png)




```python
# write as geopackage
grid_centroids.to_file(
    output_dir / "viet_0.1_degree_grid_centroids_new.gpkg", driver="GPKG"
)
```

## Intersection of grid and admin shapefile


```python
# intersection of grid and shapefile
adm2_grid_intersection = gpd.overlay(adm2_shp, grid, how="identity")
adm2_grid_intersection.loc[:, "geometry"].plot()
plt.axis([xmin, xmax, ymin, ymax])

plt.show()
```



![png](02.0_grid_definition_files/02.0_grid_definition_11_0.png)




```python
adm2_grid_intersection = adm2_grid_intersection.dropna(subset=["id"])
```


```python
adm2_grid_intersection.to_file(
    input_dir / "viet_adm2_grid_intersection_new.gpkg", driver="GPKG"
)
```

### Grid-land overlap


```python
grid_land_overlap = grid.loc[grid["id"].isin(adm2_grid_intersection["id"])]
```


```python
grid_land_overlap
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>geometry</th>
      <th>id</th>
      <th>Longitude</th>
      <th>Latitude</th>
      <th>Centroid</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2006</th>
      <td>POLYGON ((102.10000 22.50000, 102.20000 22.500...</td>
      <td>2007</td>
      <td>102.15</td>
      <td>22.45</td>
      <td>102.15E_22.45N</td>
    </tr>
    <tr>
      <th>2007</th>
      <td>POLYGON ((102.10000 22.40000, 102.20000 22.400...</td>
      <td>2008</td>
      <td>102.15</td>
      <td>22.35</td>
      <td>102.15E_22.35N</td>
    </tr>
    <tr>
      <th>2008</th>
      <td>POLYGON ((102.10000 22.30000, 102.20000 22.300...</td>
      <td>2009</td>
      <td>102.15</td>
      <td>22.25</td>
      <td>102.15E_22.25N</td>
    </tr>
    <tr>
      <th>2186</th>
      <td>POLYGON ((102.20000 22.60000, 102.30000 22.600...</td>
      <td>2187</td>
      <td>102.25</td>
      <td>22.55</td>
      <td>102.25E_22.55N</td>
    </tr>
    <tr>
      <th>2187</th>
      <td>POLYGON ((102.20000 22.50000, 102.30000 22.500...</td>
      <td>2188</td>
      <td>102.25</td>
      <td>22.45</td>
      <td>102.25E_22.45N</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>30179</th>
      <td>POLYGON ((117.60000 10.70000, 117.70000 10.700...</td>
      <td>30180</td>
      <td>117.65</td>
      <td>10.65</td>
      <td>117.65E_10.65N</td>
    </tr>
    <tr>
      <th>30358</th>
      <td>POLYGON ((117.70000 10.90000, 117.80000 10.900...</td>
      <td>30359</td>
      <td>117.75</td>
      <td>10.85</td>
      <td>117.75E_10.85N</td>
    </tr>
    <tr>
      <th>30359</th>
      <td>POLYGON ((117.70000 10.80000, 117.80000 10.800...</td>
      <td>30360</td>
      <td>117.75</td>
      <td>10.75</td>
      <td>117.75E_10.75N</td>
    </tr>
    <tr>
      <th>30539</th>
      <td>POLYGON ((117.80000 10.90000, 117.90000 10.900...</td>
      <td>30540</td>
      <td>117.85</td>
      <td>10.85</td>
      <td>117.85E_10.85N</td>
    </tr>
    <tr>
      <th>30540</th>
      <td>POLYGON ((117.80000 10.80000, 117.90000 10.800...</td>
      <td>30541</td>
      <td>117.85</td>
      <td>10.75</td>
      <td>117.85E_10.75N</td>
    </tr>
  </tbody>
</table>
<p>3579 rows Ã— 5 columns</p>
</div>




```python
grid_land_overlap.to_file(
    output_dir / "viet_0.1_degree_grid_land_overlap_new.gpkg", driver="GPKG"
)
```


```python
grid_land_overlap_centroids = grid_centroids.loc[
    grid["id"].isin(adm2_grid_intersection["id"])
]
```


```python
grid_land_overlap_centroids.to_file(
    output_dir / "viet_0.1_degree_grid_centroids_land_overlap_new.gpkg",
    driver="GPKG",
)
```


```python
grid_land_overlap.plot()
plt.xlabel('Latitude')
plt.ylabel('Longitude')
plt.title('VIETNAM')

plt.show()

```



![png](02.0_grid_definition_files/02.0_grid_definition_20_0.png)



### Grids per municipality


```python
grid_muni = gpd.sjoin(adm2_shp, grid_land_overlap, how='inner')
grid_muni = grid_muni.drop_duplicates(subset=['id'])

region_grid_muni = grid_muni[['id', 'region']].groupby(by='region').count().rename({'id':'grid_cells'}, axis=1).sort_values('grid_cells', ascending=False)
admin1_grid_muni = grid_muni[['id', 'ADM1_EN']].groupby(by='ADM1_EN').count().rename({'id':'grid_cells'}, axis=1).sort_values('grid_cells', ascending=False)

```


```python
fig, ax = plt.subplots(1,2, figsize=(15,6), gridspec_kw={'width_ratios': [2, 3]})
admin1_grid_muni.plot.bar(rot=90, legend=False, ax=ax[0])
ax[0].set_xlabel('')
ax[0].set_ylabel('Grid cells')
ax[0].set_title('Admin 1 provinces')

region_grid_muni.plot.bar(rot=90, legend=False, ax=ax[1])
ax[1].set_xlabel('')
ax[1].set_ylabel('Grid cells')
ax[1].set_title('Regions')

plt.tight_layout()
plt.show()
```



![png](02.0_grid_definition_files/02.0_grid_definition_23_0.png)




```python
grid_muni[['id', 'ADM1_EN', 'ADM1_PCODE', 'region']].to_csv(
    input_dir / "grid_municipality_info.csv", index=False
)
```
