# Notebook that reads in GPM rainfall data and extracts data for cells in Fiji


```python
# libraries
import pandas as pd
import numpy as np
import os
import geopandas as gpd
import rasterio
from rasterstats import zonal_stats
from pathlib import Path
```


```python
# Setting directory
input_dir = (
    Path(os.getenv("STORM_DATA_DIR"))
    / "analysis_vnm/02_model_features/03_rainfall/input"
)

output_dir = (
    Path(os.getenv("STORM_DATA_DIR"))
    / "analysis_vnm/02_model_features/03_rainfall/output"
)

grid_input = (
    Path(os.getenv("STORM_DATA_DIR"))
    / "analysis_vnm/02_model_features/02_housing_damage/output/"
)

# Load grid
grid_land_overlap = gpd.read_file(grid_input / "viet_0.1_degree_grid_land_overlap_new.gpkg")
grid_land_overlap["id"] = grid_land_overlap["id"].astype(int)
grid = grid_land_overlap.copy()

# gpm data
gpm_file_name = "gpm_data/rainfall_data/output_hhr/"
gpm_folder_path = Path(input_dir, gpm_file_name)
typhoon_list = os.listdir(gpm_folder_path)

# outputs
processed_output_dir = Path(
    input_dir / "gpm_data/rainfall_data/output_hhr_processed/"
)
processed_output_dir.mkdir(parents=True, exist_ok=True)

```

### Selecting particular typhoons

Check if every typhoon in the housing damage dataset is in rainfall data


```python
len(typhoon_list)
```




    37



### Testing raster method


```python
# Testing the raster stats method
day_list = os.listdir(gpm_folder_path / typhoon_list[1] / "GPM")
file_list = os.listdir(gpm_folder_path / typhoon_list[1] / "GPM" / day_list[0])
file = Path(
    gpm_folder_path / typhoon_list[1] / "GPM" / day_list[0] / file_list[0]
)
input_raster = rasterio.open(file)
array = input_raster.read(1)
# checking if crs are the same
input_raster.crs == grid.crs
```




    True




```python
# Check this
input_raster.bounds
```




    BoundingBox(left=-180.0, bottom=-90.00000268220901, right=180.00000536441803, top=90.0)




```python
grid_transformed = grid.copy()
# computing stats for 4 adjacent cells
summary_stats = zonal_stats(
    grid_transformed,
    array,
    stats=["min", "max", "mean", "std"],
    nodata=29999,
    all_touched=True,
    affine=input_raster.transform,
)
grid_stats = pd.DataFrame(summary_stats)

grid_stats
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>min</th>
      <th>max</th>
      <th>mean</th>
      <th>std</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>3574</th>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>3575</th>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>3576</th>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>3577</th>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>3578</th>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
  </tbody>
</table>
<p>3579 rows Ã— 4 columns</p>
</div>



### Looping over typhoons

This section takes a very long time to process.


```python
typhoon_list.remove('.DS_Store')
```


```python
typhoon_list[16] #Problems here! --no data
```




    'LINDA1997'




```python
# setting up loop for running through all typhoons
# extracting the max and mean of the 4 adjacent cells due to shifting to grids
stats_list = ["mean", "max"]
j=34
for typ in typhoon_list[j:]:
    print(typ, j)
    j+=1
    day_list = os.listdir(gpm_folder_path / typ / "GPM")
    if '.DS_Store' in day_list: # Sometimes this causes problems
        day_list.remove('.DS_Store')
    day_df = pd.DataFrame()
    for day in day_list:
        file_list = os.listdir(gpm_folder_path / typ / "GPM" / day)
        file_df = pd.DataFrame()
        for file in file_list:
            if file.startswith("3B-HHR"):
                file_path = Path(gpm_folder_path / typ / "GPM" / day / file)
                input_raster = rasterio.open(file_path)
                array = input_raster.read(1)
                summary_stats = zonal_stats(
                    grid_transformed,
                    array,
                    stats=stats_list,
                    nodata=29999,
                    all_touched=True,
                    affine=input_raster.transform,
                )
                grid_stats = pd.DataFrame(summary_stats)
                # change values by dividing by 10 to mm/hr
                grid_stats[stats_list] /= 10
                grid_merged = pd.merge(
                    grid.drop(["geometry", "Longitude", "Latitude"], axis=1),
                    grid_stats,
                    left_index=True,
                    right_index=True,
                )
                grid_merged["start"] = "%s%s:%s%s:%s%s" % (
                    *file.split("-S")[1][0:6],
                )
                grid_merged["end"] = "%s%s:%s%s:%s%s" % (
                    *file.split("-E")[1][0:6],
                )

                file_df = pd.concat([file_df, grid_merged], axis=0)
        file_df["date"] = str(day)
        day_df = pd.concat([day_df, file_df], axis=0)
    day_df["time"] = day_df["date"].astype(str) + "_" + day_df["start"]
    for stats in stats_list:
        day_wide = pd.pivot(
            day_df,
            index=["id", "Centroid"],
            columns=["time"],
            values=[stats],
        )
        day_wide.columns = day_wide.columns.droplevel(0)
        day_wide.reset_index(inplace=True)
        day_wide.to_csv(
            processed_output_dir / str(typ + "_gridstats_" + stats + ".csv"),
            index=False,
        )
```

    WUTIP2013 34
    KETSANA2009 35
