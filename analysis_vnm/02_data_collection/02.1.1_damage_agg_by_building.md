```python
from pathlib import Path
import os

from shapely.geometry import LineString,Polygon, MultiPolygon
import geopandas as gpd
import numpy as np
import pandas as pd
import xarray as xr
import re
import matplotlib.pyplot as plt
from matplotlib.patches import Patch
from matplotlib.lines import Line2D
from scipy import stats
```


```python
input_dir = (
    Path(os.getenv("STORM_DATA_DIR"))
    / "analysis_vnm/02_model_features/02_housing_damage/input/"
)
output_dir = (
    Path(os.getenv("STORM_DATA_DIR"))
    / "analysis_vnm/02_model_features/02_housing_damage/output/"
)

# Load Vietnam
vietnam = gpd.read_file(input_dir / "adm2_shp_fixed.gpkg")
vietnam = vietnam.to_crs('EPSG:4326')

# Load grid
grid_land_overlap = gpd.read_file(output_dir / "viet_0.1_degree_grid_land_overlap_new.gpkg")
grid_land_overlap["id"] = grid_land_overlap["id"].astype(int)

# Load grids per Municipality
ids_mun = pd.read_csv(input_dir / "grid_municipality_info.csv")

# Load damage data
damage_data = pd.read_csv(input_dir / "viet_damage_adm1_level.csv")
```

## Building locations


```python
gpd_bld = gpd.read_file(
    input_dir / "hotosm_vnm_buildings_polygons_shp.zip"
)
```

## Types of buildings


```python
# Type of buildings

bld = gpd_bld.building.copy()
fig, ax = plt.subplots(1,1)
ax.hist(bld, bins=50)
ax.set_xticklabels(ax.get_xticklabels(), rotation=90, size=8)

plt.show()
```

    /var/folders/dy/vms3cfrn4q9952h8s6l586dr0000gp/T/ipykernel_74236/1838646646.py:6: UserWarning: set_ticklabels() should only be used with a fixed number of ticks, i.e. after set_ticks() or using a FixedLocator.
      ax.set_xticklabels(ax.get_xticklabels(), rotation=90, size=8)




![png](02.1.1_damage_agg_by_building_files/02.1.1_damage_agg_by_building_5_1.png)



We just have information about if there are buildings in a location and in some cases, if that builing is a house or any other type of construction

### Map of building location


```python
# Plot builing loc over map
fig, ax = plt.subplots(1,1)

vietnam.plot(ax=ax, color='gray', edgecolor='gray', label='Fiji')
gpd_bld.plot(ax=ax, color='red', markersize=10, label='Buildings')
ax.set_xlabel('Longitude')
ax.set_ylabel('Latitude')
ax.set_title('Vietnam builings locations')
# Manually create the legend
legend_elements = [
    Line2D([0], [0], marker='o', color='w', markerfacecolor='red', markersize=10, label='Buildings'),
    Patch(color='gray', label='Vietnam')
]

ax.legend(handles=legend_elements, loc='upper left')

plt.show()
```



![png](02.1.1_damage_agg_by_building_files/02.1.1_damage_agg_by_building_8_0.png)



### Buildings to grid cells


```python
# Centroids
bld_centroids = gpd_bld.copy()
bld_centroids["geometry"] = bld_centroids["geometry"].centroid
```

    /var/folders/dy/vms3cfrn4q9952h8s6l586dr0000gp/T/ipykernel_74236/718215978.py:3: UserWarning: Geometry is in a geographic CRS. Results from 'centroid' are likely incorrect. Use 'GeoSeries.to_crs()' to re-project geometries to a projected CRS before this operation.

      bld_centroids["geometry"] = bld_centroids["geometry"].centroid



```python
# Buildings count per grid
bld_centroid_grid_count = grid_land_overlap.merge(
    grid_land_overlap.sjoin(bld_centroids, how="left")
    .groupby("id")
    .count()
    .building.rename("numbuildings")
    .reset_index()
)
```


```python
# Keep the maximum value of numbuildings
viet_bld_centroid_grid_count = bld_centroid_grid_count.groupby(['id', 'Longitude', 'Latitude', 'Centroid', 'geometry'], as_index=False)['numbuildings'].max()
viet_bld_centroid_grid_count.sort_values('numbuildings', ascending=False)
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>id</th>
      <th>Longitude</th>
      <th>Latitude</th>
      <th>Centroid</th>
      <th>geometry</th>
      <th>numbuildings</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1306</th>
      <td>8647</td>
      <td>105.75</td>
      <td>10.05</td>
      <td>105.75E_10.05N</td>
      <td>POLYGON ((105.70000 10.10000, 105.80000 10.100...</td>
      <td>54064</td>
    </tr>
    <tr>
      <th>2814</th>
      <td>13295</td>
      <td>108.35</td>
      <td>15.85</td>
      <td>108.35E_15.85N</td>
      <td>POLYGON ((108.30000 15.90000, 108.40000 15.900...</td>
      <td>50460</td>
    </tr>
    <tr>
      <th>3010</th>
      <td>14026</td>
      <td>108.75</td>
      <td>15.15</td>
      <td>108.75E_15.15N</td>
      <td>POLYGON ((108.70000 15.20000, 108.80000 15.200...</td>
      <td>49136</td>
    </tr>
    <tr>
      <th>1968</th>
      <td>10449</td>
      <td>106.75</td>
      <td>10.85</td>
      <td>106.75E_10.85N</td>
      <td>POLYGON ((106.70000 10.90000, 106.80000 10.900...</td>
      <td>43419</td>
    </tr>
    <tr>
      <th>3054</th>
      <td>14207</td>
      <td>108.85</td>
      <td>15.15</td>
      <td>108.85E_15.15N</td>
      <td>POLYGON ((108.80000 15.20000, 108.90000 15.200...</td>
      <td>33339</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>1251</th>
      <td>8526</td>
      <td>105.75</td>
      <td>22.15</td>
      <td>105.75E_22.15N</td>
      <td>POLYGON ((105.70000 22.20000, 105.80000 22.200...</td>
      <td>0</td>
    </tr>
    <tr>
      <th>1252</th>
      <td>8527</td>
      <td>105.75</td>
      <td>22.05</td>
      <td>105.75E_22.05N</td>
      <td>POLYGON ((105.70000 22.10000, 105.80000 22.100...</td>
      <td>0</td>
    </tr>
    <tr>
      <th>1253</th>
      <td>8528</td>
      <td>105.75</td>
      <td>21.95</td>
      <td>105.75E_21.95N</td>
      <td>POLYGON ((105.70000 22.00000, 105.80000 22.000...</td>
      <td>0</td>
    </tr>
    <tr>
      <th>1254</th>
      <td>8529</td>
      <td>105.75</td>
      <td>21.85</td>
      <td>105.75E_21.85N</td>
      <td>POLYGON ((105.70000 21.90000, 105.80000 21.900...</td>
      <td>0</td>
    </tr>
    <tr>
      <th>3578</th>
      <td>30541</td>
      <td>117.85</td>
      <td>10.75</td>
      <td>117.85E_10.75N</td>
      <td>POLYGON ((117.80000 10.80000, 117.90000 10.800...</td>
      <td>0</td>
    </tr>
  </tbody>
</table>
<p>3579 rows × 6 columns</p>
</div>




```python
viet_bld_centroid_grid_count.to_csv('numbuildings_per_grid.csv')
```

### Distribution of total houses per grid cell


```python
viet_bld_centroid_grid_count[viet_bld_centroid_grid_count.numbuildings !=0]
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>id</th>
      <th>Longitude</th>
      <th>Latitude</th>
      <th>Centroid</th>
      <th>geometry</th>
      <th>numbuildings</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>2007</td>
      <td>102.15</td>
      <td>22.45</td>
      <td>102.15E_22.45N</td>
      <td>POLYGON ((102.10000 22.50000, 102.20000 22.500...</td>
      <td>23</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2008</td>
      <td>102.15</td>
      <td>22.35</td>
      <td>102.15E_22.35N</td>
      <td>POLYGON ((102.10000 22.40000, 102.20000 22.400...</td>
      <td>1</td>
    </tr>
    <tr>
      <th>5</th>
      <td>2189</td>
      <td>102.25</td>
      <td>22.35</td>
      <td>102.25E_22.35N</td>
      <td>POLYGON ((102.20000 22.40000, 102.30000 22.400...</td>
      <td>37</td>
    </tr>
    <tr>
      <th>8</th>
      <td>2368</td>
      <td>102.35</td>
      <td>22.55</td>
      <td>102.35E_22.55N</td>
      <td>POLYGON ((102.30000 22.60000, 102.40000 22.600...</td>
      <td>1</td>
    </tr>
    <tr>
      <th>10</th>
      <td>2370</td>
      <td>102.35</td>
      <td>22.35</td>
      <td>102.35E_22.35N</td>
      <td>POLYGON ((102.30000 22.40000, 102.40000 22.400...</td>
      <td>21</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>3390</th>
      <td>23308</td>
      <td>113.85</td>
      <td>10.05</td>
      <td>113.85E_10.05N</td>
      <td>POLYGON ((113.80000 10.10000, 113.90000 10.100...</td>
      <td>9</td>
    </tr>
    <tr>
      <th>3400</th>
      <td>23501</td>
      <td>113.95</td>
      <td>8.85</td>
      <td>113.95E_8.85N</td>
      <td>POLYGON ((113.90000 8.90000, 114.00000 8.90000...</td>
      <td>4</td>
    </tr>
    <tr>
      <th>3409</th>
      <td>23683</td>
      <td>114.05</td>
      <td>8.75</td>
      <td>114.05E_8.75N</td>
      <td>POLYGON ((114.00000 8.80000, 114.10000 8.80000...</td>
      <td>2</td>
    </tr>
    <tr>
      <th>3418</th>
      <td>23864</td>
      <td>114.15</td>
      <td>8.75</td>
      <td>114.15E_8.75N</td>
      <td>POLYGON ((114.10000 8.80000, 114.20000 8.80000...</td>
      <td>1</td>
    </tr>
    <tr>
      <th>3468</th>
      <td>24768</td>
      <td>114.65</td>
      <td>8.85</td>
      <td>114.65E_8.85N</td>
      <td>POLYGON ((114.60000 8.90000, 114.70000 8.90000...</td>
      <td>3</td>
    </tr>
  </tbody>
</table>
<p>1558 rows × 6 columns</p>
</div>




```python
build_per_grid = viet_bld_centroid_grid_count.numbuildings
#plt.hist(build_per_grid, bins=50)
hist = np.histogram(build_per_grid, bins=10 ** np.linspace(0, np.log10(10**4), len(build_per_grid)), density=True)
x = hist[1][:-1]
y = hist[0]

plt.plot(x,y, 'ro', alpha=0.4, label='Buildings')
plt.xscale('log')
plt.yscale('log')

plt.xlabel('Buildings per grid cell')
plt.ylabel('PDF')

q25 = np.quantile(build_per_grid, 0.25)
q50 = np.quantile(build_per_grid, 0.50)
mode = stats.mode(build_per_grid).mode

# Add text boxes with annotations
plt.text(0.7, 0.9, f'Quantile 25: {q25:.2f}', transform=plt.gca().transAxes)
plt.text(0.7, 0.85, f'Quantile 50: {q50:.2f}', transform=plt.gca().transAxes)
plt.text(0.7, 0.8, f'Mode: {mode:.2f}', transform=plt.gca().transAxes)

plt.show()
```



![png](02.1.1_damage_agg_by_building_files/02.1.1_damage_agg_by_building_16_0.png)




```python
# Save it
buildings_by_grid = viet_bld_centroid_grid_count[['id','numbuildings']]
buildings_by_grid.to_csv(output_dir / "num_building_bygrid.csv")
```

### Building damage to grid


```python
# Municipalities by id
mun_dict = ids_mun[['id', 'ADM1_EN']].groupby(by='ADM1_EN').groups
muns =  mun_dict.keys()
ids = []
for m in muns:
    ids.append(ids_mun.iloc[mun_dict[m].values].id)
df_muns = pd.DataFrame({'Municipality': muns, 'ids':ids})
provinces_exploded = df_muns.explode('ids')

# Regions by id
region_dict = ids_mun[['id', 'region']].groupby(by='region').groups
regions =  region_dict.keys()
ids = []
for r in regions:
    ids.append(ids_mun.iloc[region_dict[r].values].id)
df_regions = pd.DataFrame({'Region': regions, 'ids':ids})
regions_exploded = df_regions.explode('ids')

```


```python
# Some checks
print(len(set(ids_mun.sort_values('id').id.unique()) & set(viet_bld_centroid_grid_count.id.unique())))
print(len(set(provinces_exploded.sort_values('ids').ids.unique()) & set(viet_bld_centroid_grid_count.id.unique())))
```

    3579
    3579



```python
# Assign municipality to viet_bld_centroid_grid_count
bld_grid_mun = viet_bld_centroid_grid_count.merge(provinces_exploded, left_on='id', right_on='ids', how='inner')[['id', 'Municipality', 'numbuildings']]

# Assign region to viet_bld_centroid_grid_count
bld_grid_region = viet_bld_centroid_grid_count.merge(regions_exploded, left_on='id', right_on='ids', how='inner')[['id', 'Region', 'numbuildings']]


bld_grid_region.sort_values('numbuildings', ascending=False)
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>id</th>
      <th>Region</th>
      <th>numbuildings</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1306</th>
      <td>8647</td>
      <td>MD</td>
      <td>54064</td>
    </tr>
    <tr>
      <th>2814</th>
      <td>13295</td>
      <td>SC</td>
      <td>50460</td>
    </tr>
    <tr>
      <th>3010</th>
      <td>14026</td>
      <td>SC</td>
      <td>49136</td>
    </tr>
    <tr>
      <th>1968</th>
      <td>10449</td>
      <td>SE</td>
      <td>43419</td>
    </tr>
    <tr>
      <th>3054</th>
      <td>14207</td>
      <td>SC</td>
      <td>33339</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>1251</th>
      <td>8526</td>
      <td>NE</td>
      <td>0</td>
    </tr>
    <tr>
      <th>1252</th>
      <td>8527</td>
      <td>NE</td>
      <td>0</td>
    </tr>
    <tr>
      <th>1253</th>
      <td>8528</td>
      <td>NE</td>
      <td>0</td>
    </tr>
    <tr>
      <th>1254</th>
      <td>8529</td>
      <td>NE</td>
      <td>0</td>
    </tr>
    <tr>
      <th>3578</th>
      <td>30541</td>
      <td>SC</td>
      <td>0</td>
    </tr>
  </tbody>
</table>
<p>3579 rows × 3 columns</p>
</div>




```python
# Because I can: builings by Municipality

df_aux = bld_grid_mun.groupby('Municipality').sum().sort_values(by='numbuildings', ascending=False)
df_aux2 = bld_grid_region.groupby('Region').sum().sort_values(by='numbuildings', ascending=False)

plt.figure(figsize=(12, 6))
plt.bar(df_aux.index, df_aux['numbuildings'])
plt.ylabel('Number of Buildings')
plt.title('Number of Buildings by Province')
plt.xticks(rotation=90)
plt.show()

plt.figure(figsize=(12, 6))
plt.bar(df_aux2.index, df_aux2['numbuildings'])
plt.ylabel('Number of Buildings')
plt.title('Number of Buildings by Region')
plt.xticks(rotation=90)
plt.show()
```



![png](02.1.1_damage_agg_by_building_files/02.1.1_damage_agg_by_building_22_0.png)





![png](02.1.1_damage_agg_by_building_files/02.1.1_damage_agg_by_building_22_1.png)



Since I have multiple regions affected by a single typhoon but just une quantity of damage, at the end I have damage not even at region level, but at a bigger scale (damage at a set of regions level). This is bad but is what we have, and all the calculous that we do have to take this into account.


```python
# Total number of buildings per region
total_bld_reg = bld_grid_region.groupby('Region').sum()['numbuildings'].reset_index(drop=False)
bld_grid_reg_merged = bld_grid_region.merge(total_bld_reg, on='Region', how='left')
#bld_grid_reg_merged['frac_bld'] = bld_grid_reg_merged['numbuildings_x'] / bld_grid_reg_merged['numbuildings_y']
```


```python
import ast

damage_data['region_affected'] = damage_data['region_affected'].astype('str').apply(ast.literal_eval)
damage_data_exploded = damage_data.explode('region_affected')
bld_damage_merged = damage_data_exploded.merge(bld_grid_reg_merged, left_on='region_affected', right_on='Region')
```


```python
bld_damage_merged_total = pd.DataFrame()
bld_dmg_aux = bld_damage_merged.drop_duplicates(['typhoon_name', 'Year'])
for typhoon, year in zip(bld_dmg_aux['typhoon_name'], bld_dmg_aux['Year']):
    bld_damage_merged_set_regions = bld_damage_merged.loc[(bld_damage_merged.typhoon_name == typhoon) & (bld_damage_merged.Year == year)].copy()
    # Total number of buildings in the set of regions
    bld_damage_merged_set_regions['numbuildings_z'] = bld_damage_merged_set_regions.numbuildings_y.unique().sum()
    # Density of buildings per cell for every typhoon
    bld_damage_merged_set_regions['frac_bld'] = bld_damage_merged_set_regions['numbuildings_x'] / bld_damage_merged_set_regions['numbuildings_z']
    # Create percentage of damage per grid cell
    bld_damage_merged_set_regions['perc_dmg_grid'] = bld_damage_merged_set_regions['frac_bld'] * bld_damage_merged_set_regions['total_bld_dmg'] * 100 / bld_damage_merged_set_regions['numbuildings_z']

    bld_damage_merged_total = pd.concat([bld_damage_merged_total, bld_damage_merged_set_regions])
```

### Save % of damage per grid cell


```python
bld_damage_merged_total
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>typhoon_name</th>
      <th>Year</th>
      <th>total_bld_dmg</th>
      <th>region_affected</th>
      <th>id</th>
      <th>Region</th>
      <th>numbuildings_x</th>
      <th>numbuildings_y</th>
      <th>numbuildings_z</th>
      <th>frac_bld</th>
      <th>perc_dmg_grid</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Linda</td>
      <td>1997</td>
      <td>216054.0</td>
      <td>MD</td>
      <td>3948</td>
      <td>MD</td>
      <td>0</td>
      <td>99458</td>
      <td>99458</td>
      <td>0.000000</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Linda</td>
      <td>1997</td>
      <td>216054.0</td>
      <td>MD</td>
      <td>3949</td>
      <td>MD</td>
      <td>0</td>
      <td>99458</td>
      <td>99458</td>
      <td>0.000000</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>2</th>
      <td>Linda</td>
      <td>1997</td>
      <td>216054.0</td>
      <td>MD</td>
      <td>4129</td>
      <td>MD</td>
      <td>0</td>
      <td>99458</td>
      <td>99458</td>
      <td>0.000000</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>3</th>
      <td>Linda</td>
      <td>1997</td>
      <td>216054.0</td>
      <td>MD</td>
      <td>4130</td>
      <td>MD</td>
      <td>0</td>
      <td>99458</td>
      <td>99458</td>
      <td>0.000000</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>4</th>
      <td>Linda</td>
      <td>1997</td>
      <td>216054.0</td>
      <td>MD</td>
      <td>5205</td>
      <td>MD</td>
      <td>236</td>
      <td>99458</td>
      <td>99458</td>
      <td>0.002373</td>
      <td>0.515460</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>41948</th>
      <td>Matmo</td>
      <td>2019</td>
      <td>1486.0</td>
      <td>C</td>
      <td>14233</td>
      <td>C</td>
      <td>135</td>
      <td>35102</td>
      <td>358660</td>
      <td>0.000376</td>
      <td>0.000156</td>
    </tr>
    <tr>
      <th>41949</th>
      <td>Matmo</td>
      <td>2019</td>
      <td>1486.0</td>
      <td>C</td>
      <td>14234</td>
      <td>C</td>
      <td>0</td>
      <td>35102</td>
      <td>358660</td>
      <td>0.000000</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>41950</th>
      <td>Matmo</td>
      <td>2019</td>
      <td>1486.0</td>
      <td>C</td>
      <td>14411</td>
      <td>C</td>
      <td>1</td>
      <td>35102</td>
      <td>358660</td>
      <td>0.000003</td>
      <td>0.000001</td>
    </tr>
    <tr>
      <th>41951</th>
      <td>Matmo</td>
      <td>2019</td>
      <td>1486.0</td>
      <td>C</td>
      <td>14412</td>
      <td>C</td>
      <td>0</td>
      <td>35102</td>
      <td>358660</td>
      <td>0.000000</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>41952</th>
      <td>Matmo</td>
      <td>2019</td>
      <td>1486.0</td>
      <td>C</td>
      <td>14413</td>
      <td>C</td>
      <td>0</td>
      <td>35102</td>
      <td>358660</td>
      <td>0.000000</td>
      <td>0.000000</td>
    </tr>
  </tbody>
</table>
<p>43851 rows × 11 columns</p>
</div>




```python
bld_damage_merged_total.to_csv(output_dir / "building_damage_bygrid_new.csv")
```
