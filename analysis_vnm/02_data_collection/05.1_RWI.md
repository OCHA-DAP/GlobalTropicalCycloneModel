```python
import pandas as pd
import geopandas as gpd
from pathlib import Path
import matplotlib.pyplot as plt
import os
```


```python
base_dir = Path(os.getenv("STORM_DATA_DIR")) / "analysis_vnm/02_model_features/"
input_dir = base_dir / "05_vulnerability/input/"
shp_input_dir = base_dir / "02_housing_damage/output/"
output_dir = base_dir / "05_vulnerability/output/"

# Load ids of municipalities
ids_mun = pd.read_csv(base_dir / "02_housing_damage/input/grid_municipality_info.csv")

# Load grids
grid = gpd.read_file(base_dir / "02_housing_damage/output/viet_0.1_degree_grid_land_overlap_new.gpkg")

# Load IWI
iwi = pd.read_csv(output_dir / "viet_iwi_bygrid_new.csv")

# Load RWI
rwi = pd.read_csv(input_dir / "vnm_relative_wealth_index.csv")
```

### RWI by grid


```python
# creating a geometry column for the point data
viet_rwi_gdf = gpd.GeoDataFrame(
    rwi, geometry=gpd.points_from_xy(rwi.longitude, rwi.latitude)
)
```


```python
viet_rwi_gdf.plot(column='rwi')
plt.show()
```



![png](05.1_RWI_files/05.1_RWI_4_0.png)



We have some missing values... we replace them with the mean of the rwi at country level


```python
viet_rwi_gdf.crs = grid.crs
grid_rwi_gdf = gpd.tools.sjoin(viet_rwi_gdf, grid, how="right")
grid_rwi_gdf.head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>index_left</th>
      <th>latitude</th>
      <th>longitude</th>
      <th>rwi</th>
      <th>error</th>
      <th>id</th>
      <th>Longitude</th>
      <th>Latitude</th>
      <th>Centroid</th>
      <th>geometry</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>22408.0</td>
      <td>22.421184</td>
      <td>102.183838</td>
      <td>0.881</td>
      <td>0.453</td>
      <td>2007</td>
      <td>102.15</td>
      <td>22.45</td>
      <td>102.15E_22.45N</td>
      <td>POLYGON ((102.10000 22.50000, 102.20000 22.500...</td>
    </tr>
    <tr>
      <th>0</th>
      <td>28116.0</td>
      <td>22.421184</td>
      <td>102.161865</td>
      <td>-0.139</td>
      <td>0.409</td>
      <td>2007</td>
      <td>102.15</td>
      <td>22.45</td>
      <td>102.15E_22.45N</td>
      <td>POLYGON ((102.10000 22.50000, 102.20000 22.500...</td>
    </tr>
    <tr>
      <th>1</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>2008</td>
      <td>102.15</td>
      <td>22.35</td>
      <td>102.15E_22.35N</td>
      <td>POLYGON ((102.10000 22.40000, 102.20000 22.400...</td>
    </tr>
    <tr>
      <th>2</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>2009</td>
      <td>102.15</td>
      <td>22.25</td>
      <td>102.15E_22.25N</td>
      <td>POLYGON ((102.10000 22.30000, 102.20000 22.300...</td>
    </tr>
    <tr>
      <th>3</th>
      <td>19099.0</td>
      <td>22.502407</td>
      <td>102.293701</td>
      <td>-0.465</td>
      <td>0.346</td>
      <td>2187</td>
      <td>102.25</td>
      <td>22.55</td>
      <td>102.25E_22.55N</td>
      <td>POLYGON ((102.20000 22.60000, 102.30000 22.600...</td>
    </tr>
  </tbody>
</table>
</div>




```python
grid_rwi = pd.DataFrame(
    grid_rwi_gdf.groupby(["id", "Centroid"])["rwi"].mean()
).reset_index()

# Fill nans with mean value for the country
mean_rwi = grid_rwi.rwi.mean()
grid_rwi = grid_rwi.fillna(mean_rwi)
```


```python
# RWI distance
max_rwi = grid_rwi.rwi.max()
grid_rwi['distance_rwi'] = (max_rwi - grid_rwi.rwi)
max_distance = grid_rwi['distance_rwi'].max()
grid_rwi['scaled_distance'] = grid_rwi['distance_rwi'] / max_distance
grid_rwi
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>id</th>
      <th>Centroid</th>
      <th>rwi</th>
      <th>distance_rwi</th>
      <th>scaled_distance</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>2007</td>
      <td>102.15E_22.45N</td>
      <td>0.371000</td>
      <td>0.995960</td>
      <td>0.444038</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2008</td>
      <td>102.15E_22.35N</td>
      <td>0.003629</td>
      <td>1.363331</td>
      <td>0.607827</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2009</td>
      <td>102.15E_22.25N</td>
      <td>0.003629</td>
      <td>1.363331</td>
      <td>0.607827</td>
    </tr>
    <tr>
      <th>3</th>
      <td>2187</td>
      <td>102.25E_22.55N</td>
      <td>-0.465000</td>
      <td>1.831960</td>
      <td>0.816760</td>
    </tr>
    <tr>
      <th>4</th>
      <td>2188</td>
      <td>102.25E_22.45N</td>
      <td>-0.543000</td>
      <td>1.909960</td>
      <td>0.851535</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>3574</th>
      <td>30180</td>
      <td>117.65E_10.65N</td>
      <td>0.003629</td>
      <td>1.363331</td>
      <td>0.607827</td>
    </tr>
    <tr>
      <th>3575</th>
      <td>30359</td>
      <td>117.75E_10.85N</td>
      <td>0.003629</td>
      <td>1.363331</td>
      <td>0.607827</td>
    </tr>
    <tr>
      <th>3576</th>
      <td>30360</td>
      <td>117.75E_10.75N</td>
      <td>0.003629</td>
      <td>1.363331</td>
      <td>0.607827</td>
    </tr>
    <tr>
      <th>3577</th>
      <td>30540</td>
      <td>117.85E_10.85N</td>
      <td>0.003629</td>
      <td>1.363331</td>
      <td>0.607827</td>
    </tr>
    <tr>
      <th>3578</th>
      <td>30541</td>
      <td>117.85E_10.75N</td>
      <td>0.003629</td>
      <td>1.363331</td>
      <td>0.607827</td>
    </tr>
  </tbody>
</table>
<p>3579 rows Ã— 5 columns</p>
</div>



### Save it


```python
grid_rwi.to_csv(output_dir / "viet_rwi_bygrid.csv", index=False)
```

### Maps


```python
geo_rwi = gpd.GeoDataFrame(grid.merge(grid_rwi, on='id'), geometry='geometry')

fig, ax = plt.subplots(1,1)
geo_rwi.plot(column='rwi', legend=True, cmap = 'YlOrBr', ax=ax)
ax.set_title('Vietnam RWI')
plt.show()
```



![png](05.1_RWI_files/05.1_RWI_12_0.png)




```python
fig, ax = plt.subplots(1,1)
geo_rwi.plot(column='scaled_distance', legend=True, cmap = 'YlOrBr', ax=ax)
ax.set_title('Vietnam Scaled RWI distance')
plt.show()
```



![png](05.1_RWI_files/05.1_RWI_13_0.png)



### IWI vs RWI


```python
iwi_rwi = grid_rwi.merge(iwi, left_on='id', right_on='grid_point_id')
df_merged = ids_mun.merge(iwi_rwi, on='id')
# At adm1
df_merged_grouped = df_merged[['region', 'rwi', 'IWI']].groupby('region').mean()
```


```python
plt.plot(df_merged_grouped.IWI, df_merged_grouped.rwi, 'o')
plt.xlabel('IWI')
plt.ylabel('RWI')
plt.title('Mean RWI vs IWI at AMD1 level \nVietnam')
plt.grid()
plt.show()
```



![png](05.1_RWI_files/05.1_RWI_16_0.png)
