```python
from pathlib import Path
import os

from shapely.geometry import LineString,Polygon, MultiPolygon
import geopandas as gpd
import numpy as np
import pandas as pd
import xarray as xr
import re
import matplotlib.pyplot as plt
from matplotlib.patches import Patch
from matplotlib.lines import Line2D
from scipy import stats

from climada.hazard import Centroids, TCTracks, TropCyclone
from shapely.geometry import LineString
```


```python
input_dir = (
    Path(os.getenv("STORM_DATA_DIR"))
    / "analysis_vnm/02_model_features/02_housing_damage/input/"
)
output_dir = (
    Path(os.getenv("STORM_DATA_DIR"))
    / "analysis_vnm/02_model_features/02_housing_damage/output/"
)
wind_info = (
    Path(os.getenv("STORM_DATA_DIR"))
    / "analysis_vnm/02_model_features/01_windfield"
)
# Load typhoon id info
typhoon_ids = pd.read_csv(wind_info/ "typhoons.csv")

# Load Vietnam
vietnam = gpd.read_file(input_dir / "adm2_shp_fixed.gpkg")
vietnam = vietnam.to_crs('EPSG:4326')

# Load grid
grid_land_overlap = gpd.read_file(output_dir / "viet_0.1_degree_grid_land_overlap_new.gpkg")
grid_land_overlap["id"] = grid_land_overlap["id"].astype(int)

# Load grids per Municipality
ids_mun = pd.read_csv(input_dir / "grid_municipality_info.csv")

# Load damage data
damage_data = pd.read_csv(input_dir / "viet_damage_adm1_level.csv")

# Number of buildings per id
bld_count = pd.read_csv(input_dir / "vnm_google_bld_grid_count.csv")
```

## Building locations

### Map of building location


```python
bld_count_complete = bld_count.merge(grid_land_overlap, on='id')
gpd_bld_count = gpd.GeoDataFrame(bld_count_complete, geometry='geometry')
```


```python
# Plot builing loc over map
fig, ax = plt.subplots(1,1)

vietnam.plot(ax=ax, color='gray', edgecolor='gray', label='Fiji', alpha=0.5)
gpd_bld_count.plot(ax=ax, column='count', legend=True, cmap='viridis')
ax.set_xlabel('Longitude')
ax.set_ylabel('Latitude')
ax.set_title('Vietnam builings density by grid')
plt.show()
```



![png](02.1.2_damage_agg_by_building_google_files/02.1.2_damage_agg_by_building_google_5_0.png)



Seems we don't have information for the small islands. These are 0 buildings data (not in reality)


```python
# Lets do something with this
bld_count_complete = bld_count.merge(grid_land_overlap, on='id', how='right').fillna(0)
bld_count_complete = bld_count_complete.rename({'count':'numbuildings'}, axis=1)
```


```python
# Plot per grid
# Define the bins and labels
bins = [-float('inf'), 5, 50, 100, 300, 500, 1000, 5000, 10000, 100000, float('inf')]
labels = [0, 1, 2, 3, 4, 5, 6, 7, 8, 9]

# Create the new column using pd.cut
bld_count_complete['numbuildings_cat'] = pd.cut(bld_count_complete['numbuildings'], bins=bins, labels=labels, include_lowest=True)
gpd_bld_count = gpd.GeoDataFrame(bld_count_complete, geometry='geometry')
```


```python
# Define the categories and their corresponding labels
categories = [0, 1, 2, 3, 4, 5, 6, 7, 8, 9]
category_labels = ['< 5', '5 - 50', '50 - 100', '100 - 300', '300 - 500', '500 - 1000', '1000 - 5000', '5000 - 10000', '10000 - 100000', '> 100000']

# Plot histogram
plt.figure(figsize=(10, 6))
plt.hist(bld_count_complete['numbuildings_cat'], bins=range(11), edgecolor='black', align='left', rwidth=0.8)

# Customize xticks
plt.xticks(categories, category_labels, rotation=45, ha='right')

# Add labels and title
plt.xlabel('Number of Buildings by Grid')
plt.ylabel('Frequency')
plt.title('Distribution of Number of Buildings Categories')

# Display the plot
plt.show()
```



![png](02.1.2_damage_agg_by_building_google_files/02.1.2_damage_agg_by_building_google_9_0.png)




```python
# Plot the GeoDataFrame
fig, ax = plt.subplots(1,1, figsize=(5, 5))
gpd_bld_count.plot(column='numbuildings_cat', cmap='viridis', legend=True, ax=ax, legend_kwds={'title': 'Buildings by grid'})

# Customize the legend labels
legend_labels = {
    0: '< 5',
    1: '5 - 50',
    2: '50 - 100',
    3: '100 - 300',
    4: '300 - 500',
    5: '500 - 1000',
    6: '1000 - 5000',
    7: '5000 - 10000',
    8: '10000 - 100000',
    9: '> 100000'
}

# Get the current legend
legend = ax.get_legend()

# Customize the legend labels using legend_labels dictionary
for key, label in legend_labels.items():
    legend.get_texts()[key].set_text(label)

# Display the map
plt.show()
```



![png](02.1.2_damage_agg_by_building_google_files/02.1.2_damage_agg_by_building_google_10_0.png)



### Distribution of bld per grid


```python
build_per_grid = bld_count_complete.numbuildings
#plt.hist(build_per_grid, bins=50)
hist = np.histogram(build_per_grid, bins=10 ** np.linspace(0, np.log10(10**4), len(build_per_grid)), density=True)
x = hist[1][:-1]
y = hist[0]

plt.plot(x,y, 'ro', alpha=0.4, label='Buildings')
plt.xscale('log')
plt.yscale('log')

plt.xlabel('Buildings per grid cell')
plt.ylabel('PDF')

q25 = np.quantile(build_per_grid, 0.25)
q50 = np.quantile(build_per_grid, 0.50)
mode = stats.mode(build_per_grid).mode

# Add text boxes with annotations
plt.text(0.7, 0.9, f'Quantile 25: {q25:.2f}', transform=plt.gca().transAxes)
plt.text(0.7, 0.85, f'Quantile 50: {q50:.2f}', transform=plt.gca().transAxes)
plt.text(0.7, 0.8, f'Mode: {mode:.2f}', transform=plt.gca().transAxes)

plt.show()
```



![png](02.1.2_damage_agg_by_building_google_files/02.1.2_damage_agg_by_building_google_12_0.png)




```python
# Save it
bld_count_complete[['id', 'numbuildings']].to_csv(output_dir / "num_building_bygrid.csv")
```

### Building damage to grid


```python
# Municipalities by id
mun_dict = ids_mun[['id', 'ADM1_EN']].groupby(by='ADM1_EN').groups
muns =  mun_dict.keys()
ids = []
for m in muns:
    ids.append(ids_mun.iloc[mun_dict[m].values].id)
df_muns = pd.DataFrame({'Municipality': muns, 'ids':ids})
provinces_exploded = df_muns.explode('ids')

# Regions by id
region_dict = ids_mun[['id', 'region']].groupby(by='region').groups
regions =  region_dict.keys()
ids = []
for r in regions:
    ids.append(ids_mun.iloc[region_dict[r].values].id)
df_regions = pd.DataFrame({'Region': regions, 'ids':ids})
regions_exploded = df_regions.explode('ids')
```


```python
# Some checks
print(len(set(ids_mun.sort_values('id').id.unique()) & set(bld_count_complete.id.unique())))
print(len(set(provinces_exploded.sort_values('ids').ids.unique()) - set(bld_count_complete.id.unique())))
```

    3579
    0



```python
# Assign municipality to building count
bld_grid_mun = bld_count_complete.merge(provinces_exploded, left_on='id', right_on='ids', how='inner')[['id', 'Municipality', 'numbuildings']]

# Assign region to building count
bld_grid_region = bld_count_complete.merge(regions_exploded, left_on='id', right_on='ids', how='inner')[['id', 'Region', 'numbuildings']]


bld_grid_region.sort_values('numbuildings', ascending=False)
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>id</th>
      <th>Region</th>
      <th>numbuildings</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1911</th>
      <td>10269</td>
      <td>SE</td>
      <td>615948.0</td>
    </tr>
    <tr>
      <th>1910</th>
      <td>10268</td>
      <td>SE</td>
      <td>562320.0</td>
    </tr>
    <tr>
      <th>1968</th>
      <td>10449</td>
      <td>SE</td>
      <td>404152.0</td>
    </tr>
    <tr>
      <th>2017</th>
      <td>10629</td>
      <td>SE</td>
      <td>370971.0</td>
    </tr>
    <tr>
      <th>1335</th>
      <td>8718</td>
      <td>RRD</td>
      <td>327418.0</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>3344</th>
      <td>20712</td>
      <td>SC</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>3343</th>
      <td>20711</td>
      <td>SC</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>3342</th>
      <td>20710</td>
      <td>SC</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>3341</th>
      <td>20709</td>
      <td>SC</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>3231</th>
      <td>15124</td>
      <td>SC</td>
      <td>0.0</td>
    </tr>
  </tbody>
</table>
<p>3579 rows × 3 columns</p>
</div>




```python
# Because I can: builings by Municipality

df_aux = bld_grid_mun.groupby('Municipality').sum().sort_values(by='numbuildings', ascending=False)
df_aux2 = bld_grid_region.groupby('Region').sum().sort_values(by='numbuildings', ascending=False)

plt.figure(figsize=(12, 6))
plt.bar(df_aux.index, df_aux['numbuildings'])
plt.ylabel('Number of Buildings')
plt.title('Number of Buildings by Province')
plt.xticks(rotation=90)
plt.show()

plt.figure(figsize=(12, 6))
plt.bar(df_aux2.index, df_aux2['numbuildings'])
plt.ylabel('Number of Buildings')
plt.title('Number of Buildings by Region')
plt.xticks(rotation=90)
plt.show()
```



![png](02.1.2_damage_agg_by_building_google_files/02.1.2_damage_agg_by_building_google_18_0.png)





![png](02.1.2_damage_agg_by_building_google_files/02.1.2_damage_agg_by_building_google_18_1.png)



Since I have multiple regions affected by a single typhoon but just une quantity of damage, at the end I have damage not even at region level, but at a bigger scale (damage at a set of regions level). This is bad but is what we have, and all the calculous that we do have to take this into account.


```python
# Total number of buildings per region
total_bld_reg = bld_grid_region.groupby('Region').sum()['numbuildings'].reset_index(drop=False)
bld_grid_reg_merged = bld_grid_region.merge(total_bld_reg, on='Region', how='left')
#bld_grid_reg_merged['frac_bld'] = bld_grid_reg_merged['numbuildings_x'] / bld_grid_reg_merged['numbuildings_y']
```


```python
# Fix some things on the damage data
import ast
damage_data.region_affected.replace({
    "['SC,C']": "['SC', 'C']"
}, inplace=True)
damage_data['region_affected'] = damage_data['region_affected'].astype('str').apply(ast.literal_eval)
```


```python
# Fix some other things on the damage data
damage_data.typhoon_name = damage_data.typhoon_name.str.upper()
damage_data = damage_data[~damage_data['typhoon_name'].isin(['KALMAGE', 'SONTINH', 'MANGKHUT'])].reset_index(drop=True)
damage_data['typhoon_name'].replace({
    'SON': 'SON-TINH',
    'KAITAK': 'KAI-TAK',
    'PUDOL': 'PODUL',
    'MANGKUT': 'MANGKHUT',
    'MATMO': 'BULBUL:MATMO'
}, inplace=True)

# Explode on region
damage_data_exploded = damage_data.explode('region_affected')
bld_damage_merged = damage_data_exploded.merge(bld_grid_reg_merged, left_on='region_affected', right_on='Region')
```


```python
bld_damage_merged_total = pd.DataFrame()
bld_dmg_aux = bld_damage_merged.drop_duplicates(['typhoon_name', 'Year'])
for typhoon, year in zip(bld_dmg_aux['typhoon_name'], bld_dmg_aux['Year']):
    bld_damage_merged_set_regions = bld_damage_merged.loc[(bld_damage_merged.typhoon_name == typhoon) & (bld_damage_merged.Year == year)].copy()
    # Total number of buildings in the set of regions
    bld_damage_merged_set_regions['numbuildings_z'] = bld_damage_merged_set_regions.numbuildings_y.unique().sum()
    # Density of buildings per cell for every typhoon
    bld_damage_merged_set_regions['frac_bld'] = bld_damage_merged_set_regions['numbuildings_x'] / bld_damage_merged_set_regions['numbuildings_z']
    # Create percentage of damage per grid cell
    bld_damage_merged_set_regions['perc_dmg_grid'] = bld_damage_merged_set_regions['frac_bld'] * bld_damage_merged_set_regions['total_bld_dmg'] * 100 / bld_damage_merged_set_regions['numbuildings_z']

    # For every typhoon, put 0 damage to the grid cells not affected by the typhoon
    df_aux3 = bld_damage_merged_set_regions.merge(bld_grid_region, on='id', how='right')
    df_aux3['typhoon_name'] = df_aux3.typhoon_name.fillna(typhoon)
    df_aux3['Year'] = df_aux3.Year.fillna(year)
    df_aux3 = df_aux3.rename({'Region_y': 'Region'}, axis=1)
    bld_damage_merged_set_regions_total = df_aux3.fillna(0)

    bld_damage_merged_total = pd.concat([bld_damage_merged_total, bld_damage_merged_set_regions_total])
```

### Some examples


```python
typhoon_ids.head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>typhoon_name</th>
      <th>Year</th>
      <th>id</th>
      <th>total_bld_dmg</th>
      <th>region_affected</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>LINDA</td>
      <td>1997</td>
      <td>1997298N06140</td>
      <td>216054.0</td>
      <td>['MD']</td>
    </tr>
    <tr>
      <th>1</th>
      <td>DAMREY</td>
      <td>2005</td>
      <td>2005262N13127</td>
      <td>12770.0</td>
      <td>['RRD', 'NC', 'NE']</td>
    </tr>
    <tr>
      <th>2</th>
      <td>XANGSANE</td>
      <td>2006</td>
      <td>2006268N12129</td>
      <td>349348.0</td>
      <td>['NC', 'SC', 'C']</td>
    </tr>
    <tr>
      <th>3</th>
      <td>DURIAN</td>
      <td>2006</td>
      <td>2006329N06150</td>
      <td>241438.0</td>
      <td>['SC', 'SE', 'MD']</td>
    </tr>
    <tr>
      <th>4</th>
      <td>LEKIMA</td>
      <td>2007</td>
      <td>2007272N17125</td>
      <td>113623.0</td>
      <td>['NW', 'NC', 'SC']</td>
    </tr>
  </tbody>
</table>
</div>




```python
# Damage info
linda = bld_damage_merged_total[bld_damage_merged_total.typhoon_name == 'LINDA']
linda = gpd.GeoDataFrame(linda.merge(bld_count_complete[['id', 'geometry']], on='id'))

# Track path
track = TCTracks.from_ibtracs_netcdf(storm_id='1997298N06140') #Linda
tc_track = track.get_track()
points = gpd.points_from_xy(tc_track.lon, tc_track.lat)
track_points = gpd.GeoDataFrame(geometry=points)
tc_track_line = LineString(points)
track_line = gpd.GeoDataFrame(geometry=[tc_track_line])

# Plot
fig, ax = plt.subplots(1,1)
linda.plot(ax=ax, column='perc_dmg_grid', legend=True, cmap='Reds')
track_line.plot(ax=ax, color='k', linewidth=1, label='Typhoon track')

ax.set_xlim(100, 120)
ax.set_ylim(7, 24)
ax.set_title('Linda typhoon 1997, \n% of houses affected by grid')
plt.show()
```

    2024-02-07 15:03:30,298 - climada.hazard.tc_tracks - WARNING - The cached IBTrACS data set dates from 2023-06-07 23:07:38 (older than 180 days). Very likely, a more recent version is available. Consider manually removing the file /Users/federico/climada/data/IBTrACS.ALL.v04r00.nc and re-running this function, which will download the most recent version of the IBTrACS data set from the official URL.




![png](02.1.2_damage_agg_by_building_google_files/02.1.2_damage_agg_by_building_google_26_1.png)




```python
# Damage info
damrey = bld_damage_merged_total[(bld_damage_merged_total.typhoon_name == 'DAMREY') & (bld_damage_merged_total.Year == 2017)]
damrey = gpd.GeoDataFrame(damrey.merge(bld_count_complete[['id', 'geometry']], on='id'))

# Track path
track = TCTracks.from_ibtracs_netcdf(storm_id='2017304N11127') # Damrey2017
tc_track = track.get_track()
points = gpd.points_from_xy(tc_track.lon, tc_track.lat)
track_points = gpd.GeoDataFrame(geometry=points)
tc_track_line = LineString(points)
track_line = gpd.GeoDataFrame(geometry=[tc_track_line])

# Plot
fig, ax = plt.subplots(1,1)
damrey.plot(ax=ax, column='perc_dmg_grid', legend=True, cmap='Reds')
track_line.plot(ax=ax, color='k', linewidth=1, label='Typhoon track')

ax.set_xlim(100, 120)
ax.set_ylim(7, 24)
ax.set_title('Damrey typhoon 2017, \n% of houses affected by grid')
plt.show()
```

    2024-02-07 15:03:52,755 - climada.hazard.tc_tracks - WARNING - The cached IBTrACS data set dates from 2023-06-07 23:07:38 (older than 180 days). Very likely, a more recent version is available. Consider manually removing the file /Users/federico/climada/data/IBTrACS.ALL.v04r00.nc and re-running this function, which will download the most recent version of the IBTrACS data set from the official URL.




![png](02.1.2_damage_agg_by_building_google_files/02.1.2_damage_agg_by_building_google_27_1.png)



### Save % of damage per grid cell


```python
bld_damage_merged_total
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>typhoon_name</th>
      <th>Year</th>
      <th>total_bld_dmg</th>
      <th>region_affected</th>
      <th>id</th>
      <th>Region_x</th>
      <th>numbuildings_x</th>
      <th>numbuildings_y</th>
      <th>numbuildings_z</th>
      <th>frac_bld</th>
      <th>perc_dmg_grid</th>
      <th>Region</th>
      <th>numbuildings</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>LINDA</td>
      <td>1997.0</td>
      <td>0.0</td>
      <td>0</td>
      <td>2007</td>
      <td>0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.000000e+00</td>
      <td>0.000000e+00</td>
      <td>NW</td>
      <td>333.0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>LINDA</td>
      <td>1997.0</td>
      <td>0.0</td>
      <td>0</td>
      <td>2008</td>
      <td>0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.000000e+00</td>
      <td>0.000000e+00</td>
      <td>NW</td>
      <td>294.0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>LINDA</td>
      <td>1997.0</td>
      <td>0.0</td>
      <td>0</td>
      <td>2009</td>
      <td>0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.000000e+00</td>
      <td>0.000000e+00</td>
      <td>NW</td>
      <td>21.0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>LINDA</td>
      <td>1997.0</td>
      <td>0.0</td>
      <td>0</td>
      <td>2187</td>
      <td>0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.000000e+00</td>
      <td>0.000000e+00</td>
      <td>NW</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>LINDA</td>
      <td>1997.0</td>
      <td>0.0</td>
      <td>0</td>
      <td>2188</td>
      <td>0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.000000e+00</td>
      <td>0.000000e+00</td>
      <td>NW</td>
      <td>313.0</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>3574</th>
      <td>SINLAKU</td>
      <td>2020.0</td>
      <td>3321.0</td>
      <td>SC</td>
      <td>30180</td>
      <td>SC</td>
      <td>1.0</td>
      <td>7991119.0</td>
      <td>12306771.0</td>
      <td>8.125608e-08</td>
      <td>2.192707e-09</td>
      <td>SC</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>3575</th>
      <td>SINLAKU</td>
      <td>2020.0</td>
      <td>3321.0</td>
      <td>SC</td>
      <td>30359</td>
      <td>SC</td>
      <td>0.0</td>
      <td>7991119.0</td>
      <td>12306771.0</td>
      <td>0.000000e+00</td>
      <td>0.000000e+00</td>
      <td>SC</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>3576</th>
      <td>SINLAKU</td>
      <td>2020.0</td>
      <td>3321.0</td>
      <td>SC</td>
      <td>30360</td>
      <td>SC</td>
      <td>0.0</td>
      <td>7991119.0</td>
      <td>12306771.0</td>
      <td>0.000000e+00</td>
      <td>0.000000e+00</td>
      <td>SC</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>3577</th>
      <td>SINLAKU</td>
      <td>2020.0</td>
      <td>3321.0</td>
      <td>SC</td>
      <td>30540</td>
      <td>SC</td>
      <td>0.0</td>
      <td>7991119.0</td>
      <td>12306771.0</td>
      <td>0.000000e+00</td>
      <td>0.000000e+00</td>
      <td>SC</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>3578</th>
      <td>SINLAKU</td>
      <td>2020.0</td>
      <td>3321.0</td>
      <td>SC</td>
      <td>30541</td>
      <td>SC</td>
      <td>1.0</td>
      <td>7991119.0</td>
      <td>12306771.0</td>
      <td>8.125608e-08</td>
      <td>2.192707e-09</td>
      <td>SC</td>
      <td>1.0</td>
    </tr>
  </tbody>
</table>
<p>128844 rows × 13 columns</p>
</div>




```python
bld_damage_merged_total.to_csv(output_dir / "building_damage_bygrid_new.csv", index=False)
```
