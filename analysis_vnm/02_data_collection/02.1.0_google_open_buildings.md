The data is gotten from `https://sites.research.google/open-buildings/#download`


```python
import pandas as pd
import geopandas as gpd
import os
from pathlib import Path
import requests
import matplotlib.pyplot as plt
```


```python
base_dir = Path(os.getenv("STORM_DATA_DIR")) / "analysis_vnm/02_model_features/"
input_dir = base_dir / "02_housing_damage/input"
google_dir = input_dir / "Google Footprint Data/"
os.makedirs(google_dir, exist_ok=True)

# Load Vietnam shp
vietnam = gpd.read_file(input_dir / "adm2_shp_fixed.gpkg")
vietnam = vietnam.to_crs('EPSG:4326')

# Load grids
grid = gpd.read_file(base_dir / "02_housing_damage/output/viet_0.1_degree_grid_land_overlap_new.gpkg")
```


```python
google_tiles = gpd.read_file(
    "https://sites.research.google/open-buildings/tiles.geojson"
)
```


```python
google_tiles.plot()
plt.show()
```



![png](02.1.0_google_open_buildings_files/02.1.0_google_open_buildings_4_0.png)




```python
vietnam.plot()
```




    <Axes: >





![png](02.1.0_google_open_buildings_files/02.1.0_google_open_buildings_5_1.png)




```python
vietnam.crs == google_tiles.crs
grid.crs == google_tiles.crs
```




    True




```python
joined_df = gpd.sjoin(google_tiles, grid, how="right", op="intersects")
file_pattern = joined_df.dropna().tile_id.unique()
```

    /Users/federico/anaconda3/envs/env6/lib/python3.11/site-packages/IPython/core/interactiveshell.py:3466: FutureWarning: The `op` parameter is deprecated and will be removed in a future release. Please use the `predicate` parameter instead.
      if await self.run_code(code, result, async_=asy):



```python
polygons_url_link = "https://storage.googleapis.com/open-buildings-data/v2/polygons_s2_level_4_gzip/"
points_url_link = "https://storage.googleapis.com/open-buildings-data/v2/points_s2_level_4_gzip/"
file_list = [patt + "_buildings.csv.gz" for patt in file_pattern]
```


```python
# Downloading data. It takes a long time, be cautious.
for file in file_list:
    r = requests.get(points_url_link + file, allow_redirects=True)
    open(google_dir / file, "wb").write(r.content)
```


```python
# Merging data (also takes long)
google_df = pd.DataFrame()
for file in file_list:
    zone_file = pd.read_csv(google_dir / file, compression="gzip")
    google_df = pd.concat([google_df, zone_file])
google_df
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>latitude</th>
      <th>longitude</th>
      <th>area_in_meters</th>
      <th>confidence</th>
      <th>full_plus_code</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>11.512700</td>
      <td>105.061895</td>
      <td>14.6566</td>
      <td>0.6070</td>
      <td>7P37G376+3QJ4</td>
    </tr>
    <tr>
      <th>1</th>
      <td>15.771184</td>
      <td>103.350218</td>
      <td>16.0113</td>
      <td>0.6336</td>
      <td>7P75Q9C2+F3G9</td>
    </tr>
    <tr>
      <th>2</th>
      <td>15.079025</td>
      <td>101.002190</td>
      <td>119.5626</td>
      <td>0.7940</td>
      <td>7P7332H2+JV4R</td>
    </tr>
    <tr>
      <th>3</th>
      <td>11.327440</td>
      <td>105.925089</td>
      <td>57.3053</td>
      <td>0.7959</td>
      <td>7P378WGG+X2GH</td>
    </tr>
    <tr>
      <th>4</th>
      <td>13.441568</td>
      <td>100.995020</td>
      <td>9.7941</td>
      <td>0.6190</td>
      <td>7P52CXRW+J2CP</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>36151</th>
      <td>9.518874</td>
      <td>118.543615</td>
      <td>26.8762</td>
      <td>0.7380</td>
      <td>6PXWGG9V+GCXW</td>
    </tr>
    <tr>
      <th>36152</th>
      <td>9.428561</td>
      <td>118.556408</td>
      <td>33.4775</td>
      <td>0.6771</td>
      <td>6PXWCHH4+CHFC</td>
    </tr>
    <tr>
      <th>36153</th>
      <td>9.395108</td>
      <td>118.144323</td>
      <td>80.7607</td>
      <td>0.7174</td>
      <td>6PXW94WV+2PW7</td>
    </tr>
    <tr>
      <th>36154</th>
      <td>9.549480</td>
      <td>118.303896</td>
      <td>26.9812</td>
      <td>0.7012</td>
      <td>6PXWG8X3+QHR4</td>
    </tr>
    <tr>
      <th>36155</th>
      <td>9.503830</td>
      <td>118.608765</td>
      <td>16.9282</td>
      <td>0.6499</td>
      <td>6PXWGJ35+GGJ7</td>
    </tr>
  </tbody>
</table>
<p>106904526 rows × 5 columns</p>
</div>




```python
# Saving data (takes long)
google_df.to_csv(input_dir / "google_footprint_data.csv", index=False)
```


```python
# Load (if neccesary)
google_df = pd.read_csv(input_dir / "google_footprint_data.csv.gz")
```


```python
# Creating geodataframe from df
ggl_gdf = gpd.GeoDataFrame(
    google_df,
    geometry=gpd.points_from_xy(google_df.longitude, google_df.latitude),
)
```


```python
ggl_gdf.set_crs(grid.crs, inplace=True)
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>latitude</th>
      <th>longitude</th>
      <th>area_in_meters</th>
      <th>confidence</th>
      <th>full_plus_code</th>
      <th>geometry</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>22.476902</td>
      <td>103.990640</td>
      <td>42.8850</td>
      <td>0.7019</td>
      <td>7PJ5FXGR+Q763</td>
      <td>POINT (103.99064 22.47690)</td>
    </tr>
    <tr>
      <th>1</th>
      <td>22.093290</td>
      <td>104.674233</td>
      <td>316.2294</td>
      <td>0.7681</td>
      <td>7PJ63MVF+8M9F</td>
      <td>POINT (104.67423 22.09329)</td>
    </tr>
    <tr>
      <th>2</th>
      <td>22.604843</td>
      <td>104.180937</td>
      <td>34.7107</td>
      <td>0.8088</td>
      <td>7PJ6J53J+W9MQ</td>
      <td>POINT (104.18094 22.60484)</td>
    </tr>
    <tr>
      <th>3</th>
      <td>22.394872</td>
      <td>105.626483</td>
      <td>51.4673</td>
      <td>0.7544</td>
      <td>7PJ79JVG+WHXV</td>
      <td>POINT (105.62648 22.39487)</td>
    </tr>
    <tr>
      <th>4</th>
      <td>21.898866</td>
      <td>106.319942</td>
      <td>73.8082</td>
      <td>0.6722</td>
      <td>7PH8V8X9+GXWJ</td>
      <td>POINT (106.31994 21.89887)</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>106904521</th>
      <td>9.518874</td>
      <td>118.543615</td>
      <td>26.8762</td>
      <td>0.7380</td>
      <td>6PXWGG9V+GCXW</td>
      <td>POINT (118.54362 9.51887)</td>
    </tr>
    <tr>
      <th>106904522</th>
      <td>9.428561</td>
      <td>118.556408</td>
      <td>33.4775</td>
      <td>0.6771</td>
      <td>6PXWCHH4+CHFC</td>
      <td>POINT (118.55641 9.42856)</td>
    </tr>
    <tr>
      <th>106904523</th>
      <td>9.395108</td>
      <td>118.144323</td>
      <td>80.7607</td>
      <td>0.7174</td>
      <td>6PXW94WV+2PW7</td>
      <td>POINT (118.14432 9.39511)</td>
    </tr>
    <tr>
      <th>106904524</th>
      <td>9.549480</td>
      <td>118.303896</td>
      <td>26.9812</td>
      <td>0.7012</td>
      <td>6PXWG8X3+QHR4</td>
      <td>POINT (118.30390 9.54948)</td>
    </tr>
    <tr>
      <th>106904525</th>
      <td>9.503830</td>
      <td>118.608765</td>
      <td>16.9282</td>
      <td>0.6499</td>
      <td>6PXWGJ35+GGJ7</td>
      <td>POINT (118.60877 9.50383)</td>
    </tr>
  </tbody>
</table>
<p>106904526 rows × 6 columns</p>
</div>




```python
del google_df
ggl_gdf_within = gpd.sjoin(ggl_gdf, grid, how="inner", predicate="within")

```


```python
ggl_gdf_within.head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>latitude</th>
      <th>longitude</th>
      <th>area_in_meters</th>
      <th>confidence</th>
      <th>full_plus_code</th>
      <th>geometry</th>
      <th>index_right</th>
      <th>id</th>
      <th>Longitude</th>
      <th>Latitude</th>
      <th>Centroid</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>22.476902</td>
      <td>103.990640</td>
      <td>42.8850</td>
      <td>0.7019</td>
      <td>7PJ5FXGR+Q763</td>
      <td>POINT (103.99064 22.47690)</td>
      <td>274</td>
      <td>5265</td>
      <td>103.95</td>
      <td>22.45</td>
      <td>103.95E_22.45N</td>
    </tr>
    <tr>
      <th>73</th>
      <td>22.481149</td>
      <td>103.994158</td>
      <td>54.9635</td>
      <td>0.7610</td>
      <td>7PJ5FXJV+FM3R</td>
      <td>POINT (103.99416 22.48115)</td>
      <td>274</td>
      <td>5265</td>
      <td>103.95</td>
      <td>22.45</td>
      <td>103.95E_22.45N</td>
    </tr>
    <tr>
      <th>80</th>
      <td>22.482649</td>
      <td>103.978787</td>
      <td>29.9930</td>
      <td>0.6423</td>
      <td>7PJ5FXMH+3G3R</td>
      <td>POINT (103.97879 22.48265)</td>
      <td>274</td>
      <td>5265</td>
      <td>103.95</td>
      <td>22.45</td>
      <td>103.95E_22.45N</td>
    </tr>
    <tr>
      <th>154</th>
      <td>22.457291</td>
      <td>103.954334</td>
      <td>277.1709</td>
      <td>0.6473</td>
      <td>7PJ5FX43+WP8P</td>
      <td>POINT (103.95433 22.45729)</td>
      <td>274</td>
      <td>5265</td>
      <td>103.95</td>
      <td>22.45</td>
      <td>103.95E_22.45N</td>
    </tr>
    <tr>
      <th>166</th>
      <td>22.456581</td>
      <td>103.958723</td>
      <td>45.8399</td>
      <td>0.8522</td>
      <td>7PJ5FX45+JFQ6</td>
      <td>POINT (103.95872 22.45658)</td>
      <td>274</td>
      <td>5265</td>
      <td>103.95</td>
      <td>22.45</td>
      <td>103.95E_22.45N</td>
    </tr>
  </tbody>
</table>
</div>




```python
# The important file
ggl_gdf_within.to_csv(
    input_dir / "vnm_google_bld_points.csv.gz", compression='gzip', index=False
)
```

Buildings count


```python
result = ggl_gdf_within.groupby('id').size().reset_index(name='count')
```


```python
result
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>id</th>
      <th>count</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>2007</td>
      <td>333</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2008</td>
      <td>294</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2009</td>
      <td>21</td>
    </tr>
    <tr>
      <th>3</th>
      <td>2188</td>
      <td>313</td>
    </tr>
    <tr>
      <th>4</th>
      <td>2189</td>
      <td>521</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>3225</th>
      <td>15317</td>
      <td>8</td>
    </tr>
    <tr>
      <th>3226</th>
      <td>15318</td>
      <td>1784</td>
    </tr>
    <tr>
      <th>3227</th>
      <td>15319</td>
      <td>667</td>
    </tr>
    <tr>
      <th>3228</th>
      <td>30180</td>
      <td>1</td>
    </tr>
    <tr>
      <th>3229</th>
      <td>30541</td>
      <td>1</td>
    </tr>
  </tbody>
</table>
<p>3230 rows × 2 columns</p>
</div>




```python
result.to_csv(
    input_dir / "vnm_google_bld_grid_count.csv", index=False
)
```
